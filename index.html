<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ê³ êµí•™ì ì œ ìˆ˜ê°•ì‹ ì²­ ë„ìš°ë¯¸</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Custom Modules -->
    <script src="js/db.js"></script>
    <script src="js/theme.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom styles for theme compatibility */
        .theme-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .theme-text {
            color: var(--text-color);
        }

        .theme-text-muted {
            color: var(--text-muted);
        }

        .theme-border {
            border-color: var(--border-color);
        }

        input,
        select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        input:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.8);
        }

        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left Column: Student Info & Course Selection -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Header -->
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold theme-text">ğŸ“ ìˆ˜ê°•ì‹ ì²­ ë„ìš°ë¯¸</h1>
                <div class="text-sm theme-text-muted">2025í•™ë…„ë„ êµìœ¡ê³¼ì •</div>
            </header>

            <!-- Student Info Input -->
            <div class="theme-card p-6 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold mb-4 theme-text">í•™ìƒ ì •ë³´ ì…ë ¥</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <select id="student-grade" class="p-2 border rounded">
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                    </select>
                    <div class="flex items-center">
                        <input type="number" id="student-class" class="w-full p-2 border rounded text-center"
                            placeholder="ë°˜" min="1" max="15">
                        <span class="ml-1 theme-text">ë°˜</span>
                    </div>
                    <div class="flex items-center">
                        <input type="number" id="student-number" class="w-full p-2 border rounded text-center"
                            placeholder="ë²ˆí˜¸" min="1" max="40">
                        <span class="ml-1 theme-text">ë²ˆ</span>
                    </div>
                    <input type="text" id="student-name" class="p-2 border rounded md:col-span-2" placeholder="ì´ë¦„"
                        autocomplete="off" style="background-color: var(--input-bg);">
                    <div class="md:col-span-5 flex gap-2">
                        <input type="text" id="student-major" class="flex-1 p-2 border rounded"
                            placeholder="í¬ë§ ì§„ë¡œ (ì˜ˆ: ì»´í“¨í„°ê³µí•™ì, ê°„í˜¸ì‚¬) - AI ì¶”ì²œì— í™œìš©ë©ë‹ˆë‹¤"
                            style="background-color: var(--input-bg);">
                        <button onclick="getAiRecommendation()"
                            class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 whitespace-nowrap transition-colors">
                            ì¶”ì²œ ë°›ê¸°
                        </button>
                    </div>
                </div>
            </div>

            <!-- Course Selection Table -->
            <div class="theme-card p-6 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold theme-text">ê³¼ëª© ì„ íƒ</h2>
                    <div class="text-sm theme-text-muted">
                        ì´ ì‹ ì²­ í•™ì : <span id="total-credits" class="font-bold text-blue-600">0</span>í•™ì 
                    </div>
                </div>

                <!-- Dynamic Course List -->
                <div id="course-list-container" class="space-y-6">
                    <div class="text-center py-8 theme-text-muted">
                        <div
                            class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto">
                        </div>
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            </div>

            <!-- Joint Course Input -->
            <div class="theme-card p-6 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold mb-4 theme-text">ê³µë™ êµìœ¡ê³¼ì • (ì™¸ë¶€ ìˆ˜ê°•)</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="joint-course-name" class="flex-1 p-2 border rounded" placeholder="ê³¼ëª©ëª…">
                    <select id="joint-course-credits" class="p-2 border rounded w-24">
                        <option value="2">2í•™ì </option>
                        <option value="3">3í•™ì </option>
                        <option value="4">4í•™ì </option>
                    </select>
                    <select id="joint-course-category" class="p-2 border rounded w-32">
                        <option value="2-1">2í•™ë…„ 1í•™ê¸°</option>
                        <option value="2-2">2í•™ë…„ 2í•™ê¸°</option>
                        <option value="3-1">3í•™ë…„ 1í•™ê¸°</option>
                        <option value="3-2">3í•™ë…„ 2í•™ê¸°</option>
                    </select>
                    <button id="add-joint-btn"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ì¶”ê°€</button>
                </div>
                <ul id="joint-course-list" class="space-y-2 text-sm theme-text">
                    <!-- Added joint courses will appear here -->
                </ul>
            </div>
        </div>

        <!-- Right Column: Validation & AI Helper -->
        <div class="lg:col-span-1 space-y-6">
            <!-- AI Helper (Swapped: Now Top) -->
            <div
                class="theme-card p-6 rounded-lg shadow-md bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900 border-purple-100 dark:border-gray-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-purple-700 dark:text-purple-400">ğŸ¤– AI ê³¼ëª© ì¶”ì²œ ë„ìš°ë¯¸</h2>
                    <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded-full">Beta</span>
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                    í¬ë§ ì§„ë¡œë¥¼ ì…ë ¥í•˜ê³  ê³¼ëª©ì„ ì¶”ì²œë°›ì•„ë³´ì„¸ìš”.
                </p>
                <div id="ai-helper-content"
                    class="bg-white dark:bg-gray-800 p-4 rounded border border-purple-100 dark:border-gray-600 h-[300px] overflow-y-auto custom-scrollbar shadow-inner">
                    <div id="helper-msg" class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed">
                        ì§„ë¡œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ê´€ë ¨ ê³¼ëª©ì„ ì¶”ì²œí•´ì¤ë‹ˆë‹¤.
                    </div>
                    <div id="ai-loader" class="hidden flex justify-center items-center h-full">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-purple-200 h-8 w-8">
                        </div>
                    </div>
                </div>
                <button onclick="getAiRecommendation()"
                    class="w-full mt-4 bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition-colors hidden">
                    AI ì¶”ì²œ ë°›ê¸°
                </button>
            </div>

            <!-- Validation Status (Swapped: Now Bottom & Sticky) -->
            <div class="theme-card p-6 rounded-lg shadow-md sticky top-6">
                <h2 class="text-lg font-semibold mb-4 theme-text">ê²€ì¦ í˜„í™©</h2>
                <div id="validation-messages" class="space-y-2 mb-6">
                    <div class="text-sm text-gray-500">ê³¼ëª©ì„ ì„ íƒí•˜ë©´ ê²€ì¦ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>

                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-bold theme-text">ì„ íƒí•œ ê³¼ëª© ëª©ë¡</h3>
                    <div class="flex gap-2 text-xs">
                        <button id="toggle-required-btn"
                            class="px-2 py-1 rounded bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">
                            í•™êµì§€ì •
                        </button>
                        <button id="toggle-optional-btn"
                            class="px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors">
                            í•™ìƒì„ íƒ
                        </button>
                    </div>
                </div>
                <div id="selected-courses-list"
                    class="space-y-2 text-sm max-h-[400px] overflow-y-auto custom-scrollbar mb-6">
                    <div class="text-gray-400 italic">ì„ íƒëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>

                <button id="submit-btn" disabled
                    class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                    ìˆ˜ê°•ì‹ ì²­ ì™„ë£Œ ë° ì œì¶œ
                </button>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div id="submit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 theme-text">ìˆ˜ê°•ì‹ ì²­ í™•ì¸</h2>
            <div class="mb-6">
                <p class="mb-2 theme-text">ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div id="final-selection-preview"
                    class="bg-gray-50 dark:bg-gray-700 p-4 rounded border theme-border text-sm">
                    <!-- Preview content -->
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="save-img-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ì´ë¯¸ì§€ë¡œ
                    ì €ì¥</button>
                <button id="cancel-submit-btn"
                    class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">ì·¨ì†Œ</button>
                <button id="confirm-submit-btn"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ì œì¶œí•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global Variables
        let PROCESSED_COURSES = [];
        let jointCourses = [];
        let selectionRules = {};
        let multiSemesterRules = {};
        const duplicateCourseSlugs = [];
        const jointSubCategoryToCategoryMap = {
            'êµ­ì–´': 'ê¸°ì´ˆêµê³¼', 'ìˆ˜í•™': 'ê¸°ì´ˆêµê³¼', 'ì˜ì–´': 'ê¸°ì´ˆêµê³¼', 'í•œêµ­ì‚¬': 'ê¸°ì´ˆêµê³¼',
            'ì‚¬íšŒ': 'íƒêµ¬êµê³¼', 'ê³¼í•™': 'íƒêµ¬êµê³¼',
            'ì²´ìœ¡': 'ì²´ìœ¡êµê³¼', 'ì˜ˆìˆ ': 'ì˜ˆìˆ êµê³¼',
            'ì œ2ì™¸êµ­ì–´': 'êµì–‘êµê³¼', 'ì •ë³´': 'êµì–‘êµê³¼', 'êµì–‘': 'êµì–‘êµê³¼'
        };

        // Elements
        const courseListEl = document.getElementById('course-list-container');
        const selectedCoursesEl = document.getElementById('selected-courses-list');
        const totalCreditsEl = document.getElementById('total-credits');
        const validationMessagesEl = document.getElementById('validation-messages');
        const helperMsgEl = document.getElementById('helper-msg');
        const aiLoader = document.getElementById('ai-loader');

        const gradeEl = document.getElementById('student-grade');
        const classNumEl = document.getElementById('student-class');
        const studentNumEl = document.getElementById('student-number');
        const studentNameEl = document.getElementById('student-name');
        const majorInput = document.getElementById('student-major');

        const jointNameEl = document.getElementById('joint-course-name');
        const jointCreditsEl = document.getElementById('joint-course-credits');
        const jointCategoryEl = document.getElementById('joint-course-category');
        const addJointBtn = document.getElementById('add-joint-btn');
        const jointCoursesEl = document.getElementById('joint-course-list');

        const saveImgBtn = document.getElementById('save-img-btn');
        const submitBtn = document.getElementById('submit-btn');
        const submitModalEl = document.getElementById('submit-modal');
        const cancelBtn = document.getElementById('cancel-submit-btn');
        const confirmBtn = document.getElementById('confirm-submit-btn');
        const finalSelectionEl = document.getElementById('final-selection-preview');

        // Initialization
        async function init() {
            // Check for API Key in URL
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');

            if (key) {
                try {
                    const decodedUrl = atob(key);
                    DB.init(decodedUrl);
                    await loadData();
                } catch (e) {
                    console.error('Invalid Key', e);
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ í‚¤ì…ë‹ˆë‹¤.');
                }
            } else {
                console.warn('No API Key provided');
            }

            initJointCourses();
        }

        async function loadData() {
            const loader = document.querySelector('.loader');
            if (loader) loader.classList.remove('hidden');

            try {
                // Fetch Settings (Rules)
                const settings = await DB.fetchSettings();
                if (settings) {
                    if (settings.selectionRules) selectionRules = settings.selectionRules;
                    if (settings.multiSemesterRules) multiSemesterRules = settings.multiSemesterRules;

                    // Migration for old format
                    if (settings.selectionLimits && !settings.selectionRules) {
                        Object.keys(settings.selectionLimits).forEach(key => {
                            selectionRules[key] = [{ credits: 'all', count: settings.selectionLimits[key].maxCount }];
                        });
                    }
                }

                // Fetch Courses
                const courses = await DB.fetchConfig();
                if (!courses) throw new Error('ê³¼ëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                // Process courses and ensure credits is a number
                PROCESSED_COURSES = courses.filter(c => c.subjectName).map((c, index) => {
                    // Normalize credits field - handle different possible field names
                    let credits = c.credits || c.Credits || c.credit || c.í•™ì  || 0;
                    // Convert to number if it's a string
                    if (typeof credits === 'string') {
                        // Remove any non-numeric characters except decimal point
                        credits = parseFloat(credits.replace(/[^\d.]/g, '')) || 0;
                    }
                    credits = parseInt(credits) || 0;

                    // Normalize required field - handle TRUE/FALSE in various formats
                    let required = false;
                    if (c.required !== undefined && c.required !== null) {
                        const reqValue = String(c.required).toUpperCase().trim();
                        required = reqValue === 'TRUE' || reqValue === '1' || reqValue === 'YES' || c.required === true || c.required === 1;
                    }

                    // Ensure id field exists - use existing id, slug, or generate one
                    let id = c.id || c.Id || c.ID;
                    if (!id) {
                        // Generate id from slug, subjectName, or index
                        if (c.slug) {
                            id = `${c.slug}-${c.grade || ''}-${c.semester || ''}-${index}`;
                        } else if (c.subjectName) {
                            // Create a simple id from subjectName, grade, and semester
                            id = `${c.subjectName}-${c.grade || ''}-${c.semester || ''}-${index}`.replace(/\s+/g, '-').toLowerCase();
                        } else {
                            id = `course-${index}`;
                        }
                    }

                    return {
                        ...c,
                        id: id,
                        credits: credits,
                        required: required
                    };
                });

                // Debug: Log first course to check data structure
                if (PROCESSED_COURSES.length > 0) {
                    console.log('Sample course data:', PROCESSED_COURSES[0]);
                    console.log('Sample course required value (raw):', courses.find(c => c.subjectName === PROCESSED_COURSES[0].subjectName)?.required);
                    console.log('Sample course required value (processed):', PROCESSED_COURSES[0].required);
                    console.log('Total courses loaded:', PROCESSED_COURSES.length);
                    const requiredCount = PROCESSED_COURSES.filter(c => c.required).length;
                    console.log('Required courses count:', requiredCount);
                    if (requiredCount > 0) {
                        const firstRequired = PROCESSED_COURSES.find(c => c.required);
                        console.log('First required course:', firstRequired);
                        console.log('First required course credits:', firstRequired?.credits);
                    } else {
                        console.warn('No required courses found! Checking raw data...');
                        const rawRequired = courses.filter(c => {
                            const req = c.required;
                            return req === true || req === 'TRUE' || req === 'true' || req === 1 || String(req).toUpperCase() === 'TRUE';
                        });
                        console.log('Raw required courses count:', rawRequired.length);
                        if (rawRequired.length > 0) {
                            console.log('First raw required course:', rawRequired[0]);
                        }
                    }
                }

                renderCourses();

            } catch (e) {
                console.error(e);
                courseListEl.innerHTML = `<div class="text-center text-red-500 py-8">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${e.message}</div>`;
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        function renderCourses() {
            courseListEl.innerHTML = '';

            // Group by Grade-Semester
            const grouped = {};
            PROCESSED_COURSES.forEach(c => {
                // Ensure required property is set
                if (c.required === undefined) {
                    c.required = c.required === true || c.required === 'TRUE' || c.required === 'true' || c.required === 1;
                }

                const key = `${c.grade}-${c.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(c);
            });

            // Sort keys
            const keys = Object.keys(grouped).sort();

            keys.forEach(key => {
                const [g, s] = key.split('-');
                const groupCourses = grouped[key];

                const section = document.createElement('div');
                section.className = 'border rounded-lg p-4 theme-border';
                section.style.backgroundColor = 'var(--hover-bg)';

                section.innerHTML = `
                    <h3 class="font-bold text-lg mb-3 theme-text border-b pb-2 theme-border">${g}í•™ë…„ ${s}í•™ê¸°</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${groupCourses.map(c => `
                            <label class="flex items-start p-3 rounded border cursor-pointer hover:bg-opacity-50 transition-colors ${c.required ? 'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800' : 'bg-white border-gray-200 dark:bg-gray-800 dark:border-gray-700'}">
                                <input type="checkbox" value="${c.id}" 
                                    class="mt-1 mr-3 form-checkbox h-5 w-5 text-blue-600 transition duration-150 ease-in-out"
                                    ${c.required ? 'checked disabled' : ''}
                                    onchange="validateSelections()">
                                <div>
                                    <div class="font-bold theme-text">${c.subjectName}</div>
                                    <div class="text-xs theme-text-muted">${c.category} | ${c.credits}í•™ì </div>
                                    ${c.description ? `<div class="text-xs text-gray-400 mt-1">${c.description}</div>` : ''}
                                </div>
                            </label>
                        `).join('')}
                    </div>
                `;
                courseListEl.appendChild(section);
            });

            // Initial Validation - wait a bit for DOM to be ready
            setTimeout(() => {
                validateSelections();
            }, 100);
        }

        function getSelected() {
            // Include both checked (user selected) and disabled+checked (required) courses
            const checkedIds = Array.from(courseListEl.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            // Also include all required courses from PROCESSED_COURSES
            const requiredCourseIds = PROCESSED_COURSES.filter(c => c.required).map(c => c.id);

            // Combine both sets
            const allSelectedIds = [...new Set([...checkedIds, ...requiredCourseIds])];

            const selected = PROCESSED_COURSES.filter(course => allSelectedIds.includes(course.id));

            // Ensure required property is set correctly
            selected.forEach(course => {
                // Check original data first
                const originalCourse = PROCESSED_COURSES.find(c => c.id === course.id);
                if (originalCourse && originalCourse.required !== undefined) {
                    course.required = originalCourse.required;
                } else {
                    // Then check checkbox state
                    const checkbox = courseListEl.querySelector(`input[type="checkbox"][value="${course.id}"]`);
                    if (checkbox) {
                        course.required = checkbox.disabled && checkbox.checked;
                    } else {
                        course.required = false;
                    }
                }
            });

            return selected;
        }

        function validateSelections() {
            applyLimits();
            renderSelectedCourses(selectedCoursesEl, true);
            renderCategoryStatus();

            const selectedCourses = getSelected(); // Includes required courses

            // Debug: Log selected courses
            console.log('Selected courses:', selectedCourses);
            console.log('Selected courses count:', selectedCourses.length);

            // Separate required (school designated) and optional courses
            const requiredCourses = selectedCourses.filter(c => c.required);
            const optionalCourses = selectedCourses.filter(c => !c.required);

            // Debug: Log required and optional courses
            console.log('Required courses:', requiredCourses);
            console.log('Optional courses:', optionalCourses);

            let totalCredits = 0;
            let requiredCredits = 0; // í•™êµì§€ì •ê³¼ëª© í•™ì 
            let basicCredits = 0;
            let requiredBasicCredits = 0; // í•™êµì§€ì • ê¸°ì´ˆêµê³¼ í•™ì 
            let artCredits = 0;
            let requiredArtCredits = 0; // í•™êµì§€ì • ì˜ˆìˆ êµê³¼ í•™ì 
            let electiveGroupCredits = 0; // êµì–‘/ì œ2ì™¸êµ­ì–´/ì •ë³´
            let requiredElectiveGroupCredits = 0; // í•™êµì§€ì • êµì–‘/ì œ2ì™¸êµ­ì–´/ì •ë³´ í•™ì 

            const countedCourseSlugs = new Set();
            const countedMultiSemesterNames = new Set(); // ë³µìˆ˜í¸ì œê³¼ëª© ì¤‘ë³µ ë°©ì§€ìš©

            // Identify Multi-Semester Courses for duplicate prevention
            const coursesByName = {};
            PROCESSED_COURSES.forEach(c => {
                if (!coursesByName[c.subjectName]) coursesByName[c.subjectName] = [];
                coursesByName[c.subjectName].push(c);
            });

            // 1. Calculate Credits from Required Courses (School Designated)
            requiredCourses.forEach(course => {
                // ë³µìˆ˜í¸ì œê³¼ëª© ì¤‘ë³µ ê³„ì‚° ë°©ì§€
                const isMultiSemester = (multiSemesterRules[course.subjectName] && multiSemesterRules[course.subjectName].length > 0) ||
                    (coursesByName[course.subjectName] && coursesByName[course.subjectName].length > 1);

                if (isMultiSemester && countedMultiSemesterNames.has(course.subjectName)) {
                    return; // ì´ë¯¸ ê³„ì‚°ëœ ë³µìˆ˜í¸ì œê³¼ëª©ì€ ê±´ë„ˆë›°ê¸°
                }

                let shouldCount = !duplicateCourseSlugs.includes(course.slug) || !countedCourseSlugs.has(course.slug);

                if (shouldCount) {
                    if (duplicateCourseSlugs.includes(course.slug)) countedCourseSlugs.add(course.slug);
                    if (isMultiSemester) countedMultiSemesterNames.add(course.subjectName);

                    // Ensure credits is a number
                    let credits = course.credits;
                    if (typeof credits === 'string') {
                        credits = parseFloat(credits.replace(/[^\d.]/g, '')) || 0;
                    }
                    credits = parseInt(credits) || 0;

                    // Debug: Log credit calculation
                    if (credits === 0) {
                        console.warn('Course with 0 credits:', course.subjectName, 'credits field:', course.credits);
                    }

                    requiredCredits += credits;
                    totalCredits += credits;

                    // Category Sums for required courses
                    if (course.category === 'ê¸°ì´ˆêµê³¼') {
                        basicCredits += credits;
                        requiredBasicCredits += credits;
                    }
                    if (course.category === 'ì˜ˆìˆ êµê³¼') {
                        artCredits += credits;
                        requiredArtCredits += credits;
                    }
                    if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(course.category)) {
                        electiveGroupCredits += credits;
                        requiredElectiveGroupCredits += credits;
                    }
                }
            });

            // 2. Calculate Credits from Optional Courses (Student Selected)
            optionalCourses.forEach(course => {
                // ë³µìˆ˜í¸ì œê³¼ëª© ì¤‘ë³µ ê³„ì‚° ë°©ì§€
                const isMultiSemester = (multiSemesterRules[course.subjectName] && multiSemesterRules[course.subjectName].length > 0) ||
                    (coursesByName[course.subjectName] && coursesByName[course.subjectName].length > 1);

                if (isMultiSemester && countedMultiSemesterNames.has(course.subjectName)) {
                    return; // ì´ë¯¸ ê³„ì‚°ëœ ë³µìˆ˜í¸ì œê³¼ëª©ì€ ê±´ë„ˆë›°ê¸°
                }

                let shouldCount = !duplicateCourseSlugs.includes(course.slug) || !countedCourseSlugs.has(course.slug);

                if (shouldCount) {
                    if (duplicateCourseSlugs.includes(course.slug)) countedCourseSlugs.add(course.slug);
                    if (isMultiSemester) countedMultiSemesterNames.add(course.subjectName);

                    // Ensure credits is a number
                    let credits = course.credits;
                    if (typeof credits === 'string') {
                        credits = parseFloat(credits.replace(/[^\d.]/g, '')) || 0;
                    }
                    credits = parseInt(credits) || 0;

                    // Debug: Log credit calculation
                    if (credits === 0) {
                        console.warn('Course with 0 credits:', course.subjectName, 'credits field:', course.credits);
                    }

                    totalCredits += credits;

                    // Category Sums
                    if (course.category === 'ê¸°ì´ˆêµê³¼') basicCredits += credits;
                    if (course.category === 'ì˜ˆìˆ êµê³¼') artCredits += credits;
                    if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(course.category)) electiveGroupCredits += credits;
                }
            });

            // 3. Calculate Credits from Joint Courses
            jointCourses.forEach(course => {
                totalCredits += course.credits;
                const mappedCategory = jointSubCategoryToCategoryMap[course.subCategory] || 'ê¸°íƒ€';

                if (mappedCategory === 'ê¸°ì´ˆêµê³¼') basicCredits += course.credits;
                if (mappedCategory === 'ì˜ˆìˆ êµê³¼') artCredits += course.credits;
                if (mappedCategory === 'êµì–‘êµê³¼') electiveGroupCredits += course.credits;
            });

            // Debug: Log total credits calculation
            console.log('Total credits calculated:', totalCredits);
            console.log('Required credits:', requiredCredits);
            console.log('Optional credits:', totalCredits - requiredCredits);

            totalCreditsEl.textContent = totalCredits;

            // 4. Validation Messages
            let errorMessages = [];
            const validationListEl = document.getElementById('validation-messages');
            validationListEl.innerHTML = ''; // Clear previous messages

            const addMsg = (msg, type = 'error') => {
                const div = document.createElement('div');
                div.className = `p-2 rounded text-sm ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-50 text-red-700 border border-red-200'}`;
                div.innerHTML = msg;
                validationListEl.appendChild(div);
            };

            // Rule 1: Total Credits (174)
            // ì´ ì´ìˆ˜í•™ì  = í•™êµì§€ì •ê³¼ëª© í•™ì  + í•™ìƒì„ íƒê³¼ëª© í•™ì 
            if (totalCredits < 174) {
                addMsg(`ì´ ì´ìˆ˜ í•™ì (174)ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. <span class="font-bold">${174 - totalCredits}í•™ì </span> ë” ì„ íƒí•´ì£¼ì„¸ìš”. (í•™êµì§€ì •: ${requiredCredits}í•™ì , í•™ìƒì„ íƒ: ${totalCredits - requiredCredits}í•™ì )`);
            } else {
                addMsg(`ì´ ì´ìˆ˜ í•™ì (174)ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤. (í•™êµì§€ì •: ${requiredCredits}í•™ì , í•™ìƒì„ íƒ: ${totalCredits - requiredCredits}í•™ì )`, 'success');
            }

            // Rule 2: Basic Subjects (<= 50%)
            if (totalCredits > 0 && basicCredits > (totalCredits * 0.5)) {
                // ... (Logic for identifying removable basic courses) ...
                const optionalBasicCourses = selectedCourses.filter(c => !c.required && c.category === 'ê¸°ì´ˆêµê³¼').map(c => c.subjectName || c.name);
                const jointBasicCourses = jointCourses.filter(c => (jointSubCategoryToCategoryMap[c.subCategory] || 'ê¸°íƒ€') === 'ê¸°ì´ˆêµê³¼').map(c => c.subjectName || c.name);
                const allOptionalBasicCourses = [...new Set([...optionalBasicCourses, ...jointBasicCourses])];

                if (allOptionalBasicCourses.length > 0) {
                    addMsg(`ê¸°ì´ˆêµê³¼ í•™ì ì´ 50%ë¥¼ ë„˜ì§€ ì•Šë„ë¡ ë‹¤ìŒ ê³¼ëª© ì¤‘ ì¼ë¶€ë¥¼ í•´ì œí•´ì£¼ì„¸ìš”:<div class="mt-1 pl-2 space-y-1">${allOptionalBasicCourses.map(name => `<div>- ${name}</div>`).join('')}</div>`);
                } else {
                    addMsg(`ê¸°ì´ˆêµê³¼ í•™ì ì´ 50%ë¥¼ ì´ˆê³¼í–ˆì§€ë§Œ ì¡°ì •í•  ì„ íƒê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.`);
                }
            }

            // Rule 3: Art Subjects (>= 10)
            // ì˜ˆìˆ êµê³¼ í•„ìˆ˜ì´ìˆ˜í•™ì ì—ì„œ ì´ë¯¸ ì„ íƒëœ ê³¼ëª©(í•™êµì§€ì •)ì˜ í•™ì ì„ ì°¨ê°
            const requiredArtCreditsTotal = 10;
            if (artCredits < requiredArtCreditsTotal) {
                const neededCredits = requiredArtCreditsTotal - artCredits;
                addMsg(`ì˜ˆìˆ êµê³¼ ì´ìˆ˜ í•™ì (10)ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. <span class="font-bold">${neededCredits}í•™ì </span> ë” ì„ íƒí•´ì£¼ì„¸ìš”. (í•™êµì§€ì •: ${requiredArtCredits}í•™ì  í¬í•¨)`);
            } else {
                addMsg(`ì˜ˆìˆ êµê³¼ ì´ìˆ˜ í•™ì (10)ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤. (í•™êµì§€ì •: ${requiredArtCredits}í•™ì  í¬í•¨)`, 'success');
            }

            // Rule 4: Elective/Foreign/Info (>= 16)
            // êµì–‘/ì œ2ì™¸êµ­ì–´/ì •ë³´ í•„ìˆ˜ì´ìˆ˜í•™ì ì—ì„œ ì´ë¯¸ ì„ íƒëœ ê³¼ëª©(í•™êµì§€ì •)ì˜ í•™ì ì„ ì°¨ê°
            const requiredElectiveGroupCreditsTotal = 16;
            if (electiveGroupCredits < requiredElectiveGroupCreditsTotal) {
                const neededCredits = requiredElectiveGroupCreditsTotal - electiveGroupCredits;
                // Suggest courses
                const selectedIds = new Set(selectedCourses.map(c => c.id));
                const availableCourses = [...new Set(PROCESSED_COURSES.filter(c => !c.required && !selectedIds.has(c.id) && (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(c.category) || ['êµì–‘', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(c.subCategory))).map(c => c.subjectName || c.name))];

                let suggestionList = '';
                if (availableCourses.length > 0) {
                    suggestionList = `<div class="mt-2 space-y-1 text-left text-xs text-gray-600">ì¶”ì²œ: ${availableCourses.slice(0, 5).join(', ')}...</div>`;
                }
                addMsg(`êµì–‘/ì œ2ì™¸êµ­ì–´/ì •ë³´ í•„ìˆ˜ì´ìˆ˜í•™ì  ì¤‘ <span class="font-bold">${neededCredits}í•™ì </span>ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•™êµì§€ì •: ${requiredElectiveGroupCredits}í•™ì  í¬í•¨)${suggestionList}`);
            } else {
                addMsg(`êµì–‘/ì œ2ì™¸êµ­ì–´/ì •ë³´ í•„ìˆ˜ì´ìˆ˜í•™ì (16)ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤. (í•™êµì§€ì •: ${requiredElectiveGroupCredits}í•™ì  í¬í•¨)`, 'success');
            }

            // Rule 5: Prerequisites
            const selectedCourseSlugs = new Set(selectedCourses.map(c => c.slug || '').filter(s => s));
            selectedCourses.filter(c => !c.required).forEach(course => {
                if (course.prerequisites) {
                    // Handle prerequisites as string (comma-separated) or array
                    let prereqList = [];
                    if (Array.isArray(course.prerequisites)) {
                        prereqList = course.prerequisites;
                    } else if (typeof course.prerequisites === 'string') {
                        prereqList = course.prerequisites.split(',').map(s => s.trim()).filter(s => s);
                    }

                    if (prereqList.length > 0) {
                        const missingPrereqs = new Set();
                        prereqList.forEach(prereqSlug => {
                            if (prereqSlug && !selectedCourseSlugs.has(prereqSlug.trim())) {
                                const prereqCourse = PROCESSED_COURSES.find(c => (c.slug || '').trim() === prereqSlug.trim());
                                if (prereqCourse) {
                                    missingPrereqs.add(prereqCourse.subjectName || prereqCourse.name || prereqSlug);
                                } else {
                                    // If course not found, show the slug itself
                                    missingPrereqs.add(prereqSlug);
                                }
                            }
                        });
                        if (missingPrereqs.size > 0) {
                            addMsg(`'${course.subjectName || course.name}'ì„ ìˆ˜ê°•í•˜ë ¤ë©´ ë‹¤ìŒ ì„ ì´ìˆ˜ ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤: ${Array.from(missingPrereqs).join(', ')}`);
                        }
                    }
                }
            });

            // Rule 6: Selection Rules (Grade-Semester)
            const ruleValidation = validateSelectionRules(selectedCourses);
            if (!ruleValidation.valid) {
                ruleValidation.messages.forEach(msg => addMsg(msg));
            }

            // Update Submit Button State
            updateSubmitButtonState();
        }

        function updateSubmitButtonState() {
            const validationListEl = document.getElementById('validation-messages');
            const messages = validationListEl.querySelectorAll('div');
            let hasErrors = false;

            messages.forEach(msg => {
                if (msg.classList.contains('bg-red-50') || msg.classList.contains('text-red-700')) {
                    hasErrors = true;
                }
            });

            // Check if all required validations pass
            const selectedCourses = getSelected();
            const totalCredits = parseInt(totalCreditsEl.textContent) || 0;

            // Calculate credits for validation
            let artCredits = 0;
            let electiveGroupCredits = 0;
            let basicCredits = 0;
            const countedMultiSemesterNames = new Set();
            const coursesByName = {};
            PROCESSED_COURSES.forEach(c => {
                if (!coursesByName[c.subjectName]) coursesByName[c.subjectName] = [];
                coursesByName[c.subjectName].push(c);
            });

            selectedCourses.forEach(course => {
                const isMultiSemester = (multiSemesterRules[course.subjectName] && multiSemesterRules[course.subjectName].length > 0) ||
                    (coursesByName[course.subjectName] && coursesByName[course.subjectName].length > 1);
                if (isMultiSemester && countedMultiSemesterNames.has(course.subjectName)) {
                    return;
                }
                if (isMultiSemester) countedMultiSemesterNames.add(course.subjectName);

                const credits = parseInt(course.credits || 0);
                if (course.category === 'ì˜ˆìˆ êµê³¼') artCredits += credits;
                if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(course.category)) electiveGroupCredits += credits;
                if (course.category === 'ê¸°ì´ˆêµê³¼') basicCredits += credits;
            });

            const artCreditsValid = artCredits >= 10;
            const electiveCreditsValid = electiveGroupCredits >= 16;
            const totalCreditsValid = totalCredits >= 174;
            const basicCreditsValid = totalCredits === 0 || basicCredits <= (totalCredits * 0.5);

            // Check prerequisites
            const selectedCourseSlugs = new Set(selectedCourses.map(c => c.slug || '').filter(s => s));
            let prerequisitesValid = true;
            selectedCourses.filter(c => !c.required).forEach(course => {
                if (course.prerequisites) {
                    let prereqList = [];
                    if (Array.isArray(course.prerequisites)) {
                        prereqList = course.prerequisites;
                    } else if (typeof course.prerequisites === 'string') {
                        prereqList = course.prerequisites.split(',').map(s => s.trim()).filter(s => s);
                    }
                    prereqList.forEach(prereqSlug => {
                        if (prereqSlug && !selectedCourseSlugs.has(prereqSlug.trim())) {
                            prerequisitesValid = false;
                        }
                    });
                }
            });

            // Check selection rules
            const ruleValidation = validateSelectionRules(selectedCourses);

            // Enable button if all validations pass
            const allValid = !hasErrors && totalCreditsValid && artCreditsValid && electiveCreditsValid &&
                basicCreditsValid && prerequisitesValid && ruleValidation.valid;

            submitBtn.disabled = !allValid;
        }

        function applyLimits() {
            const selected = getSelected();
            const selectedIds = new Set(selected.map(c => c.id));
            const selectedNames = new Set(selected.map(c => c.subjectName));

            // Multi-Semester Logic
            // Group courses by subject name
            const coursesByName = {};
            PROCESSED_COURSES.forEach(c => {
                if (!coursesByName[c.subjectName]) coursesByName[c.subjectName] = [];
                coursesByName[c.subjectName].push(c);
            });

            // Identify Multi-Semester Courses (either by auto-detection or manual rule)
            const multiSemesterGroups = {};
            Object.keys(coursesByName).forEach(name => {
                const group = coursesByName[name];
                const manualRule = multiSemesterRules[name];

                if (manualRule && manualRule.length > 0) {
                    // Use manual rule
                    multiSemesterGroups[name] = group.filter(c => manualRule.includes(`${c.grade}-${c.semester}`));
                } else if (group.length > 1) {
                    // Auto-detect: same name, different semesters
                    multiSemesterGroups[name] = group;
                }
            });

            // Apply Disable Logic
            // Track which courses are disabled by selection rules (í•™ê¸°ë³„ë¡œ ì¶”ì )
            const disabledBySelectionRule = new Map(); // key: courseId, value: semester key

            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                if (!course) return;

                // Reset disabled state first (unless required)
                if (!course.required) {
                    cb.disabled = false;
                    cb.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            // 1. Check Selection Rules (Auto-Disable) - ë¨¼ì € ì‹¤í–‰í•˜ì—¬ ì„ íƒ ê·œì¹™ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ê³¼ëª© ì¶”ì 
            // ì„ íƒ ê·œì¹™ì€ í•™ê¸°ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ì ìš©ë˜ë¯€ë¡œ, ê° í•™ê¸°ì—ì„œ ì‹¤ì œë¡œ ì²´í¬ëœ ê³¼ëª©ë§Œ ì¹´ìš´íŠ¸
            const selectedByGroup = {};
            // ì‹¤ì œë¡œ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ëœ ê³¼ëª©ë§Œ ì¹´ìš´íŠ¸ (getSelectedê°€ ì•„ë‹Œ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì§ì ‘ í™•ì¸)
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                if (!course || course.required) return;
                const key = `${course.grade}-${course.semester}`;
                if (!selectedByGroup[key]) selectedByGroup[key] = [];
                selectedByGroup[key].push(course);
            });

            Object.keys(selectionRules).forEach(key => {
                const rules = selectionRules[key];
                const currentSelected = selectedByGroup[key] || [];

                rules.forEach(rule => {
                    let count = 0;
                    if (rule.credits === 'all') {
                        count = currentSelected.length;
                    } else {
                        count = currentSelected.filter(c => c.credits == rule.credits).length;
                    }

                    if (count >= parseInt(rule.count)) {
                        // Disable all UNCHECKED courses in this group (matching credit criteria if specific)
                        // ë‹¨, ê°™ì€ í•™ê¸°(key)ì— ì†í•œ ê³¼ëª©ë§Œ ë¹„í™œì„±í™”
                        document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb.checked || cb.disabled) return;

                            const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                            if (!course || course.required) return;

                            // ê°™ì€ í•™ê¸°ì— ì†í•œ ê³¼ëª©ë§Œ ë¹„í™œì„±í™”
                            if (`${course.grade}-${course.semester}` === key) {
                                // If rule is specific to credits, only disable those
                                if (rule.credits === 'all' || course.credits == rule.credits) {
                                    cb.disabled = true;
                                    cb.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
                                    disabledBySelectionRule.set(course.id, key); // í•™ê¸° ì •ë³´ë„ í•¨ê»˜ ì €ì¥
                                }
                            }
                        });
                    }
                });
            });

            // 2. Check Multi-Semester Constraint - ì„ íƒ ê·œì¹™ê³¼ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                if (!course || course.required) return;

                if (multiSemesterGroups[course.subjectName]) {
                    const group = multiSemesterGroups[course.subjectName];
                    const currentSemesterKey = `${course.grade}-${course.semester}`;

                    // Is any OTHER course in this group actually selected (checked)?
                    // ì‹¤ì œë¡œ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ì„ íƒ ê·œì¹™ê³¼ ë¬´ê´€)
                    const otherSelected = group.some(c => {
                        if (c.id === course.id) return false;
                        const otherCb = document.querySelector(`input[type="checkbox"][value="${c.id}"]`);
                        return otherCb && otherCb.checked;
                    });

                    if (otherSelected && !cb.checked) {
                        // Disable if another course in the group is actually selected
                        // ì„ íƒ ê·œì¹™ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ê²½ìš°ì—ë„ ë³µìˆ˜í¸ì œ ë¡œì§ì€ ì ìš©
                        // ë‹¨, ì„ íƒ ê·œì¹™ìœ¼ë¡œ ì´ë¯¸ ë¹„í™œì„±í™”ëœ ê²½ìš°ëŠ” ë³µìˆ˜í¸ì œ ë¹„í™œì„±í™”ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                        const isDisabledByRule = disabledBySelectionRule.has(course.id);
                        const ruleSemester = disabledBySelectionRule.get(course.id);

                        // ì„ íƒ ê·œì¹™ìœ¼ë¡œ ë¹„í™œì„±í™”ë˜ì—ˆì§€ë§Œ, ë‹¤ë¥¸ í•™ê¸°ì—ì„œ ë¹„í™œì„±í™”ëœ ê²½ìš°ëŠ” ë³µìˆ˜í¸ì œ ë¡œì§ ì ìš©
                        if (!isDisabledByRule || ruleSemester !== currentSemesterKey) {
                            cb.disabled = true;
                            cb.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    } else if (!otherSelected) {
                        // Re-enable if no other course in group is actually selected (handles unchecking)
                        // ë‹¨, ì„ íƒ ê·œì¹™ìœ¼ë¡œ ë¹„í™œì„±í™”ëœ ê²½ìš°ëŠ” ì œì™¸ (ê°™ì€ í•™ê¸°ì—ì„œë§Œ)
                        const isDisabledByRule = disabledBySelectionRule.has(course.id);
                        const ruleSemester = disabledBySelectionRule.get(course.id);

                        // ì„ íƒ ê·œì¹™ìœ¼ë¡œ ë¹„í™œì„±í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜, ë‹¤ë¥¸ í•™ê¸°ì—ì„œ ë¹„í™œì„±í™”ëœ ê²½ìš°ëŠ” í™œì„±í™”
                        if (!isDisabledByRule || ruleSemester !== currentSemesterKey) {
                            cb.disabled = false;
                            cb.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }
                }
            });

        }

        function renderSelectedCourses(el, isUpdate) {
            const selected = [...getSelected(), ...jointCourses];
            renderSelectedList(selected);
        }

        function renderCategoryStatus() {
            // Placeholder for category status update if needed
        }

        function renderSelectedList(courses) {
            // Filter out duplicate multi-semester courses - only keep the first selected one
            const processedCourseNames = new Set();
            const filteredCourses = [];

            // Identify multi-semester courses
            const coursesByName = {};
            PROCESSED_COURSES.forEach(c => {
                if (!coursesByName[c.subjectName]) coursesByName[c.subjectName] = [];
                coursesByName[c.subjectName].push(c);
            });

            courses.forEach(c => {
                // Check if this is a multi-semester course
                const isMultiSemester = (multiSemesterRules[c.subjectName] && multiSemesterRules[c.subjectName].length > 0) ||
                    (coursesByName[c.subjectName] && coursesByName[c.subjectName].length > 1);

                if (isMultiSemester) {
                    // If already processed this course name, skip
                    if (processedCourseNames.has(c.subjectName)) {
                        return;
                    }
                    processedCourseNames.add(c.subjectName);
                }
                filteredCourses.push(c);
            });

            // 1. Group by Category (ê¸°ì´ˆ/ì‚¬íšŒ ë° ê³¼í•™/ì˜ˆìˆ /ì²´ìœ¡/êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´)
            const categoryGroups = {
                'ê¸°ì´ˆêµê³¼': [],
                'ì‚¬íšŒ ë° ê³¼í•™': [], // íƒêµ¬êµê³¼
                'ì˜ˆìˆ êµê³¼': [],
                'ì²´ìœ¡êµê³¼': [],
                'êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´': []
            };

            // 2. Group by Grade-Semester
            const semesterGroups = {};

            // Track which multi-semester courses have been added to semester groups
            const addedToSemesterGroups = new Set();

            filteredCourses.forEach(c => {
                // Ensure required property is set for display
                if (c.required === undefined) {
                    // Check if this is a required course by looking at the checkbox
                    const checkbox = courseListEl?.querySelector(`input[type="checkbox"][value="${c.id}"]`);
                    if (checkbox && checkbox.disabled && checkbox.checked) {
                        c.required = true;
                    } else {
                        c.required = false;
                    }
                }

                // Check if this is a multi-semester course
                const isMultiSemester = (multiSemesterRules[c.subjectName] && multiSemesterRules[c.subjectName].length > 0) ||
                    (coursesByName[c.subjectName] && coursesByName[c.subjectName].length > 1);

                // Category Grouping
                let cat = c.category;
                if (c.subCategory && jointSubCategoryToCategoryMap[c.subCategory]) {
                    cat = jointSubCategoryToCategoryMap[c.subCategory];
                }

                if (cat === 'ê¸°ì´ˆêµê³¼') {
                    categoryGroups['ê¸°ì´ˆêµê³¼'].push(c);
                } else if (cat === 'íƒêµ¬êµê³¼') {
                    categoryGroups['ì‚¬íšŒ ë° ê³¼í•™'].push(c);
                } else if (cat === 'ì˜ˆìˆ êµê³¼') {
                    categoryGroups['ì˜ˆìˆ êµê³¼'].push(c);
                } else if (cat === 'ì²´ìœ¡êµê³¼') {
                    categoryGroups['ì²´ìœ¡êµê³¼'].push(c);
                } else if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(cat)) {
                    categoryGroups['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'].push(c);
                }

                // Semester Grouping - ë³µìˆ˜í¸ì œê³¼ëª©ì€ ì„ íƒëœ í•™ê¸°ì—ë§Œ í‘œì‹œ
                const isJointCourse = c.id && typeof c.id === 'string' && c.id.startsWith('joint');
                if (isJointCourse) {
                    const key = `ê³µë™-${c.category}`;
                    if (!semesterGroups[key]) semesterGroups[key] = [];
                    semesterGroups[key].push(c);
                } else {
                    // ë³µìˆ˜í¸ì œê³¼ëª©ì¸ ê²½ìš°, ì´ë¯¸ ë‹¤ë¥¸ í•™ê¸°ì— ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (isMultiSemester && addedToSemesterGroups.has(c.subjectName)) {
                        // ì´ë¯¸ ì¶”ê°€ë˜ì—ˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                        return;
                    }

                    const key = `${c.grade || '?'}-${c.semester || '?'}`;
                    if (!semesterGroups[key]) semesterGroups[key] = [];
                    semesterGroups[key].push(c);

                    if (isMultiSemester) {
                        addedToSemesterGroups.add(c.subjectName);
                    }
                }
            });

            let html = '';

            // Render Category View
            html += `<h4 class="font-bold text-sm text-gray-700 dark:text-gray-300 mb-2 mt-4 border-b pb-1">êµê³¼ë³„ ì„ íƒí•œ ê³¼ëª© ëª©ë¡</h4>`;
            Object.keys(categoryGroups).forEach(cat => {
                if (categoryGroups[cat].length === 0) return;
                const categoryCredits = categoryGroups[cat].reduce((sum, c) => sum + parseInt(c.credits || 0), 0);
                html += `
                    <div class="mb-2">
                        <div class="text-xs font-bold text-gray-500 mb-1">${cat} (${categoryCredits}í•™ì )</div>
                        <div class="flex flex-wrap gap-1">
                            ${categoryGroups[cat].map(c => {
                    const colors = [
                        'text-pink-500 dark:text-pink-400',
                        'text-purple-500 dark:text-purple-400',
                        'text-indigo-500 dark:text-indigo-400',
                        'text-blue-500 dark:text-blue-400',
                        'text-teal-500 dark:text-teal-400',
                        'text-emerald-500 dark:text-emerald-400',
                        'text-orange-500 dark:text-orange-400',
                        'text-rose-500 dark:text-rose-400'
                    ];
                    const hash = (c.subjectName || c.name || '').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const colorClass = colors[hash % colors.length];
                    return `<span class="text-xs font-medium ${colorClass} hover:opacity-80 transition-opacity cursor-default" data-required="${c.required}">${c.subjectName || c.name}</span>`;
                }).join('')}
                        </div>
                    </div>
                `;
            });

            // Render Semester View
            html += `<h4 class="font-bold text-sm text-gray-700 dark:text-gray-300 mb-2 mt-6 border-b pb-1">í•™ë…„-í•™ê¸°ë³„ ì„ íƒ ê³¼ëª© ëª©ë¡</h4>`;
            Object.keys(semesterGroups).sort().forEach(k => {
                const [g, s] = k.replace('ê³µë™-', '').split('-');
                const isJoint = k.startsWith('ê³µë™');
                const title = isJoint ? `ê³µë™êµìœ¡ê³¼ì • (${g}-${s})` : `${g}í•™ë…„ ${s}í•™ê¸°`;

                // Calculate credits for this semester
                const semCredits = semesterGroups[k].reduce((sum, c) => sum + parseInt(c.credits || 0), 0);

                html += `
                    <div class="border-b pb-2 last:border-0 theme-border">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="font-bold text-xs text-gray-500">${title}</h4>
                            <span class="text-xs font-bold text-blue-600">(${semCredits}í•™ì )</span>
                        </div>
                        <div class="flex flex-wrap gap-1">
                            ${semesterGroups[k].map(c => {
                    // Use lighter/brighter colors for dark mode visibility
                    const colors = [
                        'text-pink-500 dark:text-pink-400',
                        'text-purple-500 dark:text-purple-400',
                        'text-indigo-500 dark:text-indigo-400',
                        'text-blue-500 dark:text-blue-400',
                        'text-teal-500 dark:text-teal-400',
                        'text-emerald-500 dark:text-emerald-400',
                        'text-orange-500 dark:text-orange-400',
                        'text-rose-500 dark:text-rose-400'
                    ];
                    const hash = (c.subjectName || '').split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const colorClass = colors[hash % colors.length];
                    return `<span class="text-sm font-medium ${colorClass} hover:opacity-80 transition-opacity cursor-default" data-required="${c.required}">${c.subjectName}</span>`;
                }).join('')}
                        </div>
                    </div>
                `;
            });

            selectedCoursesEl.innerHTML = html;

            // Apply toggle filter
            applyCourseToggle();

            // Update Final Modal Content - í•™ë…„-í•™ê¸°ë³„ ì¹´ë“œ ì„¹ì…˜
            let finalHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="final-selection-cards">';
            Object.keys(semesterGroups).sort().forEach(k => {
                const [g, s] = k.replace('ê³µë™-', '').split('-');
                const isJoint = k.startsWith('ê³µë™');
                const title = isJoint ? `ê³µë™êµìœ¡ê³¼ì • (${g}-${s})` : `${g}í•™ë…„ ${s}í•™ê¸°`;
                const semCredits = semesterGroups[k].reduce((sum, c) => sum + parseInt(c.credits || 0), 0);
                const requiredCount = semesterGroups[k].filter(c => c.required).length;
                const optionalCount = semesterGroups[k].filter(c => !c.required).length;

                finalHtml += `
                    <div class="border-2 border-blue-200 rounded-lg p-4 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-900 shadow-md">
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-blue-200">
                            <h4 class="font-bold text-lg text-blue-700 dark:text-blue-400">${title}</h4>
                            <span class="text-sm font-semibold text-blue-600 dark:text-blue-300">${semCredits}í•™ì </span>
                        </div>
                        <div class="space-y-2">
                            ${requiredCount > 0 ? `
                                <div class="mb-2">
                                    <div class="text-xs font-semibold text-red-600 dark:text-red-400 mb-1">í•™êµì§€ì • ê³¼ëª© (${requiredCount}ê°œ)</div>
                                    <div class="flex flex-wrap gap-1">
                                        ${semesterGroups[k].filter(c => c.required).map(c =>
                    `<span class="text-xs px-2 py-1 rounded bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300">${c.subjectName || c.name} (${c.credits}í•™ì )</span>`
                ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${optionalCount > 0 ? `
                                <div>
                                    <div class="text-xs font-semibold text-green-600 dark:text-green-400 mb-1">í•™ìƒì„ íƒ ê³¼ëª© (${optionalCount}ê°œ)</div>
                                    <div class="flex flex-wrap gap-1">
                                        ${semesterGroups[k].filter(c => !c.required).map(c =>
                    `<span class="text-xs px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">${c.subjectName || c.name} (${c.credits}í•™ì )</span>`
                ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            finalHtml += '</div>';
            finalSelectionEl.innerHTML = finalHtml;
        }

        function validateSelectionRules(selected) {
            const messages = [];
            let allValid = true;

            // Group selected by Grade-Semester (ì„ íƒê³¼ëª©ë§Œ ì¹´ìš´íŠ¸, í•™êµì§€ì •ê³¼ëª© ì œì™¸)
            // ì‹¤ì œë¡œ ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ëœ ê³¼ëª©ë§Œ ì¹´ìš´íŠ¸í•˜ì—¬ í•™ê¸°ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ê²€ì¦
            const grouped = {};
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì§ì ‘ í™•ì¸í•˜ì—¬ í•™ê¸°ë³„ë¡œ ë…ë¦½ì ìœ¼ë¡œ ì¹´ìš´íŠ¸
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                if (!course || course.required) return;
                const key = `${course.grade}-${course.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(course);
            });

            // Check each rule
            Object.keys(selectionRules).forEach(key => {
                const rules = selectionRules[key];
                const semesterCourses = grouped[key] || []; // í•´ë‹¹ í•™ê¸°ì—ì„œ ì‹¤ì œë¡œ ì²´í¬ëœ ì„ íƒê³¼ëª©ë§Œ í¬í•¨

                rules.forEach(rule => {
                    let count = 0;
                    if (rule.credits === 'all') {
                        count = semesterCourses.length;
                    } else {
                        count = semesterCourses.filter(c => c.credits == rule.credits).length;
                    }

                    if (count !== parseInt(rule.count)) {
                        allValid = false;
                        const [g, s] = key.split('-');
                        const creditText = rule.credits === 'all' ? 'ëª¨ë“ ' : `${rule.credits}í•™ì `;
                        messages.push(`${g}í•™ë…„ ${s}í•™ê¸°: ${creditText} ì„ íƒê³¼ëª©ì„ ${rule.count}ê°œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${count}ê°œ)`);
                    }
                });
            });

            return { valid: allValid, messages };
        }

        // Joint Courses
        function initJointCourses() {
            addJointBtn.addEventListener('click', () => {
                const name = jointNameEl.value.trim();
                const credits = parseInt(jointCreditsEl.value);
                const category = jointCategoryEl.value;

                if (!name) return alert('ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                jointCourses.push({
                    id: 'joint-' + Date.now(),
                    subjectName: name,
                    credits: credits,
                    category: category,
                    grade: category.split('-')[0],
                    semester: category.split('-')[1],
                    required: false
                });

                jointNameEl.value = '';
                renderJointCourses();
                validateSelections();
            });
        }

        function renderJointCourses() {
            jointCoursesEl.innerHTML = jointCourses.map((c, idx) => `
                <li class="flex justify-between items-center bg-gray-50 p-2 rounded theme-card theme-text">
                    <span>${c.subjectName} (${c.credits}í•™ì , ${c.category})</span>
                    <button onclick="removeJointCourse(${idx})" class="text-red-500 hover:text-red-700">Ã—</button>
                </li>
            `).join('');
        }

        window.removeJointCourse = (idx) => {
            jointCourses.splice(idx, 1);
            renderJointCourses();
            validateSelections();
        };

        // Submit Logic
        submitBtn.addEventListener('click', () => {
            submitModalEl.classList.remove('hidden');
        });

        cancelBtn.addEventListener('click', () => {
            submitModalEl.classList.add('hidden');
        });

        confirmBtn.addEventListener('click', async () => {
            if (!confirm('ì •ë§ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const selected = [...getSelected(), ...jointCourses];
            const courseNames = selected.map(c => c.subjectName).join(', ');

            const data = {
                Grade: gradeEl.value,
                Class: classNumEl.value,
                Number: studentNumEl.value,
                Name: studentNameEl.value,
                Major: majorInput.value,
                SelectedCourses: courseNames,
                TotalCredits: totalCreditsEl.textContent,
                Timestamp: new Date().toISOString()
            };

            try {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'ì œì¶œ ì¤‘...';

                await DB.submitResponse(data);

                alert('ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
                submitModalEl.classList.add('hidden');
                // Reset or Redirect?
            } catch (e) {
                alert('ì œì¶œ ì‹¤íŒ¨: ' + e.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ì œì¶œí•˜ê¸°';
            }
        });

        // Save Image
        saveImgBtn.addEventListener('click', () => {
            const cardsContainer = document.getElementById('final-selection-cards');
            if (!cardsContainer) {
                alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            html2canvas(cardsContainer, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                const studentInfo = `${gradeEl.value || ''}í•™ë…„ ${classNumEl.value || ''}ë°˜ ${studentNumEl.value || ''}ë²ˆ ${studentNameEl.value || ''}`;
                link.download = `ìˆ˜ê°•ì‹ ì²­_ë‚´ì—­_${studentInfo.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', err);
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });

        // AI Recommendation
        function getAiRecommendation() {
            const major = majorInput.value.trim();
            if (!major) return alert('í¬ë§ ì§„ë¡œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            getAiRecs(major);
        }

        async function getAiRecs(major) {
            helperMsgEl.classList.add('hidden');
            aiLoader.classList.remove('hidden');

            const availableCourses = PROCESSED_COURSES.filter(c => !c.required).map(c => c.subjectName).join(', ');

            try {
                const response = await fetch('/.netlify/functions/ai-recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ major, availableCourses })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : 'API ìš”ì²­ ì‹¤íŒ¨');
                }

                const result = await response.json();
                if (result.choices && result.choices.length > 0) {
                    const recommendationText = result.choices[0].message.content;
                    showHelperMsg(`<strong>[${major}] ë§ì¶¤ ê³¼ëª© ì¶”ì²œ:</strong><br><br>${recommendationText.replace(/\n/g, '<br>')}`, 'info');
                } else {
                    throw new Error("APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('AI ì¶”ì²œ ê¸°ëŠ¥ ì˜¤ë¥˜:', error);
                showHelperMsg(`AI ì¶”ì²œ ê¸°ëŠ¥ ì˜¤ë¥˜: ${error.message}<br><br>Netlify í™˜ê²½ë³€ìˆ˜(OPENAI_API_KEY)ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
            } finally {
                aiLoader.classList.add('hidden');
                helperMsgEl.classList.remove('hidden');
            }
        }

        function showHelperMsg(msg, type = 'info') {
            const color = type === 'error' ? 'text-red-500' : 'text-gray-700 dark:text-gray-300';
            helperMsgEl.innerHTML = `<div class="${color}">${msg}</div>`;
        }

        // Floating Theme Selector
        function toggleThemeMenu() {
            document.getElementById('theme-menu').classList.toggle('hidden');
        }

        function changeTheme(themeName) {
            applyTheme(themeName);
            localStorage.setItem('theme', themeName);
            document.getElementById('theme-menu').classList.add('hidden');
        }

        // Course Toggle Functions
        let showRequired = true;
        let showOptional = true;

        function applyCourseToggle() {
            const allCourseSpans = selectedCoursesEl.querySelectorAll('[data-required]');
            allCourseSpans.forEach(span => {
                const isRequired = span.getAttribute('data-required') === 'true';
                if (isRequired && !showRequired) {
                    span.style.display = 'none';
                } else if (!isRequired && !showOptional) {
                    span.style.display = 'none';
                } else {
                    span.style.display = '';
                }
            });

            // Update button states
            const requiredBtn = document.getElementById('toggle-required-btn');
            const optionalBtn = document.getElementById('toggle-optional-btn');
            if (requiredBtn) {
                requiredBtn.className = showRequired
                    ? 'px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors'
                    : 'px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors';
            }
            if (optionalBtn) {
                optionalBtn.className = showOptional
                    ? 'px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 transition-colors'
                    : 'px-2 py-1 rounded bg-gray-100 text-gray-700 hover:bg-gray-200 transition-colors';
            }
        }

        // Initialize Theme
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            // Setup toggle buttons
            const requiredBtn = document.getElementById('toggle-required-btn');
            const optionalBtn = document.getElementById('toggle-optional-btn');
            if (requiredBtn) {
                requiredBtn.addEventListener('click', () => {
                    showRequired = !showRequired;
                    applyCourseToggle();
                });
            }
            if (optionalBtn) {
                optionalBtn.addEventListener('click', () => {
                    showOptional = !showOptional;
                    applyCourseToggle();
                });
            }

            init();
        });
    </script>

    <!-- Floating Theme Selector UI -->
    <div class="fixed bottom-6 left-6 z-50 group">
        <div id="theme-menu"
            class="absolute bottom-full left-0 mb-2 hidden bg-white rounded-lg shadow-xl border p-2 min-w-[150px] transition-all transform origin-bottom-left">
            <div class="text-xs font-bold text-gray-400 mb-2 px-2">í…Œë§ˆ ì„ íƒ</div>
            <button onclick="changeTheme('light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>â˜€ï¸</span>ë¼ì´íŠ¸
                ëª¨ë“œ</button>
            <button onclick="changeTheme('dark-neon')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ™</span>ë‹¤í¬
                ë„¤ì˜¨</button>
            <button onclick="changeTheme('tokyo-night')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒƒ</span>ë„ì¿„
                ë‚˜ì´íŠ¸</button>
            <button onclick="changeTheme('solarized-light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ…</span>ì†”ë¼ë¼ì´ì¦ˆë“œ</button>
        </div>
        <button onclick="toggleThemeMenu()"
            class="bg-white p-3 rounded-full shadow-lg border-2 border-purple-100 hover:border-purple-300 hover:shadow-xl transition-all flex items-center justify-center w-12 h-12">
            <span class="text-2xl">ğŸ¨</span>
        </button>
    </div>
</body>

</html>
