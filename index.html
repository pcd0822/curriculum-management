<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°œì¸ë³„ êµìœ¡ê³¼ì • ì„¤ê³„í‘œ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Custom Modules -->
    <script src="js/theme.js"></script>
    <script src="js/db.js"></script>
    <script src="js/validation.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .speech-bubble {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: .4em;
            padding: 1.5rem;
            width: 100%;
        }

        .speech-bubble.error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .speech-bubble.success {
            background-color: #d1fae5;
            color: #065f46;
        }

        input[type="checkbox"]:disabled+label {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 24px;
            height: 24px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .animated-gradient {
            background: linear-gradient(-45deg, var(--primary-color), var(--secondary-color), #a855f7, #ec4899);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }

        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Theme variables are handled by js/theme.js */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        input,
        select {
            background-color: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        input:focus,
        select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
        }

        /* Custom scrollbar for dark mode */
        .dark ::-webkit-scrollbar {
            width: 8px;
        }

        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
            /* dark gray */
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
            /* darker gray */
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #718096;
            /* even darker gray */
        }

        /* Custom scrollbar for helper section */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }

        .truncate-lines-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Course Selection -->
        <div class="lg:col-span-2 space-y-8">
            <header class="mb-8">
                <h1 class="text-4xl font-bold mb-2 bg-clip-text text-transparent animated-gradient">
                    ê°œì¸ë³„ êµìœ¡ê³¼ì • ì„¤ê³„í‘œ
                </h1>
                <p class="text-gray-500 dark:text-gray-400">ìì‹ ì˜ ì§„ë¡œì— ë§ì¶° ê³¼ëª©ì„ ì„ íƒí•˜ê³  ì„¤ê³„í•´ë³´ì„¸ìš”.</p>
            </header>

            <!-- Student Info -->
            <section class="card p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“</span> í•™ìƒ ì •ë³´
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">í•™ë…„</label>
                        <select id="student-grade" class="w-full p-2 rounded border"
                            style="background-color: var(--input-bg);">
                            <option value="1">1í•™ë…„</option>
                            <option value="2">2í•™ë…„</option>
                            <option value="3">3í•™ë…„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ë°˜</label>
                        <input type="number" id="student-class" class="w-full p-2 rounded border" placeholder="ë°˜"
                            style="background-color: var(--input-bg);">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ë²ˆí˜¸</label>
                        <input type="number" id="student-number" class="w-full p-2 rounded border" placeholder="ë²ˆí˜¸"
                            style="background-color: var(--input-bg);">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ì´ë¦„</label>
                        <input type="text" id="student-name" class="w-full p-2 rounded border" placeholder="ì´ë¦„"
                            autocomplete="off" style="background-color: var(--input-bg);">
                    </div>
                    <div class="col-span-2 md:col-span-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">í¬ë§ ì§„ë¡œ</label>
                        <input type="text" id="student-major" class="w-full p-2 rounded border"
                            placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™ì, ê²½ì˜ ì»¨ì„¤í„´íŠ¸ (AI ì¶”ì²œì„ ìœ„í•´ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”)"
                            style="background-color: var(--input-bg);">
                    </div>
                </div>
            </section>

            <!-- Course Selection Area -->
            <section class="card p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <span class="text-2xl">ğŸ“š</span> ê³¼ëª© ì„ íƒ
                    </h2>
                    <div class="text-sm text-gray-500">
                        * í•„ìˆ˜ ê³¼ëª©ì€ ìë™ ì„ íƒë©ë‹ˆë‹¤.
                    </div>
                </div>

                <div id="course-list-container" class="space-y-8">
                    <div class="text-center py-12 text-gray-500">
                        <div class="loader mx-auto mb-4"></div>
                        ê³¼ëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            </section>
        </div>

        <!-- Right Column: Helper & Summary -->
        <div class="space-y-6">

            <!-- Sticky Helper Section -->
            <div class="sticky top-6 space-y-6">

                <!-- Helper Message & Validation -->
                <section class="card p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                    <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                        <span class="text-xl">ğŸ¤–</span> AI ë„ìš°ë¯¸ & ê²€ì¦
                    </h3>

                    <div class="speech-bubble relative min-h-[100px] max-h-[300px] overflow-y-auto custom-scrollbar">
                        <div id="ai-loader"
                            class="hidden absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 z-10">
                            <div class="loader"></div>
                        </div>
                        <div id="helper-msg" class="text-sm leading-relaxed">
                            ì•ˆë…•í•˜ì„¸ìš”! í¬ë§ ì§„ë¡œë¥¼ ì…ë ¥í•˜ë©´ ê³¼ëª©ì„ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”.<br>
                            ê³¼ëª©ì„ ì„ íƒí•˜ë©´ ê·œì¹™ì„ ì˜ ì§€í‚¤ê³  ìˆëŠ”ì§€ ì•Œë ¤ë“œë¦´ê²Œìš”!
                        </div>
                        <div id="validation-messages" class="mt-4 space-y-2 border-t pt-4">
                            <!-- Validation messages will appear here -->
                        </div>
                    </div>
                </section>

                <!-- Selected Courses Summary -->
                <section class="card p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="font-bold text-lg">ì„ íƒí•œ ê³¼ëª©</h3>
                        <span class="text-sm font-bold text-purple-600">ì´ <span id="total-credits">0</span>í•™ì </span>
                    </div>

                    <div id="selected-courses-list"
                        class="space-y-2 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                        <div class="text-gray-400 text-sm text-center py-4">ì„ íƒëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>

                    <!-- Subject Category Summary -->
                    <div class="mt-6 pt-4 border-t">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">êµê³¼ë³„ ì´ìˆ˜ í˜„í™©</h4>
                        <div id="category-summary-content" class="text-sm space-y-1">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </section>

                <!-- Joint Curriculum -->
                <section class="card p-6 rounded-xl shadow-md">
                    <h3 class="font-bold text-lg mb-3">ê³µë™êµìœ¡ê³¼ì • ì¶”ê°€</h3>
                    <div class="flex flex-col gap-2 mb-3">
                        <input type="text" id="joint-course-name" placeholder="ê³¼ëª©ëª…" class="p-2 border rounded text-sm">
                        <div class="flex gap-2">
                            <input type="number" id="joint-course-credits" placeholder="í•™ì "
                                class="p-2 border rounded text-sm w-20">
                            <select id="joint-course-category" class="p-2 border rounded text-sm flex-1">
                                <!-- Categories populated by JS -->
                            </select>
                            <button id="add-joint-btn"
                                class="bg-purple-600 text-white px-3 py-2 rounded text-sm hover:bg-purple-700">+</button>
                        </div>
                    </div>
                    <ul id="joint-course-list" class="space-y-2 text-sm">
                        <!-- List -->
                    </ul>
                </section>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="save-img-btn"
                        class="bg-gray-800 text-white py-3 rounded-xl hover:bg-gray-900 transition shadow-lg flex items-center justify-center gap-2">
                        <span>ğŸ“¸</span> ì´ë¯¸ì§€ ì €ì¥
                    </button>
                    <button id="submit-btn"
                        class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-xl hover:opacity-90 transition shadow-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        ì œì¶œí•˜ê¸°
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div id="submit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-lg w-full m-4">
            <h3 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">ì œì¶œ í™•ì¸</h3>
            <p class="mb-6 text-gray-600 dark:text-gray-300">ì„ íƒí•œ ê³¼ëª©ìœ¼ë¡œ êµìœ¡ê³¼ì • ì„¤ê³„í‘œë¥¼ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>

            <div id="final-selection-preview"
                class="mb-6 max-h-60 overflow-y-auto bg-gray-50 dark:bg-gray-700 p-4 rounded border">
                <!-- Preview content -->
            </div>

            <div class="flex justify-end gap-3">
                <button id="cancel-submit-btn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">ì·¨ì†Œ</button>
                <button id="confirm-submit-btn"
                    class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">ì œì¶œ</button>
            </div>
        </div>
    </div>

    <!-- Floating Theme Selector -->
    <div class="fixed bottom-6 left-6 z-50 group">
        <div id="theme-menu"
            class="absolute bottom-full left-0 mb-2 hidden bg-white rounded-lg shadow-xl border p-2 min-w-[150px] transition-all transform origin-bottom-left">
            <div class="text-xs font-bold text-gray-400 mb-2 px-2">í…Œë§ˆ ì„ íƒ</div>
            <button onclick="changeTheme('light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>â˜€ï¸</span>ë¼ì´íŠ¸
                ëª¨ë“œ</button>
            <button onclick="changeTheme('dark-neon')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ™</span>ë‹¤í¬
                ë„¤ì˜¨</button>
            <button onclick="changeTheme('tokyo-night')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒƒ</span>ë„ì¿„
                ë‚˜ì´íŠ¸</button>
            <button onclick="changeTheme('solarized-light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ…</span>ì†”ë¼ë¼ì´ì¦ˆë“œ</button>
        </div>
        <button onclick="toggleThemeMenu()"
            class="bg-white p-3 rounded-full shadow-lg border-2 border-purple-100 hover:border-purple-300 hover:shadow-xl transition-all flex items-center justify-center w-12 h-12">
            <span class="text-2xl">ğŸ¨</span>
        </button>
    </div>

    <script>
        // Global Variables
        let PROCESSED_COURSES = [];
        let jointCourses = [];
        let selectionRules = {};

        // Elements
        const courseListEl = document.getElementById('course-list-container');
        const selectedCoursesEl = document.getElementById('selected-courses-list');
        const totalCreditsEl = document.getElementById('total-credits');
        const validationMessagesEl = document.getElementById('validation-messages');
        const helperMsgEl = document.getElementById('helper-msg');
        const aiLoader = document.getElementById('ai-loader');

        const gradeEl = document.getElementById('student-grade');
        const classNumEl = document.getElementById('student-class');
        const studentNumEl = document.getElementById('student-number');
        const studentNameEl = document.getElementById('student-name');
        const majorInput = document.getElementById('student-major');

        const jointNameEl = document.getElementById('joint-course-name');
        const jointCreditsEl = document.getElementById('joint-course-credits');
        const jointCategoryEl = document.getElementById('joint-course-category');
        const addJointBtn = document.getElementById('add-joint-btn');
        const jointCoursesEl = document.getElementById('joint-course-list');

        const saveImgBtn = document.getElementById('save-img-btn');
        const submitBtn = document.getElementById('submit-btn');
        const submitModalEl = document.getElementById('submit-modal');
        const cancelBtn = document.getElementById('cancel-submit-btn');
        const confirmBtn = document.getElementById('confirm-submit-btn');
        const finalSelectionEl = document.getElementById('final-selection-preview');

        // Initialization
        async function init() {
            // Check for API Key in URL
            const urlParams = new URLSearchParams(window.location.search);
            const key = urlParams.get('key');

            if (key) {
                try {
                    const decodedUrl = atob(key);
                    DB.init(decodedUrl);
                    await loadData();
                } catch (e) {
                    console.error('Invalid Key', e);
                    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì ‘ê·¼ í‚¤ì…ë‹ˆë‹¤.');
                }
            } else {
                console.warn('No API Key provided');
            }

            initJointCourses();
        }

        async function loadData() {
            const loader = document.querySelector('.loader');
            if (loader) loader.classList.remove('hidden');

            try {
                // Fetch Settings (Rules)
                const settings = await DB.fetchSettings();
                if (settings && settings.selectionRules) {
                    selectionRules = settings.selectionRules;
                } else if (settings && settings.selectionLimits) {
                    // Migration for old format
                    Object.keys(settings.selectionLimits).forEach(key => {
                        selectionRules[key] = [{ credits: 'all', count: settings.selectionLimits[key].maxCount }];
                    });
                }

                // Fetch Courses
                const courses = await DB.fetchConfig();
                if (!courses) throw new Error('ê³¼ëª© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

                PROCESSED_COURSES = courses.filter(c => c.subjectName);
                renderCourses();

            } catch (e) {
                console.error(e);
                courseListEl.innerHTML = `<div class="text-center text-red-500 py-8">ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${e.message}</div>`;
            } finally {
                if (loader) loader.classList.add('hidden');
            }
        }

        function renderCourses() {
            // Group by Grade-Semester
            const grouped = {};
            PROCESSED_COURSES.forEach(c => {
                const key = `${c.grade}-${c.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(c);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(key => {
                const [g, s] = key.split('-');
                const courses = grouped[key];

                // Get rules for this semester
                const rules = selectionRules[key] || [];
                let ruleText = '';
                if (rules.length > 0) {
                    ruleText = rules.map(r => {
                        if (r.credits === 'all') return `ì´ ${r.count}ê³¼ëª©`;
                        return `${r.credits}í•™ì  ${r.count}ê°œ`;
                    }).join(', ');
                }

                html += `
                    <div class="border-b pb-6 last:border-b-0">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200">${g}í•™ë…„ ${s}í•™ê¸°</h3>
                            ${ruleText ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">ì„ íƒ ê¸°ì¤€: ${ruleText}</span>` : ''}
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${courses.map(c => `
                                <div class="flex items-center p-3 rounded border hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${c.required ? 'bg-gray-100 dark:bg-gray-800 opacity-75' : 'bg-white dark:bg-gray-800'}">
                                    <input type="checkbox" 
                                        id="course-${c.id}" 
                                        value="${c.id}" 
                                        class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500"
                                        ${c.required ? 'checked disabled' : ''}
                                        onchange="validateSelections()">
                                    <label for="course-${c.id}" class="ml-3 text-sm cursor-pointer flex-1">
                                        <span class="font-medium block">${c.subjectName}</span>
                                        <span class="text-xs text-gray-500">${c.credits}í•™ì  | ${c.category}</span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            courseListEl.innerHTML = html;
            validateSelections(); // Initial validation
        }

        function getSelected() {
            const selected = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                if (course) selected.push(course);
            });
            return selected;
        }

        function validateSelections() {
            const selected = getSelected();
            const allSelected = [...selected, ...jointCourses];
            const messages = [];

            // 1. Multi-Semester Exclusion (Strict)
            // If a course is selected, disable same-named courses in other semesters
            const selectedNames = new Set(selected.map(c => c.subjectName));

            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                const course = PROCESSED_COURSES.find(c => c.id == cb.value);
                if (!course) return;

                // Skip if this checkbox is already checked or required
                if (cb.checked || cb.disabled && course.required) return;

                // If this course's name is in the selected list, but it's not the one selected (different ID), disable it
                // Actually, we just check if the name is in selectedNames
                if (selectedNames.has(course.subjectName)) {
                    cb.disabled = true;
                    cb.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
                    // Optional: Add tooltip or visual cue?
                } else {
                    // Re-enable if not selected
                    cb.disabled = false;
                    cb.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            // 2. Advanced Rules Check
            const ruleResult = validateSelectionRules(selected);
            if (!ruleResult.valid) {
                messages.push(...ruleResult.messages.map(m => ({ type: 'error', text: m })));
            } else {
                messages.push({ type: 'success', text: 'ëª¨ë“  ì„ íƒ ê·œì¹™ì„ ë§Œì¡±í•©ë‹ˆë‹¤!' });
            }

            // Render Messages
            validationMessagesEl.innerHTML = messages.map(m => `
                <div class="text-sm p-2 rounded ${m.type === 'error' ? 'bg-red-50 text-red-700' : 'bg-green-50 text-green-700'}">
                    ${m.type === 'error' ? 'âš ï¸' : 'âœ…'} ${m.text}
                </div>
            `).join('');

            // Update UI
            let total = 0;
            allSelected.forEach(c => total += c.credits);
            totalCreditsEl.textContent = total;
            submitBtn.disabled = total === 0;

            renderSelectedList(allSelected);
        }

        function validateSelectionRules(selectedCourses) {
            const grouped = {};
            selectedCourses.forEach(c => {
                const key = `${c.grade}-${c.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(c);
            });

            const messages = [];
            let isValid = true;

            Object.keys(selectionRules).forEach(key => {
                const rules = selectionRules[key];
                const courses = grouped[key] || [];
                const [g, s] = key.split('-');

                rules.forEach(rule => {
                    let count = 0;
                    if (rule.credits === 'all') {
                        count = courses.length;
                    } else {
                        count = courses.filter(c => c.credits == rule.credits).length;
                    }

                    if (count !== parseInt(rule.count)) {
                        isValid = false;
                        const criteria = rule.credits === 'all' ? 'ê³¼ëª©' : `${rule.credits}í•™ì  ê³¼ëª©`;
                        messages.push(`${g}í•™ë…„ ${s}í•™ê¸°: ${criteria}ì„ ${rule.count}ê°œ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬ ${count}ê°œ)`);
                    }
                });
            });

            return { valid: isValid, messages };
        }

        function renderSelectedList(selectedCourses) {
            let html = '';
            const grouped = {};

            selectedCourses.forEach(c => {
                const k = `${c.grade}-${c.semester}`;
                if (!grouped[k]) grouped[k] = [];
                grouped[k].push(c);
            });

            Object.keys(grouped).sort().forEach(k => {
                const [g, s] = k.split('-');
                const semesterCredits = grouped[k].reduce((sum, c) => sum + c.credits, 0);

                html += `
                    <div class="p-3 border-b last:border-b-0">
                        <div class="font-bold text-sm text-gray-500 mb-2 flex justify-between items-center">
                            <span>${g}í•™ë…„ ${s}í•™ê¸°</span>
                            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full text-gray-600">ì„ íƒ: ${semesterCredits}í•™ì </span>
                        </div>
                        <div class="flex flex-wrap gap-x-3 gap-y-1">
                            ${grouped[k].map(c => {
                    // Use lighter/brighter colors for dark mode visibility
                    const colors = [
                        'text-pink-500 dark:text-pink-400',
                        'text-purple-500 dark:text-purple-400',
                        'text-indigo-500 dark:text-indigo-400',
                        'text-blue-500 dark:text-blue-400',
                        'text-teal-500 dark:text-teal-400',
                        'text-emerald-500 dark:text-emerald-400',
                        'text-orange-500 dark:text-orange-400',
                        'text-rose-500 dark:text-rose-400'
                    ];
                    const hash = c.subjectName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                    const colorClass = colors[hash % colors.length];
                    return `<span class="text-sm font-medium ${colorClass} hover:opacity-80 transition-opacity cursor-default" style="text-shadow: 0 0 1px currentColor;">${c.subjectName}</span>`;
                }).join('')}
                        </div>
                    </div>
                `;
            });

            selectedCoursesEl.innerHTML = html;

            // Update Final Modal Content
            let finalHtml = '';
            Object.keys(grouped).sort().forEach(k => {
                const [g, s] = k.split('-');
                finalHtml += `
                    <div class="border p-3 rounded bg-white mb-2 text-gray-800">
                        <h4 class="font-bold text-purple-600 mb-2">${g}í•™ë…„ ${s}í•™ê¸°</h4>
                        <ul class="text-sm space-y-1">
                            ${grouped[k].map(c => `<li>${c.subjectName} (${c.credits})</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            finalSelectionEl.innerHTML = finalHtml;

            renderCategorySummary(selectedCourses);
        }

        function renderCategorySummary(selectedCourses) {
            const summary = {};
            const allCourses = [...selectedCourses]; // jointCourses are already in selectedCourses if passed from validateSelections

            allCourses.forEach(c => {
                const cat = c.subjectCategory || c.category || 'ê¸°íƒ€';
                if (!summary[cat]) summary[cat] = { credits: 0, courses: [] };
                summary[cat].credits += c.credits;
                summary[cat].courses.push(c.subjectName);
            });

            const summaryEl = document.getElementById('category-summary-content');
            if (!summaryEl) return;

            if (Object.keys(summary).length === 0) {
                summaryEl.innerHTML = '<div class="text-gray-400 text-center">ì„ íƒëœ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            summaryEl.innerHTML = Object.entries(summary).map(([cat, data]) => {
                const isLong = data.courses.length > 2;
                const courseListHtml = data.courses.join(', ');

                return `
                    <div class="flex flex-col border-b last:border-b-0 py-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-medium text-gray-600 dark:text-gray-400">${cat}</span>
                            <span class="font-bold text-blue-600 dark:text-blue-400">${data.credits}í•™ì </span>
                        </div>
                        <div class="text-xs text-gray-400 relative group">
                            <div class="truncate-lines-1" id="summary-text-${cat}">${courseListHtml}</div>
                            ${isLong ? `<button onclick="toggleSummary('${cat}')" id="summary-btn-${cat}" class="text-xs text-blue-400 hover:text-blue-600 mt-1 focus:outline-none">ë”ë³´ê¸° â–¼</button>` : ''}
                            <div id="summary-full-${cat}" class="hidden mt-1 text-gray-500 dark:text-gray-300 break-words bg-gray-50 dark:bg-gray-700 p-2 rounded">
                                ${courseListHtml}
                            </div>
                        </div>
                    </div>
                `
            }).join('');
        }

        window.toggleSummary = (cat) => {
            const fullEl = document.getElementById(`summary-full-${cat}`);
            const btnEl = document.getElementById(`summary-btn-${cat}`);
            if (fullEl.classList.contains('hidden')) {
                fullEl.classList.remove('hidden');
                btnEl.innerHTML = 'ì ‘ê¸° â–²';
            } else {
                fullEl.classList.add('hidden');
                btnEl.innerHTML = 'ë”ë³´ê¸° â–¼';
            }
        };

        function initJointCourses() {
            const categories = ['ì¸ë¬¸', 'ì‚¬íšŒ', 'ê³¼í•™', 'ì²´ìœ¡', 'ì˜ˆìˆ ', 'êµì–‘'];
            jointCategoryEl.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');

            addJointBtn.addEventListener('click', () => {
                const name = jointNameEl.value.trim();
                const credits = parseInt(jointCreditsEl.value);
                const category = jointCategoryEl.value;

                if (!name || !credits) {
                    alert('ê³¼ëª©ëª…ê³¼ í•™ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                jointCourses.push({ subjectName: name, credits, category, isJoint: true });
                jointNameEl.value = '';
                jointCreditsEl.value = '';
                renderJointCourses();
                validateSelections();
            });
        }

        function renderJointCourses() {
            jointCoursesEl.innerHTML = jointCourses.map((c, idx) => `
                <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <span>${c.subjectName} (${c.credits})</span>
                    <button onclick="removeJointCourse(${idx})" class="text-red-500 hover:text-red-700">Ã—</button>
                </li>
            `).join('');
        }

        window.removeJointCourse = (idx) => {
            jointCourses.splice(idx, 1);
            renderJointCourses();
            validateSelections();
        };

        // Helper Message Function
        function showHelperMsg(msg, type = 'info') {
            helperMsgEl.innerHTML = msg;
            const bubble = helperMsgEl.closest('.speech-bubble');
            bubble.className = 'speech-bubble w-full'; // Reset
            if (type === 'error') bubble.classList.add('error');
            else if (type === 'success') bubble.classList.add('success');
        }

        // AI Recommendation Logic
        let debounceTimer;
        majorInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const major = majorInput.value.trim();
                if (major && major !== 'íƒìƒ‰ì¤‘') getAiRecs(major);
                else showHelperMsg('ì•ˆë…•í•˜ì„¸ìš”! í¬ë§ ì§„ë¡œë¥¼ ì…ë ¥í•˜ë©´ ê³¼ëª©ì„ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”. ê³¼ëª©ì„ ì„ íƒí•˜ë©´ ê·œì¹™ì„ ì˜ ì§€í‚¤ê³  ìˆëŠ”ì§€ ì•Œë ¤ë“œë¦´ê²Œìš”!');
            }, 1000);
        });

        async function getAiRecs(major) {
            helperMsgEl.classList.add('hidden');
            aiLoader.classList.remove('hidden');

            const availableCourses = PROCESSED_COURSES.filter(c => !c.required).map(c => c.subjectName).join(', ');

            try {
                // Call Netlify Function instead of direct OpenAI API
                const response = await fetch('/.netlify/functions/ai-recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ major, availableCourses })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error ? errorData.error.message : 'API ìš”ì²­ ì‹¤íŒ¨');
                }

                const result = await response.json();
                if (result.choices && result.choices.length > 0) {
                    const recommendationText = result.choices[0].message.content;
                    showHelperMsg(`<strong>[${major}] ë§ì¶¤ ê³¼ëª© ì¶”ì²œ:</strong><br><br>${recommendationText.replace(/\n/g, '<br>')}`, 'info');
                } else {
                    throw new Error("APIë¡œë¶€í„° ìœ íš¨í•œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('AI ì¶”ì²œ ê¸°ëŠ¥ ì˜¤ë¥˜:', error);
                showHelperMsg(`AI ì¶”ì²œ ê¸°ëŠ¥ ì˜¤ë¥˜: ${error.message}<br><br>Netlify í™˜ê²½ë³€ìˆ˜(OPENAI_API_KEY)ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
            } finally {
                aiLoader.classList.add('hidden');
                helperMsgEl.classList.remove('hidden');
            }
        }

        // Image Save
        saveImgBtn.addEventListener('click', () => {
            html2canvas(finalSelectionEl).then(canvas => {
                const link = document.createElement('a');
                link.download = 'ë‚˜ì˜_êµìœ¡ê³¼ì •_ì„¤ê³„í‘œ.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // Submit Logic
        submitBtn.addEventListener('click', () => {
            submitModalEl.classList.remove('hidden');
        });

        cancelBtn.addEventListener('click', () => {
            submitModalEl.classList.add('hidden');
        });

        confirmBtn.addEventListener('click', async () => {
            const studentInfo = {
                grade: gradeEl.value,
                classNum: classNumEl.value,
                studentNum: studentNumEl.value,
                name: studentNameEl.value,
                major: majorInput.value
            };

            if (!studentInfo.grade || !studentInfo.classNum || !studentInfo.studentNum || !studentInfo.name) {
                alert('í•™ìƒ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const selectedCourses = getSelected();
            const allCourses = [...selectedCourses, ...jointCourses];
            const courseNames = allCourses.map(c => c.subjectName).join(', ');

            confirmBtn.disabled = true;
            confirmBtn.textContent = 'ì œì¶œ ì¤‘...';

            try {
                const result = await DB.submitResponse({
                    ...studentInfo,
                    selectedCourses: courseNames,
                    totalCredits: totalCreditsEl.textContent
                });

                if (result.status === 'success') {
                    alert('ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    submitModalEl.classList.add('hidden');
                    // Optional: Reset form or redirect
                } else {
                    throw new Error('ì œì¶œ ì‹¤íŒ¨');
                }
            } catch (e) {
                console.error(e);
                alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ì œì¶œ';
            }
        });

        // Theme Helper
        function changeTheme(themeName) {
            applyTheme(themeName);
            localStorage.setItem('theme', themeName);
            document.getElementById('theme-menu').classList.add('hidden');
        }

        function toggleThemeMenu() {
            document.getElementById('theme-menu').classList.toggle('hidden');
        }

        // Initialize Theme
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        });

        // Start
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
