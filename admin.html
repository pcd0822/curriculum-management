<!DOCTYPE html>
<html lang="ko">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- SheetJS (XLSX) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js -->
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Custom Modules -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="js/db.js"></script>
<script src="js/excel-handler.js"></script>
<script src="js/qrcode-generator.js"></script>
<script src="js/theme.js"></script>

<style>
    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }

    .tab-btn.active {
        border-bottom: 2px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
    }

    /* Custom styles for theme compatibility */
    .theme-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
    }

    /* Dynamic height adjustment for modal sections */
    #student-report-card .grid.items-stretch {
        align-items: stretch;
    }

    #student-report-card .theme-card.flex.flex-col {
        display: flex;
        flex-direction: column;
    }

    /* Validation detail table container - flexible height */
    #student-report-card .theme-card.flex.flex-col > div.flex-1 {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
    }

    /* Chart container - flexible height, fill section */
    #student-report-card .theme-card.flex.flex-col > div.flex-1.flex {
        flex: 1 1 auto;
        min-height: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: stretch;
    }

    /* Chart canvas - fill container completely */
    #student-report-card #individualCreditChart {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        flex: 1 1 auto;
    }

    /* Chart wrapper div - fill container */
    #student-report-card .theme-card.flex.flex-col > div.flex-1.flex > div {
        width: 100% !important;
        height: 100% !important;
        flex: 1 1 auto;
        display: flex;
        align-items: stretch;
    }

    /* Chart wrapper div - fill container */
    #student-report-card .theme-card.flex.flex-col > div.flex-1.flex > div {
        width: 100% !important;
        height: 100% !important;
    }

    /* Course list table container - flexible height */
    #student-report-card .theme-card.flex.flex-col > div.flex-1.overflow-y-auto {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
    }

    /* Ensure course list and AI section cards match height */
    #student-report-card .grid.items-stretch > .theme-card.flex.flex-col {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    /* Course list table wrapper - ensure it fills available space */
    #student-report-card .theme-card.flex.flex-col > div.flex-1.overflow-y-auto.min-h-0 {
        flex: 1 1 auto;
        min-height: 0;
        overflow-y: auto;
    }

    /* AI analysis container - flexible height */
    #student-report-card #ai-analysis-container.flex-1 {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
    }

    .theme-text {
        color: var(--text-color);
    }

    .theme-text-muted {
        color: var(--text-muted);
    }

    .theme-border {
        border-color: var(--border-color);
    }

    input,
    select {
        background-color: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-color);
    }

    input:focus,
    select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.8);
    }

    @media print {
        @page {
            size: A4;
            margin: 10mm;
        }

        body {
            padding: 0;
            background: white;
            font-size: 8pt;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Hide everything except the modal and batch print container */
        body>*:not(#class-lookup-modal):not(#batch-print-container) {
            display: none !important;
        }
        
        /* ì¶œë ¥ ì˜µì…˜ ëª¨ë‹¬ ìˆ¨ê¹€ */
        #print-options-modal {
            display: none !important;
        }

        /* Show batch print container in print */
        #batch-print-container {
            display: block !important;
            position: relative !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            background: white !important;
        }

        /* Each report card in batch print should start on a new page (except first) */
        #batch-print-container > div:not(:first-child) {
            page-break-before: always !important;
            break-before: page !important;
        }

        /* Modal styling */
        #class-lookup-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            background: white !important;
            z-index: 9999;
            display: block !important;
            overflow: visible !important;
        }

        #class-lookup-modal>div {
            box-shadow: none !important;
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            max-height: none !important;
            overflow: visible !important;
            overflow-y: visible !important;
        }
        
        /* class-stats-content: ìŠ¤í¬ë¡¤ ì œê±°, ì „ì²´ ë‚´ìš© ë…¸ì¶œ */
        #class-stats-content {
            overflow: visible !important;
            overflow-y: visible !important;
            max-height: none !important;
            min-height: auto !important;
        }

        /* Report Card - ê°€ë…ì„± ìš°ì„ , A4 ì„¸ë¡œ 2~3ìª½ */
        #student-report-card {
            border: none !important;
            box-shadow: none !important;
            padding: 2mm !important;
            margin: 0 !important;
            font-size: 8pt !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Header */
        #student-report-card > div:first-child {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            margin-bottom: 1mm !important;
            padding-bottom: 1mm !important;
            page-break-after: avoid !important;
            page-break-inside: avoid !important;
            border: none !important;
            border-bottom: none !important;
        }

        /* í•™ë²ˆ í…Œë‘ë¦¬ ìˆ¨ê¹€ */
        #student-report-card > div:first-child span.bg-gray-200,
        #student-report-card > div:first-child span[class*="bg-gray"] {
            border: none !important;
            box-shadow: none !important;
        }

        /* Ensure header content is visible */
        #student-report-card > div:first-child * {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Header inline elements */
        #student-report-card > div:first-child span,
        #student-report-card > div:first-child h3 {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #student-report-card h3 {
            font-size: 11pt !important;
            margin: 0 !important;
            line-height: 1.2 !important;
        }
        
        #student-report-card .text-2xl {
            font-size: 12pt !important;
        }
        
        /* Grid layout */
        #student-report-card .grid {
            gap: 1.5mm !important;
            margin-bottom: 1.5mm !important;
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            align-items: start !important;
        }

        #student-report-card .grid.grid-cols-1.lg\:grid-cols-2 {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        #student-report-card .grid.grid-cols-1.lg\:grid-cols-3 {
            grid-template-columns: 2fr 1fr !important;
        }
        
        /* Cards */
        #student-report-card .theme-card {
            padding: 1.5mm !important;
            margin-bottom: 1.5mm !important;
            page-break-inside: avoid !important;
        }
        
        #student-report-card h4 {
            font-size: 8pt !important;
            margin-bottom: 0.5mm !important;
            line-height: 1.2 !important;
        }
        
        /* Chart - fill container in print */
        #student-report-card canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
        }
        
        /* Chart container - ê°€ë…ì„± ìš°ì„  */
        #student-report-card .theme-card.flex.flex-col > div.flex-1.flex {
            width: 100% !important;
            height: 100% !important;
            min-height: 90px !important;
            max-height: 120px !important;
        }

        /* Chart wrapper div */
        #student-report-card .theme-card.flex.flex-col > div.flex-1.flex > div {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Chart container height */
        #student-report-card .h-48 {
            height: 100% !important;
            min-height: 90px !important;
        }

        /* êµê³¼ë³„ ì„ íƒí•™ì  ì°¨íŠ¸ */
        #student-report-card #subcategory-chart-wrap {
            min-height: 90px !important;
            max-height: 130px !important;
        }
        
        /* Tables - ê°€ë…ì„± ìš°ì„  */
        #student-report-card table {
            font-size: 7.5pt !important;
            width: 100% !important;
        }
        
        #student-report-card table th,
        #student-report-card table td {
            padding: 0.5mm 0.4mm !important;
            line-height: 1.25 !important;
        }
        
        /* Validation table */
        #student-report-card .text-xs {
            font-size: 7.5pt !important;
        }
        
        /* Show AI section in print */
        #student-report-card .bg-indigo-50 {
            display: block !important;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            page-break-inside: avoid !important;
        }
        
        /* Spacing - more compact */
        #student-report-card .space-y-4 > * + * {
            margin-top: 1.5mm !important;
        }
        
        #student-report-card .gap-6 {
            gap: 1.5mm !important;
        }
        
        #student-report-card .mb-6 {
            margin-bottom: 1.5mm !important;
        }
        
        #student-report-card .mb-4 {
            margin-bottom: 1mm !important;
        }
        
        #student-report-card .mb-2 {
            margin-bottom: 0.75mm !important;
        }
        
        /* Hide dropdown area in print */
        #class-lookup-modal select,
        #class-lookup-modal .flex.gap-2.items-center,
        #class-lookup-modal .mb-4:has(select) {
            display: none !important;
        }
        
        /* Table rows */
        #student-report-card table tr {
            line-height: 1.2 !important;
        }
        
        /* Course list table */
        #student-report-card .overflow-y-auto {
            max-height: none !important;
            overflow: visible !important;
            overflow-y: visible !important;
            overflow-x: visible !important;
        }
        
        /* Remove scroll from all elements in print */
        #student-report-card * {
            overflow: visible !important;
            overflow-y: visible !important;
            overflow-x: visible !important;
            line-height: 1.2 !important;
        }
        
        /* Course list table - optimize column widths for print */
        #student-report-card .overflow-y-auto table th:nth-child(3),
        #student-report-card .overflow-y-auto table td:nth-child(3) {
            width: 50% !important;
            max-width: 50% !important;
        }
        
        /* ê³¼ëª©ëª… ì»¬ëŸ¼ */
        #student-report-card .overflow-y-auto table td:nth-child(3) {
            font-size: 8pt !important;
        }
        
        /* Print layout: 2x2 grid with equal column widths */
        /* Top row: Chart (left) = Course List (left), Validation (right) = AI (right) */
        /* Both rows use 50% 50% split */
        #student-report-card .print\:grid-cols-2 {
            grid-template-columns: 1fr 1fr !important;
        }
        
        /* AI section - match height with course list */
        #student-report-card .lg\:col-span-1 {
            display: flex !important;
            flex-direction: column !important;
            height: 100% !important;
        }
        
        #student-report-card #ai-analysis-container {
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
            min-height: 0 !important;
        }
        
        /* Make course list and AI section same height */
        #student-report-card .lg\:col-span-2 {
            display: flex !important;
            flex-direction: column !important;
        }
        
        #student-report-card .overflow-y-auto {
            flex: 1 !important;
            min-height: 0 !important;
        }
        
        /* Ensure header is visible in print */
        #student-report-card > div:first-child {
            display: flex !important;
            flex-direction: row !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            page-break-after: avoid !important;
            page-break-inside: avoid !important;
            margin-bottom: 1mm !important;
            padding-bottom: 1mm !important;
            border-bottom: 1px solid #000 !important;
            width: 100% !important;
            align-items: center !important;
            justify-content: space-between !important;
        }

        /* Ensure all header content is visible */
        #student-report-card > div:first-child > * {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Header left section - í•™ë²ˆ, ì´ë¦„, ì§„ë¡œí¬ë§ì‚¬í•­ */
        #student-report-card > div:first-child > div:first-child {
            display: flex !important;
            flex-direction: column !important;
            visibility: visible !important;
            opacity: 1 !important;
            flex: 1 !important;
        }

        /* Header inline elements - ensure they're visible */
        #student-report-card > div:first-child span,
        #student-report-card > div:first-child h3 {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: black !important;
        }

        /* Header paragraph */
        #student-report-card > div:first-child p {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            color: black !important;
            margin: 0 !important;
        }

        /* Header right section - ì„ íƒ ê³¼ëª©, ì´ í•™ì  */
        #student-report-card > div:first-child > div:last-child {
            display: flex !important;
            flex-direction: row !important;
            visibility: visible !important;
            opacity: 1 !important;
            gap: 1rem !important;
        }

        /* Header text */
        #student-report-card > div:first-child h3,
        #student-report-card > div:first-child span,
        #student-report-card > div:first-child p {
            color: black !important;
            font-size: 9pt !important;
            line-height: 1.3 !important;
        }
        
        /* Border spacing */
        #student-report-card .border-b {
            border-width: 0.5px !important;
        }
        
        /* AI ì„¹ì…˜ */
        #student-report-card .bg-indigo-50 h4 {
            color: black !important;
            font-size: 8pt !important;
        }
        
        #student-report-card .text-indigo-400,
        #student-report-card .text-indigo-800 {
            color: black !important;
        }
        
        /* ì¸ë¼ì¸ print í´ë˜ìŠ¤ ì˜¤ë²„ë¼ì´ë“œ - ê°€ë…ì„± ìš°ì„  */
        #student-report-card [class*="print:h-"],
        #student-report-card [class*="print:min-h"],
        #student-report-card [class*="print:max-h"] {
            min-height: 90px !important;
            max-height: 130px !important;
        }
        
        /* Grid */
        #student-report-card .grid.print\:grid-cols-2 {
            grid-template-columns: 1fr 1fr !important;
            gap: 1.5mm !important;
            margin-bottom: 1.5mm !important;
        }

        #student-report-card .print\:gap-1\.5 {
            gap: 1mm !important;
        }

        #student-report-card .print\:mb-1\.5 {
            margin-bottom: 1mm !important;
        }

        #student-report-card .print\:p-1\.5 {
            padding: 1mm !important;
        }

        #student-report-card .print\:h-\[120px\] {
            height: 100px !important;
            min-height: 90px !important;
            max-height: 120px !important;
        }

        #student-report-card .print\:text-\[8pt\] {
            font-size: 7.5pt !important;
        }

        #student-report-card .print\:mb-0\.75 {
            margin-bottom: 0.5mm !important;
        }
        
        /* ê³¼ëª© ëª©ë¡ í…Œì´ë¸” */
        #student-report-card .overflow-y-auto table {
            font-size: 7.5pt !important;
        }
        
        #student-report-card .overflow-y-auto table th,
        #student-report-card .overflow-y-auto table td {
            padding: 0.5mm 0.4mm !important;
        }

        /* Hide UI controls */
        .modal-controls,
        button,
        .no-print,
        .print\:hidden {
            display: none !important;
        }

        /* Compact Spacing */
        .print\:mb-1 {
            margin-bottom: 0.25rem !important;
        }

        .print\:mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .print\:p-1 {
            padding: 0.25rem !important;
        }

        .print\:p-2 {
            padding: 0.5rem !important;
        }

        .print\:gap-2 {
            gap: 0.5rem !important;
        }

        /* Grid Layout */
        .print\:grid-cols-2 {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 0.75rem !important;
        }

        /* Chart Height Reduction */
        .print\:h-32 {
            height: 8rem !important;
        }

        .print\:h-40 {
            height: 10rem !important;
        }

        /* Text Adjustments */
        .print\:text-xs {
            font-size: 0.65rem !important;
        }

        .print\:text-sm {
            font-size: 0.75rem !important;
        }

        /* Table Optimization */
        table td,
        table th {
            padding: 2px 4px !important;
            /* Tighter table cells */
        }

        /* Ensure colors print */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* Force text colors to black/dark for readability */
        .print\:text-black {
            color: black !important;
        }
    }
</style>
</head>

<body class="min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold theme-text">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1><a href="index.html" target="_blank"
                class="text-blue-600 hover:underline">í•™ìƒ í˜ì´ì§€ ë³´ê¸° &rarr;
            </a>
        </header>
        <!-- Tabs -->
        <div class="flex border-b mb-6 theme-border"><button
                class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600 active" onclick="switchTab('system')">ì‹œìŠ¤í…œ
                ì„¤ì •</button><button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600"
                onclick="switchTab('courses')">ê³¼ëª© ë°ì´í„°
                ê´€ë¦¬</button><button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600"
                onclick="switchTab('rules')">ì„ íƒ ê·œì¹™</button><button
                class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600" onclick="switchTab('share')">ë°°í¬ ë°
                ê³µìœ </button><button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600"
                onclick="switchTab('dashboard')">í•™ìƒ ì‹ ì²­ í˜„í™©</button><button
                class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600"
                onclick="switchTab('bulk')">ì¼ê´„ ë“±ë¡</button></div>
        <!-- 1. System Config -->
        <div id="tab-system" class="tab-content">
            <div class="theme-card p-6 rounded-lg shadow-md max-w-2xl">
                <h2 class="text-xl font-semibold mb-4 theme-text">Google Apps Script API ì„¤ì •</h2>
                <p class="text-sm mb-4 theme-text-muted">ë°°í¬ëœ Google Apps Script ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”. ì´ URLì€
                    ë°ì´í„°ë² ì´ìŠ¤(Google Sheets)ì™€ì˜ í†µì‹ ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
                <div class="mb-4"><label class="block text-sm font-medium mb-1 theme-text">API URL</label><input
                        type="text" id="api-url" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500"
                        placeholder="https://script.google.com/macros/s/.../exec"></div>
                <div class="flex gap-2"><button id="save-url-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì €ì¥</button><button
                        id="test-connection-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300"
                        style="background-color: var(--hover-bg); color: var(--text-color)">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
                <div id="connection-status" class="mt-4 text-sm"></div>
            </div>
        </div>
        <!-- 2. Course Data Management -->
        <div id="tab-courses" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Course Upload -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">ê³¼ëª© ì—‘ì…€ ì—…ë¡œë“œ</h2>
                    <p class="text-sm mb-4 theme-text-muted">'í¸ì œí‘œ' ì‹œíŠ¸ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. ê¸°ì¡´ ë°ì´í„°ëŠ”
                        ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</p>
                    <div class="space-y-4"><button onclick="ExcelHandler.downloadTemplate()"
                            class="text-blue-600 hover:underline text-sm flex items-center"><svg class="w-4 h-4 mr-1"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                </path>
                            </svg>ê³¼ëª© í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ </button><input type="file" id="course-excel-file" accept=".xlsx, .xls"
                            class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><button
                            id="upload-course-btn"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">ê³¼ëª©
                            ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥</button></div>
                    <div id="upload-status" class="mt-4 text-sm"></div>
                </div>
                <!-- Student Registry Upload -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í•™ì  ì •ë³´ ì—…ë¡œë“œ</h2>
                    <p class="text-sm mb-4 theme-text-muted">í•™ë²ˆ(5ìë¦¬)ê³¼ ì´ë¦„ì´ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>(ê¸°ì¡´
                        ë°ì´í„°ì— ì¶”ê°€/ê°±ì‹ ë©ë‹ˆë‹¤)</p>
                    <div class="space-y-4"><button onclick="ExcelHandler.downloadRegistryTemplate()"
                            class="text-blue-600 hover:underline text-sm flex items-center"><svg class="w-4 h-4 mr-1"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                </path>
                            </svg>í•™ì  í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ </button><input type="file" id="registry-excel-file"
                            accept=".xlsx, .xls"
                            class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" /><button
                            id="upload-registry-btn"
                            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 w-full">í•™ì 
                            ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥</button></div>
                    <div id="registry-upload-status" class="mt-4 text-sm"></div>
                </div>
                <!-- ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ê³¼ëª© ì—…ë¡œë“œ -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ê³¼ëª© ì—‘ì…€ ì—…ë¡œë“œ</h2>
                    <p class="text-sm mb-4 theme-text-muted">ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ê³¼ëª©ì„ ì—‘ì…€ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”. JointCurriculum ì‹œíŠ¸ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                    <div class="space-y-4">
                        <button onclick="ExcelHandler.downloadJointCurriculumTemplate()" class="text-blue-600 hover:underline text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ê³µë™êµìœ¡ê³¼ì • í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <input type="file" id="joint-curriculum-excel-file" accept=".xlsx, .xls" class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <button id="upload-joint-curriculum-btn" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700 w-full">ê³µë™êµìœ¡ê³¼ì • ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥</button>
                    </div>
                    <div id="joint-curriculum-upload-status" class="mt-4 text-sm"></div>
                </div>
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í˜„ì¬ ë“±ë¡ëœ ê³¼ëª©</h2>
                    <div id="current-course-count" class="text-3xl font-bold mb-2 theme-text">-</div>
                    <p class="text-sm theme-text-muted">ê°œì˜ ê³¼ëª©ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <button id="refresh-course-btn" class="mt-4 text-sm text-blue-600 hover:underline">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">ë“±ë¡ëœ ê³µë™êµìœ¡ê³¼ì •</h2>
                    <div id="current-joint-curriculum-count" class="text-3xl font-bold mb-2 theme-text">-</div>
                    <p class="text-sm theme-text-muted">ê°œì˜ ê³µë™êµìœ¡ê³¼ì •ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <button class="mt-4 text-sm text-blue-600 hover:underline" onclick="loadCourseCount()">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <!-- í•™ê³¼ë³„ ê¶Œì¥ê³¼ëª© ì—…ë¡œë“œ -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í•™ê³¼ë³„ ê¶Œì¥ê³¼ëª© ì—‘ì…€ ì—…ë¡œë“œ</h2>
                    <p class="text-sm mb-4 theme-text-muted">ì¶œì²˜/í•™ê³¼/í•µì‹¬ ê¶Œì¥ê³¼ëª©/ê¶Œì¥ê³¼ëª©ì„ ì—‘ì…€ë¡œ ì—…ë¡œë“œí•˜ì„¸ìš”. RecommendedCourses ì‹œíŠ¸ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                    <div class="space-y-4">
                        <button onclick="ExcelHandler.downloadRecommendedCoursesTemplate()" class="text-blue-600 hover:underline text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            ê¶Œì¥ê³¼ëª© í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <input type="file" id="recommended-courses-excel-file" accept=".xlsx, .xls" class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <button id="upload-recommended-courses-btn" class="bg-amber-600 text-white px-4 py-2 rounded hover:bg-amber-700 w-full">ê¶Œì¥ê³¼ëª© ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥</button>
                    </div>
                    <div id="recommended-courses-upload-status" class="mt-4 text-sm"></div>
                </div>
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">ë“±ë¡ëœ ê¶Œì¥ê³¼ëª©(í•™ê³¼)</h2>
                    <div id="current-recommended-courses-count" class="text-3xl font-bold mb-2 theme-text">-</div>
                    <p class="text-sm theme-text-muted">ê°œ í•™ê³¼ì˜ ê¶Œì¥ê³¼ëª©ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <button class="mt-4 text-sm text-blue-600 hover:underline" onclick="loadCourseCount()">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>
        <!-- 2.5 Selection Rules -->
        <div id="tab-rules" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Limit Configuration -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í•™ë…„-í•™ê¸°ë³„ ì„ íƒ ê·œì¹™ ì„¤ì •</h2>
                    <p class="text-sm mb-4 theme-text-muted">ê° í•™ê¸°ë³„ë¡œ í•™ì  ë‹¨ìœ„ ì„ íƒ ê·œì¹™ì„ ì¶”ê°€í•˜ì„¸ìš”.<br>(ì˜ˆ: 4í•™ì 
                        ê³¼ëª© 5ê°œ ì„ íƒ)</p>
                    <div id="limit-config-container" class="space-y-6">
                        <!-- Dynamic Content -->
                    </div><button id="save-rules-btn"
                        class="mt-6 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">ê·œì¹™
                        ì €ì¥</button>
                </div>
                <!-- Course Classification View -->
                <div class="space-y-6">
                    <div class="theme-card p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 theme-text">ê³¼ëª© í¸ì œ í™•ì¸</h2>
                        <p class="text-sm mb-4 theme-text-muted">ë“±ë¡ëœ ê³¼ëª©ì´ í•™ë…„-í•™ê¸°ë³„ë¡œ ì˜¬ë°”ë¥´ê²Œ ë¶„ë¥˜ë˜ì—ˆëŠ”ì§€
                            í™•ì¸í•˜ì„¸ìš”.</p>
                        <div id="course-classification-view"
                            class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                    <!-- Multi-Semester Course Config -->
                    <div class="theme-card p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 theme-text">ë³µìˆ˜ í¸ì œ ê³¼ëª© ê´€ë¦¬</h2>
                        <p class="text-sm mb-4 theme-text-muted">ì—¬ëŸ¬ í•™ê¸°(í•™ë…„)ì— ì¤‘ë³µ ê°œì„¤ëœ ê³¼ëª© ëª©ë¡ì…ë‹ˆë‹¤.
                            ì´ ê³¼ëª©ë“¤ì€ í•™ìƒ í˜ì´ì§€ì—ì„œ ìë™ìœ¼ë¡œ ìƒí˜¸ ë°°íƒ€ì ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                        <div id="multi-semester-config-container"
                            class="space-y-4 max-h-[300px] overflow-y-auto custom-scrollbar">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 3. Share & Deploy -->
        <div id="tab-share" class="tab-content hidden">
            <div class="theme-card p-6 rounded-lg shadow-md max-w-2xl">
                <h2 class="text-xl font-semibold mb-4 theme-text">í•™ìƒìš© ë§í¬ ìƒì„±</h2>
                <p class="text-sm mb-4 theme-text-muted">ì•„ë˜ QR ì½”ë“œ ë˜ëŠ” ë§í¬ë¥¼ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”. ë§í¬ì—ëŠ” API URL
                    ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì–´ í•™ìƒë“¤ì´ ë³„ë„ì˜ ì„¤ì • ì—†ì´ ë°”ë¡œ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div id="share-container" class="hidden">
                    <div class="flex flex-col items-center p-4 rounded border mb-4 theme-border"
                        style="background-color: var(--card-bg)">
                        <div id="qrcode" class="mb-4 bg-white p-2 rounded"></div>
                        <p class="text-sm font-mono break-all text-center theme-text-muted" id="share-link-text"></p>
                    </div><button id="copy-link-btn"
                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ë§í¬
                        ë³µì‚¬í•˜ê¸°</button>
                </div>
                <div id="share-error" class="hidden text-red-500">ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
            </div>
        </div>
        <!-- 3.5 Bulk Enrollment -->
        <div id="tab-bulk" class="tab-content hidden">
            <div class="theme-card p-6 rounded-lg shadow-md max-w-4xl">
                <h2 class="text-xl font-semibold mb-4 theme-text">ì¼ê´„ ìˆ˜ê°•ì‹ ì²­ ë“±ë¡</h2>
                <p class="text-sm mb-4 theme-text-muted">
                    xlsx íŒŒì¼ì„ í†µí•´ ì „ì²´ í•™ìƒì˜ ê³¼ëª© ìˆ˜ê°• ì‹ ì²­ ì •ë³´ë¥¼ í•œ ë²ˆì— ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                    ìƒ˜í”Œ ì–‘ì‹ì„ ë‹¤ìš´ë¡œë“œí•œ ë’¤, í•™ë²ˆÂ·ì´ë¦„Â·í¬ë§ ì§„ë¡œì™€ ê³¼ëª©ë³„ ìˆ˜ê°• ì—¬ë¶€(0/1)ë¥¼ ì…ë ¥í•˜ê³  ì—…ë¡œë“œí•˜ì„¸ìš”.
                </p>
                <div class="space-y-4">
                    <div class="flex flex-wrap gap-4 items-center">
                        <button type="button" id="bulk-download-template-btn"
                            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ğŸ“¥ ìƒ˜í”Œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ (xlsx)</button>
                        <span id="bulk-template-hint" class="text-sm theme-text-muted">ì„œë²„ì— ë“±ë¡ëœ ì„ íƒê³¼ëª© ëª©ë¡ìœ¼ë¡œ ì–‘ì‹ì´ ìƒì„±ë©ë‹ˆë‹¤.</span>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 theme-text">ìˆ˜ê°•ì‹ ì²­ ì¼ê´„ íŒŒì¼ ì„ íƒ</label>
                        <input type="file" id="bulk-enrollment-file" accept=".xlsx,.xls"
                            class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                    </div>
                    <button type="button" id="bulk-upload-btn" disabled
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">ì¼ê´„ ë“±ë¡ ì‹¤í–‰</button>
                </div>
                <div id="bulk-upload-status" class="mt-4 text-sm"></div>
            </div>
        </div>
        <!-- 4. Student Dashboard -->
        <div id="tab-dashboard" class="tab-content hidden">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><button onclick="openClassRoster()"
                    class="p-4 rounded-lg shadow-md bg-gradient-to-br from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-lg">í•™ê¸‰ë³„ ì‹ ì²­ í˜„í™© ì¡°íšŒ</h3>
                        <p class="text-sm opacity-90">ë°˜ë³„ ëª…ë ¬í‘œ ë° ì‹ ì²­ ìƒíƒœ í™•ì¸</p>
                    </div><span class="text-2xl">ğŸ“‹</span>
                </button>
                <div class="theme-card p-4 rounded-lg shadow-md border theme-border flex items-center justify-between">
                    <div>
                        <h3 class="font-bold theme-text">ì „ì²´ ì œì¶œ í˜„í™©</h3>
                        <p class="text-sm theme-text-muted" id="total-submissions-count">0ëª…
                            ì œì¶œë¨</p>
                    </div><button onclick="loadStudentData()"
                        class="text-blue-600 hover:underline text-sm">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
            <!-- Visual Stats Section -->
            <div id="course-stats-container" class="mb-6 hidden">
                <div class="theme-card p-4 rounded-lg shadow-md border theme-border">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold theme-text text-lg">ê³¼ëª©ë³„ ìˆ˜ê°•ì‹ ì²­ í˜„í™©</h3><button
                            onclick="document.getElementById('course-stats-container').classList.add('hidden')"
                            class="text-gray-500 hover:text-gray-700">ì ‘ê¸°</button>
                    </div>
                    <div id="course-stats-grid"
                        class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                        <!-- Stats will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2"><select id="filter-grade" class="p-2 border rounded">
                        <option value="">ì „ì²´ í•™ë…„</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                    </select><select id="filter-class" class="p-2 border rounded">
                        <option value="">ì „ì²´ ë°˜</option>
                        <!-- Options will be populated dynamically -->
                    </select><button id="refresh-data-btn" class="px-3 py-2 rounded hover:bg-gray-300"
                        style="background-color: var(--hover-bg)">ğŸ”„</button></div>
                <!-- Visual Stats Buttons -->
                <div class="flex gap-2"><button onclick="deleteSelectedStudents()" id="delete-selected-btn"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button><button
                        onclick="openIndividualStats()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ğŸ“Š
                        ê°œì¸ë³„ í†µê³„</button><button onclick="openClassStatistics()"
                        class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">ğŸ“ˆ
                        í•™ê¸‰ í†µê³„</button><button id="download-matrix-btn"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ì—‘ì…€
                        ë‹¤ìš´ë¡œë“œ (í•™ìƒì„ íƒ)</button></div>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md theme-card">
                <table class="w-full text-sm text-left">
                    <thead class="uppercase" style="background-color: var(--hover-bg); color: var(--text-muted)">
                        <tr>
                            <th class="px-4 py-3 text-center w-10">
                                <input type="checkbox" id="select-all-students" onchange="toggleAllStudents(this)">
                            </th>
                            <th class="px-4 py-3">ì‹œê°„</th>
                            <th class="px-4 py-3">í•™ë²ˆ</th>
                            <th class="px-4 py-3">ì´ë¦„</th>
                            <th class="px-4 py-3">ì§„ë¡œ</th>
                            <th class="px-4 py-3">ì´ í•™ì </th>
                            <th class="px-4 py-3">ê²€ì¦ ê²°ê³¼</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="7" class="px-4 py-4 text-center theme-text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”
                                ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- Class Lookup Modal -->
    <div id="class-lookup-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2 theme-border">
                <h2 class="text-xl font-bold theme-text">ê°œì¸ë³„ í†µê³„ ë° í•™ê¸‰ ì‹ ì²­ í˜„í™©</h2><button onclick="closeIndividualStats()"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;
                </button>
            </div>
            <div class="flex gap-4 mb-4"><select id="modal-select-grade" class="p-2 border rounded"
                    onchange="populateStudentNumberOptions()">
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                </select><select id="modal-select-class" class="p-2 border rounded"
                    onchange="populateStudentNumberOptions()">
                    <!-- Options populated by JS -->
                </select><select id="modal-select-number" class="p-2 border rounded min-w-[200px] w-auto">
                    <option value="all">ì „ì²´</option>
                    <!-- Options populated by JS -->
                </select><button onclick="renderIndividualStatsTable()"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì¡°íšŒ</button>
            </div>
            <div id="class-stats-content"
                class="bg-white p-4 rounded border min-h-[300px] overflow-auto dark:text-black">
                <div class="text-center text-gray-500 py-10">í•™ë…„ê³¼ ë°˜ì„ ì„ íƒí•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            </div>
        </div>
    </div>
    <!-- ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ê³¼ëª© ì •ë³´ íŒì—… -->
    <div id="joint-course-info-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[60]"
        onclick="if(event.target===this)closeJointCourseInfoModal()">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col m-4"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-3 border-b theme-border flex-none">
                <h3 class="font-bold theme-text text-sm">ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ê³¼ëª© ì •ë³´</h3>
                <button onclick="closeJointCourseInfoModal()" class="text-gray-500 hover:text-gray-700 text-xl leading-none">&times;</button>
            </div>
            <div id="joint-course-info-body" class="p-3 overflow-auto flex-1 text-xs"></div>
        </div>
    </div>
    <!-- Class Statistics Dashboard Modal (New) -->
    <div id="class-stats-dashboard-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg max-w-6xl w-full h-[90vh] shadow-2xl flex flex-col overflow-hidden">
            <!-- Header (Fixed) -->
            <div class="flex justify-between items-center p-6 border-b theme-border flex-none">
                <h2 class="text-xl font-bold theme-text">ğŸ“ˆ í•™ê¸‰ í†µê³„ ëŒ€ì‹œë³´ë“œ</h2><button
                    onclick="document.getElementById('class-stats-dashboard-modal').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;
                </button>
            </div>
            <!-- Controls (Fixed) -->
            <div class="flex gap-4 px-6 py-4 flex-none bg-gray-50 dark:bg-gray-900 border-b theme-border">
                <select id="dashboard-select-grade" class="p-2 border rounded">
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                </select><select id="dashboard-select-class" class="p-2 border rounded">
                    <!-- JS populated -->
                </select><button onclick="renderClassStatsDashboard()"
                    class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">í†µê³„ ì¡°íšŒ</button>
            </div>
            <!-- Message (Centered) -->
            <div id="dashboard-message" class="text-center text-gray-500 py-20 flex-1 flex items-center justify-center">
                <p>í•™ë…„ê³¼ ë°˜ì„ ì„ íƒí•˜ê³  [í†µê³„ ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
            <!-- Dashboard Content Container (Flex Column) -->
            <div id="dashboard-content" class="flex-1 flex flex-col overflow-hidden hidden">
                <!-- Tabs (Sticky) -->
                <div class="flex-none px-6 pt-4 border-b theme-border bg-white dark:bg-gray-800">
                    <div id="dashboard-tabs" class="flex gap-4">
                        <!-- Injected via JS -->
                    </div>
                </div>
                <!-- Tab Content (Scrollable) -->
                <div id="dashboard-tab-content"
                    class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-gray-50 dark:bg-gray-900">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>
    <script> // Global Variables
        let allStudentData = [];
        let allCourseData = []; // Store course config globaly for Excel sorting

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'share') updateShareLink();
            if (tabName === 'dashboard') loadStudentData();
            if (tabName === 'rules') loadRulesAndClassification();
            if (tabName === 'bulk') initBulkTab();
        }

        // 1. System Config
        function loadConfig() {
            const savedUrl = localStorage.getItem('gas_api_url');

            if (savedUrl) {
                document.getElementById('api-url').value = savedUrl;
                DB.init(savedUrl);
                loadCourseCount();
            }
        }

        document.getElementById('save-url-btn').addEventListener('click', () => {
            const url = document.getElementById('api-url').value.trim();
            if (!url) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            localStorage.setItem('gas_api_url', url);
            DB.init(url);
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCourseCount();
        });

        document.getElementById('test-connection-btn').addEventListener('click', async () => {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const result = await DB.fetchConfig();

                if (Array.isArray(result)) {
                    statusEl.textContent = `ì—°ê²° ì„±ê³µ ! (ê³¼ëª© ìˆ˜: ${result.length
                        })`;
                    statusEl.className = 'mt-4 text-sm text-green-600';
                }

                else {
                    throw new Error('Invalid response');
                }
            }

            catch (e) {
                statusEl.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // 2. Course Data & Registry
        async function loadCourseCount() {
            if (!DB.isConfigured()) return;

            try {
                const [courses, jointCurriculum, recommendedCourses] = await Promise.all([
                    DB.fetchConfig(),
                    DB.fetchJointCurriculum ? DB.fetchJointCurriculum().catch(() => []) : [],
                    DB.fetchRecommendedCourses ? DB.fetchRecommendedCourses().catch(() => []) : []
                ]);
                allCourseData = courses || [];
                document.getElementById('current-course-count').textContent = courses ? courses.length : 0;
                const jointEl = document.getElementById('current-joint-curriculum-count');
                if (jointEl) jointEl.textContent = Array.isArray(jointCurriculum) ? jointCurriculum.length : 0;
                const recEl = document.getElementById('current-recommended-courses-count');
                if (recEl) recEl.textContent = Array.isArray(recommendedCourses) ? recommendedCourses.length : 0;
            } catch (e) {
                console.error('Failed to load course count', e);
            }
        }

        document.getElementById('refresh-course-btn').addEventListener('click', loadCourseCount);

        document.getElementById('upload-course-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('course-excel-file');
            const file = fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const jsonData = await ExcelHandler.readExcel(file);

                // Standardize keys (required field mostly)
                // Map Korean headers to English keys
                const headerMap = {
                    'ê³¼ëª©ëª…': 'subjectName',
                    'ì˜ë¬¸ID': 'slug',
                    'slug': 'slug', // Support both
                    'ì˜ë¬¸id': 'slug',
                    'í•™ë…„': 'grade',
                    'í•™ê¸°': 'semester',
                    'í•™ì ': 'credits',
                    'êµê³¼êµ°': 'category',
                    'ì„¸ë¶€êµê³¼': 'subCategory',
                    'í•„ìˆ˜ì—¬ë¶€': 'required',
                    'ê°œì„¤ì—¬ë¶€': 'offered',
                    'ì„ ìˆ˜ê³¼ëª©': 'prerequisites'
                }

                    ;

                const processed = jsonData.map(row => {
                    const newRow = {}

                        ;

                    Object.keys(row).forEach(key => {
                        const cleanKey = key.trim();
                        const mappedKey = headerMap[cleanKey] || headerMap[cleanKey.toLowerCase()] || cleanKey;
                        newRow[mappedKey] = row[key];
                    });

                    // Standard Schema Keys
                    const standardKeys = ['subjectName', 'slug', 'grade', 'semester', 'credits',
                        'category', 'subCategory', 'required', 'offered', 'prerequisites'
                    ];

                    // Ensure all standard keys exist
                    standardKeys.forEach(k => {
                        if (newRow[k] === undefined) newRow[k] = '';
                    });

                    // Normalize required field
                    if (newRow.required !== undefined && newRow.required !== '') {
                        const v = String(newRow.required).toUpperCase();
                        newRow.required = (v === 'TRUE' || v === 'YES' || v === '1' || newRow.required === true);
                    }

                    else {
                        newRow.required = false;
                    }

                    if (newRow.offered !== undefined && newRow.offered !== '') {
                        const v = String(newRow.offered).toUpperCase();
                        newRow.offered = (v === 'TRUE' || v === 'YES' || v === '1' || newRow.offered === true);
                    }

                    else {
                        newRow.offered = true;
                    }

                    // Generate Slug if missing
                    if (!newRow.slug && newRow.subjectName) {
                        // Simple fallback slug generation (not perfect but better than nothing)
                        // Ideally user provides slug.
                    }

                    return newRow;
                });

                const result = await DB.saveConfig(processed);

                if (result.status === 'success') {
                    statusEl.textContent = 'ì—…ë¡œë“œ ì„±ê³µ!';
                    statusEl.className = 'mt-4 text-sm text-green-600';
                    loadCourseCount();
                }

                else {
                    throw new Error('Upload failed');
                }
            }

            catch (e) {
                statusEl.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // Registry Upload
        document.getElementById('upload-registry-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('registry-excel-file');
            const file = fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('registry-upload-status');
            statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const jsonData = await ExcelHandler.readExcel(file);

                // Check if data has ID and Name
                if (jsonData.length === 0 || !jsonData[0].hasOwnProperty('í•™ë²ˆ') || !jsonData[0].hasOwnProperty('ì´ë¦„')) {
                    throw new Error('ì˜¬ë°”ë¥¸ ì—‘ì…€ ì„œì‹ì´ ì•„ë‹™ë‹ˆë‹¤. "í•™ë²ˆ"ê³¼ "ì´ë¦„" ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }

                // Send to server
                if (DB.saveRegistry) {
                    const result = await DB.saveRegistry(jsonData);

                    if (result.status === 'success') {
                        statusEl.textContent = 'í•™ì  ì •ë³´ ì—…ë¡œë“œ ì„±ê³µ!';
                        statusEl.className = 'mt-4 text-sm text-green-600';
                    }

                    else {
                        throw new Error(result.message || 'Upload failed');
                    }
                }

                else {
                    throw new Error('DB.saveRegistry ê¸°ëŠ¥ì´ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. server.gsë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.');
                }

            }

            catch (e) {
                statusEl.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // ê³µë™êµìœ¡ê³¼ì • ì—…ë¡œë“œ
        document.getElementById('upload-joint-curriculum-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('joint-curriculum-excel-file');
            const file = fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            if (!DB.isConfigured()) return alert('API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('joint-curriculum-upload-status');
            statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const jsonData = await ExcelHandler.readExcel(file);
                if (jsonData.length === 0) throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                const targetKeys = ['ë¶„ë¥˜','ê±°ì í•™êµ','ê³¼ëª©ëª…','slug','ì„¸ë¶€êµê³¼','êµê³¼í¸ì œ','í•™ë…„','í•™ê¸°','í•™ì ','ìš´ì˜ì¼ì‹œ','ì„ ì´ìˆ˜ê³¼ëª©'];
                const altMap = { subjectName:'ê³¼ëª©ëª…', subCategory:'ì„¸ë¶€êµê³¼', grade:'í•™ë…„', semester:'í•™ê¸°', credits:'í•™ì ', prerequisites:'ì„ ì´ìˆ˜ê³¼ëª©' };
                const mapped = jsonData.map(row => {
                    const out = {};
                    targetKeys.forEach(k => {
                        out[k] = row[k] ?? row[altMap[k]] ?? '';
                    });
                    return out;
                });
                const result = await DB.saveJointCurriculum(mapped);
                if (result && result.status === 'success') {
                    statusEl.textContent = 'ê³µë™êµìœ¡ê³¼ì • ì—…ë¡œë“œ ì„±ê³µ! (' + mapped.length + 'ê±´)';
                    statusEl.className = 'mt-4 text-sm text-green-600';
                } else throw new Error(result?.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            } catch (e) {
                statusEl.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // í•™ê³¼ë³„ ê¶Œì¥ê³¼ëª© ì—…ë¡œë“œ
        document.getElementById('upload-recommended-courses-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('recommended-courses-excel-file');
            const file = fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            if (!DB.isConfigured()) return alert('API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
            const statusEl = document.getElementById('recommended-courses-upload-status');
            statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';
            try {
                const jsonData = await ExcelHandler.readExcel(file);
                if (jsonData.length === 0) throw new Error('ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                const targetKeys = ['ì¶œì²˜', 'í•™ê³¼', 'í•µì‹¬ ê¶Œì¥ê³¼ëª©', 'ê¶Œì¥ê³¼ëª©'];
                const altMap = { source: 'ì¶œì²˜', major: 'í•™ê³¼', core: 'í•µì‹¬ ê¶Œì¥ê³¼ëª©', recommended: 'ê¶Œì¥ê³¼ëª©' };
                const mapped = jsonData.map(row => {
                    const out = {};
                    targetKeys.forEach(k => { out[k] = row[k] ?? row[altMap[k]] ?? ''; });
                    return out;
                });
                const result = await DB.saveRecommendedCourses(mapped);
                if (result && result.status === 'success') {
                    statusEl.textContent = 'ê¶Œì¥ê³¼ëª© ì—…ë¡œë“œ ì„±ê³µ! (' + mapped.length + 'ê±´)';
                    statusEl.className = 'mt-4 text-sm text-green-600';
                    loadCourseCount();
                } else throw new Error(result?.message || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
            } catch (e) {
                statusEl.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // 2.5 Selection Rules (Advanced)
        let currentRules = {
            '2-1': [], '2-2': [], '3-1': [], '3-2': []
        }

            ;

        let currentMultiRules = {};
        let allowMultiSemesterDuplicate = false;

        async function loadRulesAndClassification() {
            if (!DB.isConfigured()) return;

            // Show Loading
            const container = document.getElementById('course-classification-view');
            const limitContainer = document.getElementById('limit-config-container');
            if (container) container.innerHTML = '<div class="text-center py-4 text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            if (limitContainer) limitContainer.innerHTML = '<div class="text-center py-4 text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            // 1. Fetch Data First (Parallel)
            let courses = [];

            let settings = {}

                ;

            try {

                [courses,
                    settings] = await Promise.all([DB.fetchConfig(),
                    DB.fetchSettings().catch(() => ({}))]);
                allCourseData = courses || []; // Update global cache
            }

            catch (e) {
                console.error('Data load failed', e);
                return;
            }

            if (!courses) return;

            // 2. Update State
            if (settings && settings.selectionRules) {
                currentRules = settings.selectionRules;
            }

            if (settings && settings.multiSemesterRules) {
                currentMultiRules = settings.multiSemesterRules;
            }
            if (settings && settings.allowMultiSemesterDuplicate !== undefined) {
                allowMultiSemesterDuplicate = !!settings.allowMultiSemesterDuplicate;
            } else {
                allowMultiSemesterDuplicate = false;
            }

            // 3. Render Classification
            container.innerHTML = '';

            const grouped = {}

                ;

            courses.forEach(c => {
                const key = `${c.grade}-${c.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(c);
            });

            Object.keys(grouped).sort().forEach(key => {
                const [g, s] = key.split('-');
                const groupCourses = grouped[key];

                const section = document.createElement('div');
                section.className = 'border p-4 rounded bg-opacity-50';
                section.style.borderColor = 'var(--border-color)';
                section.style.backgroundColor = 'var(--hover-bg)';

                section.innerHTML = ` <h3 class="font-bold mb-2 theme-text" >${g
                    }

                í•™ë…„ ${s
                    }

                í•™ê¸° (${groupCourses.length
                    }

                    ê³¼ëª©)</h3> <div class="flex flex-wrap gap-2" > ${groupCourses.map(c => ` <span class="text-xs px-2 py-1 rounded border ${c.required ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-gray-700 border-gray-200'}" title = "${c.subjectName}" > ${c.id || c.subjectName
                        }

                        (${c.credits
                        }) </span > `).join('')
                    }

                </div> `;
                container.appendChild(section);
            });

            // 4. Render Limit Config (Advanced)
            limitContainer.innerHTML = ''; // Clear immediately before appending

            ['2-1',
                '2-2',
                '3-1',
                '3-2'].forEach(key => {
                    const [g, s] = key.split('-');

                    const wrapper = document.createElement('div');
                    wrapper.className = 'border p-4 rounded';
                    wrapper.style.borderColor = 'var(--border-color)';

                    wrapper.innerHTML = ` <div class="flex justify-between items-center mb-3" > <h4 class="font-bold theme-text" >${g
                        }

                í•™ë…„ ${s
                        }

                í•™ê¸°</h4> <button onclick="addRule('${key}')" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700" >+ ê·œì¹™ ì¶”ê°€</button> </div> <div id="rules-list-${key}" class="space-y-2" > <!-- Rules will be added here --> </div> `;
                    limitContainer.appendChild(wrapper);
                    renderRulesList(key);
                });

            // 5. Render Multi-Semester Course Config
            renderMultiSemesterConfig(courses, settings);
        }

        function renderMultiSemesterConfig(courses, settings) {
            const container = document.getElementById('multi-semester-config-container');
            if (!container) return;

            container.innerHTML = ` <div class="mb-4 p-3 bg-gray-50 rounded border"><h4 class="font-bold text-sm mb-2 theme-text">ë³µìˆ˜ í¸ì œ ê³µí†µ ì„¤ì •</h4><label class="flex items-center gap-2 text-sm cursor-pointer theme-text mb-3"><input type="checkbox" id="allow-multi-semester-duplicate" ${allowMultiSemesterDuplicate ? 'checked' : ''} onchange="updateAllowMultiSemesterDuplicate(this.checked)" class="form-checkbox h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"> <span>ëª¨ë“  ë³µìˆ˜ í¸ì œ ê³¼ëª©ì— ëŒ€í•´ ì¤‘ë³µ ì‹ ì²­ í—ˆìš©</span></label><p class="text-xs theme-text-muted mb-4">ì²´í¬í•˜ë©´ ë™ì¼ ê³¼ëª©ì„ ì—¬ëŸ¬ í•™ê¸°ì— ì¤‘ë³µ ì‹ ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•´ì œí•˜ë©´ í•™ê¸°ë‹¹ í•œ ë²ˆë§Œ ì„ íƒë©ë‹ˆë‹¤.</p><h4 class="font-bold text-sm mb-2 theme-text">ìƒˆë¡œìš´ ë³µìˆ˜ í¸ì œ ê·¸ë£¹ ì¶”ê°€</h4><div class="flex flex-col gap-2"><div class="flex gap-2"><select id="multi-course-select" class="flex-1 p-2 border rounded text-sm"><option value="">ê³¼ëª© ì„ íƒ...</option>${[...new Set(courses.map(c => c.subjectName))].sort().map(name => `<option value = "${name}" > ${name
                }

                </option > `).join('')
                }

        </select><button onclick="addMultiSemesterGroup()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">ì¶”ê°€</button></div><div class="text-xs text-gray-500">* ë™ì¼í•œ ê³¼ëª©ëª…ì´ ì—¬ëŸ¬ í•™ê¸°ì— ê°œì„¤ëœ ê²½ìš°,
        ì•„ë˜ ëª©ë¡ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. * ìˆ˜ë™ìœ¼ë¡œ ê·¸ë£¹ì„ ì¶”ê°€í•˜ë ¤ë©´ ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”. </div></div></div><div id="multi-semester-list" class="space-y-2"></div>`;

            const listEl = document.getElementById('multi-semester-list');

            // 1. Automatic Detection (Name-based) & ID Mapping
            const nameMap = {}

                ;

            const nameToIds = {}

                ;

            courses.forEach(c => {
                if (!nameMap[c.subjectName]) {
                    nameMap[c.subjectName] = new Set();
                    nameToIds[c.subjectName] = new Set();
                }

                nameMap[c.subjectName].add(`${c.grade}-${c.semester}`);
                nameToIds[c.subjectName].add(c.id || c.subjectName);
            });

            // 2. Merge with Manual Settings
            let multiRules = settings.multiSemesterRules || {}

                ;

            // Combine automatic and manual
            const allSubjects = new Set([...Object.keys(nameMap), ...Object.keys(multiRules)]);
            const sortedSubjects = [...allSubjects].sort();

            // Populate Dropdown with IDs
            const selectEl = document.getElementById('multi-course-select');

            selectEl.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ...</option>' + sortedSubjects.map(name => {
                const ids = nameToIds[name] ? [...nameToIds[name]].join(', ') : name;

                return `<option value="${name}" >${ids
                    }

                </option>`;
            }).join('');

            sortedSubjects.forEach(name => {
                const autoSemesters = nameMap[name] ? [...nameMap[name]] : [];
                const manualSemesters = multiRules[name] || [];
                const ids = nameToIds[name] ? [...nameToIds[name]].join(', ') : name;

                // If no duplicates and no manual rule, skip
                if (autoSemesters.length < 2 && manualSemesters.length === 0) return;

                const allSemesters = [...new Set([...autoSemesters, ...manualSemesters])].sort();
                const nameEscaped = (name || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");

                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-white hover:bg-gray-50 transition-colors';
                div.style.borderColor = 'var(--border-color)';
                div.style.backgroundColor = 'var(--card-bg)';

                div.innerHTML = ` <div class="flex justify-between items-start mb-2" > <div> <span class="font-bold theme-text" >${ids
                    }

                </span> </div> <button onclick="deleteMultiRule('${nameEscaped}')" class="text-xs text-red-500 hover:text-red-700" >ì´ˆê¸°í™”</button> </div> <div class="flex flex-wrap gap-2" > ${['1-1', '1-2', '2-1', '2-2', '3-1', '3-2'].map(sem => {
                        const isAuto = autoSemesters.includes(sem);
                        const isChecked = allSemesters.includes(sem);
                        return ` <label class="flex items-center space-x-1 text-xs cursor-pointer" > <input type="checkbox"
                            value="${sem}"

                            ${isChecked ? 'checked' : ''
                            }

                            ${isAuto ? 'disabled' : ''
                            }

                            onchange="updateMultiRule('${nameEscaped}', '${sem}', this.checked)"

                            class="form-checkbox h-3 w-3 text-blue-600 rounded border-gray-300 focus:ring-blue-500" > <span class="${isChecked ? 'text-blue-600 font-medium' : 'text-gray-500'}" >${sem
                            }

                            </span> </label> `;
                    }).join('')
                    }

                </div> `;
                listEl.appendChild(div);
            });
        }

        window.updateAllowMultiSemesterDuplicate = (checked) => {
            allowMultiSemesterDuplicate = !!checked;
            saveMultiRules();
        };

        window.addMultiSemesterGroup = () => {
            const select = document.getElementById('multi-course-select');
            const name = select.value;
            if (!name) return alert('ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            if (!currentMultiRules[name]) currentMultiRules[name] = [];
            saveMultiRules();
        }

            ;

        window.updateMultiRule = (name, semester, isChecked) => {
            if (!currentMultiRules[name]) currentMultiRules[name] = [];

            if (isChecked) {
                if (!currentMultiRules[name].includes(semester)) {
                    currentMultiRules[name].push(semester);
                }
            }

            else {
                currentMultiRules[name] = currentMultiRules[name].filter(s => s !== semester);
            }

            saveMultiRules();
        }

            ;

        window.deleteMultiRule = (name) => {
            if (confirm(`'${name}' ì˜ ìˆ˜ë™ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìë™ ê°ì§€ëœ í¸ì œëŠ” ìœ ì§€ë©ë‹ˆë‹¤)`)) {
                delete currentMultiRules[name];
                saveMultiRules();
            }
        }

            ;

        async function saveMultiRules() {
            try {
                const settings = await DB.fetchSettings() || {};
                await DB.saveSettings({
                    ...settings,
                    multiSemesterRules: currentMultiRules,
                    allowMultiSemesterDuplicate: allowMultiSemesterDuplicate
                });
                loadRulesAndClassification();
            }

            catch (e) {
                console.error('Failed to save multi rules', e);
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        }

        function renderRulesList(key) {
            const listEl = document.getElementById(`rules-list-${key}`);
            listEl.innerHTML = '';

            if (!currentRules[key] || currentRules[key].length === 0) {
                listEl.innerHTML = '<div class="text-xs text-gray-400 italic">ì„¤ì •ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            currentRules[key].forEach((rule, idx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 text-sm';

                row.innerHTML = ` <select onchange="updateRule('${key}', ${idx}, 'credits', this.value)" class="p-1 border rounded w-24" > <option value="all"${rule.credits === 'all' ? 'selected' : ''
                    }

                >ëª¨ë“  í•™ì </option> <option value="4"${rule.credits == 4 ? 'selected' : ''
                    }

                >4í•™ì </option> <option value="3"${rule.credits == 3 ? 'selected' : ''
                    }

                >3í•™ì </option> <option value="2"${rule.credits == 2 ? 'selected' : ''
                    }

                >2í•™ì </option> <option value="1"${rule.credits == 1 ? 'selected' : ''
                    }

                >1í•™ì </option> </select> <span class="theme-text" >ê³¼ëª©ì„</span> <select onchange="updateRule('${key}', ${idx}, 'count', this.value)" class="p-1 border rounded w-16" > ${[...Array(10).keys()].map(i => `<option value = "${i + 1}"${rule.count == i + 1 ? 'selected' : ''
                        }

                        > ${i + 1
                        }

                        </option > `).join('')
                    }

                </select> <span class="theme-text" >ê°œ ì„ íƒ</span> <button onclick="removeRule('${key}', ${idx})" class="text-red-500 hover:text-red-700 ml-auto" >Ã—</button> `;
                listEl.appendChild(row);
            });
        }

        window.addRule = (key) => {
            if (!currentRules[key]) currentRules[key] = [];

            currentRules[key].push({
                credits: 'all', count: 1
            });
            renderRulesList(key);
        }

            ;

        window.removeRule = (key, idx) => {
            currentRules[key].splice(idx, 1);
            renderRulesList(key);
        }

            ;

        window.updateRule = (key, idx, field, value) => {
            currentRules[key][idx][field] = value;
        }

            ;

        document.getElementById('save-rules-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-rules-btn');
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                const settings = await DB.fetchSettings() || {};
                await DB.saveSettings({
                    ...settings,
                    selectionRules: currentRules
                });
                alert('ê·œì¹™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            catch (e) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
            }

            finally {
                btn.disabled = false;
                btn.textContent = 'ê·œì¹™ ì €ì¥';
            }
        });


        // 3. Share
        function updateShareLink() {
            const container = document.getElementById('share-container');
            const errorMsg = document.getElementById('share-error');
            const savedUrl = localStorage.getItem('gas_api_url');

            if (!savedUrl) {
                container.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            errorMsg.classList.add('hidden');

            // í•™ìƒ ìˆ˜ê°•ì‹ ì²­ í˜ì´ì§€ URL: í˜„ì¬ì™€ ê°™ì€ ê²½ë¡œì—ì„œ admin.html ëŒ€ì‹  index.htmlë¡œ
            const origin = window.location.origin;
            const pathname = window.location.pathname || '/';
            const basePath = pathname.replace(/\/[^/]*$/, '/') + 'index.html';
            const baseUrl = origin + basePath;
            const encodedKey = btoa(savedUrl);

            const fullLink = `${baseUrl}?key=${encodedKey}`;

            document.getElementById('share-link-text').textContent = fullLink;
            QRCodeGenerator.generate('qrcode', fullLink, 256);

            document.getElementById('copy-link-btn').onclick = () => {
                navigator.clipboard.writeText(fullLink).then(() => alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
            }

                ;
        }

        // 3.5 Bulk Enrollment
        function initBulkTab() {
            document.getElementById('bulk-enrollment-file').value = '';
            document.getElementById('bulk-upload-btn').disabled = true;
            document.getElementById('bulk-upload-status').textContent = '';
            document.getElementById('bulk-download-template-btn').onclick = downloadBulkEnrollmentTemplate;
            document.getElementById('bulk-enrollment-file').onchange = function () {
                document.getElementById('bulk-upload-btn').disabled = !this.files || !this.files[0];
            };
            document.getElementById('bulk-upload-btn').onclick = runBulkEnrollmentUpload;
        }

        async function downloadBulkEnrollmentTemplate() {
            if (!DB.isConfigured()) {
                alert('ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ API URLì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            try {
                const courses = await DB.fetchConfig() || [];
                const optionalOnly = courses.filter(c => {
                    const name = (c.subjectName || c.ê³¼ëª©ëª… || '').toString().trim();
                    if (!name) return false;
                    const req = c.required !== undefined && c.required !== null
                        ? (String(c.required).toUpperCase() === 'TRUE' || c.required === true || c.required === 1) : false;
                    return !req;
                });
                optionalOnly.sort((a, b) => {
                    const g1 = parseInt(a.grade || a.í•™ë…„ || 0, 10);
                    const g2 = parseInt(b.grade || b.í•™ë…„ || 0, 10);
                    if (g1 !== g2) return g1 - g2;
                    const s1 = parseInt(a.semester || a.í•™ê¸° || 0, 10);
                    const s2 = parseInt(b.semester || b.í•™ê¸° || 0, 10);
                    return s1 - s2;
                });
                ExcelHandler.downloadBulkEnrollmentTemplate(optionalOnly);
            } catch (e) {
                alert('ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        async function runBulkEnrollmentUpload() {
            const fileInput = document.getElementById('bulk-enrollment-file');
            const file = fileInput && fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            if (!DB.isConfigured()) return alert('API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('bulk-upload-status');
            statusEl.textContent = 'íŒŒì¼ ì½ëŠ” ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const rows = await ExcelHandler.readExcelRaw(file);
                if (!rows || rows.length < 2) {
                    throw new Error('íŒŒì¼ì—ëŠ” ìµœì†Œ 1í–‰ í—¤ë”ì™€ 1í–‰ ì´ìƒì˜ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                }
                const headerRow = rows[0];
                const colA = 0, colB = 1, colC = 2;
                const subjectHeaders = [];
                for (let c = 3; c < headerRow.length; c++) {
                    const v = headerRow[c];
                    if (v != null && String(v).trim() !== '') subjectHeaders.push(String(v).trim());
                }
                if (subjectHeaders.length === 0) {
                    throw new Error('Dì—´ë¶€í„° ê³¼ëª©ëª…ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ìƒ˜í”Œ ì–‘ì‹ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                }

                let courses = allCourseData && allCourseData.length > 0 ? allCourseData : await DB.fetchConfig() || [];
                const optionalOnly = courses.filter(co => {
                    const name = (co.subjectName || co.ê³¼ëª©ëª… || '').toString().trim();
                    if (!name) return false;
                    const req = co.required !== undefined && co.required !== null
                        ? (String(co.required).toUpperCase() === 'TRUE' || co.required === true || co.required === 1) : false;
                    return !req;
                });
                optionalOnly.sort((a, b) => {
                    const g1 = parseInt(a.grade || a.í•™ë…„ || 0, 10);
                    const g2 = parseInt(b.grade || b.í•™ë…„ || 0, 10);
                    if (g1 !== g2) return g1 - g2;
                    const s1 = parseInt(a.semester || a.í•™ê¸° || 0, 10);
                    const s2 = parseInt(b.semester || b.í•™ê¸° || 0, 10);
                    return s1 - s2;
                });
                // SelectedCoursesì— í•™ë…„-í•™ê¸° êµ¬ë¶„ì´ ë˜ë„ë¡ ì €ì¥ (slugë§Œ ìˆìœ¼ë©´ ë™ì¼ ê³¼ëª© ì—¬ëŸ¬ í•™ê¸°ê°€ êµ¬ë¶„ ì•ˆ ë¨)
                const headerToId = {};
                optionalOnly.forEach((co, idx) => {
                    const name = (co.subjectName || co.ê³¼ëª©ëª… || '').toString().trim();
                    const g = co.grade ?? co.í•™ë…„ ?? '';
                    const s = co.semester ?? co.í•™ê¸° ?? '';
                    const header = `${name} (${g}-${s})`;
                    const idAlreadyHasSemester = co.id && (String(co.id).match(/\d+-\d+/) || String(co.id).split('-').length >= 3);
                    headerToId[header] = (co.id && idAlreadyHasSemester)
                        ? co.id
                        : `${name}-${g}-${s}-${idx}`.replace(/\s+/g, '-');
                });
                const nameToId = {};
                optionalOnly.forEach((co, idx) => {
                    const name = (co.subjectName || co.ê³¼ëª©ëª… || '').toString().trim();
                    if (!name) return;
                    const idAlreadyHasSemester = co.id && (String(co.id).match(/\d+-\d+/) || String(co.id).split('-').length >= 3);
                    nameToId[name] = (co.id && idAlreadyHasSemester)
                        ? co.id
                        : `${name}-${co.grade ?? co.í•™ë…„ ?? ''}-${co.semester ?? co.í•™ê¸° ?? ''}-${idx}`.replace(/\s+/g, '-');
                });

                const toSubmit = [];
                for (let r = 1; r < rows.length; r++) {
                    const row = rows[r];
                    const sid = row[colA] != null ? String(row[colA]).trim() : '';
                    const name = row[colB] != null ? String(row[colB]).trim() : '';
                    const major = row[colC] != null ? String(row[colC]).trim() : '';
                    if (!sid || sid.length !== 5) continue;
                    const grade = parseInt(sid[0], 10);
                    const classNum = sid.substring(1, 3);
                    const num = sid.substring(3, 5);
                    const selectedIds = [];
                    for (let c = 0; c < subjectHeaders.length; c++) {
                        const cell = row[3 + c];
                        const v = cell != null ? String(cell).trim() : '0';
                        if (v !== '1' && v !== 1) continue;
                        const header = subjectHeaders[c];
                        let id = headerToId[header];
                        if (id == null && c < optionalOnly.length) {
                            const co = optionalOnly[c];
                            const n = (co.subjectName || co.ê³¼ëª©ëª… || '').toString().trim();
                            const hasSemester = co.id && (String(co.id).match(/\d+-\d+/) || String(co.id).split('-').length >= 3);
                            id = (co.id && hasSemester) ? co.id : `${n}-${co.grade ?? ''}-${co.semester ?? ''}-${c}`.replace(/\s+/g, '-');
                        }
                        if (id == null) id = nameToId[header] || header;
                        if (id) selectedIds.push(id);
                    }
                    toSubmit.push({
                        Grade: grade,
                        Class: classNum,
                        Number: num,
                        Name: name,
                        Major: major,
                        SelectedCourses: selectedIds.join(', '),
                        JointCourses: '',
                        TotalCredits: '',
                        ValidationResult: '',
                        AiRecommendation: ''
                    });
                }
                if (toSubmit.length === 0) {
                    statusEl.textContent = 'ë“±ë¡í•  ìœ íš¨í•œ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•™ë²ˆì€ 5ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.';
                    statusEl.className = 'mt-4 text-sm text-amber-600';
                    return;
                }

                statusEl.textContent = `ì´ ${toSubmit.length}ëª… ì œì¶œ ì¤‘...`;
                let ok = 0, fail = 0;
                for (const data of toSubmit) {
                    try {
                        await DB.submitResponse(data);
                        ok++;
                    } catch (err) {
                        fail++;
                        console.warn('Submit failed for', data.Number, data.Name, err);
                    }
                }
                statusEl.textContent = `ì™„ë£Œ: ì„±ê³µ ${ok}ëª…, ì‹¤íŒ¨ ${fail}ëª… (ì´ ${toSubmit.length}ëª…)`;
                statusEl.className = fail > 0 ? 'mt-4 text-sm text-amber-600' : 'mt-4 text-sm text-green-600';
                loadStudentData();
            } catch (e) {
                statusEl.textContent = 'ì˜¤ë¥˜: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        }

        // 4. Dashboard
        function updateDashboardCounts() {
            // Count total submissions
            const count = allStudentData ? allStudentData.length : 0;
            const countEl = document.getElementById('total-submissions-count');

            if (countEl) countEl.textContent = `${count
                }

        ëª… ì œì¶œë¨`;
        }

        // Global Data
        // Global Data - Ensure these are initialized only once if they exist globally, but if 416 has it, we just use it.
        // If allStudentData is declared at 416, we don't redeclare here.
        // let allStudentData = []; // Removed to avoid conflict
        let registryData = [];

        async function loadStudentData() {
            if (!DB.isConfigured()) return;
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center theme-text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>';

            // Also ensure course data is loaded for headers
            if (allCourseData.length === 0) {
                try {
                    allCourseData = await DB.fetchConfig() || [];
                }

                catch (e) { }
            }

            // Parallel Fetch
            try {
                const [response,
                    registry] = await Promise.all([DB.fetchResponses(),
                    DB.fetchRegistry()]);

                // Handle Responses
                if (Array.isArray(response)) {
                    allStudentData = response;
                }

                else if (response && response.data) {
                    allStudentData = response.data;
                }

                else {
                    allStudentData = [];
                }

                // Handle Registry
                if (Array.isArray(registry)) {
                    registryData = registry;
                }

                else {
                    registryData = [];
                }

                updateDashboardCounts();

                document.getElementById('total-submissions-count').textContent = `${allStudentData.length
                    }

            ëª… ì œì¶œë¨`;
                renderStudentTable();
                updateClassFilter();
            }

            catch (e) {
                console.error("Failed to load data:", e);

                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message
                    }

            </td></tr>`;
            }
        }

        function renderStudentTable() {
            const tbody = document.getElementById('student-table-body');
            const gradeFilter = document.getElementById('filter-grade').value;
            const classFilter = document.getElementById('filter-class').value;

            if (!Array.isArray(allStudentData)) allStudentData = [];

            let filtered = allStudentData;
            if (gradeFilter) filtered = filtered.filter(d => String(d.Grade) === String(gradeFilter));
            if (classFilter) filtered = filtered.filter(d => String(d.Class) === String(classFilter));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center theme-text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // Sort: Grade -> Class -> Number
            filtered.sort((a, b) => {
                if (a.Grade !== b.Grade) return a.Grade - b.Grade;
                if (a.Class !== b.Class) return a.Class - b.Class;
                return a.Number - b.Number;
            });

            tbody.innerHTML = filtered.map(d => {
                const date = new Date(d.Timestamp).toLocaleString();
                const isValid = true; // Assuming valid for now
                // Use Timestamp as unique ID for deletion, fallback to Student ID string
                const uniqueId = d.Timestamp || `${d.Grade}-${d.Class}-${d.Number}`;

                return ` <tr class="border-b hover:bg-opacity-50" style="background-color: var(--card-bg); border-color: var(--border-color)" > <td class="px-4 py-2 text-center" > <input type="checkbox" class="student-checkbox" value="${uniqueId}" > </td> <td class="px-4 py-2 theme-text" >${date}</td> <td class="px-4 py-2 theme-text font-mono" >${d.Grade}${String(d.Class).padStart(2, '0')}${String(d.Number).padStart(2, '0')}</td> <td class="px-4 py-2 font-medium theme-text" >${d.Name}</td> <td class="px-4 py-2 theme-text" >${d.Major}</td> <td class="px-4 py-2 theme-text" >${d.TotalCredits}</td> <td class="px-4 py-2 text-green-600" >ì œì¶œì™„ë£Œ</td> </tr> `;
            }).join('');
        }

        // Bulk Delete Functions
        window.toggleAllStudents = (source) => {
            document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = source.checked);
        };

        window.deleteSelectedStudents = async () => {
            const selected = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return alert('ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            if (!confirm(`${selected.length}ëª…ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì£¼ì˜: ì„œë²„ ìŠ¤í¬ë¦½íŠ¸ê°€ ì‚­ì œ ê¸°ëŠ¥ì„ ì§€ì›í•´ì•¼ í•˜ë©°, ì§€ì›í•˜ì§€ ì•Šì„ ê²½ìš° ìƒˆë¡œê³ ì¹¨ ì‹œ ë‹¤ì‹œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)`)) return;

            try {
                const btn = document.getElementById('delete-selected-btn');
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'ì‚­ì œ ì¤‘...';
                }

                // Try server delete
                if (DB.deleteResponse) {
                    const res = await DB.deleteResponse(selected);
                    if (res && res.status === 'success') {
                        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadStudentData(); // Reload
                    } else {
                        throw new Error(res.message || 'Server error');
                    }
                } else {
                    // Local simulation if DB.deleteResponse undefined (should be defined now though)
                    allStudentData = allStudentData.filter(s => {
                        const uid = s.Timestamp || `${s.Grade}-${s.Class}-${s.Number}`;
                        return !selected.includes(String(uid));
                    });
                    renderStudentTable();
                    updateDashboardCounts();
                    alert('ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„œë²„ ë°˜ì˜ì„ ìœ„í•´ ìŠ¤í¬ë¦½íŠ¸ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                }
            } catch (e) {
                console.error('Delete failed', e);
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + e.message);
            } finally {
                const btn = document.getElementById('delete-selected-btn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ';
                }
            }
        };

        function updateClassFilter() {
            const classSelect = document.getElementById('filter-class');
            const classes = [...new Set(allStudentData.map(d => d.Class))].sort((a, b) => a - b);

            classSelect.innerHTML = '<option value="">ì „ì²´ ë°˜</option>' + classes.map(c => `<option value="${c}" >${c
                }

            ë°˜</option>`).join('');
        }

        document.getElementById('filter-grade').addEventListener('change', renderStudentTable);
        document.getElementById('filter-class').addEventListener('change', renderStudentTable);
        document.getElementById('refresh-data-btn').addEventListener('click', loadStudentData);

        // Excel Matrix Download (Enhanced)
        document.getElementById('download-matrix-btn').addEventListener('click', () => {
            if (!allStudentData || allStudentData.length === 0) return alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

            // 1. Prepare All Courses Columns (Sorted 2-1 ~ 3-2)
            // Filter: Grade 2 or 3, and NOT required (electives only)
            // Note: This assumes elective courses are only offered in grades 2-3
            // If your DB has electives in other grades, modify this filter accordingly
            const allCourses = allCourseData.filter(c => {
                // Check if course has required fields
                if (!c.subjectName) return false; // subjectName is required
                
                const isReq = (c.required === true || String(c.required).toLowerCase() === 'true');
                // Filter: Only non-required courses in grades 2-3
                // This matches the typical curriculum structure where electives start from grade 2
                return (c.grade == 2 || c.grade == 3) && !isReq;
            });

            // Sort: Grade -> Semester -> SubjectName
            allCourses.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                if (a.semester !== b.semester) return a.semester - b.semester;
                return a.subjectName.localeCompare(b.subjectName);
            });

            const headers = allCourses.map(c => c.subjectName); // Using Names for headers

            // Helper function: Convert SelectedCourses (slug format) to subject names
            const getSelectedSubjectNames = (selectedCoursesStr) => {
                if (!selectedCoursesStr) return new Set();
                
                const selectedNames = new Set();
                const courses = selectedCoursesStr.split(',').map(c => c.trim()).filter(c => c);
                
                courses.forEach(cName => {
                    const originalName = cName.trim();
                    if (!originalName) return;

                    // slug í˜•ì‹ ì²˜ë¦¬ (ì˜ˆ: "gongtonggwamog-1-1-0" -> "gongtonggwamog")
                    let searchKey = originalName;
                    if (searchKey.includes('-')) {
                        searchKey = searchKey.split('-')[0].trim();
                    }

                    // ê³¼ëª© ë§¤ì¹­ (slug ìš°ì„ , ê·¸ ë‹¤ìŒ subjectName) - í•™ê¸‰ë³„ í†µê³„ì™€ ë™ì¼í•œ ë¡œì§
                    const meta = allCourseData.find(c => {
                        // ì •í™•í•œ ë§¤ì¹­
                        if (c.slug === searchKey || c.subjectName === searchKey || c.subjectName === originalName) {
                            return true;
                        }
                        // ë¶€ë¶„ ì¼ì¹˜ (slugë‚˜ subjectNameì´ searchKeyë¥¼ í¬í•¨í•˜ê±°ë‚˜ ê·¸ ë°˜ëŒ€)
                        if (c.slug && c.slug.includes(searchKey)) return true;
                        if (c.subjectName && c.subjectName.includes(searchKey)) return true;
                        if (searchKey && c.slug && searchKey.includes(c.slug)) return true;
                        if (searchKey && c.subjectName && searchKey.includes(c.subjectName)) return true;
                        return false;
                    });

                    // í•™êµì§€ì •ê³¼ëª© ì œì™¸
                    if (meta && (meta.required === true || String(meta.required).toLowerCase() === 'true')) {
                        return;
                    }

                    // metaê°€ ìˆìœ¼ë©´ ì •í™•í•œ subjectName ì‚¬ìš©, ì—†ìœ¼ë©´ ì›ë³¸ ì´ë¦„ ì‚¬ìš©
                    const finalName = meta ? meta.subjectName : originalName;
                    if (finalName) {
                        selectedNames.add(finalName);
                    }
                });
                
                return selectedNames;
            };

            // 2. Build Matrix
            const matrix = allStudentData.map(d => {
                const row = {
                    'í•™ë…„': d.Grade,
                    'ë°˜': d.Class,
                    'ë²ˆí˜¸': d.Number,
                    'í•™ë²ˆ': `${d.Grade}${String(d.Class).padStart(2, '0')}${String(d.Number).padStart(2, '0')}`,
                    'ì´ë¦„': d.Name,
                    'ì§„ë¡œ': d.Major,
                    'ì´í•™ì ': d.TotalCredits
                };

                // SelectedCoursesë¥¼ ê³¼ëª©ëª… Setìœ¼ë¡œ ë³€í™˜
                const selectedSubjectNames = getSelectedSubjectNames(d.SelectedCourses);

                // í—¤ë”ì˜ ê° ê³¼ëª©ëª…ì— ëŒ€í•´ ì„ íƒ ì—¬ë¶€ í™•ì¸
                headers.forEach(h => {
                    row[h] = selectedSubjectNames.has(h) ? 1 : 0;
                });
                return row;
            });

            ExcelHandler.downloadExcel(matrix, 'í•™ìƒì„ íƒê³¼ëª©_ë§¤íŠ¸ë¦­ìŠ¤(ì „ì²´).xlsx');
        });

        // Helper to capture class roster
        window.downloadClassRosterImage = () => {
            const element = document.getElementById('class-stats-content'); // Capture the whole content area
            if (!element) return;

            html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                ignoreElements: (element) => {
                    // Ignore buttons
                    return element.tagName === 'BUTTON';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `í•™ê¸‰ì‹ ì²­í˜„í™©_${document.getElementById('dashboard-select-grade').value}-${document.getElementById('dashboard-select-class').value}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('Capture failed', err);
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        };

        // --- Class Stats & Modal Functions ---
        const modal = document.getElementById('class-lookup-modal');
        const modalContent = document.getElementById('class-stats-content');

        window.openClassStats = () => {
            modal.classList.remove('hidden');
        }

            ;

        window.closeClassStats = () => {
            modal.classList.add('hidden');
        }

            ;

        // Close on click outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeClassStats();
        });

        // Populate Student Number Options
        function populateStudentNumberOptions() {
            const grade = document.getElementById('modal-select-grade').value;
            const cls = document.getElementById('modal-select-class').value;
            const numSelect = document.getElementById('modal-select-number');

            // Clear existing
            numSelect.innerHTML = '<option value="all">ì „ì²´</option>';

            // Use Registry data if available, or fall back to responses
            let studentsInClass = [];

            if (registryData && registryData.length > 0) {
                studentsInClass = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '');
                    return sNum.startsWith(grade) && parseInt(sNum.substring(1, 3)) == cls;

                }).map(r => ({
                    number: parseInt(String(r['í•™ë²ˆ']).substring(3, 5)),
                    name: r['ì´ë¦„'] || r.name
                }));
            }

            else {
                studentsInClass = allStudentData.filter(s => s.Grade == grade && s.Class == cls).map(s => ({
                    number: parseInt(s.Number),
                    name: s.Name
                }));
            }

            // Remove duplicates and sort
            const unique = [];
            const seen = new Set();

            studentsInClass.forEach(s => {
                if (!seen.has(s.number)) {
                    seen.add(s.number);
                    unique.push(s);
                }
            });
            unique.sort((a, b) => a.number - b.number);

            unique.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.number;

                opt.textContent = `${s.number
                    }

            ë²ˆ ${s.name
                    }

            `;
                numSelect.appendChild(opt);
            });
        }

        // Updated Render Function (was queryClassStats)
        window.renderIndividualStatsTable = async () => {
            const grade = document.getElementById('modal-select-grade').value;
            const cls = document.getElementById('modal-select-class').value;
            const targetNum = document.getElementById('modal-select-number').value;

            const modalContent = document.getElementById('class-stats-content');
            
            // Show loading state
            modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600 text-lg font-medium">ì¡°íšŒì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            `;

            // 1. Identify Target Students (from Registry if available, else from Submissions)
            let targetStudents = [];
            let usingRegistry = false;

            if (registryData && registryData.length > 0) {
                // Filter Registry by Grade/Class
                targetStudents = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '');
                    const rGrade = sNum.substring(0, 1);
                    const rClass = parseInt(sNum.substring(1, 3));
                    return rGrade == grade && rClass == cls;
                }).map(r => {
                    const num = parseInt(String(r['í•™ë²ˆ']).substring(3, 5));
                    return {
                        Grade: grade,
                        Class: cls,
                        Number: num,
                        Name: r['ì´ë¦„'] || r.name,
                        isRegistry: true
                    };
                });
                usingRegistry = true;
            } else {
                // Fallback to only submitted students
                targetStudents = allStudentData.filter(s => s.Grade == grade && s.Class == cls);
            }

            // 2. Filter by Number if specific one selected
            if (targetNum !== 'all') {
                console.log(`[Debug] Looking for Student: Grade=${grade}, Class=${cls}, Num=${targetNum}`);
                const selectedStudent = targetStudents.find(s => parseInt(s.Number) == targetNum);
                console.log('[Debug] Selected Student (Registry/List):', selectedStudent);

                // Detailed Report Mode logic remains similar but needs submission data
                if (selectedStudent) {
                    // Find submission data for this student
                    // Fix: Ensure loose comparison for Grade/Class/Number just in case of type mismatch
                    const submission = allStudentData.find(s =>
                        String(s.Grade) == String(selectedStudent.Grade) &&
                        String(s.Class) == String(selectedStudent.Class) &&
                        parseInt(s.Number) == parseInt(selectedStudent.Number)
                    );

                    console.log('[Debug] Submission Data Found:', submission);

                    if (submission) {
                        try {
                            renderDetailedStudentReport(submission);
                        } catch (e) {
                            console.error('[Debug] renderDetailedStudentReport Failed:', e);
                            alert('ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + e.message);
                        }
                    } else {
                        // Modified: Show basic info even if no submission
                        modalContent.innerHTML = `
                    <div class="text-center py-10">
                        <h3 class="text-xl font-bold mb-2">${selectedStudent.Grade}í•™ë…„ ${selectedStudent.Class}ë°˜ ${selectedStudent.Number}ë²ˆ ${selectedStudent.Name}</h3>
                        <p class="text-red-500 font-bold mb-4">ì•„ì§ ìˆ˜ê°•ì‹ ì²­ ë‚´ìš©ì„ ì œì¶œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                        <button onclick="document.getElementById('modal-select-number').value='all'; renderIndividualStatsTable()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
                    }
                    return;
                } else {
                    // Student not found in filtered list
                    targetStudents = [];
                }
            }

            // Sort by Number
            targetStudents.sort((a, b) => a.Number - b.Number);

            // 3. Render Table
            const html = `
        <div class="mb-4 flex justify-between items-center">
            <h3 class="font-bold text-lg">${grade}í•™ë…„ ${cls}ë°˜ í•™ìƒ ëª©ë¡ (${targetStudents.length}ëª…)</h3>
            <div class="text-sm text-gray-500">
                ${usingRegistry ? 'í•™ì ë¶€ ë°ì´í„° ê¸°ì¤€' : 'ì œì¶œ ë°ì´í„° ê¸°ì¤€'}
            </div>
        </div>
        <table class="w-full text-sm text-left border-collapse border">
            <thead class="bg-gray-100 text-gray-700">
                <tr>
                    <th class="border p-2">ë²ˆí˜¸</th>
                    <th class="border p-2">ì´ë¦„</th>
                    <th class="border p-2">ì§„ë¡œ</th>
                    <th class="border p-2">ê³¼ëª©ìˆ˜</th>
                    <th class="border p-2">ì´í•™ì </th>
                    <th class="border p-2">ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody>
                ${targetStudents.length > 0 ? targetStudents.map(s => {
                // Match with submission
                const submission = allStudentData.find(sub =>
                    sub.Grade == s.Grade &&
                    sub.Class == s.Class &&
                    sub.Number == s.Number
                );

                let statusBadge = '<span class="text-red-500">ë¯¸ì œì¶œ</span>';
                let courseCount = '-';
                let credits = '-';
                let major = '-';
                let rowClass = 'bg-red-50'; // Default for not submitted

                if (submission) {
                    statusBadge = '<span class="text-green-600 font-bold">ì œì¶œì™„ë£Œ</span>';
                    courseCount = submission.SelectedCourses ? submission.SelectedCourses.split(',').length : 0;
                    credits = submission.TotalCredits;
                    major = submission.Major;
                    rowClass = 'bg-white';
                } else if (!usingRegistry) {
                    // If not using registry, we shouldn't even be here for 'missed' students usually,
                    // but if we are falling back to allStudentData, then everyone is submitted.
                    statusBadge = '<span class="text-green-600 font-bold">ì œì¶œì™„ë£Œ</span>';
                    rowClass = 'bg-white';
                }

                return `
                        <tr class="${rowClass} hover:bg-gray-50 cursor-pointer" onclick="openDetailedReportByNum(${s.Number})">
                            <td class="border p-2 text-center">${s.Number}</td>
                            <td class="border p-2 text-center font-medium">${s.Name}</td>
                            <td class="border p-2 text-center truncate max-w-[100px]">${major}</td>
                            <td class="border p-2 text-center">${courseCount}</td>
                            <td class="border p-2 text-center">${credits}</td>
                            <td class="border p-2 text-center">${statusBadge}</td>
                        </tr>
                    `;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
            </tbody>
        </table>
    `;
            modalContent.innerHTML = html;
        }

        // Helper to open detailed report directly from list
        window.openDetailedReportByNum = (num) => {
            document.getElementById('modal-select-number').value = num;
            renderIndividualStatsTable();
        };

        // ìˆ˜í•™/ê³¼í•™ ìœ„ê³„ ì‹œê°í™” ë°ì´í„° (ìˆ˜í˜•ë„: ì„ ì´ìˆ˜ -> ì‹¬í™”)
        const MATH_CHAINS = [
            ['ìˆ˜í•™', 'ìˆ˜í•™1', 'ë¯¸ì ë¶„', 'ê³ ê¸‰ìˆ˜í•™1', 'ê³ ê¸‰ìˆ˜í•™2'],
            ['ìˆ˜í•™', 'ìˆ˜í•™2', 'ë¯¸ì ë¶„', 'ê³ ê¸‰ìˆ˜í•™1', 'ê³ ê¸‰ìˆ˜í•™2'],
            ['ìˆ˜í•™', 'ê¸°í•˜', 'ê³ ê¸‰ìˆ˜í•™1', 'ê³ ê¸‰ìˆ˜í•™2'],
            ['ìˆ˜í•™', 'í™•ë¥ ê³¼ í†µê³„', 'ê³ ê¸‰ìˆ˜í•™1', 'ê³ ê¸‰ìˆ˜í•™2'],
            ['ìˆ˜í•™', 'ì‹¬í™”ìˆ˜í•™1', 'ì‹¬í™”ìˆ˜í•™2', 'ê³ ê¸‰ìˆ˜í•™1', 'ê³ ê¸‰ìˆ˜í•™2'],
            ['ìˆ˜í•™', 'ì¸ê³µì§€ëŠ¥ ìˆ˜í•™'],
            ['ìˆ˜í•™', 'ìˆ˜í•™1', 'ê²½ì œ ìˆ˜í•™']
        ];
        /** ìˆ˜í•™ ìœ„ê³„ ë ˆë²¨ë³„ ë…¸ë“œ í‘œì‹œ ìˆœì„œ (ìœ„â†’ì•„ë˜, ê²½ì œ ìˆ˜í•™Â·ë¯¸ì ë¶„ ìœ„ì¹˜ ë°˜ì˜) */
        const MATH_LEVEL_ORDER = ['ìˆ˜í•™', 'ìˆ˜í•™1', 'ìˆ˜í•™2', 'ê¸°í•˜', 'í™•ë¥ ê³¼ í†µê³„', 'ì¸ê³µì§€ëŠ¥ ìˆ˜í•™', 'ì‹¬í™”ìˆ˜í•™1', 'ì‹¬í™”ìˆ˜í•™2', 'ê²½ì œ ìˆ˜í•™', 'ë¯¸ì ë¶„', 'ê³ ê¸‰ìˆ˜í•™1', 'ê³ ê¸‰ìˆ˜í•™2'];
        const SCIENCE_CHAINS = [
            ['í†µí•©ê³¼í•™/ê³¼í•™íƒêµ¬ì‹¤í—˜', 'ë¬¼ë¦¬í•™1', 'ë¬¼ë¦¬í•™2', 'ê³ ê¸‰ ë¬¼ë¦¬í•™/ë¬¼ë¦¬í•™ ì‹¤í—˜'],
            ['í†µí•©ê³¼í•™/ê³¼í•™íƒêµ¬ì‹¤í—˜', 'í™”í•™1', 'í™”í•™2', 'ê³ ê¸‰ í™”í•™/í™”í•™ ì‹¤í—˜'],
            ['í†µí•©ê³¼í•™/ê³¼í•™íƒêµ¬ì‹¤í—˜', 'ìƒëª…ê³¼í•™1', 'ìƒëª…ê³¼í•™2', 'ê³ ê¸‰ ìƒëª…ê³¼í•™/ìƒëª…ê³¼í•™ ì‹¤í—˜'],
            ['í†µí•©ê³¼í•™/ê³¼í•™íƒêµ¬ì‹¤í—˜', 'ì§€êµ¬ê³¼í•™1', 'ì§€êµ¬ê³¼í•™2', 'ê³ ê¸‰ ì§€êµ¬ê³¼í•™/ì§€êµ¬ê³¼í•™ ì‹¤í—˜'],
            ['í†µí•©ê³¼í•™/ê³¼í•™íƒêµ¬ì‹¤í—˜', 'ê³¼í•™ì‚¬/ìƒí™œê³¼ ê³¼í•™/ìœµí•©ê³¼í•™/ìœµí•©ê³¼í•™ íƒêµ¬/ê³¼í•™ê³¼ì œ ì—°êµ¬/ìƒíƒœì™€ í™˜ê²½']
        ];
        function normSubject(x) { return (x || '').trim().replace(/\s+/g, ' '); }
        /** configì— ìˆëŠ” ê³¼ëª©ë§Œ ì´ìˆ˜ë¡œ ê°„ì£¼. ê° partë³„ ì´ìˆ˜ ì—¬ë¶€ ë°˜í™˜ (configì— ì—†ê±°ë‚˜ ì‹ ì²­/requiredê°€ ì•„ë‹ˆë©´ ë¯¸ì´ìˆ˜) */
        function partCompletedList(nodeStr, completedSet, configSet) {
            const parts = nodeStr.split('/').map(p => p.trim()).filter(Boolean);
            const norm = (x) => (x || '').trim().replace(/\s/g, '');
            const inConfig = (nPart) => configSet && configSet.size && [...configSet].some(c => { const nc = (c||'').trim().replace(/\s/g,''); return nc && (nc === nPart || nc.includes(nPart) || nPart.includes(nc)); });
            const inCompleted = (nPart) => completedSet && completedSet.size && completedSet.has(nPart);
            return parts.map(part => {
                const nPart = norm(part);
                if (!nPart || !inConfig(nPart)) return false;
                return inCompleted(nPart);
            });
        }
        function buildGraphFromChains(chains) {
            const nodes = new Map();
            const edges = [];
            chains.forEach(chain => {
                for (let i = 0; i < chain.length; i++) {
                    const id = chain[i];
                    if (!nodes.has(id)) nodes.set(id, { id, label: id.split('/').map(p => p.trim()).join(' / ') });
                    if (i < chain.length - 1) edges.push({ from: chain[i], to: chain[i + 1] });
                }
            });
            const parents = new Map();
            edges.forEach(e => {
                if (!parents.has(e.to)) parents.set(e.to, []);
                parents.get(e.to).push(e.from);
            });
            const levels = new Map();
            const queue = [...nodes.keys()].filter(id => !parents.has(id) || parents.get(id).length === 0);
            queue.forEach(id => levels.set(id, 0));
            const outEdges = new Map();
            edges.forEach(e => {
                if (!outEdges.has(e.from)) outEdges.set(e.from, []);
                outEdges.get(e.from).push(e.to);
            });
            const inDeg = new Map();
            nodes.forEach((_, id) => inDeg.set(id, (parents.get(id) || []).length));
            let idx = 0;
            while (idx < queue.length) {
                const from = queue[idx++];
                (outEdges.get(from) || []).forEach(to => {
                    inDeg.set(to, inDeg.get(to) - 1);
                    if (inDeg.get(to) === 0) queue.push(to);
                });
            }
            queue.forEach(id => {
                const preds = parents.get(id) || [];
                levels.set(id, preds.length ? 1 + Math.max(...preds.map(p => levels.get(p) ?? 0)) : 0);
            });
            const byLevel = new Map();
            levels.forEach((l, id) => {
                if (!byLevel.has(l)) byLevel.set(l, []);
                byLevel.get(l).push(id);
            });
            return { nodes, edges, levels, byLevel };
        }
        function buildHierarchyHtml(completedNames, requiredNames, configSubjectNames) {
            const norm = (x) => (x || '').trim().replace(/\s/g, '');
            const configSet = new Set([...(configSubjectNames || [])].map(n => norm(n)).filter(Boolean));
            const completedRaw = new Set([...(completedNames || []), ...(requiredNames || [])].map(n => (n || '').trim()).filter(Boolean));
            const completedSet = new Set();
            // configì— ìˆê³ , í•™ìƒì´ ì‹ ì²­í–ˆê±°ë‚˜ requiredì¸ ê³¼ëª©ë§Œ ì´ìˆ˜ë¡œ í‘œì‹œ (ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ë§Œ)
            [...(configSubjectNames || [])].forEach(configName => {
                const nc = norm(configName);
                if (!nc) return;
                const matched = [...completedRaw].some(r => norm(r) === nc);
                if (matched) completedSet.add(nc);
            });
            const NODE_MIN_W = 56, NODE_H = 22, GAP_X = 12, GAP_Y = 10;
            const nodeWidth = (label) => Math.max(NODE_MIN_W, Math.min(420, (label || '').length * 8 + 16));
            const renderGraph = (chains, title, levelOrder, opts) => {
                const variableWidth = opts && opts.variableWidth;
                const maxW = (opts && opts.maxW) != null ? opts.maxW : 220;
                const perChar = (opts && opts.perChar) != null ? opts.perChar : 6;
                const paddingX = (opts && opts.paddingX) != null ? opts.paddingX : 6;
                const getW = (label) => {
                    if (!variableWidth) return nodeWidth(label);
                    const hasMultiple = (label || '').indexOf(' / ') >= 0;
                    const pad = hasMultiple ? 14 : 8;
                    return Math.max(NODE_MIN_W, (label || '').length * perChar + pad * 2);
                };
                const g = buildGraphFromChains(chains);
                const levels = [...g.byLevel.keys()].sort((a,b)=>a-b);
                const pos = new Map();
                const parents = new Map();
                g.edges.forEach(e => { if (!parents.has(e.to)) parents.set(e.to, []); parents.get(e.to).push(e.from); });
                const orderIdx = (id) => { if (!levelOrder || !levelOrder.length) return 9999; const i = levelOrder.indexOf(id); return i >= 0 ? i : 9999; };
                let maxY = 0;
                levels.forEach((l, levelIndex) => {
                    let ids = g.byLevel.get(l);
                    if (levelIndex === 0) {
                        ids.forEach((id, i) => {
                            const w = getW(g.nodes.get(id).label);
                            pos.set(id, { x: 0, y: i * (NODE_H + GAP_Y), w, rowIndex: i });
                            maxY = Math.max(maxY, (i + 1) * (NODE_H + GAP_Y) - GAP_Y + NODE_H);
                        });
                    } else if (levelIndex === 1 && levelOrder && levelOrder.length) {
                        ids = [...ids].sort((a, b) => orderIdx(a) - orderIdx(b));
                        ids.forEach((id, i) => {
                            const w = getW(g.nodes.get(id).label);
                            pos.set(id, { x: 0, y: i * (NODE_H + GAP_Y), w, rowIndex: i });
                            maxY = Math.max(maxY, (i + 1) * (NODE_H + GAP_Y) - GAP_Y + NODE_H);
                        });
                    } else {
                        const predRow = (id) => {
                            const preds = parents.get(id) || [];
                            if (preds.length === 0) return 0;
                            const indices = preds.map(p => (pos.get(p) || {}).rowIndex).filter(x => x != null);
                            return indices.length ? Math.min(...indices) : 0;
                        };
                        ids = [...ids].sort((a, b) => predRow(a) - predRow(b));
                        ids.forEach((id, i) => {
                            const w = getW(g.nodes.get(id).label);
                            pos.set(id, { x: 0, y: i * (NODE_H + GAP_Y), w, rowIndex: i });
                            maxY = Math.max(maxY, (i + 1) * (NODE_H + GAP_Y) - GAP_Y + NODE_H);
                        });
                    }
                });
                const maxNodeW = variableWidth ? 0 : Math.max(NODE_MIN_W, ...[...pos.values()].map(p => p.w));
                if (!variableWidth) pos.forEach((p) => { p.w = maxNodeW; });
                const levelWidths = levels.map(l => {
                    const ids = g.byLevel.get(l);
                    const ws = ids.map(id => (pos.get(id) || {}).w || NODE_MIN_W);
                    return Math.max(NODE_MIN_W, ...ws);
                });
                const fixedStep = (opts && opts.fixedStep) != null ? opts.fixedStep : null;
                const step = fixedStep != null ? fixedStep : (variableWidth ? (Math.max(...levelWidths) + GAP_X) : (maxNodeW + GAP_X));
                levels.forEach((l, li) => {
                    g.byLevel.get(l).forEach(id => { const p = pos.get(id); if (p) p.x = li * step; });
                });
                const W = levels.length * step - GAP_X;
                const outDegree = new Map();
                const inDegree = new Map();
                g.nodes.forEach((_, id) => { outDegree.set(id, 0); inDegree.set(id, 0); });
                g.edges.forEach(e => {
                    outDegree.set(e.from, (outDegree.get(e.from) || 0) + 1);
                    inDegree.set(e.to, (inDegree.get(e.to) || 0) + 1);
                });
                const segmentOverlapsRect = (sx1, sy1, sx2, sy2, rx, ry, rw, rh) => {
                    const segMinX = Math.min(sx1, sx2), segMaxX = Math.max(sx1, sx2);
                    const segMinY = Math.min(sy1, sy2), segMaxY = Math.max(sy1, sy2);
                    return segMinX < rx + rw && segMaxX > rx && segMinY < ry + rh && segMaxY > ry;
                };
                const pathOverlapsAnyNode = (segments, excludeFrom, excludeTo) => {
                    let overlap = false;
                    g.nodes.forEach((_, nid) => {
                        if (nid === excludeFrom || nid === excludeTo) return;
                        const p = pos.get(nid);
                        if (!p) return;
                        for (const [sx1, sy1, sx2, sy2] of segments) {
                            if (segmentOverlapsRect(sx1, sy1, sx2, sy2, p.x, p.y, p.w, NODE_H)) { overlap = true; return; }
                        }
                    });
                    return overlap;
                };
                const svgExtra = 28;
                let svg = `<svg class="absolute left-0 top-0 pointer-events-none" width="${W}" height="${maxY + svgExtra}" xmlns="http://www.w3.org/2000/svg">`;
                g.edges.forEach(e => {
                    const a = pos.get(e.from);
                    const b = pos.get(e.to);
                    if (!a || !b) return;
                    const x1 = a.x + a.w, y1 = a.y + NODE_H/2;
                    const x2 = b.x, y2 = b.y + NODE_H/2;
                    const useBent = (outDegree.get(e.from) || 0) > 1 || (inDegree.get(e.to) || 0) > 1;
                    let useStraight = !useBent;
                    if (useStraight) {
                        g.nodes.forEach((_, nid) => {
                            if (nid === e.from || nid === e.to) return;
                            const p = pos.get(nid);
                            if (p && segmentOverlapsRect(x1, y1, x2, y2, p.x, p.y, p.w, NODE_H)) useStraight = false;
                        });
                    }
                    if (useStraight) {
                        svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#94a3b8" stroke-width="1"/>`;
                    } else {
                        const segHthenV = [[x1, y1, x2, y1], [x2, y1, x2, y2]];
                        const segVthenH = [[x1, y1, x1, y2], [x1, y2, x2, y2]];
                        const overlapHthenV = pathOverlapsAnyNode(segHthenV, e.from, e.to);
                        const overlapVthenH = pathOverlapsAnyNode(segVthenH, e.from, e.to);
                        if (!overlapHthenV || !overlapVthenH) {
                            const t = 0.4;
                            const c1x = x1 + (x2 - x1) * t;
                            const c2x = x2 - (x2 - x1) * t;
                            svg += `<path d="M ${x1} ${y1} C ${c1x} ${y1} ${c2x} ${y2} ${x2} ${y2}" fill="none" stroke="#94a3b8" stroke-width="1"/>`;
                        } else {
                            const dx = 10;
                            const routeY = Math.max(a.y, b.y) + NODE_H + 6;
                            svg += `<path d="M ${x1} ${y1} L ${x1 + dx} ${y1} L ${x1 + dx} ${routeY} L ${x2 - dx} ${routeY} L ${x2 - dx} ${y2} L ${x2} ${y2}" fill="none" stroke="#94a3b8" stroke-width="1"/>`;
                        }
                    }
                });
                svg += '</svg>';
                let nodesHtml = '';
                g.nodes.forEach((n, id) => {
                    const p = pos.get(id);
                    if (!p) return;
                    const parts = n.label.split(/\s*\/\s*/).map(s => s.trim()).filter(Boolean);
                    const completed = partCompletedList(id, completedSet, configSet);
                    const labelHtml = parts.length <= 1
                        ? (completed[0] ? `<span class="font-bold text-blue-700 dark:text-blue-300">${escapeHtml(n.label)}</span>` : `<span class="text-gray-500 dark:text-gray-400">${escapeHtml(n.label)}</span>`)
                        : parts.map((part, i) => (completed[i] ? `<span class="font-bold text-blue-700 dark:text-blue-300">${escapeHtml(part)}</span>` : `<span class="text-gray-500 dark:text-gray-400">${escapeHtml(part)}</span>`)).join(' <span class="text-gray-400">/</span> ');
                    const pad = parts.length >= 2 ? 14 : 8;
                    nodesHtml += `<div class="absolute rounded border border-gray-300 bg-gray-50 dark:bg-gray-700 dark:border-gray-500 text-[10px] flex items-center justify-center py-0.5 text-center leading-tight whitespace-nowrap" style="left:${p.x}px;top:${p.y}px;width:${p.w}px;height:${NODE_H}px;padding-left:${pad}px;padding-right:${pad}px;box-sizing:border-box;">${labelHtml}</div>`;
                });
                return `<div class="mb-3"><h5 class="text-xs font-bold text-gray-600 dark:text-gray-400 mb-1">${title}</h5><div class="relative" style="width:${W}px;height:${maxY + svgExtra}px;">${svg}${nodesHtml}</div></div>`;
            };
            function escapeHtml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
            const mathHtml = renderGraph(MATH_CHAINS, 'ìˆ˜í•™ ìœ„ê³„', MATH_LEVEL_ORDER, { fixedStep: 144 });
            const scienceHtml = renderGraph(SCIENCE_CHAINS, 'ê³¼í•™ ìœ„ê³„', null, { variableWidth: true, perChar: 6, paddingX: 14, fixedStep: 144 });
            return `<div class="space-y-3">${mathHtml}${scienceHtml}<p class="text-[10px] text-gray-500">êµµì€ ê¸€ì”¨+íŒŒë€ìƒ‰=ì´ìˆ˜ / íšŒìƒ‰=ë¯¸ì´ìˆ˜</p></div>`;
        }

        async function renderDetailedStudentReport(s) {
            const modalContent = document.getElementById('class-stats-content');

            const vRes = s.ValidationResult || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ';
            const isPass = !vRes.includes('ë¶€ì¡±') && !vRes.includes('ì´ˆê³¼') && !vRes.includes('í•„ìš”') && !vRes.includes('í™•ì¸');
            const vColor = !isPass ? 'text-red-600' : 'text-blue-600';
            const vBg = !isPass ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200';

            // 1. Course Processing: Exclude Required, Sort by Semester
            // 1. Stats Setup (index.htmlê³¼ ë™ì¼í•œ ì¹´í…Œê³ ë¦¬)
            const creditStats = {
                'ê¸°ì´ˆêµê³¼': 0, 'ì‚¬íšŒ ë° ê³¼í•™': 0, 'ì˜ˆìˆ êµê³¼': 0, 'ì²´ìœ¡êµê³¼': 0, 'êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´': 0
            };
            
            // jointSubCategoryToCategoryMap (index.htmlê³¼ ë™ì¼)
            const jointSubCategoryToCategoryMap = {
                'êµ­ì–´': 'ê¸°ì´ˆêµê³¼', 'ìˆ˜í•™': 'ê¸°ì´ˆêµê³¼', 'ì˜ì–´': 'ê¸°ì´ˆêµê³¼', 'í•œêµ­ì‚¬': 'ê¸°ì´ˆêµê³¼',
                'ì‚¬íšŒ': 'íƒêµ¬êµê³¼', 'ê³¼í•™': 'íƒêµ¬êµê³¼',
                'ì²´ìœ¡': 'ì²´ìœ¡êµê³¼', 'ì˜ˆìˆ ': 'ì˜ˆìˆ êµê³¼',
                'ì œ2ì™¸êµ­ì–´': 'êµì–‘êµê³¼', 'ì •ë³´': 'êµì–‘êµê³¼', 'êµì–‘': 'êµì–‘êµê³¼'
            };

            // ë³µìˆ˜í¸ì œê³¼ëª© ì¤‘ë³µ ê³„ì‚° ë°©ì§€ ë³€ìˆ˜ ì´ˆê¸°í™” (Required courses ì²˜ë¦¬ ì „ì— ì„ ì–¸)
            const countedCourseSlugs = new Set();
            const countedMultiSemesterNames = new Set();
            
            // Identify Multi-Semester Courses for duplicate prevention
            const coursesByName = {};
            allCourseData.forEach(c => {
                const name = c.subjectName || c.name || '';
                if (name && !coursesByName[name]) coursesByName[name] = [];
                if (name) coursesByName[name].push(c);
            });
            
            // Get multiSemesterRules, allowMultiSemesterDuplicate, duplicateCourseSlugs from settings
            let multiSemesterRules = {};
            let duplicateCourseSlugs = [];
            let allowMultiSemesterDuplicate = false;
            try {
                const settings = await DB.fetchSettings();
                if (settings) {
                    if (settings.multiSemesterRules) multiSemesterRules = settings.multiSemesterRules;
                    if (settings.duplicateCourseSlugs) duplicateCourseSlugs = settings.duplicateCourseSlugs;
                    if (settings.allowMultiSemesterDuplicate !== undefined) allowMultiSemesterDuplicate = !!settings.allowMultiSemesterDuplicate;
                }
            } catch (e) {
                console.warn('Could not fetch settings:', e);
            }

            // 2. Base Credits from REQUIRED Courses (index.htmlê³¼ ë™ì¼í•œ ë¡œì§)
            // Config ì‹œíŠ¸ì—ì„œ required=trueì¸ ê³¼ëª©ì€ í•™êµ ì§€ì • ê³¼ëª©(ì´ìˆ˜ ì™„ë£Œ)ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ êµê³¼ ì˜ì—­ë³„ ì´ìˆ˜ í˜„í™©ì— í¬í•¨
            allCourseData.forEach(c => {
                const isRequired = c.required === true || String(c.required).toLowerCase() === 'true';
                if (isRequired) {
                    const subjectName = c.subjectName || c.name || '';
                    
                    // ë³µìˆ˜í¸ì œê³¼ëª© ì¤‘ë³µ ê³„ì‚° ë°©ì§€ (ì¤‘ë³µ ì‹ ì²­ í—ˆìš©ì´ë©´ í•™ê¸°ë³„ ëª¨ë‘ ê³„ì‚°)
                    const isMultiSemester = (multiSemesterRules[subjectName] && multiSemesterRules[subjectName].length > 0) ||
                        (coursesByName[subjectName] && coursesByName[subjectName].length > 1);
                    const multiRestrictedReq = isMultiSemester && !allowMultiSemesterDuplicate;

                    if (multiRestrictedReq && countedMultiSemesterNames.has(subjectName)) {
                        return; // ì´ë¯¸ ê³„ì‚°ëœ ë³µìˆ˜í¸ì œê³¼ëª©ì€ ê±´ë„ˆë›°ê¸°
                    }

                    // ìŠ¬ëŸ¬ê·¸â†’ê³¼ëª©ëª… ì „í™˜: duplicateCourseSlugsì— slug/subjectName/id ì¤‘ í•˜ë‚˜ê°€ ë“¤ì–´ ìˆì„ ìˆ˜ ìˆìŒ
                    const courseKey = c.subjectName || c.slug || c.id || '';
                    const inDupList = duplicateCourseSlugs.some(x => (x || '') === (c.slug || '') || (x || '') === (c.subjectName || '') || (x || '') === (c.id || ''));
                    let shouldCount = !multiRestrictedReq || (!inDupList || !countedCourseSlugs.has(courseKey));

                    if (!shouldCount) {
                        return; // ì¤‘ë³µëœ ê³¼ëª©ì€ ê±´ë„ˆë›°ê¸°
                    }

                    if (multiRestrictedReq && inDupList) {
                        countedCourseSlugs.add(courseKey);
                    }
                    if (multiRestrictedReq) {
                        countedMultiSemesterNames.add(subjectName);
                    }
                    
                    const cred = parseInt(c.credit || c.credits || 0);
                    const cat = c.category || 'ê¸°íƒ€';
                    const subCat = c.subCategory || '';

                    // Check category for proper classification (index.htmlê³¼ ë™ì¼)
                    // íƒêµ¬êµê³¼ëŠ” categoryê°€ 'íƒêµ¬êµê³¼'ì´ê±°ë‚˜ subCategoryê°€ 'ì‚¬íšŒ'/'ê³¼í•™'ì¸ ê²½ìš°
                    if (cat === 'ê¸°ì´ˆêµê³¼') {
                        creditStats['ê¸°ì´ˆêµê³¼'] += cred;
                    } else if (cat === 'íƒêµ¬êµê³¼' || subCat === 'ì‚¬íšŒ' || subCat === 'ê³¼í•™') {
                        creditStats['ì‚¬íšŒ ë° ê³¼í•™'] += cred;
                    } else if (cat === 'ì˜ˆìˆ êµê³¼') {
                        creditStats['ì˜ˆìˆ êµê³¼'] += cred;
                    } else if (cat === 'ì²´ìœ¡êµê³¼') {
                        creditStats['ì²´ìœ¡êµê³¼'] += cred;
                    } else if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(cat)) {
                        creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += cred;
                    }
                }
            });

            // 3. Process Selected & Joint Courses
            const selectedRaw = s.SelectedCourses ? s.SelectedCourses.split(',').map(c => c.trim()).filter(x => x) : [];
            const jointRaw = s.JointCourses ? s.JointCourses.split(',').map(c => c.trim()).filter(x => x) : [];

            const courseList = [];
            const addedCourses = new Set();
            let calculatedTotal = 0; // For verification

            // Process Selected Courses
            selectedRaw.forEach(cName => {
                // Skip joint courses (joint-### format) - they should not appear in the course list
                // but their credits are already counted in creditStats via JointCourses processing
                if (cName.startsWith('joint-')) {
                    return; // Skip joint courses from course list
                }

                // 1. Resolve Metadata - id ìš°ì„ (í•™ê¸°ë³„ êµ¬ë¶„), ê·¸ ë‹¤ìŒ ê³¼ëª©ëª…-í•™ë…„-í•™ê¸° í˜•ì‹ íŒŒì‹±, slug, subjectName
                let meta = allCourseData.find(c => c.id === cName);
                if (!meta) meta = allCourseData.find(c => c.slug === cName || c.subjectName === cName);

                // Fallback: "ê³¼ëª©ëª…-í•™ë…„-í•™ê¸°" (3ë¶€) ë˜ëŠ” "ê³¼ëª©ëª…-í•™ë…„-í•™ê¸°-ì¸ë±ìŠ¤" (4ë¶€) - ì¼ê´„ë“±ë¡/ì œì¶œ ì €ì¥ í˜•ì‹
                if (!meta && cName.includes('-')) {
                    const parts = cName.split('-');
                    let namePart = '';
                    let g = '';
                    let s = '';
                    if (parts.length === 3 && /^\d+$/.test(parts[1]) && /^\d+$/.test(parts[2])) {
                        namePart = parts[0];
                        g = parts[1];
                        s = parts[2];
                    } else if (parts.length >= 4 && /^\d+$/.test(parts[parts.length - 3]) && /^\d+$/.test(parts[parts.length - 2]) && /^\d+$/.test(parts[parts.length - 1])) {
                        namePart = parts.slice(0, -3).join('-');
                        g = parts[parts.length - 3];
                        s = parts[parts.length - 2];
                    }
                    if (namePart && g && s) {
                        meta = allCourseData.find(c =>
                            String(c.grade ?? c.í•™ë…„ ?? '') === g &&
                            String(c.semester ?? c.í•™ê¸° ?? '') === s &&
                            (c.subjectName === namePart || (c.subjectName && c.subjectName.replace(/\s+/g, '-') === namePart) || (c.slug && c.slug.includes(namePart)))
                        );
                    }
                    if (!meta && parts.length >= 3) {
                        const lastTwo = parts.slice(-2);
                        if (lastTwo.every(p => /^\d+$/.test(p))) {
                            const slug = parts.slice(0, -2).join('-');
                            meta = allCourseData.find(c => c.slug === slug || c.subjectName === slug);
                        }
                    }
                    if (!meta && parts.length > 0) {
                        meta = allCourseData.find(c => c.slug === parts[0] || c.subjectName === parts[0]);
                    }
                }

                let displayName = cName;
                let displayCredit = 0;
                let displayCat = 'ê¸°íƒ€';
                let displaySem = '??';
                let displayGrade = 99;
                let isRequired = false;

                if (meta) {
                    // FOUND: Use Korean Name and Correct Data
                    displayName = meta.subjectName || meta.name || cName; // Ensure subjectName is used
                    displayCredit = parseInt(meta.credit || meta.credits || 0);
                    displayCat = meta.category || 'ê¸°íƒ€';
                    displaySem = `${meta.grade || '?'}-${meta.semester || '?'}`;
                    displayGrade = parseInt(meta.grade || 99);
                    isRequired = meta.required === true || String(meta.required).toLowerCase() === 'true';

                    // ë³µìˆ˜í¸ì œê³¼ëª© ì¤‘ë³µ ê³„ì‚° ë°©ì§€ (ì¤‘ë³µ ì‹ ì²­ í—ˆìš©ì´ë©´ í•™ê¸°ë³„ ëª¨ë‘ í‘œì‹œÂ·ê³„ì‚°)
                    const isMultiSemester = (multiSemesterRules[displayName] && multiSemesterRules[displayName].length > 0) ||
                        (coursesByName[displayName] && coursesByName[displayName].length > 1);
                    const multiRestrictedSel = isMultiSemester && !allowMultiSemesterDuplicate;

                    if (multiRestrictedSel && countedMultiSemesterNames.has(displayName)) {
                        return; // ì´ë¯¸ ê³„ì‚°ëœ ë³µìˆ˜í¸ì œê³¼ëª©ì€ ê±´ë„ˆë›°ê¸°
                    }

                    const metaKey = meta.subjectName || meta.slug || meta.id || '';
                    const metaInDupList = duplicateCourseSlugs.some(x => (x || '') === (meta.slug || '') || (x || '') === (meta.subjectName || '') || (x || '') === (meta.id || ''));
                    let shouldCount = !multiRestrictedSel || (!metaInDupList || !countedCourseSlugs.has(metaKey));

                    if (!shouldCount) {
                        return; // ì¤‘ë³µëœ ê³¼ëª©ì€ ê±´ë„ˆë›°ê¸°
                    }

                    if (multiRestrictedSel && metaInDupList) {
                        countedCourseSlugs.add(metaKey);
                    }
                    if (multiRestrictedSel) {
                        countedMultiSemesterNames.add(displayName);
                    }

                    // Add to Stats (index.htmlê³¼ ë™ì¼í•œ ë¡œì§)
                    // í•™êµì§€ì • ê³¼ëª©ì€ Required courses ì²˜ë¦¬ì—ì„œ ì´ë¯¸ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                    if (!isRequired) {
                        // subCategoryë„ í™•ì¸ (íƒêµ¬êµê³¼ëŠ” subCategoryë¡œë„ ë¶„ë¥˜ ê°€ëŠ¥)
                        const displaySubCat = meta.subCategory || '';
                        
                        if (displayCat === 'ê¸°ì´ˆêµê³¼') {
                            creditStats['ê¸°ì´ˆêµê³¼'] += displayCredit;
                        } else if (displayCat === 'íƒêµ¬êµê³¼' || displaySubCat === 'ì‚¬íšŒ' || displaySubCat === 'ê³¼í•™') {
                            creditStats['ì‚¬íšŒ ë° ê³¼í•™'] += displayCredit;
                        } else if (displayCat === 'ì˜ˆìˆ êµê³¼') {
                            creditStats['ì˜ˆìˆ êµê³¼'] += displayCredit;
                        } else if (displayCat === 'ì²´ìœ¡êµê³¼') {
                            creditStats['ì²´ìœ¡êµê³¼'] += displayCredit;
                        } else if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(displayCat)) {
                            creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                        }
                    }

                } else {
                    // NOT FOUND: Log warning and try to extract slug more carefully
                    console.warn(`[Admin] Course metadata not found for: ${cName}`);
                    
                    // Try to extract slug from format: slug-grade-semester
                    if (cName.includes('-')) {
                        const parts = cName.split('-');
                        
                        // If last 2 parts are numbers (grade-semester), use everything before as slug
                        if (parts.length >= 3) {
                            const lastTwo = parts.slice(-2);
                            const isGradeSemester = lastTwo.every(p => /^\d+$/.test(p));
                            
                            if (isGradeSemester) {
                                // Remove last 2 parts to get slug
                                let slugParts = parts.slice(0, -2);
                                
                                // If there's a 3rd number at the end (numbering), remove it too
                                if (parts.length >= 4 && /^\d+$/.test(parts[parts.length - 3])) {
                                    slugParts = parts.slice(0, -3);
                                }
                                
                                const slug = slugParts.join('-');
                                console.warn(`[Admin] Extracted slug: ${slug} from ${cName}`);
                                
                                // Try one more time with extracted slug
                                meta = allCourseData.find(c => c.slug === slug);
                                if (!meta) {
                                    meta = allCourseData.find(c => c.id === slug || c.subjectName === slug);
                                }
                                
                                if (meta) {
                                    // Found! Use the metadata
                                    displayName = meta.subjectName || meta.name || slug;
                                    displayCredit = parseInt(meta.credit || meta.credits || 0);
                                    displayCat = meta.category || 'ê¸°íƒ€';
                                    displaySem = `${meta.grade || '?'}-${meta.semester || '?'}`;
                                    displayGrade = parseInt(meta.grade || 99);
                                    isRequired = meta.required === true || String(meta.required).toLowerCase() === 'true';
                                    
                                    // Add to Stats with correct category
                                    // í•™êµì§€ì • ê³¼ëª©ì€ Required courses ì²˜ë¦¬ì—ì„œ ì´ë¯¸ ì¶”ê°€ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                                    if (!isRequired) {
                                        // subCategoryë„ í™•ì¸ (íƒêµ¬êµê³¼ëŠ” subCategoryë¡œë„ ë¶„ë¥˜ ê°€ëŠ¥)
                                        const displaySubCat = meta.subCategory || '';
                                        
                                        if (displayCat === 'ê¸°ì´ˆêµê³¼') {
                                            creditStats['ê¸°ì´ˆêµê³¼'] += displayCredit;
                                        } else if (displayCat === 'íƒêµ¬êµê³¼' || displaySubCat === 'ì‚¬íšŒ' || displaySubCat === 'ê³¼í•™') {
                                            creditStats['ì‚¬íšŒ ë° ê³¼í•™'] += displayCredit;
                                        } else if (displayCat === 'ì˜ˆìˆ êµê³¼') {
                                            creditStats['ì˜ˆìˆ êµê³¼'] += displayCredit;
                                        } else if (displayCat === 'ì²´ìœ¡êµê³¼') {
                                            creditStats['ì²´ìœ¡êµê³¼'] += displayCredit;
                                        } else if (['êµì–‘êµê³¼', 'ì œ2ì™¸êµ­ì–´', 'ì •ë³´'].includes(displayCat)) {
                                            creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                                        } else {
                                            // Unknown category, default to êµì–‘
                                            console.warn(`[Admin] Unknown category "${displayCat}" for course: ${displayName}, defaulting to êµì–‘`);
                                            creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                                        }
                                    }
                                } else {
                                    // Still not found - use default
                                    console.error(`[Admin] Still cannot find metadata for slug: ${slug}`);
                                    displayCat = 'êµì–‘êµê³¼';
                                    displayCredit = 0;
                                    creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                                }
                            } else {
                                // Doesn't match slug-grade-semester format
                                displayCat = 'êµì–‘êµê³¼';
                                displayCredit = 0;
                                creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                            }
                        } else {
                            // Not enough parts
                            displayCat = 'êµì–‘êµê³¼';
                            displayCredit = 0;
                            creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                        }
                    } else {
                        // No hyphen - use as-is
                        displayCat = 'êµì–‘êµê³¼';
                        displayCredit = 0;
                        creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] += displayCredit;
                    }
                }

                // Add to Course List (Deduplicate) - Only add non-required courses
                if (!isRequired) {
                const uniqueKey = `${displayName}-${displaySem}`;
                if (!addedCourses.has(uniqueKey)) {
                    addedCourses.add(uniqueKey);
                    const subCat = meta ? (meta.subCategory || meta.ì„¸ë¶€êµê³¼ || '') : '';
                    courseList.push({
                        name: displayName,
                        semester: displaySem,
                        grade: displayGrade,
                        credit: displayCredit,
                            category: displayCat,
                            subCategory: subCat || 'ê¸°íƒ€',
                            required: isRequired
                    });
                    }
                }
            });

            // Recalculate Total from Stats to ensure match
            // totalCredits is now sum of (Required Base + Selected + Joint)
            let totalCredits = Object.values(creditStats).reduce((a, b) => a + b, 0);

            // êµê³¼êµ°ë³„ ì„ íƒí•™ì  (subCategory ê¸°ë°˜, Config ì°¸ì¡°)
            const subCategoryCredits = {};
            courseList.forEach(c => {
                const subCat = (c.subCategory || 'ê¸°íƒ€').trim() || 'ê¸°íƒ€';
                subCategoryCredits[subCat] = (subCategoryCredits[subCat] || 0) + (parseInt(c.credit) || 0);
            });
            const subCategoryEntries = Object.entries(subCategoryCredits).sort((a, b) => b[1] - a[1]);

            // í•™ë…„ ì „ì²´ êµê³¼ë³„ ì¶”ì„¸ (ê°™ì€ í•™ë…„ í•™ìƒë“¤ì˜ subCategoryë³„ ì§‘ê³„)
            const gradeSubCategoryCredits = {};
            const gradeSubCategoryCount = {};
            const studentGrade = String(s.Grade || '');
            const gradeStudents = (typeof allStudentData !== 'undefined' && Array.isArray(allStudentData)) ? allStudentData.filter(x => String(x.Grade) === studentGrade) : [];
            gradeStudents.forEach(st => {
                if (!st.SelectedCourses) return;
                const seen = {};
                st.SelectedCourses.split(',').forEach(cName => {
                    const orig = cName.trim();
                    if (!orig || orig.startsWith('joint-')) return;
                    let meta = allCourseData.find(c => c.id === orig || c.slug === orig || c.subjectName === orig);
                    // 3ë¶€Â·4ë¶€ í˜•ì‹ íŒŒì‹± (ê°œì¸ ë¦¬í¬íŠ¸ì™€ ë™ì¼) - "ê³µí†µêµ­ì–´1-1-1" ë“± êµ­ì–´ ê³¼ëª© ëˆ„ë½ ë°©ì§€
                    if (!meta && orig.includes('-')) {
                        const parts = orig.split('-');
                        let namePart = '', g = '', sem = '';
                        if (parts.length >= 4 && /^\d+$/.test(parts[parts.length-3]) && /^\d+$/.test(parts[parts.length-2]) && /^\d+$/.test(parts[parts.length-1])) {
                            g = parts[parts.length-3];
                            sem = parts[parts.length-2];
                            namePart = parts.slice(0, -3).join('-');
                        } else if (parts.length >= 3 && /^\d+$/.test(parts[parts.length-2]) && /^\d+$/.test(parts[parts.length-1])) {
                            g = parts[parts.length-2];
                            sem = parts[parts.length-1];
                            namePart = parts.length === 3 ? parts[0] : parts.slice(0, -2).join('-');
                        }
                        if (namePart && g && sem) {
                            meta = allCourseData.find(c =>
                                String(c.grade ?? c.í•™ë…„ ?? '') === g && String(c.semester ?? c.í•™ê¸° ?? '') === sem &&
                                (c.subjectName === namePart || (c.subjectName && c.subjectName.replace(/\s+/g, '-') === namePart) || (c.slug && c.slug === namePart))
                            );
                        }
                    }
                    if (meta) {
                        const sc = (meta.subCategory || meta.ì„¸ë¶€êµê³¼ || 'ê¸°íƒ€').trim() || 'ê¸°íƒ€';
                        const cred = parseInt(meta.credit || meta.credits || 0) || 0;
                        gradeSubCategoryCredits[sc] = (gradeSubCategoryCredits[sc] || 0) + cred;
                        if (!seen[sc]) { seen[sc] = true; gradeSubCategoryCount[sc] = (gradeSubCategoryCount[sc] || 0) + 1; }
                    }
                });
            });
            const gradeNum = gradeStudents.length;
            const allSubCats = [...new Set([...Object.keys(subCategoryCredits), ...Object.keys(gradeSubCategoryCredits)])];
            const gradeTrendData = allSubCats.map(sc => gradeNum ? Math.round(((gradeSubCategoryCredits[sc] || 0) / gradeNum) * 10) / 10 : 0);

            let subCategoryTableRows = '';
            for (let i = 0; i < subCategoryEntries.length; i += 2) {
                const r1 = subCategoryEntries[i];
                const r2 = subCategoryEntries[i + 1];
                subCategoryTableRows += '<tr><td class="border p-1 print:p-0.5">' + (r1 ? r1[0] : '') + '</td><td class="border p-1 text-right print:p-0.5">' + (r1 ? r1[1] : '') + '</td><td class="border p-1 print:p-0.5">' + (r2 ? r2[0] : '') + '</td><td class="border p-1 text-right print:p-0.5">' + (r2 ? r2[1] : '') + '</td></tr>';
            }
            if (!subCategoryTableRows) subCategoryTableRows = '<tr><td class="border p-1" colspan="4">-</td></tr>';

            // Sort: Grade > Semester > Name
            courseList.sort((a, b) => {
                const gA = parseInt(a.grade || 99);
                const gB = parseInt(b.grade || 99);
                if (gA !== gB) return gA - gB;

                // Semester compare (handle "1" vs "2" or "1-1" vs "1-2")
                // Simplistic check: If contains '-' split, else compare string
                return a.semester.localeCompare(b.semester) || a.name.localeCompare(b.name);
            });

            // 2. AI Init (Placeholder)
            const recs = null; // Removed Mock Call

            // 3. Validation Detail (Replicating index.html logic)
            // Calculate Stats for Validation (totalCreditsëŠ” ì´ë¯¸ ìœ„ì—ì„œ ê³„ì‚°ë¨)
            // basicCreditsëŠ” creditStats['ê¸°ì´ˆêµê³¼']ë¥¼ ì‚¬ìš© (required + selected ëª¨ë‘ í¬í•¨)
            let basicCredits = creditStats['ê¸°ì´ˆêµê³¼'] || 0;
            // artCreditsì™€ electiveGroupCreditsëŠ” creditStatsì—ì„œ ê°€ì ¸ì˜¤ë˜, required coursesë„ í¬í•¨í•´ì•¼ í•¨
            // index.htmlì—ì„œëŠ” courseList(selected)ì™€ required coursesë¥¼ ëª¨ë‘ í¬í•¨í•˜ì—¬ ê³„ì‚°
            let artCredits = creditStats['ì˜ˆìˆ êµê³¼'] || 0;
            let electiveGroupCredits = creditStats['êµì–‘,ì œ2ì™¸êµ­ì–´,ì •ë³´'] || 0;
            // ì²´ìœ¡êµê³¼ë„ creditStatsì—ì„œ ì§ì ‘ ê°€ì ¸ì™€ì„œ ë§‰ëŒ€ê·¸ë˜í”„ì™€ ì¼ì¹˜ì‹œí‚´
            let physicalCredits = creditStats['ì²´ìœ¡êµê³¼'] || 0;

            // êµê³¼ë³„ í•„ìˆ˜ ì´ìˆ˜í•™ì  ê³„ì‚°
            let koreanCredits = 0; // êµ­ì–´
            let mathCredits = 0; // ìˆ˜í•™
            let englishCredits = 0; // ì˜ì–´
            let koreanHistory1 = false; // í•œêµ­ì‚¬1
            let koreanHistory2 = false; // í•œêµ­ì‚¬2
            let socialCredits = 0; // ì‚¬íšŒ
            let scienceCredits = 0; // ê³¼í•™
            // physicalCreditsëŠ” ìœ„ì—ì„œ creditStats['ì²´ìœ¡êµê³¼']ë¡œ ì´ë¯¸ ì´ˆê¸°í™”ë¨ (ë§‰ëŒ€ê·¸ë˜í”„ì™€ ì¼ì¹˜)

            // Map for Joint Courses/etc. (index.htmlê³¼ ë™ì¼)
            const jointSubCategoryToCategoryMapForValidation = {
                'êµ­ì–´': 'ê¸°ì´ˆêµê³¼', 'ìˆ˜í•™': 'ê¸°ì´ˆêµê³¼', 'ì˜ì–´': 'ê¸°ì´ˆêµê³¼', 'í•œêµ­ì‚¬': 'ê¸°ì´ˆêµê³¼',
                'ì‚¬íšŒ': 'íƒêµ¬êµê³¼', 'ê³¼í•™': 'íƒêµ¬êµê³¼',
                'ì²´ìœ¡': 'ì²´ìœ¡êµê³¼', 'ì˜ˆìˆ ': 'ì˜ˆìˆ êµê³¼',
                'ì œ2ì™¸êµ­ì–´': 'êµì–‘êµê³¼', 'ì •ë³´': 'êµì–‘êµê³¼', 'êµì–‘': 'êµì–‘êµê³¼'
            };

            const selectedSlugs = new Set();

            // Calculate artCredits and electiveGroupCredits from selected courses (index.htmlê³¼ ë™ì¼)
            courseList.forEach(c => {
                const credits = parseInt(c.credit || 0);

                // Determine Category
                let cat = c.category;
                let subCat = '';
                if (!cat || cat === 'ê¸°íƒ€') {
                    // Try to infer from name or use passed info
                    const meta = allCourseData.find(m => m.subjectName === c.name);
                    if (meta) {
                        cat = meta.category;
                        subCat = meta.subCategory || '';
                    }
                } else {
                    // Get subCategory from meta if available
                    const meta = allCourseData.find(m => m.subjectName === c.name);
                    if (meta) subCat = meta.subCategory || '';
                }

                // Category sumsëŠ” creditStatsì—ì„œ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŒ
                // artCreditsì™€ electiveGroupCreditsëŠ” creditStatsì—ì„œ ê°€ì ¸ì˜´

                // êµê³¼ë³„ í•„ìˆ˜ ì´ìˆ˜í•™ì  ê³„ì‚°
                if (subCat === 'êµ­ì–´') koreanCredits += credits;
                if (subCat === 'ìˆ˜í•™') mathCredits += credits;
                if (subCat === 'ì˜ì–´') englishCredits += credits;
                if (subCat === 'ì‚¬íšŒ') socialCredits += credits;
                if (subCat === 'ê³¼í•™') scienceCredits += credits;
                // ì²´ìœ¡: creditStatsì—ì„œ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŒ (ë§‰ëŒ€ê·¸ë˜í”„ì™€ ì¼ì¹˜)
                // physicalCreditsëŠ” creditStats['ì²´ìœ¡êµê³¼']ë¥¼ ì‚¬ìš©
                
                // í•œêµ­ì‚¬1, í•œêµ­ì‚¬2 í™•ì¸
                const subjectName = (c.name || '').toLowerCase();
                if (subjectName.includes('í•œêµ­ì‚¬')) {
                    if (subjectName.includes('1') || c.semester && c.semester.includes('-1')) koreanHistory1 = true;
                    if (subjectName.includes('2') || c.semester && c.semester.includes('-2')) koreanHistory2 = true;
                }

                // ì„ ì´ìˆ˜ ê²€ì¦ìš©: ìŠ¬ëŸ¬ê·¸â†’ê³¼ëª©ëª… ì „í™˜ìœ¼ë¡œ slugì™€ subjectName ëª¨ë‘ ìˆ˜ì§‘
                const meta = allCourseData.find(m => m.subjectName === c.name || m.slug === c.name || m.id === c.name);
                if (meta) {
                    if (meta.slug) selectedSlugs.add(meta.slug);
                    if (meta.subjectName) selectedSlugs.add(meta.subjectName);
                }
                selectedSlugs.add(c.name); // ì‹œíŠ¸ ê°’(ê³¼ëª©ëª… ë˜ëŠ” slug) ê·¸ëŒ€ë¡œë„ ì¶”ê°€
            });
            
            // Also check required courses for subject-specific credits and category sums (index.htmlê³¼ ë™ì¼)
            allCourseData.forEach(c => {
                const isRequired = c.required === true || String(c.required).toLowerCase() === 'true';
                if (isRequired && (parseInt(c.grade) === parseInt(s.Grade))) {
                    const cred = parseInt(c.credit || c.credits || 0);
                    const subCat = c.subCategory || '';
                    const cat = c.category || '';
                    
                    // Category sumsëŠ” creditStatsì—ì„œ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŒ
                    // artCreditsì™€ electiveGroupCreditsëŠ” creditStatsì—ì„œ ê°€ì ¸ì˜´
                    
                    // subCategoryë¡œ í™•ì¸
                    if (subCat === 'êµ­ì–´') koreanCredits += cred;
                    if (subCat === 'ìˆ˜í•™') mathCredits += cred;
                    if (subCat === 'ì˜ì–´') englishCredits += cred;
                    if (subCat === 'ì‚¬íšŒ') socialCredits += cred;
                    if (subCat === 'ê³¼í•™') scienceCredits += cred;
                    // ì²´ìœ¡: creditStatsì—ì„œ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŒ (ë§‰ëŒ€ê·¸ë˜í”„ì™€ ì¼ì¹˜)
                    // physicalCreditsëŠ” creditStats['ì²´ìœ¡êµê³¼']ë¥¼ ì‚¬ìš©
                    
                    // í•œêµ­ì‚¬1, í•œêµ­ì‚¬2 í™•ì¸
                    const subjectName = (c.subjectName || '').toLowerCase();
                    if (subjectName.includes('í•œêµ­ì‚¬')) {
                        if (subjectName.includes('1') || c.semester === '1') koreanHistory1 = true;
                        if (subjectName.includes('2') || c.semester === '2') koreanHistory2 = true;
                    }
                }
            });
            
            // Check JointCourses for subject-specific credits (index.htmlê³¼ ë™ì¼)
            if (s.JointCourses) {
                const jointRaw = s.JointCourses.split(',').map(c => c.trim()).filter(x => x);
                jointRaw.forEach(jointName => {
                    // Joint courses format: "joint-###" - parse if needed
                    // For now, joint courses credits are already counted in creditStats
                    // But we need to add to category sums if they contribute
                    // This would require parsing the joint course data structure
                });
            }

            // Rules
            const validationChecklist = [];

            // 1) Total Credits (>= 174)
            validationChecklist.push({
                label: `ì´ ì´ìˆ˜í•™ì  (174í•™ì  ì´ìƒ)`,
                status: totalCredits >= 174,
                desc: `ì´ ì´ìˆ˜í•™ì ì´ 174í•™ì  ì´ìƒ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${totalCredits}í•™ì )`
            });

            // 2) Foundation <= 50%
            const foundationRatio = totalCredits > 0 ? (basicCredits / totalCredits) * 100 : 0;
            validationChecklist.push({
                label: `ê¸°ì´ˆêµê³¼ 50% ì´ˆê³¼ ì—¬ë¶€`,
                status: totalCredits === 0 || foundationRatio <= 50,
                desc: `ê¸°ì´ˆêµê³¼(êµ­ì–´, ì˜ì–´, ìˆ˜í•™, í•œêµ­ì‚¬) ì´ìˆ˜í•™ì ì´ ì´ ì´ìˆ˜í•™ì ì˜ 50%ë¥¼ ì´ˆê³¼í•˜ì˜€ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${foundationRatio.toFixed(1)}%)`
            });

            // 3) Subject Minimums - êµê³¼ë³„ ìµœì†Œ ì´ìˆ˜í•™ì  ê²€ì¦
            const artPass = artCredits >= 10;
            const electivePass = electiveGroupCredits >= 16;
            const koreanPass = koreanCredits >= 8;
            const mathPass = mathCredits >= 8;
            const englishPass = englishCredits >= 8;
            const koreanHistoryPass = koreanHistory1 && koreanHistory2;
            const socialPass = socialCredits >= 8;
            const sciencePass = scienceCredits >= 10;
            const physicalPass = physicalCredits >= 10;
            
            const allSubjectMinimumsPass = artPass && electivePass && koreanPass && mathPass && englishPass && 
                                          koreanHistoryPass && socialPass && sciencePass && physicalPass;
            
            // ê°œë³„ êµê³¼ë³„ ê²€ì¦ í•­ëª© (í† ê¸€ìš©)
            const subjectDetails = [
                {
                    label: `êµ­ì–´ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (8í•™ì )`,
                    status: koreanPass,
                    desc: `êµ­ì–´ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  8í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${koreanCredits}í•™ì )`
                },
                {
                    label: `ìˆ˜í•™ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (8í•™ì )`,
                    status: mathPass,
                    desc: `ìˆ˜í•™ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  8í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${mathCredits}í•™ì )`
                },
                {
                    label: `ì˜ì–´ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (8í•™ì )`,
                    status: englishPass,
                    desc: `ì˜ì–´ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  8í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${englishCredits}í•™ì )`
                },
                {
                    label: `í•œêµ­ì‚¬1, í•œêµ­ì‚¬2 ì´ìˆ˜ ì—¬ë¶€`,
                    status: koreanHistoryPass,
                    desc: `í•œêµ­ì‚¬1ê³¼ í•œêµ­ì‚¬2ë¥¼ ëª¨ë‘ ì´ìˆ˜í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. ${!koreanHistory1 ? 'í•œêµ­ì‚¬1 ë¯¸ì´ìˆ˜' : ''} ${!koreanHistory2 ? 'í•œêµ­ì‚¬2 ë¯¸ì´ìˆ˜' : ''}`
                },
                {
                    label: `ì‚¬íšŒ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (8í•™ì )`,
                    status: socialPass,
                    desc: `ì‚¬íšŒ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  8í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${socialCredits}í•™ì )`
                },
                {
                    label: `ê³¼í•™ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (10í•™ì )`,
                    status: sciencePass,
                    desc: `ê³¼í•™ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  10í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${scienceCredits}í•™ì )`
                },
                {
                    label: `ì²´ìœ¡ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (10í•™ì )`,
                    status: physicalPass,
                    desc: `ì²´ìœ¡ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  10í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${physicalCredits}í•™ì )`
                },
                {
                    label: `ì˜ˆìˆ  êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (10í•™ì )`,
                    status: artPass,
                    desc: `ì˜ˆìˆ  êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  10í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${artCredits}í•™ì )`
                },
                {
                    label: `êµì–‘ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  (16í•™ì )`,
                    status: electivePass,
                    desc: `êµì–‘ êµê³¼ í•„ìˆ˜ ì´ìˆ˜í•™ì  16í•™ì ì„ ì¶©ì¡±í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. (í˜„ì¬: ${electiveGroupCredits}í•™ì )`
                }
            ];
            
            validationChecklist.push({
                label: `êµê³¼ë³„ ìµœì†Œ ì´ìˆ˜í•™ì  ì¶©ì¡± ì—¬ë¶€`,
                status: allSubjectMinimumsPass,
                desc: `êµê³¼ë³„ ìµœì†Œ ì´ìˆ˜í•™ì ì´ ì¶©ì¡±ë˜ì—ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. 
                êµ­ì–´ 8í•™ì , ìˆ˜í•™ 8í•™ì , ì˜ì–´ 8í•™ì , í•œêµ­ì‚¬1/2 ì´ìˆ˜, ì‚¬íšŒ 8í•™ì , ê³¼í•™ 10í•™ì , ì²´ìœ¡ 10í•™ì , ì˜ˆìˆ  10í•™ì , êµì–‘ 16í•™ì `,
                details: subjectDetails,
                hasToggle: true
            });

            // 4) Prerequisites
            let prereqFailures = [];
            courseList.forEach(c => {
                const meta = allCourseData.find(m => m.subjectName === c.name);
                if (meta && meta.prerequisites) {
                    let reqs = [];
                    if (typeof meta.prerequisites === 'string') reqs = meta.prerequisites.split(',').map(s => s.trim());
                    else if (Array.isArray(meta.prerequisites)) reqs = meta.prerequisites;

                    reqs.forEach(req => {
                        if (req && !selectedSlugs.has(req)) {
                            const reqMeta = allCourseData.find(m => m.slug === req || m.subjectName === req || (m.id && m.id === req));
                            const reqName = reqMeta ? reqMeta.subjectName : req;
                            prereqFailures.push(`${c.name} (ì„ ì´ìˆ˜: ${reqName})`);
                        }
                    });
                }
            });
            const uniquePrereqFailures = [...new Set(prereqFailures)];

            validationChecklist.push({
                label: `ìœ„ê³„ì— ë”°ë¥¸ ê³¼ëª© ì´ìˆ˜ ì—¬ë¶€`,
                status: uniquePrereqFailures.length === 0,
                desc: `ìˆ˜í•™, ê³¼í•™ê³¼ëª©ì„ ì„ íƒí•  ë•Œ ì„ ì´ìˆ˜ê³¼ëª©ì— ë§ì¶°ì„œ ì´ìˆ˜í–ˆëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤. ${uniquePrereqFailures.length > 0 ? 'ë¯¸ì´ìˆ˜: ' + uniquePrereqFailures.join(', ') : ''}`
            });

            const completedNamesForHierarchy = courseList.map(c => c.name);
            const requiredSubjectNames = (allCourseData || []).filter(c => c.required === true || String(c.required).toLowerCase() === 'true').map(c => (c.subjectName || c.name || '').trim()).filter(Boolean);
            const configSubjectNames = (allCourseData || []).map(c => (c.subjectName || c.name || '').trim()).filter(Boolean);
            const hierarchyHtml = buildHierarchyHtml(completedNamesForHierarchy, requiredSubjectNames, configSubjectNames);

            const html = ` <div id="student-report-card" class="bg-white dark:bg-gray-800 rounded-lg shadow-sm print:shadow-none print:border-none print:w-full print:p-0"><!-- Header - Always visible in print --><div class="flex flex-row justify-between items-center mb-6 border-b pb-4 theme-border gap-4 print:mb-2 print:pb-2 print:flex-row print:items-center"><div class="flex-1 print:flex-1"><div class="flex items-center gap-3 print:gap-3 print:mb-1"><span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-xs font-bold print:border-0 print:bg-transparent print:text-black print:px-0 print:py-0 print:text-[9pt] print:font-bold print:shadow-none">í•™ë²ˆ: ${s.Grade}${String(s.Class).padStart(2, '0')}${String(s.Number).padStart(2, '0')}</span><h3 class="text-2xl font-bold theme-text print:text-black print:text-[12pt] print:m-0 print:inline-block print:ml-2 print:font-bold">ì´ë¦„: ${s.Name
                }

    </h3></div><p class="text-gray-500 mt-1 flex items-center gap-2 print:text-xs print:mt-1 print:text-[9pt] print:block print:mt-0.5"><span class="font-bold text-gray-400 print:text-black print:font-bold">ì§„ë¡œí¬ë§ì‚¬í•­: </span><span class="font-medium text-blue-600 text-lg print:text-black print:text-[9pt]">${s.Major || '-'
                }

    </span></p></div><div class="flex flex-row gap-4 text-center bg-gray-50 dark:bg-gray-700 p-3 rounded-lg print:bg-white print:border print:text-black print:gap-3 print:p-2 print:flex-shrink-0"><div class="px-2 print:px-2"><div class="text-xs text-gray-500 print:text-black print:text-[7pt]">ì„ íƒ ê³¼ëª©</div><div class="text-2xl font-bold theme-text print:text-black print:text-[14pt]">${courseList.length
                }

    </div></div><div class="w-px bg-gray-300 print:hidden"></div><div class="px-2 print:px-2"><div class="text-xs text-gray-500 print:text-black print:text-[7pt]">ì´ í•™ì </div><div class="text-2xl font-bold theme-text print:text-black print:text-[14pt]">${totalCredits}</div></div></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6 print:grid-cols-2 print:gap-1 print:mb-1 items-stretch"><!-- Left Top: Credit Chart --><div class="theme-card rounded border p-4 print:border-gray-300 print:break-inside-avoid print:mb-1 print:p-1 flex flex-col"><h4 class="font-bold mb-2 theme-text print:text-black print:text-[7pt] print:mb-0.5">ğŸ“Š êµê³¼ ì˜ì—­ë³„ ì´ìˆ˜ í˜„í™©</h4><div class="flex-1 flex items-stretch justify-stretch min-h-[192px] print:h-[100px] print:min-h-[100px] print:max-h-[140px]"><div class="w-full h-full relative flex-1"><canvas id="individualCreditChart"></canvas></div></div><div class="mt-2 min-h-[260px] print:min-h-[100px]" id="subcategory-chart-wrap" style="height: 260px;"><canvas id="individualSubCategoryChart"></canvas></div><table class="w-full text-xs mt-2 print:text-[6pt] print:mt-1 border-collapse" id="subcategory-credits-table"><thead><tr><th class="border p-1 text-left print:p-0.5">êµê³¼êµ°</th><th class="border p-1 text-right print:p-0.5">ì‹ ì²­í•™ì </th><th class="border p-1 text-left print:p-0.5">êµê³¼êµ°</th><th class="border p-1 text-right print:p-0.5">ì‹ ì²­í•™ì </th></tr></thead><tbody>${subCategoryTableRows}</tbody></table></div><!-- Right Top: ìˆ˜ê°•ì‹ ì²­ ê²€ì¦ ìƒì„¸ (êµê³¼ ì˜ì—­ë³„ ì´ìˆ˜ í˜„í™©ê³¼ ê°™ì€ í–‰Â·ê°™ì€ ë†’ì´) --><div class="h-full flex flex-col min-h-0"><div class="theme-card rounded border p-4 print:border-gray-300 print:break-inside-avoid print:p-1.5 flex flex-col h-full overflow-hidden"><h4 class="font-bold mb-1 theme-text print:text-black print:text-[8pt] print:mb-0.75">âœ… ìˆ˜ê°•ì‹ ì²­ ê²€ì¦ ìƒì„¸</h4><div class="overflow-hidden rounded border ${vBg} mb-1 p-1.5 print:mb-1 print:p-1"><p class="font-bold text-center ${vColor} text-sm print:text-black print:text-[7pt]">${isPass ? 'PASS' : 'í™•ì¸ í•„ìš”'
                }

    </p></div><div class="flex-1 overflow-y-auto min-h-0"><table class="w-full text-xs print:text-[7pt]"><thead class="hidden print:table-header-group"><tr><th class="text-left print:p-0.75 print:text-[7pt]">í•­ëª©</th><th class="text-right print:p-0.75 print:text-[7pt]">ìƒíƒœ</th></tr></thead><tbody>${validationChecklist.map((v, idx) => {
                    // Escape HTML in description for tooltip
                    const escapedDesc = (v.desc || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, ' ');
                    const toggleId = 'validation-toggle-' + idx;
                    const hasDetails = v.hasToggle && v.details && v.details.length > 0;
                    let rowHtml = ' <tr class="border-b last:border-0 border-gray-100 cursor-help print:border-gray-300" title="' + escapedDesc + '"> <td class="py-1 text-gray-600 print:text-black print:py-0.5 print:px-0.5 print:text-[7pt]" >';
                    
                    if (hasDetails) {
                        rowHtml += '<span class="cursor-pointer select-none hover:text-blue-600" onclick="const toggle = document.getElementById(\'' + toggleId + '\'); toggle.classList.toggle(\'hidden\'); const icon = this.querySelector(\'span\'); if (icon) icon.textContent = toggle.classList.contains(\'hidden\') ? \'â–¶\' : \'â–¼\';">' + v.label + ' <span class="text-xs inline-block ml-1">â–¶</span></span>';
                    } else {
                        rowHtml += v.label;
                    }
                    
                    rowHtml += '</td> <td class="py-1 text-right font-bold ' + (v.status ? 'text-blue-600' : 'text-red-500') + ' print:text-black print:py-0.5 print:px-0.5 print:text-[7pt]" > ' + (v.status ? 'âœ“' : 'âœ—') + '</td> </tr>';
                    
                    // Add detail rows if toggle exists
                    if (hasDetails) {
                        rowHtml += '<tr id="' + toggleId + '" class="hidden print:table-row"><td colspan="2" class="py-0.5 px-2 bg-gray-50 print:bg-white print:py-0.5"><table class="w-full text-xs print:text-[6pt]">';
                        v.details.forEach(d => {
                            const detailEscaped = (d.desc || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\n/g, ' ');
                            rowHtml += '<tr class="border-b last:border-0 border-gray-200 cursor-help" title="' + detailEscaped + '"><td class="py-0.5 pl-2 text-gray-500 print:text-black print:py-0.25 print:pl-1">' + d.label + '</td><td class="py-0.5 text-right font-bold ' + (d.status ? 'text-blue-600' : 'text-red-500') + ' print:text-black print:py-0.25">' + (d.status ? 'âœ“' : 'âœ—') + '</td></tr>';
                        });
                        rowHtml += '</table></td></tr>';
                    }
                    
                    return rowHtml;
                }).join('')
                }

    </tbody></table></div>${!isPass ? `<p class="mt-2 text-xs text-red-500 font-medium bg-white p-1 rounded border border-red-100 print:text-red-600 print:mt-1 print:p-1 print:text-[6pt]" > ${vRes
                    }

        </p > ` : ''
                }

    </div></div></div><!-- Bottom Row: Course List and AI Recommendations --><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 print:grid-cols-2 print:gap-1 print:mb-1 mt-6 print:mt-1 items-stretch"><!-- Left Bottom: Selected Course List (same width as Chart in print) --><div class="theme-card rounded border p-4 print:border-gray-300 print:break-inside-avoid print:mb-1 print:p-1 lg:col-span-2 print:col-span-1 flex flex-col"><h4 class="font-bold mb-2 theme-text print:text-black print:text-[7pt] print:mb-0.5">ğŸ“š ì„ íƒ ê³¼ëª© ëª©ë¡ (${courseList.length

                })</h4><div class="flex-1 overflow-y-auto custom-scrollbar print:overflow-visible print:max-h-none min-h-0"><table class="w-full text-xs text-left print:text-[8pt]"><thead class="bg-gray-50 dark:bg-gray-700 text-gray-500 font-medium print:bg-gray-100 print:text-black"><tr><th class="p-2 w-10 text-center print:p-0.5 print:text-[8pt]">í•™ë…„</th><th class="p-2 w-10 text-center print:p-0.5 print:text-[8pt]">í•™ê¸°</th><th class="p-2 print:p-0.5 print:text-[9pt]" style="width: 50% !important;">ê³¼ëª©ëª…</th><th class="p-2 w-10 text-center print:p-0.5 print:text-[8pt]">í•™ì </th></tr></thead><tbody class="divide-y divide-gray-100">${courseList.map(c => {
                    const [grade, sem] = c.semester.includes('-') ? c.semester.split('-') : ['?', '?'];
                    return ` <tr class="hover:bg-gray-50 print:border-b print:border-gray-200"> <td class="p-2 text-center text-gray-500 print:text-black font-mono print:p-0.5 print:text-[8pt]" >${grade}</td> <td class="p-2 text-center text-gray-500 print:text-black font-mono print:p-0.5 print:text-[8pt]" >${sem}</td> <td class="p-2 font-medium theme-text print:text-black print:p-0.5 print:text-[9pt]" style="width: 50% !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.name}</td> <td class="p-2 text-center text-gray-500 print:text-black print:p-0.5 print:text-[8pt]" >${c.credit}</td> </tr> `;
                }).join('')
                }

    </tbody></table></div></div><!-- Right Bottom: AI Recommendations (same width as Validation in print) --><div class="theme-card rounded border p-4 bg-indigo-50 dark:bg-indigo-900/20 border-indigo-100 print:bg-white print:border-gray-300 print:break-inside-avoid lg:col-span-1 print:col-span-1 flex flex-col"><h4 class="font-bold mb-2 text-indigo-800 dark:text-indigo-300 flex items-center gap-2 print:text-black print:text-[8pt] print:mb-0.75">ğŸ¤– AI ì¶”ì²œ íƒêµ¬í™œë™</h4><div id="ai-analysis-container" class="flex-1 text-sm space-y-3 print:overflow-visible"><div class="text-center py-4 print:hidden"><div class="text-xs text-indigo-400 mt-2">AIê°€ ì„ íƒ ê³¼ëª©ê³¼ ì§„ë¡œë¥¼ ë¶„ì„í•˜ì—¬<br>ì¶”ì²œ íƒêµ¬ í™œë™ê³¼ í‚¤ì›Œë“œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.</div></div><div class="print:block text-gray-600 text-xs p-2 print:text-black print:text-[7pt]">${s.Major ? 'AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.' : 'ì§„ë¡œ í¬ë§ ì •ë³´ê°€ ì—†ì–´ AI ë¶„ì„ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div></div></div></div></div><!-- í•™ê³¼ë³„ ê¶Œì¥ê³¼ëª© (ì„¹ì…˜ í•œ í–‰, 2ì—´ ê· ì¼) --><div class="mt-4 print:mt-2"><div class="theme-card rounded border p-4 print:border-gray-300 print:break-inside-avoid flex flex-col overflow-hidden"><h4 class="font-bold mb-2 theme-text print:text-black text-sm">ğŸ“ í•™ê³¼ë³„ ê¶Œì¥ê³¼ëª©</h4><p class="text-[10px] text-gray-500 dark:text-gray-400 mb-2">ê³¼ëª©ëª…ì„ í´ë¦­í•˜ë©´ ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p><div class="grid grid-cols-2 gap-4 flex-1 min-h-0 overflow-y-auto"><div id="recommended-courses-left" class="text-xs theme-text min-w-0">ë¡œë”© ì¤‘...</div><div id="recommended-courses-right" class="text-xs theme-text min-w-0">ë¡œë”© ì¤‘...</div></div></div></div><!-- ê³¼ëª©ë³„ ìœ„ê³„ ì´ìˆ˜ í˜„í™© (ì›ë˜ ë„ˆë¹„, ë³„ë„ í–‰) --><div class="mt-4 print:mt-2 w-full"><div class="theme-card rounded border p-4 print:border-gray-300 print:break-inside-avoid"><h4 class="font-bold mb-2 theme-text print:text-black text-sm">ğŸ“ ê³¼ëª©ë³„ ìœ„ê³„ ì´ìˆ˜ í˜„í™©</h4><div class="w-full overflow-x-auto overflow-y-auto text-xs custom-scrollbar min-h-[200px] max-h-[420px]">${hierarchyHtml}</div></div></div></div><div class="mt-6 text-center print:hidden flex justify-center gap-4"><button onclick="document.getElementById('modal-select-number').value='all'; renderIndividualStatsTable();"
    class="px-6 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors shadow">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸° </button><button onclick="showPrintOptions()"
    class="px-6 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors shadow flex items-center gap-2"><span>ğŸ–¨ï¸</span>ì¶œë ¥</button></div></div>`;
            modalContent.innerHTML = html;

            // í•™ê³¼ë³„ ê¶Œì¥ê³¼ëª© ë¡œë“œ (ì¶œì²˜ë³„ ì™¼ìª½/ì˜¤ë¥¸ìª½ 2ì—´, ê³¼ëª©ëª… í´ë¦­ ì‹œ ê³µë™êµìœ¡ê³¼ì • ì¡°íšŒ)
            setTimeout(async () => {
                const elLeft = document.getElementById('recommended-courses-left');
                const elRight = document.getElementById('recommended-courses-right');
                if (!elLeft || !elRight) return;
                try {
                    const [list, jointList] = await Promise.all([
                        (DB.fetchRecommendedCourses ? DB.fetchRecommendedCourses() : Promise.resolve([])).catch(() => []),
                        (DB.fetchJointCurriculum ? DB.fetchJointCurriculum() : Promise.resolve([])).catch(() => [])
                    ]);
                    window._adminJointCurriculum = jointList || [];
                    const major = (s.Major || '').trim();
                    if (!major) {
                        elLeft.innerHTML = '<p class="text-gray-500">ì§„ë¡œ í¬ë§ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        elRight.innerHTML = '';
                        return;
                    }
                    if (list.length === 0) {
                        elLeft.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ê¶Œì¥ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        elRight.innerHTML = '';
                        return;
                    }
                    const exact = list.find(r => (r.í•™ê³¼ || '').trim() === major);
                    const partial = list.filter(r => { const d = (r.í•™ê³¼ || '').trim(); return d && d !== major && (d.includes(major) || major.includes(d)); });
                    const makeCourseSpans = (text) => {
                        const items = (text || '').toString().split(/[,ï¼Œ]/).map(x => x.trim()).filter(Boolean);
                        return items.length ? items.map(name => {
                            const safe = name.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');
                            return `<span class="cursor-pointer hover:underline text-blue-600 dark:text-blue-400" onclick="showJointCourseInfo('${safe}')" title="ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ì—¬ë¶€ ì¡°íšŒ">${name.replace(/</g,'&lt;')}</span>`;
                        }).join(', ') : '-';
                    };
                    const renderRow = (r, showSource) => {
                        const ì¶œì²˜ = (r.ì¶œì²˜ || '').toString().trim();
                        const sourceHtml = showSource && ì¶œì²˜ ? `<p class="text-[10px] text-gray-400 dark:text-gray-500 mb-0.5">ì¶œì²˜: ${ì¶œì²˜.replace(/</g,'&lt;')}</p>` : '';
                        return `<div class="mb-2 p-2 bg-gray-50 dark:bg-gray-700/50 rounded">${sourceHtml}<p class="font-semibold text-gray-700 dark:text-gray-300">${(r.í•™ê³¼||'').toString().replace(/</g,'&lt;')}</p><p class="text-xs mb-0.5"><span class="text-amber-600 dark:text-amber-400 font-medium">í•µì‹¬ ê¶Œì¥ê³¼ëª©:</span> ${makeCourseSpans(r['í•µì‹¬ ê¶Œì¥ê³¼ëª©'])}</p><p class="text-xs"><span class="text-blue-600 dark:text-blue-400 font-medium">ê¶Œì¥ê³¼ëª©:</span> ${makeCourseSpans(r['ê¶Œì¥ê³¼ëª©'])}</p></div>`;
                    };
                    const rows = [];
                    if (exact) rows.push({ ...exact, _label: 'ì¼ì¹˜ í•™ê³¼' });
                    if (partial.length) rows.push(...partial.map(r => ({ ...r, _label: 'ìœ ì‚¬ í•™ê³¼' })));
                    if (rows.length === 0) {
                        elLeft.innerHTML = '<p class="text-gray-600 dark:text-gray-400">ì „ê³µì— ê´€ë ¨ìˆëŠ” ê³¼ëª©ì„ ì ê·¹ ì´ìˆ˜ ê¶Œì¥í•¨.</p>';
                        elRight.innerHTML = '';
                    } else {
                        const bySource = new Map();
                        rows.forEach(r => {
                            const ì¶œì²˜ = (r.ì¶œì²˜ || '').toString().trim() || '(ì¶œì²˜ ì—†ìŒ)';
                            if (!bySource.has(ì¶œì²˜)) bySource.set(ì¶œì²˜, []);
                            bySource.get(ì¶œì²˜).push(r);
                        });
                        const sources = [...bySource.keys()];
                        const mid = Math.ceil(sources.length / 2);
                        const leftSources = sources.slice(0, mid);
                        const rightSources = sources.slice(mid);
                        const fillColumn = (sourcesList, el) => {
                            if (!sourcesList.length) { el.innerHTML = ''; return; }
                            let html = '';
                            sourcesList.forEach(ì¶œì²˜ => {
                                const listRows = bySource.get(ì¶œì²˜) || [];
                                html += '<p class="text-[10px] text-gray-500 dark:text-gray-400 font-medium mt-2 mb-1">' + (ì¶œì²˜ !== '(ì¶œì²˜ ì—†ìŒ)' ? 'ì¶œì²˜: ' : '') + ì¶œì²˜.replace(/</g,'&lt;') + '</p>';
                                html += listRows.map(r => renderRow(r, false)).join('');
                            });
                            el.innerHTML = html || '<p class="text-gray-500">-</p>';
                        };
                        fillColumn(leftSources, elLeft);
                        fillColumn(rightSources, elRight);
                    }
                } catch (e) {
                    if (elLeft) elLeft.textContent = 'ê¶Œì¥ê³¼ëª© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    if (elRight) elRight.textContent = '';
                }
            }, 300);

            // Auto-fetch AI analysis if major is available
            if (s.Major) {
                setTimeout(async () => {
                    let jointCurriculum = [];
                    try { if (DB.fetchJointCurriculum) jointCurriculum = await DB.fetchJointCurriculum() || []; } catch (e) { console.warn('Joint curriculum fetch failed', e); }
                    fetchAiCareerAnalysis(s.Major, courseList.map(c => c.name).join(','), jointCurriculum);
                }, 500);
            }

            // Render Chart
            // Increased timeout to ensure Modal animation is finished or DOM is ready
            setTimeout(() => {
                const ctx = document.getElementById('individualCreditChart');

                if (ctx) {
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(creditStats),
                            datasets: [{
                                label: 'ì´ìˆ˜ í•™ì ',
                                data: Object.values(creditStats),
                                backgroundColor: ['rgba(173, 216, 230, 0.85)', 'rgba(152, 251, 152, 0.85)', 'rgba(221, 160, 221, 0.85)', 'rgba(255, 182, 193, 0.85)', 'rgba(255, 218, 185, 0.85)'],
                                borderRadius: 4
                            }]
                        },
                        options: {
                            indexAxis: 'x', // Always vertical bars for consistency
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    left: 5,
                                    right: 5,
                                    top: 5,
                                    bottom: 5
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: { display: false },
                                    ticks: {
                                        autoSkip: false,
                                        maxRotation: 45,
                                        minRotation: 0,
                                        font: { size: window.matchMedia('print').matches ? 7 : 10 }
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: { display: false },
                                    ticks: { font: { size: window.matchMedia('print').matches ? 7 : 11 } }
                                }
                            }
                        }
                    });
                }

                // êµê³¼ë³„ ì„ íƒí•™ì  ë§‰ëŒ€ + í•™ë…„ ì¶”ì„¸ì„  ì°¨íŠ¸ (íŒŒìŠ¤í…”í†¤, ì¶”ì„¸ì„ ì´ ë§‰ëŒ€ ìœ„ì— í‘œì‹œ)
                const subCategoryPalette = ['rgba(173, 216, 230, 0.85)', 'rgba(152, 251, 152, 0.85)', 'rgba(221, 160, 221, 0.85)', 'rgba(255, 182, 193, 0.85)', 'rgba(255, 218, 185, 0.85)', 'rgba(255, 228, 196, 0.85)', 'rgba(176, 224, 230, 0.85)', 'rgba(255, 192, 203, 0.85)', 'rgba(230, 230, 250, 0.85)', 'rgba(255, 250, 205, 0.85)'];
                const ctx2 = document.getElementById('individualSubCategoryChart');
                if (ctx2 && allSubCats && allSubCats.length > 0) {
                    const myCredits = allSubCats.map(sc => subCategoryCredits[sc] || 0);
                    const countMap = typeof gradeSubCategoryCount !== 'undefined' ? gradeSubCategoryCount : {};
                    const barColors = allSubCats.map((_, i) => subCategoryPalette[i % subCategoryPalette.length]);
                    new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: allSubCats,
                            datasets: [
                                { label: 'ë³¸ì¸ ì‹ ì²­í•™ì ', data: myCredits, backgroundColor: barColors, borderRadius: 4, order: 2 },
                                { label: 'í•™ë…„ í‰ê· ', data: gradeTrendData, type: 'line', borderColor: 'rgba(245, 158, 11, 0.95)', borderWidth: 2.5, backgroundColor: 'transparent', fill: false, pointRadius: 6, pointHoverRadius: 8, order: 1 }
                            ]
                        },
                        options: {
                            indexAxis: 'x',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true, position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        afterLabel: (ctx) => {
                                            if (ctx.datasetIndex === 1) {
                                                const idx = ctx.dataIndex;
                                                const sc = allSubCats[idx];
                                                const cnt = countMap[sc] || 0;
                                                return 'í•™ë…„ í•´ë‹¹ êµê³¼ ì„ íƒ: ' + cnt + 'ëª…';
                                            }
                                            return '';
                                        }
                                    }
                                }
                            },
                            onClick: (evt, els) => {
                                if (els && els[0] && els[0].datasetIndex === 1) {
                                    const idx = els[0].index;
                                    const sc = allSubCats[idx];
                                    const cnt = countMap[sc] || 0;
                                    alert(sc + ' êµê³¼ ì„ íƒ ì¸ì›: ' + cnt + 'ëª…');
                                }
                            },
                            scales: {
                                x: { beginAtZero: true, grid: { display: false } },
                                y: {
                                    beginAtZero: true,
                                    grid: { display: true },
                                    ticks: { stepSize: 10 },
                                    suggestedMax: (function() {
                                        const maxVal = Math.max(...myCredits, ...(gradeTrendData || []), 10);
                                        return Math.ceil(maxVal / 10) * 10;
                                    })()
                                }
                            }
                        }
                    });
                }
            }, 300); // 300ms delay
        }

        function getAiRecommendations(major) {

            // Mock Data
            const db = {
                'ê³µí•™': {
                    subjects: ['ì‹¬í™”ìˆ˜í•™I', 'ë¬¼ë¦¬í•™II íƒêµ¬ í”„ë¡œì íŠ¸', 'ì •ë³´ê³¼í•™ ì„¸ë¯¸ë‚˜'], keywords: ['ì•Œê³ ë¦¬ì¦˜', 'ë¬¸ì œí•´ê²°', 'ì‹œìŠ¤í…œì„¤ê³„']
                }

                ,
                'ì˜í•™': {
                    subjects: ['ìƒëª…ê³¼í•™II ì‹¤í—˜', 'í™”í•™ ì‹¬í™” íƒêµ¬', 'ì˜ë£Œ ìœ¤ë¦¬ í† ë¡ '], keywords: ['ìƒëª…ì¡´ì¤‘', 'ì„ìƒì‹¤í—˜', 'ë°ì´í„°ë¶„ì„']
                }

                ,
                'ì¸ë¬¸': {
                    subjects: ['ì‚¬íšŒë¬¸ì œ íƒêµ¬', 'ì„¸ê³„ì‚¬ ë¹„êµ ì—°êµ¬', 'ë¬¸í•™ ì°½ì‘ ì‹¤ìŠµ'], keywords: ['ë¹„íŒì ì‚¬ê³ ', 'ë¬¸í™”ì´í•´', 'ê¸€ì“°ê¸°']
                }

                ,
                'default': {
                    subjects: ['ì§„ë¡œì™€ ì§ì—… íƒìƒ‰', 'ì°½ì˜ì  ì²´í—˜í™œë™', 'ë…ì„œì™€ í† ë¡ '], keywords: ['ìê¸°ì£¼ë„', 'í˜‘ì—…', 'ì˜ì‚¬ì†Œí†µ']
                }
            };

            let key = 'default';

            if (major) {
                if (major.includes('ê³µí•™') || major.includes('ì»´í“¨í„°') || major.includes('SW')) key = 'ê³µí•™';
                else if (major.includes('ì˜') || major.includes('ê°„í˜¸') || major.includes('ìƒëª…')) key = 'ì˜í•™';
                else if (major.includes('ê²½ì˜') || major.includes('ì¸ë¬¸') || major.includes('ì‚¬íšŒ')) key = 'ì¸ë¬¸';
            }

            return db[key];
        }

        // NEW: Download Individual Student Report (Full Capture) - Print style
        window.downloadStudentReportImage = (studentName, studentNumber) => {
            // Check if html2canvas is available
            if (typeof html2canvas === 'undefined') {
                alert('ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                console.error('html2canvas is not defined');
                return;
            }

            // Target the actual Report Card Div
            const element = document.getElementById('student-report-card');

            if (!element) {
                alert('ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.error('student-report-card element not found');
                return;
            }

            console.log('Starting image download for:', studentName, studentNumber);

            // Clone to detach from DOM constraints
            const clone = element.cloneNode(true);
            clone.style.width = element.offsetWidth + 'px';
            clone.style.height = 'auto';
            clone.style.maxHeight = 'none';
            clone.style.overflow = 'visible';
            clone.style.overflowY = 'visible';
            clone.style.overflowX = 'visible';
            clone.style.transform = 'none';
            
            // Apply print styles to clone (output style)
            clone.classList.add('print-mode');
            
            // Remove scroll from all child elements
            const allElements = clone.querySelectorAll('*');
            allElements.forEach(el => {
                el.style.overflow = 'visible';
                el.style.overflowY = 'visible';
                el.style.overflowX = 'visible';
                el.style.maxHeight = 'none';
                // Remove scrollbar classes
                if (el.classList) {
                    el.classList.remove('overflow-y-auto', 'overflow-x-auto', 'custom-scrollbar');
                }
            });
            
            // Ensure header is visible and all content is shown (í•™ë²ˆ, ì´ë¦„, ì§„ë¡œí¬ë§ì‚¬í•­ í¬í•¨)
            const header = clone.querySelector('div:first-child');
            if (header) {
                header.style.display = 'flex';
                header.style.flexDirection = 'row';
                header.style.visibility = 'visible';
                header.style.opacity = '1';
                header.style.height = 'auto';
                header.style.minHeight = 'auto';
                header.style.maxHeight = 'none';
                header.style.overflow = 'visible';
                header.style.position = 'relative';
                header.style.zIndex = '10';
                header.style.marginBottom = '2mm';
                header.style.paddingBottom = '1.5mm';
                header.style.borderBottom = '1px solid #000';
                header.style.backgroundColor = '#ffffff';
                header.style.width = '100%';
                header.style.alignItems = 'center';
                header.style.justifyContent = 'space-between';
                
                // Force show all header children (í•™ë²ˆ, ì´ë¦„, ì§„ë¡œí¬ë§ì‚¬í•­, ì„ íƒê³¼ëª©, ì´ í•™ì )
                const headerChildren = header.querySelectorAll('*');
                headerChildren.forEach(child => {
                    child.style.display = '';
                    child.style.visibility = 'visible';
                    child.style.opacity = '1';
                    child.style.height = 'auto';
                    child.style.maxHeight = 'none';
                    child.style.overflow = 'visible';
                    // Ensure text is black and visible
                    if (child.tagName === 'H3' || child.tagName === 'SPAN' || child.tagName === 'P') {
                        child.style.color = '#000000';
                    }
                });
            }
            
            // Apply print styles to all sections (compact layout)
            const allSections = clone.querySelectorAll('.theme-card, .grid, div');
            allSections.forEach(section => {
                section.style.display = '';
                section.style.visibility = 'visible';
                section.style.opacity = '1';
                section.style.overflow = 'visible';
            });

            // Apply all print CSS styles to match output exactly
            // Base styles
            clone.style.fontSize = '9pt';
            clone.style.padding = '2mm';
            clone.style.margin = '0';
            clone.style.width = '100%';
            clone.style.maxWidth = '100%';
            clone.style.backgroundColor = '#ffffff';

            // Grid styles
            const grids = clone.querySelectorAll('.grid');
            grids.forEach(grid => {
                grid.style.gap = '1mm';
                grid.style.marginBottom = '1mm';
            });

            // Card styles
            const cards = clone.querySelectorAll('.theme-card');
            cards.forEach(card => {
                card.style.padding = '1mm';
                card.style.marginBottom = '1mm';
                card.style.border = '1px solid #e5e7eb';
                card.style.backgroundColor = '#ffffff';
            });

            // Heading styles
            const h4s = clone.querySelectorAll('h4');
            h4s.forEach(h4 => {
                h4.style.fontSize = '7pt';
                h4.style.marginBottom = '0.5mm';
                h4.style.lineHeight = '1.1';
            });

            // Chart container - apply print styles
            const chartContainers = clone.querySelectorAll('.theme-card.flex.flex-col > div.flex-1.flex');
            chartContainers.forEach(container => {
                container.style.minHeight = '100px';
                container.style.maxHeight = '140px';
                container.style.width = '100%';
                container.style.height = '100%';
            });

            // Table styles
            const tables = clone.querySelectorAll('table');
            tables.forEach(table => {
                table.style.fontSize = '7pt';
                table.style.width = '100%';
            });

            const tableCells = clone.querySelectorAll('table th, table td');
            tableCells.forEach(cell => {
                cell.style.padding = '0.75mm 0.5mm';
                cell.style.lineHeight = '1.2';
            });

            // Course name column
            const courseNameCells = clone.querySelectorAll('table td:nth-child(3)');
            courseNameCells.forEach(cell => {
                cell.style.fontSize = '9pt';
            });

            // Text sizes
            const textXs = clone.querySelectorAll('.text-xs');
            textXs.forEach(el => {
                el.style.fontSize = '7pt';
            });

            // Spacing adjustments
            const mb6 = clone.querySelectorAll('.mb-6');
            mb6.forEach(el => {
                el.style.marginBottom = '1.5mm';
            });

            const mb4 = clone.querySelectorAll('.mb-4');
            mb4.forEach(el => {
                el.style.marginBottom = '1mm';
            });

            const mb2 = clone.querySelectorAll('.mb-2');
            mb2.forEach(el => {
                el.style.marginBottom = '0.75mm';
            });

            // AI section - apply print styles
            const aiSections = clone.querySelectorAll('.bg-indigo-50');
            aiSections.forEach(section => {
                section.style.backgroundColor = '#ffffff';
                section.style.border = '1px solid #e5e7eb';
                section.style.display = 'block';
            });

            // Hide print:hidden elements (buttons, etc.)
            const printHiddenElements = clone.querySelectorAll('[class*="print:hidden"]');
            printHiddenElements.forEach(el => {
                el.style.display = 'none';
            });

            // Show print:block elements
            const printBlockElements = clone.querySelectorAll('[class*="print:block"]');
            printBlockElements.forEach(el => {
                el.style.display = 'block';
            });

            // Apply print text colors
            const printTextElements = clone.querySelectorAll('[class*="print:text-black"]');
            printTextElements.forEach(el => {
                el.style.color = '#000000';
            });

            // Apply print background colors
            const printBgElements = clone.querySelectorAll('[class*="print:bg-white"]');
            printBgElements.forEach(el => {
                el.style.backgroundColor = '#ffffff';
            });

            // Manually copy Canvas content (Chart.js)
            const originalCanvas = element.querySelector('canvas');
            const clonedCanvas = clone.querySelector('canvas');
            if (originalCanvas && clonedCanvas) {
                const ctx = clonedCanvas.getContext('2d');
                ctx.drawImage(originalCanvas, 0, 0);
            }

            // Copy AI analysis content if it exists (ensure it's included in image)
            const originalAiContainer = element.querySelector('#ai-analysis-container');
            const clonedAiContainer = clone.querySelector('#ai-analysis-container');
            if (originalAiContainer && clonedAiContainer) {
                clonedAiContainer.innerHTML = originalAiContainer.innerHTML;
                // Ensure AI container is visible in print style
                clonedAiContainer.style.display = 'block';
                clonedAiContainer.style.visibility = 'visible';
                clonedAiContainer.style.opacity = '1';
                clonedAiContainer.style.overflow = 'visible';
                clonedAiContainer.style.maxHeight = 'none';
                // Hide loading spinner if present
                const loadingSpinner = clonedAiContainer.querySelector('.animate-spin');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
                // Show print:block content
                const printBlockContent = clonedAiContainer.querySelector('[class*="print:block"]');
                if (printBlockContent) {
                    printBlockContent.style.display = 'block';
                }
            }

            // Ensure full content is visible before capture
            const allCards = clone.querySelectorAll('.theme-card');
            allCards.forEach(card => {
                card.style.pageBreakInside = 'avoid';
                card.style.breakInside = 'avoid';
            });
            
            // Add to temp container with extra padding to prevent clipping
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.top = '-9999px';
            container.style.left = '0';
            container.style.background = '#ffffff';
            container.style.padding = '5mm';
            container.style.width = '210mm'; // A4 width
            container.style.minHeight = 'auto';
            container.style.height = 'auto';
            container.style.overflow = 'visible';
            container.appendChild(clone);
            document.body.appendChild(container);

            // Force layout recalculation
            void container.offsetHeight;
            
            // Wait for AI analysis if still loading, then proceed with image capture
            const waitForAiAndCapture = async () => {
                // Wait for AI analysis to complete if it's still loading
                const aiContainer = element.querySelector('#ai-analysis-container');
                if (aiContainer) {
                    const loadingSpinner = aiContainer.querySelector('.animate-spin');
                    if (loadingSpinner) {
                        // Wait for AI analysis to complete
                        let aiComplete = false;
                        let attempts = 0;
                        const maxAttempts = 60; // 30 seconds max wait
                        
                        while (!aiComplete && attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                            const spinner = aiContainer.querySelector('.animate-spin');
                            const errorMsg = aiContainer.querySelector('.text-red-500');
                            const hasContent = aiContainer.innerHTML && 
                                !aiContainer.innerHTML.includes('ì˜¤í”ˆAIê°€ ìƒí™œê¸°ë¡ë¶€ì™€ ì§„ë¡œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤') &&
                                !aiContainer.innerHTML.includes('AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤');
                            if ((!spinner || errorMsg) && hasContent) {
                                aiComplete = true;
                            }
                            attempts++;
                        }
                        
                        // Update cloned AI container with latest content
                        const clonedAiContainer = clone.querySelector('#ai-analysis-container');
                        if (clonedAiContainer && aiContainer) {
                            clonedAiContainer.innerHTML = aiContainer.innerHTML;
                        }
                        
                        // Additional wait to ensure content is fully rendered
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                // Force a reflow to ensure all styles are applied
                clone.style.display = 'block';
                void clone.offsetHeight;
                
                // Calculate full height including all content after styles are applied
                // Get the actual rendered height from the clone
                const cloneRect = clone.getBoundingClientRect();
                const actualHeight = Math.max(
                    clone.scrollHeight,
                    clone.offsetHeight,
                    cloneRect.height,
                    container.scrollHeight - 10, // Subtract container padding
                    element.scrollHeight
                );

                console.log('Height calculation:', {
                    cloneScrollHeight: clone.scrollHeight,
                    cloneOffsetHeight: clone.offsetHeight,
                    cloneRectHeight: cloneRect.height,
                    containerScrollHeight: container.scrollHeight,
                    elementScrollHeight: element.scrollHeight,
                    actualHeight: actualHeight
                });

                // Use html2canvas to capture full content
            html2canvas(container, {
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true,
                    logging: true, // Enable logging to debug
                    width: container.offsetWidth,
                    height: actualHeight + 40, // Add padding for margins
                    windowWidth: container.offsetWidth,
                    windowHeight: actualHeight + 40,
                    scrollX: 0,
                    scrollY: 0,
                    allowTaint: true,
                    removeContainer: false,
                ignoreElements: (element) => {
                    return element.tagName === 'BUTTON';
                    },
                    onclone: (clonedDoc) => {
                        // Ensure all elements are visible in the cloned document
                        const clonedContainer = clonedDoc.querySelector('div');
                        if (clonedContainer) {
                            clonedContainer.style.overflow = 'visible';
                            clonedContainer.style.height = 'auto';
                            clonedContainer.style.maxHeight = 'none';
                        }
                        // Ensure clone is fully visible
                        const clonedClone = clonedDoc.querySelector('#student-report-card') || clonedDoc.querySelector('[id^="student-report"]');
                        if (clonedClone) {
                            clonedClone.style.height = 'auto';
                            clonedClone.style.maxHeight = 'none';
                            clonedClone.style.overflow = 'visible';
                        }
                }
            }).then(canvas => {
                    console.log('Canvas created successfully, size:', canvas.width, 'x', canvas.height);
                const link = document.createElement('a');
                    const fileName = `${String(studentNumber).padStart(2, '0')}_${studentName}_ë¦¬í¬íŠ¸.png`;
                    link.download = fileName;
                link.href = canvas.toDataURL('image/png');
                    document.body.appendChild(link);
                link.click();
                    setTimeout(() => {
                        document.body.removeChild(link);
                    }, 100);
                    console.log('Image download triggered:', fileName);
            }).catch(err => {
                console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', err);
                    alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (err.message || err));
            }).finally(() => {
                    if (container && container.parentNode) {
                document.body.removeChild(container);
                    }
            });
            };

            // Start the async process
            waitForAiAndCapture();
        };

        // Close Individual Stats Modal
        window.closeIndividualStats = () => {
            document.getElementById('class-lookup-modal').classList.add('hidden');
        };

        // Show print options modal
        window.showPrintOptions = () => {
            const modal = document.getElementById('print-options-modal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                // Create modal if it doesn't exist
                const printModal = document.createElement('div');
                printModal.id = 'print-options-modal';
                printModal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50';
                printModal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full shadow-2xl">
                        <h3 class="text-xl font-bold theme-text mb-4">ì¶œë ¥ ì˜µì…˜ ì„ íƒ</h3>
                        <p class="text-sm theme-text-muted mb-2">ì¶œë ¥í•  ë‚´ìš©ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                        <p class="text-xs text-gray-500 mb-6">(ì¸ì‡„ ëŒ€í™”ìƒìì—ì„œ ëŒ€ìƒ: <strong>PDFë¡œ ì €ì¥</strong> ì„ íƒ ì‹œ íŒŒì¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. A4 ì„¸ë¡œ, 2~3ìª½)</p>
                        <div class="flex flex-col gap-3">
                            <button onclick="printIndividualReport()" class="w-full px-6 py-3 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors shadow flex items-center justify-center gap-2">
                                <span>ğŸ“„</span> ê°œì¸ í†µê³„ìë£Œ ì¶œë ¥
                            </button>
                            <button onclick="printClassRoster()" class="w-full px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors shadow flex items-center justify-center gap-2">
                                <span>ğŸ“‹</span> í•™ê¸‰ ì „ì²´ í•™ìƒ í†µê³„ìë£Œ ì¶œë ¥
                            </button>
                            <button onclick="closePrintOptions()" class="w-full px-6 py-3 bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors">
                                ì·¨ì†Œ
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(printModal);
                printModal.classList.remove('hidden');
            }
        };

        // Close print options modal
        window.closePrintOptions = () => {
            const modal = document.getElementById('print-options-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Print individual report (PDF ì €ì¥ ì‹œ ë¸Œë¼ìš°ì €ì—ì„œ 'ëŒ€ìƒ: PDFë¡œ ì €ì¥' ì„ íƒ)
        window.printIndividualReport = () => {
            closePrintOptions();
            const content = document.getElementById('class-stats-content');
            if (content) content.scrollTop = 0;
            const modalInner = document.querySelector('#class-lookup-modal > div');
            if (modalInner) modalInner.scrollTop = 0;
            window.print();
        };

        // Print class roster - Print all individual reports as one PDF
        window.printClassRoster = async () => {
            closePrintOptions();
            
            const grade = document.getElementById('modal-select-grade').value;
            const cls = document.getElementById('modal-select-class').value;
            
            if (!grade || !cls) {
                alert('í•™ë…„ê³¼ ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // Get all students for this class
            let targetStudents = [];
            
            if (registryData && registryData.length > 0) {
                targetStudents = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '');
                    const rGrade = sNum.substring(0, 1);
                    const rClass = parseInt(sNum.substring(1, 3));
                    return rGrade == grade && rClass == cls;
                }).map(r => {
                    const num = parseInt(String(r['í•™ë²ˆ']).substring(3, 5));
                    return {
                        Grade: grade,
                        Class: cls,
                        Number: num,
                        Name: r['ì´ë¦„'] || r.name,
                        isRegistry: true
                    };
                }).sort((a, b) => parseInt(a.Number) - parseInt(b.Number));
            } else {
                targetStudents = allStudentData
                    .filter(s => s.Grade == grade && s.Class == cls)
                    .sort((a, b) => parseInt(a.Number) - parseInt(b.Number));
            }

            if (targetStudents.length === 0) {
                alert('í•´ë‹¹ í•™ê¸‰ì— í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Filter only students with submission data
            const studentsWithData = targetStudents.filter(student => {
                return allStudentData.find(s => 
                    s.Grade == student.Grade && 
                    s.Class == student.Class && 
                    parseInt(s.Number) == parseInt(student.Number)
                );
            });

            if (studentsWithData.length === 0) {
                alert('ì œì¶œëœ ë°ì´í„°ê°€ ìˆëŠ” í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // Confirm before printing
            const confirmMsg = `${studentsWithData.length}ëª…ì˜ í•™ìƒ ë¦¬í¬íŠ¸ë¥¼ í•˜ë‚˜ì˜ PDF íŒŒì¼ë¡œ ì¶œë ¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (!confirm(confirmMsg)) {
                return;
            }

            // Show loading
            const modalContent = document.getElementById('class-stats-content');
            modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600 text-lg font-medium">ë¦¬í¬íŠ¸ ìƒì„± ì¤‘... (${studentsWithData.length}ëª…)</p>
                </div>
            `;

            // Create a container for all reports
            const printContainer = document.createElement('div');
            printContainer.id = 'batch-print-container';
            printContainer.style.position = 'absolute';
            printContainer.style.top = '-9999px';
            printContainer.style.left = '0';
            printContainer.style.width = '100%';
            printContainer.style.background = '#ffffff';
            document.body.appendChild(printContainer);

            try {
                // Render each student report and collect HTML
                for (let i = 0; i < studentsWithData.length; i++) {
                    const student = studentsWithData[i];
                    const submission = allStudentData.find(s => 
                        s.Grade == student.Grade && 
                        s.Class == student.Class && 
                        parseInt(s.Number) == parseInt(student.Number)
                    );

                    if (submission) {
                        // Render the report in modal (hidden)
                        await renderDetailedStudentReport(submission);
                        
                        // Wait for chart to render
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        // Wait for AI analysis to complete if major is available
                        if (submission.Major) {
                            const aiContainer = document.getElementById('ai-analysis-container');
                            if (aiContainer) {
                                // Wait for AI analysis to complete (check if loading spinner is gone)
                                let aiComplete = false;
                                let attempts = 0;
                                const maxAttempts = 60; // 30 seconds max wait
                                
                                while (!aiComplete && attempts < maxAttempts) {
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                    const loadingSpinner = aiContainer.querySelector('.animate-spin');
                                    const errorMsg = aiContainer.querySelector('.text-red-500');
                                    const hasContent = aiContainer.innerHTML && 
                                        !aiContainer.innerHTML.includes('ì˜¤í”ˆAIê°€ ìƒí™œê¸°ë¡ë¶€ì™€ ì§„ë¡œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤') &&
                                        !aiContainer.innerHTML.includes('AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤');
                                    // AI is complete if there's no loading spinner and content is loaded
                                    if ((!loadingSpinner || errorMsg) && hasContent) {
                                        aiComplete = true;
                                    }
                                    attempts++;
                                }
                                
                                // Additional wait to ensure content is fully rendered
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                        }
                        
                        // Get the rendered report card
                        const reportCard = document.getElementById('student-report-card');
                        if (reportCard) {
                            // Clone the report card
                            const clonedCard = reportCard.cloneNode(true);
                            
                            // Add page break after each report (except the last one)
                            if (i < studentsWithData.length - 1) {
                                clonedCard.style.pageBreakAfter = 'always';
                                clonedCard.style.breakAfter = 'page';
                            }
                            
                            // Ensure chart is copied
                            const originalCanvas = reportCard.querySelector('canvas');
                            const clonedCanvas = clonedCard.querySelector('canvas');
                            if (originalCanvas && clonedCanvas) {
                                const ctx = clonedCanvas.getContext('2d');
                                ctx.drawImage(originalCanvas, 0, 0);
                            }
                            
                            // Copy AI analysis content if it exists
                            const originalAiContainer = reportCard.querySelector('#ai-analysis-container');
                            const clonedAiContainer = clonedCard.querySelector('#ai-analysis-container');
                            if (originalAiContainer && clonedAiContainer) {
                                clonedAiContainer.innerHTML = originalAiContainer.innerHTML;
                            }
                            
                            // Add to print container
                            printContainer.appendChild(clonedCard);
                        }
                    }
                }

                // Hide modal and show print container
                document.getElementById('class-lookup-modal').classList.add('hidden');
                printContainer.style.position = 'relative';
                printContainer.style.top = '0';
                
                // Wait a bit for layout to settle
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Print
                window.print();
                
                // Clean up after print
                setTimeout(() => {
                    document.body.removeChild(printContainer);
                    // Restore modal
                    document.getElementById('class-lookup-modal').classList.remove('hidden');
                    // Reset to class list view
                    document.getElementById('modal-select-number').value = 'all';
                    renderIndividualStatsTable();
                }, 1000);

            } catch (error) {
                console.error('Batch print error:', error);
                alert('ì¶œë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                if (printContainer && printContainer.parentNode) {
                    document.body.removeChild(printContainer);
                }
                document.getElementById('class-lookup-modal').classList.remove('hidden');
            }
        };

        // Close batch save progress modal
        window.closeBatchSaveProgress = () => {
            const modal = document.getElementById('batch-save-progress-modal');
            if (modal) {
                modal.classList.add('hidden');
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
        };

        // Download student report image for batch processing (with callback)
        window.downloadStudentReportImageForBatch = (studentName, studentNumber, callback) => {
            const element = document.getElementById('student-report-card');
            if (!element) {
                if (callback) callback();
                return;
            }

            // Clone to detach from DOM constraints
            const clone = element.cloneNode(true);
            clone.style.width = element.offsetWidth + 'px';
            clone.style.height = 'auto';
            clone.style.maxHeight = 'none';
            clone.style.overflow = 'visible';
            clone.style.overflowY = 'visible';
            clone.style.overflowX = 'visible';
            clone.style.transform = 'none';
            
            // Apply print styles to clone (output style)
            clone.classList.add('print-mode');
            
            // Remove scroll from all child elements
            const allElements = clone.querySelectorAll('*');
            allElements.forEach(el => {
                el.style.overflow = 'visible';
                el.style.overflowY = 'visible';
                el.style.overflowX = 'visible';
                el.style.maxHeight = 'none';
                if (el.classList) {
                    el.classList.remove('overflow-y-auto', 'overflow-x-auto', 'custom-scrollbar');
                }
            });
            
            // Ensure header is visible
            const header = clone.querySelector('div:first-child');
            if (header) {
                header.style.display = 'flex';
                header.style.flexDirection = 'row';
                header.style.visibility = 'visible';
                header.style.opacity = '1';
                header.style.height = 'auto';
                header.style.minHeight = 'auto';
                header.style.maxHeight = 'none';
                header.style.overflow = 'visible';
                header.style.position = 'relative';
                header.style.zIndex = '10';
                header.style.marginBottom = '2mm';
                header.style.paddingBottom = '1.5mm';
                header.style.borderBottom = '1px solid #000';
                header.style.backgroundColor = '#ffffff';
                header.style.width = '100%';
                header.style.alignItems = 'center';
                header.style.justifyContent = 'space-between';
                
                const headerChildren = header.querySelectorAll('*');
                headerChildren.forEach(child => {
                    child.style.display = '';
                    child.style.visibility = 'visible';
                    child.style.opacity = '1';
                    child.style.height = 'auto';
                    child.style.maxHeight = 'none';
                    child.style.overflow = 'visible';
                    if (child.tagName === 'H3' || child.tagName === 'SPAN' || child.tagName === 'P') {
                        child.style.color = '#000000';
                    }
                });
            }
            
            // Apply print styles
            const allSections = clone.querySelectorAll('.theme-card, .grid, div');
            allSections.forEach(section => {
                section.style.display = '';
                section.style.visibility = 'visible';
                section.style.opacity = '1';
                section.style.overflow = 'visible';
            });

            const grids = clone.querySelectorAll('.grid');
            grids.forEach(grid => {
                grid.style.gap = '1mm';
                grid.style.marginBottom = '1mm';
            });

            const cards = clone.querySelectorAll('.theme-card');
            cards.forEach(card => {
                card.style.padding = '1mm';
                card.style.marginBottom = '1mm';
            });

            const h4s = clone.querySelectorAll('h4');
            h4s.forEach(h4 => {
                h4.style.fontSize = '7pt';
                h4.style.marginBottom = '0.5mm';
            });

            const chartContainers = clone.querySelectorAll('.theme-card.flex.flex-col > div.flex-1.flex');
            chartContainers.forEach(container => {
                container.style.minHeight = '100px';
                container.style.maxHeight = '140px';
            });

            // Manually copy Canvas content (Chart.js)
            const originalCanvas = element.querySelector('canvas');
            const clonedCanvas = clone.querySelector('canvas');
            if (originalCanvas && clonedCanvas) {
                const ctx = clonedCanvas.getContext('2d');
                ctx.drawImage(originalCanvas, 0, 0);
            }

            const allCards = clone.querySelectorAll('.theme-card');
            allCards.forEach(card => {
                card.style.pageBreakInside = 'avoid';
                card.style.breakInside = 'avoid';
            });
            
            // Add to temp container
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.top = '-9999px';
            container.style.left = '-9999px';
            container.style.background = '#ffffff';
            container.style.padding = '30px';
            container.style.width = (element.scrollWidth + 60) + 'px';
            container.appendChild(clone);
            document.body.appendChild(container);

            const fullHeight = Math.max(
                clone.scrollHeight,
                clone.offsetHeight,
                element.scrollHeight
            );

            html2canvas(container, {
                scale: 2,
                backgroundColor: '#ffffff',
                useCORS: true,
                logging: false,
                width: element.scrollWidth + 60,
                height: fullHeight + 60,
                windowWidth: element.scrollWidth + 60,
                windowHeight: fullHeight + 60,
                scrollX: 0,
                scrollY: 0,
                allowTaint: true,
                ignoreElements: (element) => {
                    return element.tagName === 'BUTTON';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${String(studentNumber).padStart(2, '0')}_${studentName}_ë¦¬í¬íŠ¸.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Clean up
                document.body.removeChild(container);
                
                // Call callback after a short delay
                if (callback) {
                    setTimeout(callback, 300);
                }
            }).catch(err => {
                console.error('ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨:', err);
                document.body.removeChild(container);
                if (callback) callback();
            });
        };

        // Helper to capture class roster
        window.downloadClassRosterImage = () => {
            // Target the scrollable content area
            const element = document.getElementById('dashboard-tab-content');
            if (!element) return;

            // Verify content exists
            if (element.children.length === 0) return alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

            // Clone the element to capture full height without scrollbars
            const clone = element.cloneNode(true);
            clone.style.height = 'auto';
            clone.style.overflow = 'visible';
            clone.style.width = element.scrollWidth + 'px'; // Ensure full width
            clone.style.maxHeight = 'none';

            // Create a temporary container off-screen
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.top = '-9999px';
            container.style.left = '-9999px';
            container.style.width = element.offsetWidth + 'px'; // Match original width
            container.style.background = '#ffffff';
            container.style.padding = '20px'; // Add padding

            // Add Header manually since it's outside the scroll area
            const grade = document.getElementById('dashboard-select-grade').value;
            const cls = document.getElementById('dashboard-select-class').value;
            const header = document.createElement('h2');
            header.textContent = `${grade}í•™ë…„ ${cls}ë°˜ ì‹ ì²­ í˜„í™©`;
            header.style.textAlign = 'center';
            header.style.fontSize = '24px';
            header.style.fontWeight = 'bold';
            header.style.marginBottom = '20px';
            header.style.color = '#333';
            container.appendChild(header);

            container.appendChild(clone);
            document.body.appendChild(container);

            html2canvas(container, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                ignoreElements: (el) => {
                    return el.tagName === 'BUTTON'; // Remove buttons from image
                },
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight
            }).then(canvas => {
                const link = document.createElement('a');
                const grade = document.getElementById('dashboard-select-grade').value;
                const cls = document.getElementById('dashboard-select-class').value;
                link.download = `í•™ê¸‰ì‹ ì²­í˜„í™©_${grade}í•™ë…„${cls}ë°˜.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('Capture failed', err);
                alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }).finally(() => {
                document.body.removeChild(container);
            });
        };

        function populateClassOptions() {
            // Find existing max class or default to 15
            const maxClass = 15;

            const optionsHtml = [...Array(maxClass).keys()].map(i => `<option value="${i + 1}" >${i + 1
                }

            ë°˜</option>`).join('');

            const filterEl = document.getElementById('filter-class');
            const modalEl = document.getElementById('modal-select-class');
            const dashboardEl = document.getElementById('dashboard-select-class');

            if (filterEl) {

                // Ensure filter-class has all options but keep "All Classes"
                if (!filterEl.innerHTML.includes('1ë°˜')) {
                    filterEl.innerHTML = '<option value="">ì „ì²´ ë°˜</option>' + optionsHtml;
                }
            }

            if (modalEl) modalEl.innerHTML = optionsHtml;
            if (dashboardEl) dashboardEl.innerHTML = optionsHtml;
        }

        // Call on load
        document.addEventListener('DOMContentLoaded', () => {
            populateClassOptions();
        });

        // 1. Individual Stats (Class Lookup Modal) - "ê°œì¸ë³„ í†µê³„"
        window.openIndividualStats = () => {
            document.getElementById('class-lookup-modal').classList.remove('hidden');
            populateStudentNumberOptions();
        };

        // 2. Class Stats Dashboard (Dashboard Modal) - "í•™ê¸‰ í†µê³„" & "í•™ê¸‰ë³„ ì‹ ì²­ í˜„í™© ì¡°íšŒ"
        // 2. Class Stats Dashboard (Dashboard Modal) - Shared Entry Point
        // Mode: 'roster' (List Only) or 'stats' (Analysis Tabs)
        window.dashboardViewMode = 'roster';

        window.openClassRoster = () => {
            window.dashboardViewMode = 'roster';
            document.getElementById('class-stats-dashboard-modal').classList.remove('hidden');

            // Sync filters
            const mainGrade = document.getElementById('filter-grade').value || '1';
            const mainClass = document.getElementById('filter-class').value || '1';
            document.getElementById('dashboard-select-grade').value = mainGrade;
            document.getElementById('dashboard-select-class').value = mainClass;

            renderClassStatsDashboard();
        };

        window.openClassStatistics = () => {
            window.dashboardViewMode = 'stats';
            document.getElementById('class-stats-dashboard-modal').classList.remove('hidden');

            const mainGrade = document.getElementById('filter-grade').value || '1';
            const mainClass = document.getElementById('filter-class').value || '1';
            document.getElementById('dashboard-select-grade').value = mainGrade;
            document.getElementById('dashboard-select-class').value = mainClass;

            // Default tab for stats
            window.switchDashboardTab('class-subjects');
            renderClassStatsDashboard();
        };

        // Old Alias kept for compatibility if needed
        window.openClassStats = window.openClassRoster;
        window.openClassStatsDashboard = window.openClassStatistics;

        window.closeClassStats = () => {
            document.getElementById('class-stats-dashboard-modal').classList.add('hidden');
        };

        window.switchDashboardTab = (tabId) => {
            window.currentDashboardTab = tabId;
            renderClassStatsDashboard();
        };

        // Render Dashboard Content based on Mode
        async function renderClassStatsDashboard() {
            const container = document.getElementById('dashboard-content');
            const tabContent = document.getElementById('dashboard-tab-content');
            const tabsContainer = document.getElementById('dashboard-tabs');
            const message = document.getElementById('dashboard-message');

            // Show content
            container.classList.remove('hidden');
            message.classList.add('hidden');

            // Get Current Filter State
            const grade = document.getElementById('dashboard-select-grade').value;
            const cls = document.getElementById('dashboard-select-class').value;

            // Filter Students
            let students = allStudentData.filter(s => s.Grade == grade && s.Class == cls);

            // --- VIEW MODE HANDLING ---
            if (window.dashboardViewMode === 'roster') {
                // ROSTER VIEW: No Tabs, Fixed Header, Save Image
                tabsContainer.innerHTML = `
                    <div class="flex justify-between items-center w-full">
                        <div class="px-4 py-2 text-lg font-bold text-blue-600 border-b-2 border-blue-600">
                             ğŸ“‹ ${grade}í•™ë…„ ${cls}ë°˜ ëª…ë ¬í‘œ
                        </div>
                        <button onclick="downloadClassRosterImage()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                            ğŸ“· ì´ë¯¸ì§€ ì €ì¥
                        </button>
                    </div>
                `;

                // Content
                renderClassStatusList(tabContent, students, grade, cls);

            } else {
                // STATS VIEW: Tabs (Class Subjects, Grade Subjects)
                const tabs = [
                    { id: 'class-subjects', label: 'í•™ê¸‰ë³„ ê³¼ëª© ì‹ ì²­' },
                    { id: 'grade-subjects', label: 'ì „ì²´(í•™ë…„) ê³¼ëª© ì‹ ì²­' }
                ];

                // Render Tabs
                tabsContainer.innerHTML = tabs.map(t => `
                    <button onclick="switchDashboardTab('${t.id}')" 
                        class="px-4 py-2 font-medium transition-colors border-b-2 ${window.currentDashboardTab === t.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                        ${t.label}
                    </button>
                `).join('');

                // Render Content based on Active Tab
                if (window.currentDashboardTab === 'class-subjects') {
                    await renderClassSubjectStats(tabContent, students);
                } else if (window.currentDashboardTab === 'grade-subjects') {
                    // í•„í„° ë³€ê²½ ì‹œ window.gradeDashboardGradeFilterë¥¼ ì‚¬ìš©í•˜ë„ë¡ í•¨
                    await renderGradeSubjectStats(tabContent, allStudentData, window.gradeDashboardGradeFilter || grade);
                }
            }
        }

        // New Feature: Class Status List (Roster)
        function renderClassStatusList(container, students, grade, cls) {
            // 1. Merge with Registry to find missing students
            let roster = [];

            // Generate full roster from registry if available
            if (registryData && registryData.length > 0) {
                roster = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '').trim();
                    return sNum.startsWith(grade) && parseInt(sNum.substring(1, 3)) == cls;
                }).map(r => {
                    const num = parseInt(String(r['í•™ë²ˆ']).trim().substring(3, 5));
                    const submitted = students.find(s => parseInt(s.Number) == num);
                    return {
                        number: num,
                        name: r['ì´ë¦„'] || r.name,
                        major: submitted ? submitted.Major : '-',
                        count: submitted && submitted.SelectedCourses ? submitted.SelectedCourses.split(',').length : 0,
                        credits: submitted ? submitted.TotalCredits : 0,
                        status: submitted ? 'ì™„ë£Œ' : 'ë¯¸ì‹ ì²­',
                        raw: submitted
                    };
                });
            } else {
                // Fallback to just submitted students
                roster = students.map(s => ({
                    number: parseInt(s.Number),
                    name: s.Name,
                    major: s.Major,
                    count: s.SelectedCourses ? s.SelectedCourses.split(',').length : 0,
                    credits: s.TotalCredits,
                    status: 'ì™„ë£Œ',
                    raw: s
                }));
            }

            roster.sort((a, b) => a.number - b.number);

            // Render Table
            const html = `
                        <div class="mb-4 flex justify-between items-center">
                            <span class="text-sm text-gray-500">
                                ì´ ${roster.length}ëª… (ì œì¶œ: <span class="text-blue-600 font-bold">${students.length}</span> / ë¯¸ì œì¶œ: <span class="text-red-500 font-bold">${roster.length - students.length}</span>)
                            </span>
                            <button onclick="window.print()" class="text-sm bg-gray-100 px-3 py-1 rounded hover:bg-gray-200">ğŸ–¨ï¸ ì¸ì‡„</button>
                        </div>
                        <div class="overflow-x-auto border rounded-lg">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-700 uppercase">
                                    <tr>
                                        <th class="px-4 py-3 text-center w-16">ë²ˆí˜¸</th>
                                        <th class="px-4 py-3 text-center w-24">ì´ë¦„</th>
                                        <th class="px-4 py-3 text-center">ì§„ë¡œ í¬ë§</th>
                                        <th class="px-4 py-3 text-center w-24">ì‹ ì²­ ê³¼ëª©</th>
                                        <th class="px-4 py-3 text-center w-20">í•™ì </th>
                                        <th class="px-4 py-3 text-center w-24">ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 bg-white">
                                    ${roster.length > 0 ? roster.map(s => `
                                        <tr class="hover:bg-gray-50 cursor-pointer transition" onclick="openDetailedReport(${s.number})">
                                            <td class="px-4 py-3 text-center font-medium">${s.number}</td>
                                            <td class="px-4 py-3 text-center font-bold text-gray-900">${s.name}</td>
                                            <td class="px-4 py-3 text-center text-gray-500">${s.major}</td>
                                            <td class="px-4 py-3 text-center">${s.count}</td>
                                            <td class="px-4 py-3 text-center">${s.credits}</td>
                                            <td class="px-4 py-3 text-center">
                                                <span class="px-2 py-1 rounded text-xs font-bold ${s.status === 'ì™„ë£Œ' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                                    ${s.status}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="6" class="p-8 text-center text-gray-500">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                        <p class="mt-4 text-xs text-center text-gray-400">í•™ìƒ ì´ë¦„ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ë¦¬í¬íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    `;
            container.innerHTML = html;
        }

        // Helper to link back to detailed report
        window.openDetailedReport = (studentNum) => {
            // Close Dashboard
            document.getElementById('class-stats-dashboard-modal').classList.add('hidden');

            // Open Individual Stats Modal
            document.getElementById('class-lookup-modal').classList.remove('hidden');

            // Set Filters
            const grade = document.getElementById('dashboard-select-grade').value;
            const cls = document.getElementById('dashboard-select-class').value;

            document.getElementById('modal-select-grade').value = grade;
            document.getElementById('modal-select-class').value = cls;
            document.getElementById('modal-select-number').value = studentNum;

            // Trigger Render
            renderIndividualStatsTable();
        }

        // Render Class Subject Stats (Refactored)
        // Includes: Bar Chart (Top 10), Filters (2/3 Grade), Data Fix
        async function renderClassSubjectStats(container, students) {
            if (!container) return;

            let allowMultiSemesterDuplicate = false;
            try {
                const settings = await DB.fetchSettings();
                if (settings && settings.allowMultiSemesterDuplicate !== undefined) allowMultiSemesterDuplicate = !!settings.allowMultiSemesterDuplicate;
            } catch (e) { /* ignore */ }

            // Updated HTML to include Charts
            const html = `
                <div class="mb-4 flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                    <div class="flex gap-2 items-center bg-gray-50 p-3 rounded border border-gray-200">
                     <span class="font-bold text-gray-700">ğŸ” í•„í„°: </span>
                     <select id="stats-filter-grade-semester" onchange="window.dashboardGradeSemesterFilter=this.value; renderClassStatsDashboard()" class="border p-1 rounded text-sm bg-white">
                        <option value="all" ${(!window.dashboardGradeSemesterFilter || window.dashboardGradeSemesterFilter === 'all') ? 'selected' : ''}>ì „ì²´</option>
                        <option value="2-1" ${window.dashboardGradeSemesterFilter === '2-1' ? 'selected' : ''}>2í•™ë…„ 1í•™ê¸°</option>
                        <option value="2-2" ${window.dashboardGradeSemesterFilter === '2-2' ? 'selected' : ''}>2í•™ë…„ 2í•™ê¸°</option>
                        <option value="3-1" ${window.dashboardGradeSemesterFilter === '3-1' ? 'selected' : ''}>3í•™ë…„ 1í•™ê¸°</option>
                        <option value="3-2" ${window.dashboardGradeSemesterFilter === '3-2' ? 'selected' : ''}>3í•™ë…„ 2í•™ê¸°</option>
                     </select>
                    </div>
                </div>

                <!-- Top: Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="theme-card rounded border p-4 shadow-sm">
                        <h4 class="font-bold mb-4 theme-text">ğŸ“Š ê³¼ëª©ë³„ ì‹ ì²­ í˜„í™© (TOP 10)</h4>
                        <div class="h-64 relative">
                            <canvas id="classSubjectChart"></canvas>
                        </div>
                    </div>
                    <div class="theme-card rounded border p-4 shadow-sm">
                        <h4 class="font-bold mb-4 theme-text">ğŸ¤– ì§„ë¡œ í¬ë§ ì í•©ë„ ë¶„ì„ (AI)</h4>
                        <div class="h-64 relative">
                            <canvas id="classCareerChart"></canvas>
                        </div>
                        <p class="text-xs text-center text-gray-400 mt-2">* í•™ìƒì˜ ì§„ë¡œ í¬ë§ í‚¤ì›Œë“œì™€ ì‹ ì²­ ê³¼ëª©ì˜ ì—°ê´€ì„±ì„ ë¶„ì„í•œ ê²°ê³¼ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Bottom: Table -->
                <div id="class-subject-table-container"></div>
            `;
            container.innerHTML = html;

            // Process Data & Fix Parsing Logic - ì„ íƒê³¼ëª©ë§Œ í¬í•¨ (í•™êµê³¼ëª© ì œì™¸)
            const subjectCounts = {};
            const filterValue = window.dashboardGradeSemesterFilter || 'all';
            const [filterGrade, filterSemester] = filterValue !== 'all' ? filterValue.split('-') : [null, null];

            students.forEach(s => {
                if (!s.SelectedCourses) return;
                s.SelectedCourses.split(',').forEach(cName => {
                    const originalName = cName.trim();
                    if (!originalName) return;

                    // id ìš°ì„  ë§¤ì¹­ (ì¤‘ë³µ í¸ì œ í—ˆìš© ì‹œ í•™ê¸°ë³„ êµ¬ë¶„)
                    let meta = allCourseData.find(c => c.id === originalName);
                    // "ê³¼ëª©ëª…-í•™ë…„-í•™ê¸°" ë˜ëŠ” "ê³¼ëª©ëª…-í•™ë…„-í•™ê¸°-ì¸ë±ìŠ¤" í˜•ì‹ íŒŒì‹± (4ë¶€ë¥¼ ë¨¼ì € ê²€ì‚¬í•´ì•¼ ì¸ë±ìŠ¤ê°€ í•™ê¸°ë¡œ ì˜ëª» í•´ì„ë˜ì§€ ì•ŠìŒ)
                    if (!meta && originalName.includes('-')) {
                        const parts = originalName.split('-');
                        let namePart = '', g = '', sem = '';
                        if (parts.length >= 4 && /^\d+$/.test(parts[parts.length - 3]) && /^\d+$/.test(parts[parts.length - 2]) && /^\d+$/.test(parts[parts.length - 1])) {
                            g = parts[parts.length - 3];
                            sem = parts[parts.length - 2];
                            namePart = parts.slice(0, -3).join('-');
                        } else if (parts.length >= 3 && /^\d+$/.test(parts[parts.length - 2]) && /^\d+$/.test(parts[parts.length - 1])) {
                            g = parts[parts.length - 2];
                            sem = parts[parts.length - 1];
                            namePart = parts.length === 3 ? parts[0] : parts.slice(0, -2).join('-');
                        }
                        if (namePart && g && sem) {
                            meta = allCourseData.find(c =>
                                String(c.grade ?? '') === g && String(c.semester ?? '') === sem &&
                                (c.subjectName === namePart || (c.subjectName && c.subjectName.replace(/\s+/g, '-') === namePart) || (c.slug && c.slug === namePart))
                            );
                        }
                    }
                    if (!meta) {
                        let searchKey = originalName;
                        if (searchKey.includes('-')) searchKey = searchKey.split('-')[0].trim();
                        meta = allCourseData.find(c => {
                            if (c.slug === searchKey || c.subjectName === searchKey || c.subjectName === originalName) return true;
                            if (c.slug && c.slug.includes(searchKey)) return true;
                            if (c.subjectName && c.subjectName.includes(searchKey)) return true;
                            if (searchKey && c.slug && searchKey.includes(c.slug)) return true;
                            if (searchKey && c.subjectName && searchKey.includes(c.subjectName)) return true;
                            return false;
                        });
                    }

                    // í•™êµê³¼ëª©(required) ì œì™¸ - ì„ íƒê³¼ëª©ë§Œ í†µê³„ì— í¬í•¨
                    if (meta && (meta.required === true || String(meta.required).toLowerCase() === 'true')) {
                        return;
                    }

                    // í•„í„° ì ìš© (í•™ë…„-í•™ê¸°)
                    if (filterValue !== 'all' && meta) {
                        if (String(meta.grade) !== filterGrade || String(meta.semester) !== filterSemester) {
                            return;
                        }
                    }

                    // ì¤‘ë³µ í¸ì œ í—ˆìš©ì´ë©´ í•™ê¸°ë³„ë¡œ í‚¤ êµ¬ë¶„ (3-1, 3-2 ê°ê° í‘œì‹œ)
                    const finalName = meta
                        ? (allowMultiSemesterDuplicate ? `${meta.subjectName} (${meta.grade}-${meta.semester})` : meta.subjectName)
                        : originalName;

                    if (finalName) {
                        subjectCounts[finalName] = (subjectCounts[finalName] || 0) + 1;
                    }
                });
            });

            // Prepare Table List - ì„ íƒê³¼ëª©ë§Œ, í•„í„° ì ìš©
            const filterValueForTable = window.dashboardGradeSemesterFilter || 'all';
            const [filterGradeForTable, filterSemesterForTable] = filterValueForTable !== 'all' ? filterValueForTable.split('-') : [null, null];
            
            let displayList = allCourseData.filter(c => {
                // í•„ìˆ˜ í•„ë“œ í™•ì¸
                if (!c.subjectName) return false; // subjectName is required
                
                // í•™êµê³¼ëª© ì œì™¸ (required courses are excluded from elective statistics)
                if (c.required === true || String(c.required).toLowerCase() === 'true') return false;
                
                // 1í•™ë…„ ì œì™¸ (elective courses typically start from grade 2)
                // Note: If your DB has electives in grade 1, remove this line
                if (c.grade == 1) return false;
                
                // í•„í„° ì ìš© (í•™ë…„-í•™ê¸°)
                if (filterValueForTable !== 'all') {
                    if (String(c.grade) !== filterGradeForTable || String(c.semester) !== filterSemesterForTable) return false;
                }
                return true;
            });

            // Sort
            displayList.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade - b.grade;
                if (a.semester !== b.semester) return String(a.semester).localeCompare(String(b.semester));
                return a.subjectName.localeCompare(b.subjectName);
            });

            // Chart Data Helper (Top 10)
            const sortedForChart = Object.entries(subjectCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);

            // íŒŒìŠ¤í…”í†¤ ìƒ‰ìƒ íŒ”ë ˆíŠ¸
            const pastelColors = [
                'rgba(255, 182, 193, 0.8)', // íŒŒìŠ¤í…” í•‘í¬
                'rgba(173, 216, 230, 0.8)', // íŒŒìŠ¤í…” ë¸”ë£¨
                'rgba(221, 160, 221, 0.8)', // íŒŒìŠ¤í…” í¼í”Œ
                'rgba(255, 218, 185, 0.8)', // íŒŒìŠ¤í…” í”¼ì¹˜
                'rgba(152, 251, 152, 0.8)', // íŒŒìŠ¤í…” ê·¸ë¦°
                'rgba(255, 228, 196, 0.8)', // íŒŒìŠ¤í…” ì˜¤ë Œì§€
                'rgba(176, 224, 230, 0.8)', // íŒŒìŠ¤í…” ì‹œì•ˆ
                'rgba(255, 192, 203, 0.8)', // íŒŒìŠ¤í…” ë¡œì¦ˆ
                'rgba(230, 230, 250, 0.8)', // ë¼ë²¤ë”
                'rgba(255, 250, 205, 0.8)'  // ë ˆëª¬ í¬ë¦¼
            ];

            // Render Charts Delayed
            setTimeout(() => {
                // 1. Subject Chart
                const ctx1 = document.getElementById('classSubjectChart');
                if (ctx1) {
                    if (window.dashboardCharts && window.dashboardCharts.classSubject) {
                        window.dashboardCharts.classSubject.destroy();
                    }
                    window.dashboardCharts = window.dashboardCharts || {};
                    window.dashboardCharts.classSubject = new Chart(ctx1, {
                        type: 'bar',
                        data: {
                            labels: sortedForChart.map(([name]) => name),
                            datasets: [{
                                label: 'ì‹ ì²­ í•™ìƒ ìˆ˜',
                                data: sortedForChart.map(([, count]) => count),
                                backgroundColor: sortedForChart.map((_, index) => pastelColors[index % pastelColors.length]),
                                borderRadius: 4
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { beginAtZero: true, grid: { display: false } } }
                        }
                    });
                }

                // 2. Career Chart
                if (typeof analyzeClassCareerSuitability === 'function') {
                    analyzeClassCareerSuitability(students);
                }
            }, 100);

            // Render Table (HTML string build)
            // í…Œì´ë¸”ì—ëŠ” ì‹¤ì œë¡œ ì‹ ì²­ëœ ì„ íƒê³¼ëª©ë§Œ í‘œì‹œ (ì‹ ì²­ ì¸ì›ì´ 0ì¸ ê³¼ëª©ë„ í¬í•¨í•˜ë˜, ì„ íƒê³¼ëª©ë§Œ)
            // subjectCountsì— ìˆëŠ” ê³¼ëª©ë“¤ì„ ê¸°ì¤€ìœ¼ë¡œ í…Œì´ë¸” ìƒì„±
            const tableSubjects = [];
            
            // subjectCountsì— ìˆëŠ” ê³¼ëª©ë“¤ì„ allCourseDataì—ì„œ ì°¾ì•„ì„œ ì •ë³´ ì¶”ê°€ (í‚¤ê°€ "ê³¼ëª©ëª… (í•™ë…„-í•™ê¸°)" í˜•ì‹ ì§€ì›)
            Object.keys(subjectCounts).forEach(subjectName => {
                let course = null;
                const match = subjectName.match(/^(.+)\s*\((\d+)-(\d+)\)$/);
                if (match) {
                    const baseName = match[1].trim();
                    const g = match[2], s = match[3];
                    course = allCourseData.find(c => c.subjectName === baseName && String(c.grade) === g && String(c.semester) === s);
                }
                if (!course) {
                    course = allCourseData.find(c => {
                        if (c.subjectName === subjectName) return true;
                        if (c.subjectName && c.subjectName.includes(subjectName)) return true;
                        if (subjectName && subjectName.includes(c.subjectName)) return true;
                        return false;
                    });
                }

                if (course) {
                    if (course.required !== true && String(course.required).toLowerCase() !== 'true') {
                        if (filterValue === 'all' || (String(course.grade) === filterGrade && String(course.semester) === filterSemester)) {
                            if (course.grade != 1) {
                                tableSubjects.push({
                                    grade: course.grade,
                                    semester: course.semester,
                                    subjectName: course.subjectName,
                                    count: subjectCounts[subjectName]
                                });
                            }
                        }
                    }
                } else {
                    if (filterValue === 'all') {
                        tableSubjects.push({
                            grade: '?',
                            semester: '?',
                            subjectName: subjectName,
                            count: subjectCounts[subjectName]
                        });
                    }
                }
            });

            // í•™ë…„, í•™ê¸°, ê³¼ëª©ëª… ìˆœìœ¼ë¡œ ì •ë ¬
            tableSubjects.sort((a, b) => {
                if (a.grade !== b.grade) {
                    if (a.grade === '?') return 1;
                    if (b.grade === '?') return -1;
                    return a.grade - b.grade;
                }
                if (a.semester !== b.semester) {
                    if (a.semester === '?') return 1;
                    if (b.semester === '?') return -1;
                    return String(a.semester).localeCompare(String(b.semester));
                }
                return a.subjectName.localeCompare(b.subjectName);
            });

            let tableHtml = `<table class="w-full text-sm border-collapse text-left"><thead class="bg-gray-100"><tr class="theme-text"><th class="border p-2 text-center w-16">í•™ë…„</th><th class="border p-2 text-center w-16">í•™ê¸°</th><th class="border p-2">ê³¼ëª©ëª…</th><th class="border p-2 text-center w-24">ì‹ ì²­ ì¸ì›</th></tr></thead><tbody>`;

            if (tableSubjects.length === 0) {
                tableHtml += `<tr><td colspan="4" class="p-4 text-center text-gray-500">í‘œì‹œí•  ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                tableSubjects.forEach(item => {
                    const isZero = item.count === 0;
                    tableHtml += `
                                <tr class="hover:bg-gray-50 ${isZero ? 'opacity-50' : ''}">
                                    <td class="border p-2 text-center text-gray-500">${item.grade}</td>
                                    <td class="border p-2 text-center text-gray-500">${item.semester}</td>
                                    <td class="border p-2 font-medium text-gray-800">${item.subjectName}</td>
                                    <td class="border p-2 text-center font-bold ${isZero ? 'text-gray-400' : 'text-blue-600'}">${item.count}ëª…</td>
                                </tr>
                             `;
                });
            }
            tableHtml += `</tbody></table>`;

            document.getElementById('class-subject-table-container').innerHTML = tableHtml;
        }

        // Analyze Class Career Suitability
        async function analyzeClassCareerSuitability(students) {
            const ctx = document.getElementById('classCareerChart');
            if (!ctx) return;

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            if (window.dashboardCharts && window.dashboardCharts.classCareer) {
                window.dashboardCharts.classCareer.destroy();
            }
            window.dashboardCharts = window.dashboardCharts || {};
            window.dashboardCharts.classCareer = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ë¶„ì„ ì¤‘...'],
                    datasets: [{
                        label: 'ì§„ë¡œ ì í•©ì„±',
                        data: [0],
                        backgroundColor: 'rgba(200, 200, 200, 0.5)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, max: 100, grid: { display: false } } }
                }
            });

            // 1. ìˆ˜ì§‘: í•™ìƒë“¤ì˜ ì§„ë¡œ í¬ë§ ì‚¬í•­ê³¼ ì‹ ì²­ ê³¼ëª©
            const studentsWithData = students.filter(s => s.Major && s.SelectedCourses);
            if (studentsWithData.length === 0) {
                window.dashboardCharts.classCareer.destroy();
                window.dashboardCharts.classCareer = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ë°ì´í„° ì—†ìŒ'],
                        datasets: [{
                            label: 'ì§„ë¡œ ì í•©ì„±',
                            data: [0],
                            backgroundColor: 'rgba(200, 200, 200, 0.5)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'ì§„ë¡œ í¬ë§ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤'
                            }
                        },
                        scales: { x: { beginAtZero: true, max: 100, grid: { display: false } } }
                    }
                });
                return;
            }

            // 2. ì§„ë¡œë³„ ê·¸ë£¹í™”
            const careerGroups = {};
            studentsWithData.forEach((student) => {
                const major = student.Major.trim();
                if (!careerGroups[major]) {
                    careerGroups[major] = {
                        students: [],
                        totalSuitability: 0,
                        count: 0,
                        recommendedSubjects: null // AI ì¶”ì²œ ê³¼ëª© ìºì‹œ
                    };
                }
                careerGroups[major].students.push(student);
            });

            // 3. ê° ì§„ë¡œë³„ë¡œ AI ì¶”ì²œ ê³¼ëª©ì„ ê°€ì ¸ì˜¤ê³ , í•™ìƒë“¤ì˜ ì‹ ì²­ ê³¼ëª©ê³¼ ë¹„êµí•˜ì—¬ ì í•©ì„± ê³„ì‚°
            for (const [major, group] of Object.entries(careerGroups)) {
                try {
                    // ì§„ë¡œë³„ ì¶”ì²œ ê³¼ëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í•œ ë²ˆë§Œ í˜¸ì¶œ)
                    const allSelectedCourses = new Set();
                    group.students.forEach(s => {
                        s.SelectedCourses.split(',').forEach(c => {
                            const courseName = c.trim();
                            if (courseName) allSelectedCourses.add(courseName);
                        });
                    });

                    const courseListStr = Array.from(allSelectedCourses).join(', ');
                    
                    // AI API í˜¸ì¶œí•˜ì—¬ ì¶”ì²œ ê³¼ëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const recommendedSubjects = await getRecommendedSubjectsForCareer(major, courseListStr);
                    group.recommendedSubjects = recommendedSubjects;

                    // ê° í•™ìƒì˜ ì‹ ì²­ ê³¼ëª©ê³¼ ì¶”ì²œ ê³¼ëª©ì„ ë¹„êµí•˜ì—¬ ì í•©ì„± ê³„ì‚°
                    for (const student of group.students) {
                        const selectedCourses = student.SelectedCourses.split(',').map(c => c.trim()).filter(c => c);
                        if (selectedCourses.length === 0) continue;

                        const suitability = calculateSuitabilityScore(selectedCourses, recommendedSubjects);
                        group.totalSuitability += suitability;
                        group.count++;
                    }
                } catch (error) {
                    console.error(`Error processing career ${major}:`, error);
                    // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ê°’ 50%ë¡œ ì„¤ì •
                    group.totalSuitability += 50 * group.students.length;
                    group.count += group.students.length;
                }
            }

            // 4. ì§„ë¡œë³„ í‰ê·  ì í•©ì„± ê³„ì‚°
            const careerData = Object.entries(careerGroups)
                .map(([major, group]) => ({
                    major: major,
                    avgSuitability: group.count > 0 ? Math.round(group.totalSuitability / group.count) : 0,
                    studentCount: group.students.length
                }))
                .sort((a, b) => b.avgSuitability - a.avgSuitability);

            // 5. ë§‰ëŒ€ê·¸ë˜í”„ ë Œë”ë§
            window.dashboardCharts.classCareer.destroy();

            const pastelColors = [
                'rgba(255, 182, 193, 0.8)', // íŒŒìŠ¤í…” í•‘í¬
                'rgba(173, 216, 230, 0.8)', // íŒŒìŠ¤í…” ë¸”ë£¨
                'rgba(221, 160, 221, 0.8)', // íŒŒìŠ¤í…” í¼í”Œ
                'rgba(255, 218, 185, 0.8)', // íŒŒìŠ¤í…” í”¼ì¹˜
                'rgba(152, 251, 152, 0.8)', // íŒŒìŠ¤í…” ê·¸ë¦°
                'rgba(255, 228, 196, 0.8)', // íŒŒìŠ¤í…” ì˜¤ë Œì§€
                'rgba(176, 224, 230, 0.8)', // íŒŒìŠ¤í…” ì‹œì•ˆ
                'rgba(255, 192, 203, 0.8)', // íŒŒìŠ¤í…” ë¡œì¦ˆ
                'rgba(230, 230, 250, 0.8)', // ë¼ë²¤ë”
                'rgba(255, 250, 205, 0.8)'  // ë ˆëª¬ í¬ë¦¼
            ];

            window.dashboardCharts.classCareer = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: careerData.map(d => `${d.major} (${d.studentCount}ëª…)`),
                    datasets: [{
                        label: 'ì§„ë¡œ ì í•©ì„± (%)',
                        data: careerData.map(d => d.avgSuitability),
                        backgroundColor: careerData.map((_, index) => pastelColors[index % pastelColors.length]),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `ì í•©ì„±: ${context.parsed.x}%`;
                                }
                            }
                        }
                    },
                    scales: { 
                        x: { 
                            beginAtZero: true, 
                            max: 100,
                            grid: { display: false },
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        } 
                    }
                }
            });
        }

        // AIë¥¼ í™œìš©í•˜ì—¬ ì§„ë¡œë³„ ì¶”ì²œ ê³¼ëª© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getRecommendedSubjectsForCareer(major, availableCourses) {
            try {
                const response = await fetch('/.netlify/functions/ai-recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        major: major,
                        availableCourses: availableCourses || "í•™êµ ì „ì²´ ê°œì„¤ ê³¼ëª©",
                        mode: 'admin' // JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
                    })
                });

                if (!response.ok) {
                    throw new Error('AI API í˜¸ì¶œ ì‹¤íŒ¨');
                }

                const result = await response.json();
                let content = result.choices[0].message.content;

                try {
                    const data = JSON.parse(content);
                    const subjects = data.subjects || [];
                    // ê³¼ëª©ëª…ë§Œ ì¶”ì¶œ (ì˜ˆ: "ê³¼ëª©ëª…: ì´ìœ " í˜•ì‹ì—ì„œ ê³¼ëª©ëª…ë§Œ)
                    return subjects.map(s => {
                        const match = s.match(/^([^:ï¼š]+)/);
                        return match ? match[1].trim() : s.trim();
                    });
                } catch (e) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ì—ì„œ ê³¼ëª©ëª… ì¶”ì¶œ ì‹œë„
                    console.warn('JSON parse failed, trying text extraction');
                    return [];
                }
            } catch (error) {
                console.error('Error fetching recommended subjects:', error);
                return [];
            }
        }

        // ì‹ ì²­ ê³¼ëª©ê³¼ ì¶”ì²œ ê³¼ëª©ì„ ë¹„êµí•˜ì—¬ ì í•©ì„± ì ìˆ˜ ê³„ì‚° (0-100%)
        function calculateSuitabilityScore(selectedCourses, recommendedSubjects) {
            if (!recommendedSubjects || recommendedSubjects.length === 0) {
                return 50; // ì¶”ì²œ ê³¼ëª©ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            }

            // ê³¼ëª©ëª… ë§¤ì¹­ (ë¶€ë¶„ ì¼ì¹˜ í—ˆìš©)
            let matchCount = 0;
            selectedCourses.forEach(selected => {
                const selectedLower = selected.toLowerCase();
                const matched = recommendedSubjects.some(recommended => {
                    const recommendedLower = recommended.toLowerCase();
                    return selectedLower.includes(recommendedLower) || recommendedLower.includes(selectedLower);
                });
                if (matched) matchCount++;
            });

            // ì í•©ì„± = (ì¼ì¹˜í•˜ëŠ” ê³¼ëª© ìˆ˜ / ì‹ ì²­í•œ ê³¼ëª© ìˆ˜) * 100
            // ìµœì†Œ 30%, ìµœëŒ€ 100%ë¡œ ì œí•œ
            if (selectedCourses.length === 0) return 0;
            
            const baseScore = (matchCount / selectedCourses.length) * 100;
            // ì¶”ì²œ ê³¼ëª©ì´ ë§ì„ìˆ˜ë¡ ê°€ì¤‘ì¹˜ ì¶”ê°€ (ì¶”ì²œ ê³¼ëª© ì¤‘ ì¼ë¶€ë¼ë„ ì„ íƒí•˜ë©´ ì¢‹ìŒ)
            const bonus = Math.min(20, (matchCount / recommendedSubjects.length) * 20);
            
            return Math.min(100, Math.max(30, Math.round(baseScore + bonus)));
        }

        // Tab 3: Validation Stats
        function renderValidationStats(container, students, grade, cls) {
            // Merge Registry
            let baseList = [];
            const hasRegistry = registryData && registryData.length > 0;

            if (hasRegistry) {
                baseList = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '');

                    if (sNum.trim().length > 0) {
                        return sNum.trim().startsWith(grade) && parseInt(sNum.trim().substring(1, 3)) == cls;
                    }
                    return false;

                }).map(r => ({
                    number: parseInt(String(r['í•™ë²ˆ']).trim().substring(3, 5)),
                    name: r['ì´ë¦„'] || r.name,
                    studentId: r['í•™ë²ˆ'],
                    fromRegistry: true
                }));
            }

            if (baseList.length === 0 && students.length > 0) {
                baseList = students.map(s => ({

                    number: parseInt(s.Number),
                    name: s.Name,
                    studentId: `${s.Grade
                        }

                    ${String(s.Class).padStart(2, '0')
                        }

                    ${String(s.Number).padStart(2, '0')
                        }

        `,
                    fromRegistry: false
                }));
            }

            baseList.sort((a, b) => a.number - b.number);

            const merged = baseList.map(item => {
                const res = students.find(s => parseInt(s.Number) == item.number);

                return {
                    ...item, response: res
                }

                    ;
            });

            let html = ` < div class="mb-2 text-sm text-gray-500 text-right" > ì´ ${merged.length
                }

        ëª…(ì œì¶œ: ${merged.filter(m => m.response).length
                }

        ëª…)</div > <div class="overflow-y-auto max-h-[400px]"><table class="w-full text-sm border-collapse"><thead class="sticky top-0 bg-gray-100 dark:bg-gray-700 z-10 shadow-sm"><tr class="theme-text"><th class="border p-2 theme-border w-16 text-center">ë²ˆí˜¸</th><th class="border p-2 theme-border w-24 text-center">ì´ë¦„</th><th class="border p-2 theme-border text-center">ê²€ì¦ í˜„í™©</th></tr></thead><tbody>`;

            merged.forEach(m => {
                let statusHtml = '<span class="text-gray-400">-</span>';

                if (!m.response) {
                    statusHtml = '<span class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">ë¯¸ì œì¶œ</span>';
                }

                else {
                    const vRes = m.response.ValidationResult || '';

                    if (!vRes) {
                        statusHtml = '<span class="text-gray-500">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</span>';
                    }

                    else if (vRes.includes('ë¶€ì¡±') || vRes.includes('ì´ˆê³¼') || vRes.includes('í•„ìš”') || vRes.includes('í™•ì¸')) {
                        statusHtml = `<span class="text-red-600 font-bold whitespace-pre-wrap text-xs" >${vRes
                            }

                    </span>`;
                    }

                    else {
                        statusHtml = `<span class="text-blue-600 font-bold" >PASS (í†µê³¼)</span>`;
                    }
                }

                html += ` <tr class="hover:bg-gray-50 dark:hover:bg-gray-600 theme-text" > <td class="border p-2 theme-border text-center" >${m.number
                    }

            </td> <td class="border p-2 theme-border text-center font-medium" >${m.name
                    }

                </td> <td class="border p-2 theme-border" >${statusHtml
                    }

                </td> </tr> `;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Tab 4: Grade Subject Stats (Entire Grade)
        async function renderGradeSubjectStats(container, students, grade) {
            if (!container) return;

            let allowMultiSemesterDuplicate = false;
            try {
                const settings = await DB.fetchSettings();
                if (settings && settings.allowMultiSemesterDuplicate !== undefined) allowMultiSemesterDuplicate = !!settings.allowMultiSemesterDuplicate;
            } catch (e) { /* ignore */ }

            // í•„í„° ì´ˆê¸°í™”
            if (!window.gradeDashboardGradeFilter) window.gradeDashboardGradeFilter = '2';
            if (window.gradeDashboardSemesterFilter === undefined || window.gradeDashboardSemesterFilter === null) {
                window.gradeDashboardSemesterFilter = 'all';
            }

            const html = `
                <div class="mb-4 flex gap-2 items-center bg-gray-50 p-3 rounded border border-gray-200">
                     <span class="font-bold text-gray-700">ğŸ” í•„í„°: </span>
                     <select id="grade-filter-grade" onchange="window.gradeDashboardGradeFilter=this.value; renderClassStatsDashboard()" class="border p-1 rounded text-sm bg-white">
                        <option value="2" ${window.gradeDashboardGradeFilter === '2' ? 'selected' : ''}>2í•™ë…„</option>
                        <option value="3" ${window.gradeDashboardGradeFilter === '3' ? 'selected' : ''}>3í•™ë…„</option>
                     </select>
                     <select id="grade-filter-semester" onchange="window.gradeDashboardSemesterFilter=this.value; renderClassStatsDashboard()" class="border p-1 rounded text-sm bg-white">
                        <option value="all" ${window.gradeDashboardSemesterFilter === 'all' ? 'selected' : ''}>ì „ì²´ í•™ê¸°</option>
                        <option value="1" ${window.gradeDashboardSemesterFilter === '1' ? 'selected' : ''}>1í•™ê¸°</option>
                        <option value="2" ${window.gradeDashboardSemesterFilter === '2' ? 'selected' : ''}>2í•™ê¸°</option>
                     </select>
                </div>
                <div id="grade-subject-table-container"></div>
            `;
            container.innerHTML = html;

            // í•„í„° ì ìš©: í•™ë…„ ì„ íƒ
            // window í•„í„°ë¥¼ ìš°ì„  ì‚¬ìš© (í•„í„° ë³€ê²½ ì‹œ ë°˜ì˜ë˜ë„ë¡)
            const targetGrade = window.gradeDashboardGradeFilter || grade || '2';
            
            // ë””ë²„ê¹…: students ë°ì´í„° í™•ì¸
            console.log('[Grade Subject Stats] Students data check:', {
                studentsLength: students ? students.length : 0,
                studentsIsArray: Array.isArray(students),
                studentsSample: students && students.length > 0 ? {
                    Grade: students[0].Grade,
                    grade: students[0].grade,
                    í•™ë²ˆ: students[0].í•™ë²ˆ,
                    SelectedCourses: students[0].SelectedCourses ? students[0].SelectedCourses.substring(0, 50) : null,
                    allKeys: Object.keys(students[0] || {})
                } : null,
                targetGrade: targetGrade,
                gradeParam: grade
            });
            
            // í•™ìƒ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
            if (!students || students.length === 0) {
                console.warn('[Grade Subject Stats] No students data available');
                const tableContainer = document.getElementById('grade-subject-table-container');
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div class="p-8 text-center text-gray-500">
                            <p class="font-bold mb-2">í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm">í•™ìƒ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                        </div>
                    `;
                }
                return;
            }
            
            // í•™ìƒ í•™ë…„ìœ¼ë¡œ í•„í„°ë§í•˜ì§€ ì•ŠìŒ - ëª¨ë“  í•™ìƒ í¬í•¨
            // í•„í„°ëŠ” ê³¼ëª©ì˜ ê°œì„¤ í•™ë…„(meta.grade)ìœ¼ë¡œ ì ìš©ë¨
            const allStudents = students;
            const totalStudents = allStudents.length;
            
            console.log('[Grade Subject Stats] Students info:', {
                totalStudents: totalStudents,
                targetGrade: targetGrade,
                note: 'í•„í„°ëŠ” ê³¼ëª©ì˜ ê°œì„¤ í•™ë…„ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤ (í•™ìƒ í•™ë…„ ì•„ë‹˜)'
            });

            // ì„ íƒê³¼ëª©ë§Œ ì¹´ìš´íŠ¸ (í•™êµì§€ì •ê³¼ëª© ì œì™¸)
            const subjectCounts = {};
            const subjectStudentMap = {}; // ê° ê³¼ëª©ì„ ì‹ ì²­í•œ í•™ìƒ ëª©ë¡ (ë“±ê¸‰ ê³„ì‚°ìš©)

            console.log('[Grade Subject Stats] Processing students, allCourseData length:', allCourseData.length);
            
            let processedCoursesCount = 0;
            let skippedCoursesCount = 0;
            
            // ëª¨ë“  í•™ìƒì˜ ê³¼ëª©ì„ ì²˜ë¦¬í•˜ë˜, ê³¼ëª©ì˜ ê°œì„¤ í•™ë…„ìœ¼ë¡œ í•„í„°ë§
            allStudents.forEach(s => {
                if (!s.SelectedCourses) return;
                const courses = s.SelectedCourses.split(',').map(c => c.trim()).filter(c => c);

                courses.forEach(cName => {
                    const originalName = cName.trim();
                    if (!originalName) return;
                    processedCoursesCount++;

                    // id ìš°ì„  ë§¤ì¹­ (ì¤‘ë³µ í¸ì œ í—ˆìš© ì‹œ í•™ê¸°ë³„ êµ¬ë¶„)
                    let meta = allCourseData.find(c => c.id === originalName);
                    // "ê³¼ëª©ëª…-í•™ë…„-í•™ê¸°" ë˜ëŠ” "ê³¼ëª©ëª…-í•™ë…„-í•™ê¸°-ì¸ë±ìŠ¤" í˜•ì‹ íŒŒì‹± (4ë¶€ë¥¼ ë¨¼ì € ê²€ì‚¬í•´ì•¼ ì¸ë±ìŠ¤ê°€ í•™ê¸°ë¡œ ì˜ëª» í•´ì„ë˜ì§€ ì•ŠìŒ)
                    if (!meta && originalName.includes('-')) {
                        const parts = originalName.split('-');
                        let namePart = '', g = '', sem = '';
                        if (parts.length >= 4 && /^\d+$/.test(parts[parts.length - 3]) && /^\d+$/.test(parts[parts.length - 2]) && /^\d+$/.test(parts[parts.length - 1])) {
                            g = parts[parts.length - 3];
                            sem = parts[parts.length - 2];
                            namePart = parts.slice(0, -3).join('-');
                        } else if (parts.length >= 3 && /^\d+$/.test(parts[parts.length - 2]) && /^\d+$/.test(parts[parts.length - 1])) {
                            g = parts[parts.length - 2];
                            sem = parts[parts.length - 1];
                            namePart = parts.length === 3 ? parts[0] : parts.slice(0, -2).join('-');
                        }
                        if (namePart && g && sem) {
                            meta = allCourseData.find(c =>
                                String(c.grade ?? '') === g && String(c.semester ?? '') === sem &&
                                (c.subjectName === namePart || (c.subjectName && c.subjectName.replace(/\s+/g, '-') === namePart) || (c.slug && c.slug === namePart))
                            );
                        }
                    }
                    if (!meta) {
                        let searchKey = originalName;
                        if (searchKey.includes('-')) searchKey = searchKey.split('-')[0].trim();
                        meta = allCourseData.find(c => {
                            if (c.slug === searchKey || c.subjectName === searchKey || c.subjectName === originalName) return true;
                            if (c.slug && c.slug.includes(searchKey)) return true;
                            if (c.subjectName && c.subjectName.includes(searchKey)) return true;
                            if (searchKey && c.slug && searchKey.includes(c.slug)) return true;
                            if (searchKey && c.subjectName && searchKey.includes(c.subjectName)) return true;
                            return false;
                        });
                    }

                    if (meta && (meta.required === true || String(meta.required).toLowerCase() === 'true')) {
                        skippedCoursesCount++;
                        return;
                    }

                    if (meta) {
                        const courseGrade = meta.grade;
                        if (courseGrade != targetGrade) {
                            skippedCoursesCount++;
                            return;
                        }
                    } else {
                        skippedCoursesCount++;
                        return;
                    }

                    if (window.gradeDashboardSemesterFilter !== 'all') {
                        if (!meta) {
                            skippedCoursesCount++;
                            return;
                        }
                        if (String(meta.semester) !== String(window.gradeDashboardSemesterFilter)) {
                            skippedCoursesCount++;
                            return;
                        }
                    }

                    // ì¤‘ë³µ í¸ì œ í—ˆìš©ì´ë©´ í•™ê¸°ë³„ë¡œ í‚¤ êµ¬ë¶„
                    const finalName = meta
                        ? (allowMultiSemesterDuplicate ? `${meta.subjectName} (${meta.grade}-${meta.semester})` : meta.subjectName)
                        : originalName;

                    if (finalName) {
                        subjectCounts[finalName] = (subjectCounts[finalName] || 0) + 1;
                        if (!subjectStudentMap[finalName]) subjectStudentMap[finalName] = [];
                        subjectStudentMap[finalName].push(s);
                    } else {
                        skippedCoursesCount++;
                    }
                });
            });
            
            console.log('[Grade Subject Stats] Course processing summary:', {
                processedCourses: processedCoursesCount,
                skippedCourses: skippedCoursesCount,
                subjectCountsKeys: Object.keys(subjectCounts).length
            });
            
            console.log('[Grade Subject Stats] After processing:', {
                subjectCountsKeys: Object.keys(subjectCounts).length,
                subjectCountsSample: Object.keys(subjectCounts).slice(0, 10),
                subjectCounts: Object.fromEntries(Object.entries(subjectCounts).slice(0, 10)),
                allCourseDataSample: allCourseData.slice(0, 5).map(c => ({
                    subjectName: c.subjectName,
                    slug: c.slug,
                    grade: c.grade,
                    semester: c.semester,
                    required: c.required
                }))
            });

            // í…Œì´ë¸”ìš© ê³¼ëª© ëª©ë¡ ìƒì„± (ì‹¤ì œ ì‹ ì²­ëœ ì„ íƒê³¼ëª©ë§Œ)
            const tableSubjects = [];
            const processedSubjects = new Set(); // ì¤‘ë³µ ë°©ì§€
            
            console.log('[Grade Subject Stats] Building table, subjectCounts keys:', Object.keys(subjectCounts).length);
            
            Object.keys(subjectCounts).forEach(subjectName => {
                if (processedSubjects.has(subjectName)) return;

                // "ê³¼ëª©ëª… (í•™ë…„-í•™ê¸°)" í˜•ì‹ì´ë©´ í•™ê¸°ë³„ ê³¼ëª©ìœ¼ë¡œ ë§¤ì¹­
                let course = null;
                const match = subjectName.match(/^(.+)\s*\((\d+)-(\d+)\)$/);
                if (match) {
                    const baseName = match[1].trim();
                    const g = match[2], s = match[3];
                    course = allCourseData.find(c => c.subjectName === baseName && String(c.grade) === g && String(c.semester) === s);
                }
                if (!course) {
                    course = allCourseData.find(c => {
                        if (c.subjectName === subjectName) return true;
                        if (c.subjectName && c.subjectName.includes(subjectName)) return true;
                        if (subjectName && subjectName.includes(c.subjectName)) return true;
                        if (c.slug === subjectName) return true;
                        if (c.slug && c.slug.includes(subjectName)) return true;
                        if (subjectName && subjectName.includes(c.slug)) return true;
                        return false;
                    });
                }

                if (course) {
                    // ì„ íƒê³¼ëª©ë§Œ (í•™êµì§€ì •ê³¼ëª© ì œì™¸) - ì´ë¯¸ ìœ„ì—ì„œ í•„í„°ë§í–ˆì§€ë§Œ ë‹¤ì‹œ í™•ì¸
                    const isRequired = course.required === true || String(course.required).toLowerCase() === 'true';
                    
                    // í•™ê¸‰ë³„ í†µê³„ì™€ ë™ì¼í•œ ë¡œì§: í•„í„°ê°€ 'all'ì´ë©´ ëª¨ë“  ê³¼ëª© í‘œì‹œ, ì•„ë‹ˆë©´ í•™ë…„/í•™ê¸° ì¼ì¹˜ í™•ì¸
                    // subjectCountsì— ìˆëŠ” ê³¼ëª©ë“¤ì€ ì´ë¯¸ í•„í„°ë§ëœ ê²ƒì´ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ í‘œì‹œ
                    const semesterMatch = window.gradeDashboardSemesterFilter === 'all' || 
                        String(course.semester) === String(window.gradeDashboardSemesterFilter);
                    
                    // 1í•™ë…„ ê³¼ëª© ì œì™¸ (í•™ê¸‰ë³„ í†µê³„ì™€ ë™ì¼)
                    // Note: This assumes elective courses are only in grades 2-3
                    // If your DB has electives in grade 1, set this to true or remove the check
                    const isNotFirstGrade = course.grade != 1;
                    
                    console.log('[Grade Subject Stats] Course check:', {
                        subjectName: course.subjectName,
                        courseGrade: course.grade,
                        courseSemester: course.semester,
                        targetGrade: targetGrade,
                        semesterFilter: window.gradeDashboardSemesterFilter,
                        isRequired: isRequired,
                        isNotFirstGrade: isNotFirstGrade,
                        semesterMatch: semesterMatch,
                        willAdd: !isRequired && isNotFirstGrade && semesterMatch
                    });
                    
                    // subjectCountsì— ìˆëŠ” ê³¼ëª©ë“¤ì€ ì´ë¯¸ í•„í„°ë§ëœ ê²ƒì´ë¯€ë¡œ, required ì²´í¬ì™€ 1í•™ë…„ ì œì™¸, í•™ê¸° í•„í„°ë§Œ í™•ì¸
                    if (!isRequired && isNotFirstGrade && semesterMatch) {
                        processedSubjects.add(subjectName);
                        processedSubjects.add(course.subjectName); // ì¤‘ë³µ ë°©ì§€
                        
                        tableSubjects.push({
                            grade: course.grade,
                            semester: course.semester,
                            subjectName: course.subjectName,
                            count: subjectCounts[subjectName],
                            students: subjectStudentMap[subjectName] || []
                        });
                    }
                } else {
                    // allCourseDataì— ì—†ëŠ” ê²½ìš° (ì˜ˆ: ê³µë™êµìœ¡ê³¼ì •, ë˜ëŠ” ë§¤ì¹­ ì‹¤íŒ¨)
                    // í•™ê¸‰ë³„ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬: í•„í„°ê°€ 'all'ì´ë©´ í‘œì‹œ
                    console.log('[Grade Subject Stats] Course not found in allCourseData:', subjectName);
                    // í•™ê¸° í•„í„°ê°€ 'all'ì´ë©´ í‘œì‹œ (í•™ê¸‰ë³„ê³¼ ë™ì¼í•œ ë¡œì§)
                    if (window.gradeDashboardSemesterFilter === 'all') {
                        processedSubjects.add(subjectName);
                        
                        tableSubjects.push({
                            grade: targetGrade,
                            semester: '?',
                            subjectName: subjectName, // ì›ë³¸ ê³¼ëª©ëª… ì‚¬ìš©
                            count: subjectCounts[subjectName],
                            students: subjectStudentMap[subjectName] || []
                        });
                    }
                }
            });
            
            console.log('[Grade Subject Stats] Table subjects built:', {
                tableSubjectsCount: tableSubjects.length,
                tableSubjectsSample: tableSubjects.slice(0, 5).map(s => ({
                    name: s.subjectName,
                    grade: s.grade,
                    semester: s.semester,
                    count: s.count
                }))
            });
            
            // ë””ë²„ê¹…: ì½˜ì†”ì— ì •ë³´ ì¶œë ¥
            console.log('[Grade Subject Stats Debug]', {
                targetGrade,
                semesterFilter: window.gradeDashboardSemesterFilter,
                totalStudents: totalStudents,
                subjectCountsKeys: Object.keys(subjectCounts).length,
                subjectCountsSample: Object.keys(subjectCounts).slice(0, 5),
                tableSubjectsCount: tableSubjects.length,
                tableSubjectsSample: tableSubjects.slice(0, 3).map(s => ({ name: s.subjectName, count: s.count }))
            });

            // ì •ë ¬: í•™ê¸° â†’ ê³¼ëª©ëª…
            tableSubjects.sort((a, b) => {
                if (a.semester !== b.semester) {
                    if (a.semester === '?') return 1;
                    if (b.semester === '?') return -1;
                    return String(a.semester).localeCompare(String(b.semester));
                }
                return a.subjectName.localeCompare(b.subjectName);
            });

            // ì„ì°¨ë“±ê¸‰ë³„ ì¸ì› ê³„ì‚°
            // ë“±ê¸‰ë³„ ë¹„ìœ¨: 1ë“±ê¸‰(0~10%), 2ë“±ê¸‰(10~34%), 3ë“±ê¸‰(34~66%), 4ë“±ê¸‰(66~90%), 5ë“±ê¸‰(90~100%)
            function calculateGradeDistribution(totalCount) {
                if (totalCount === 0) {
                    return {
                        '1ë“±ê¸‰': 0,
                        '2ë“±ê¸‰': 0,
                        '3ë“±ê¸‰': 0,
                        '4ë“±ê¸‰': 0,
                        '5ë“±ê¸‰': 0
                    };
                }

                // ê° ë“±ê¸‰ì˜ ë¹„ìœ¨ì— ë”°ë¼ ì¸ì› ê³„ì‚° (ì†Œìˆ˜ì  ë°˜ì˜¬ë¦¼)
                const grade1End = Math.round(totalCount * 0.10); // 0~10%
                const grade2End = Math.round(totalCount * 0.34); // 10~34%
                const grade3End = Math.round(totalCount * 0.66); // 34~66%
                const grade4End = Math.round(totalCount * 0.90); // 66~90%
                // grade5ëŠ” ë‚˜ë¨¸ì§€ (90~100%)

                const grade1 = grade1End;
                const grade2 = grade2End - grade1End;
                const grade3 = grade3End - grade2End;
                const grade4 = grade4End - grade3End;
                const grade5 = totalCount - grade4End;

                return {
                    '1ë“±ê¸‰': grade1,
                    '2ë“±ê¸‰': grade2,
                    '3ë“±ê¸‰': grade3,
                    '4ë“±ê¸‰': grade4,
                    '5ë“±ê¸‰': grade5
                };
            }

            let tableHtml = `
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-gray-100 text-gray-700">
                        <tr>
                            <th class="border p-2 text-center w-16">í•™ë…„</th>
                            <th class="border p-2 text-center w-16">í•™ê¸°</th>
                            <th class="border p-2 text-center">ê³¼ëª©ëª…</th>
                            <th class="border p-2 text-center w-24">ì‹ ì²­ ì¸ì›</th>
                            <th class="border p-2 text-center w-20">1ë“±ê¸‰</th>
                            <th class="border p-2 text-center w-20">2ë“±ê¸‰</th>
                            <th class="border p-2 text-center w-20">3ë“±ê¸‰</th>
                            <th class="border p-2 text-center w-20">4ë“±ê¸‰</th>
                            <th class="border p-2 text-center w-20">5ë“±ê¸‰</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
            `;

            if (tableSubjects.length === 0) {
                tableHtml += `<tr><td colspan="9" class="p-8 text-center text-gray-500">í‘œì‹œí•  ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                tableSubjects.forEach(item => {
                    const isZero = item.count === 0;
                    
                    // ì„ì°¨ë“±ê¸‰ë³„ ì¸ì› ê³„ì‚° (ì‹ ì²­ ì¸ì› ê¸°ì¤€)
                    const gradeDistribution = calculateGradeDistribution(item.count);

                    tableHtml += `
                        <tr class="hover:bg-gray-50 ${isZero ? 'opacity-50' : ''}">
                            <td class="border p-2 text-center text-gray-500">${item.grade}</td>
                            <td class="border p-2 text-center text-gray-500">${item.semester === '?' ? '?' : item.semester + 'í•™ê¸°'}</td>
                            <td class="border p-2 font-medium text-gray-800">${item.subjectName}</td>
                            <td class="border p-2 text-center font-bold ${isZero ? 'text-gray-400' : 'text-blue-600'}">${item.count}ëª…</td>
                            <td class="border p-2 text-center text-gray-600">${gradeDistribution['1ë“±ê¸‰']}ëª…</td>
                            <td class="border p-2 text-center text-gray-600">${gradeDistribution['2ë“±ê¸‰']}ëª…</td>
                            <td class="border p-2 text-center text-gray-600">${gradeDistribution['3ë“±ê¸‰']}ëª…</td>
                            <td class="border p-2 text-center text-gray-600">${gradeDistribution['4ë“±ê¸‰']}ëª…</td>
                            <td class="border p-2 text-center text-gray-600">${gradeDistribution['5ë“±ê¸‰']}ëª…</td>
                        </tr>
                    `;
                });
            }
            tableHtml += `</tbody></table>`;

            // Render INTO the container
            const tableContainer = document.getElementById('grade-subject-table-container');
            if (tableContainer) tableContainer.innerHTML = tableHtml;
        }


        function renderInquiryChart(students) {
            const ctx = document.getElementById('inquiryRatioChart');
            if (!ctx) return;

            // Count Social vs Science
            let social = 0;
            let science = 0;

            // Need to match course names to categories.
            // Using allCourseData global to lookup category by subjectName
            const courseMap = {}

                ;

            allCourseData.forEach(c => {
                courseMap[c.subjectName] = c.subCategory || c.category;
            });

            students.forEach(s => {
                if (s.SelectedCourses) {
                    const uniqueCourses = new Set(s.SelectedCourses.split(', ').map(x => x.trim()));

                    uniqueCourses.forEach(cName => {
                        const meta = allCourseData.find(c => c.subjectName === cName);
                        // Exclude Required
                        if (meta && (meta.required === true || String(meta.required).toLowerCase() === 'true')) return;

                        const cat = courseMap[cName];
                        if (cat && cat.includes('ì‚¬íšŒ')) social++;
                        if (cat && cat.includes('ê³¼í•™')) science++;
                    });
                }
            });

            if (dashboardCharts.inquiry) dashboardCharts.inquiry.destroy();

            dashboardCharts.inquiry = new Chart(ctx, {

                type: 'doughnut',
                data: {

                    labels: ['ì‚¬íšŒíƒêµ¬', 'ê³¼í•™íƒêµ¬'],
                    datasets: [{
                        data: [social, science],
                        backgroundColor: ['rgba(251, 146, 60, 0.6)', 'rgba(59, 130, 246, 0.6)'],
                        borderWidth: 1
                    }

                    ]
                }

                ,
                options: {
                    responsive: true, maintainAspectRatio: false
                }
            });
        }

        function renderLanguageChart(students) {
            const ctx = document.getElementById('languageChart');
            if (!ctx) return;

            const counts = {}

                ;
            const targetLangs = ['ì¼ë³¸ì–´',
                'ì¤‘êµ­ì–´',
                'í•œë¬¸',
                'ìŠ¤í˜ì¸ì–´',
                'í”„ë‘ìŠ¤ì–´',
                'ë…ì¼ì–´'];
            // Dynamic detection?

            students.forEach(s => {
                if (s.SelectedCourses) {
                    const uniqueCourses = new Set(s.SelectedCourses.split(', ').map(x => x.trim()));

                    uniqueCourses.forEach(cName => {
                        const meta = allCourseData.find(c => c.subjectName === cName);
                        // Exclude Required
                        if (meta && (meta.required === true || String(meta.required).toLowerCase() === 'true')) return;

                        // Simple check if course name contains language
                        if (targetLangs.some(l => cName.includes(l)) || cName.endsWith('ì–´') || cName === 'í•œë¬¸') {
                            counts[cName] = (counts[cName] || 0) + 1;
                        }
                    });
                }
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (dashboardCharts.language) dashboardCharts.language.destroy();

            dashboardCharts.language = new Chart(ctx, {
                type: 'bar', // or doughnut

                data: {

                    labels: labels,
                    datasets: [{
                        label: 'ì„ íƒ ì¸ì›',
                        data: data,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    }

                    ]
                }

                ,
                options: {
                    responsive: true, maintainAspectRatio: false
                }
            });
        }

        // ê³µë™êµìœ¡ê³¼ì • ê°œì„¤ ê³¼ëª© ì •ë³´ íŒì—… (êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ê¸°ë°˜)
        function slugToSubjectName(val, courseData) {
            if (!val || !(courseData && courseData.length)) return String(val || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const tokens = String(val).split(/[,ï¼Œ\/\s]+/).map(s => s.trim()).filter(Boolean);
            const names = tokens.map(t => {
                const c = courseData.find(c => (c.slug && c.slug === t) || (c.slug && c.slug.toLowerCase() === (t||'').toLowerCase()) || (c.subjectName && String(c.subjectName).trim() === t) || (c.ê³¼ëª©ëª… && String(c.ê³¼ëª©ëª…).trim() === t));
                return c ? (c.subjectName || c.ê³¼ëª©ëª… || t) : t;
            });
            return names.join(', ').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        }
        function showJointCourseInfo(subjectName) {
            const list = (window._adminJointCurriculum || []);
            const courseData = (typeof allCourseData !== 'undefined' && allCourseData) ? allCourseData : [];
            const name = (subjectName || '').toString().trim();
            const matches = list.filter(c => {
                const cn = (c.ê³¼ëª©ëª… || c.subjectName || c.name || '').toString().trim();
                return cn && (cn === name || cn.includes(name) || name.includes(cn));
            });
            const modal = document.getElementById('joint-course-info-modal');
            const body = document.getElementById('joint-course-info-body');
            if (!modal || !body) return;
            const headers = ['ë¶„ë¥˜','ê±°ì í•™êµ','ê³¼ëª©ëª…','ì„¸ë¶€êµê³¼','êµê³¼í¸ì œ','í•™ë…„','í•™ê¸°','í•™ì ','ìš´ì˜ì¼ì‹œ','ì„ ì´ìˆ˜ê³¼ëª©'];
            if (matches.length === 0) {
                body.innerHTML = `<p class="text-sm text-gray-500 p-4">"${name}"ì— í•´ë‹¹í•˜ëŠ” ê°œì„¤ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            } else {
                body.innerHTML = `<table class="w-full text-xs border-collapse theme-text"><thead><tr class="bg-gray-100 dark:bg-gray-700">${headers.map(h => `<th class="border border-gray-300 dark:border-gray-600 p-1.5 text-left">${h}</th>`).join('')}</tr></thead><tbody>${matches.map(r => `<tr>${headers.map(h => {
                    const raw = r[h] ?? '';
                    const display = (h === 'ì„ ì´ìˆ˜ê³¼ëª©') ? slugToSubjectName(raw, courseData) : String(raw).replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    return `<td class="border border-gray-300 dark:border-gray-600 p-1.5">${display}</td>`;
                }).join('')}</tr>`).join('')}</tbody></table>`;
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        function closeJointCourseInfoModal() {
            const modal = document.getElementById('joint-course-info-modal');
            if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
        }

        // AI Analysis Fetcher (Admin Mode)
        async function fetchAiCareerAnalysis(major, userCourses, jointCurriculum) {
            window._adminJointCurriculum = jointCurriculum || [];
            const container = document.getElementById('ai-analysis-container');
            if (!container) return;

            // Loading State
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-6 text-indigo-600">
                    <svg class="animate-spin h-8 w-8 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm font-bold">ì˜¤í”ˆAIê°€ ìƒí™œê¸°ë¡ë¶€ì™€ ì§„ë¡œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>
                    <span class="text-xs text-gray-400 mt-1 max-w-xs text-center">(ì•½ 10~20ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</span>
                </div>
            `;

            try {
                // Determine Available Course Context
                const availableCourses = userCourses && userCourses.length > 0 ? userCourses : "í•™êµ ì „ì²´ ê°œì„¤ ê³¼ëª©";

                const response = await fetch('/.netlify/functions/ai-recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        major: major,
                        availableCourses: availableCourses,
                        jointCurriculum: jointCurriculum || [],
                        mode: 'admin'
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error ? err.error.message : 'Analysis failed');
                }

                const result = await response.json();
                let content = result.choices[0].message.content;
                let data;

                try {
                    data = JSON.parse(content);
                } catch (e) {
                    console.error("JSON Parse Error, falling back to text", e);
                    // Fallback: Try to clean code blocks if present (```json ... ```)
                    if (content.includes('```')) {
                        content = content.replace(/```json/g, '').replace(/```/g, '');
                        try { data = JSON.parse(content); } catch (e2) { throw new Error('AI ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
                    } else {
                        throw new Error('AI ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }

                // Render Results
                const subjects = data.subjects || [];
                const keywords = data.keywords || [];
                const activities = data.activities || [];
                const balancedRecs = data.balancedRecommendations || [];
                const advancedRecs = data.advancedRecommendations || [];

                container.innerHTML = `
                    <div class="space-y-4">
                        ${balancedRecs.length > 0 ? `
                        <div>
                            <span class="block text-xs font-bold text-gray-500 mb-1 print:text-black">âš–ï¸ ê· í˜• ì¡íŒ ê³µë™êµìœ¡ê³¼ì • ì¶”ì²œ (ê° 3ê°œ)</span>
                            <ul class="list-disc pl-4 text-gray-700 dark:text-gray-300 space-y-1 text-xs print:text-black leading-snug">
                                ${balancedRecs.map(r => {
                                    const subj = (r.subject || r.ê³¼ëª©ëª… || '').toString();
                                    const safe = subj.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');
                                    return `<li class="flex items-center gap-1 flex-wrap"><strong>${subj.replace(/</g,'&lt;')}</strong>: ${(r.reason||'').replace(/</g,'&lt;')} <button type="button" onclick="showJointCourseInfo('${safe}')" class="inline-flex items-center justify-center w-3.5 h-3.5 min-w-[14px] text-gray-400 hover:text-indigo-600 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 rounded flex-shrink-0 print:hidden" title="ê°œì„¤ ê³¼ëª© ì •ë³´"><svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button></li>`;
                                }).join('')}
                            </ul>
                        </div>` : ''}
                        ${advancedRecs.length > 0 ? `
                        <div class="pt-2 border-t border-indigo-100">
                            <span class="block text-xs font-bold text-gray-500 mb-1 print:text-black">ğŸ“ˆ ì‹¬í™” ê³µë™êµìœ¡ê³¼ì • ì¶”ì²œ (ì§„ë¡œ/ìœµí•©)</span>
                            <ul class="list-disc pl-4 text-gray-700 dark:text-gray-300 space-y-1 text-xs print:text-black leading-snug">
                                ${advancedRecs.map(r => {
                                    const subj = (r.subject || r.ê³¼ëª©ëª… || '').toString();
                                    const safe = subj.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');
                                    return `<li class="flex items-center gap-1 flex-wrap"><strong>${subj.replace(/</g,'&lt;')}</strong>: ${(r.reason||'').replace(/</g,'&lt;')} <button type="button" onclick="showJointCourseInfo('${safe}')" class="inline-flex items-center justify-center w-3.5 h-3.5 min-w-[14px] text-gray-400 hover:text-indigo-600 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 rounded flex-shrink-0 print:hidden" title="ê°œì„¤ ê³¼ëª© ì •ë³´"><svg xmlns="http://www.w3.org/2000/svg" class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></button></li>`;
                                }).join('')}
                            </ul>
                        </div>` : ''}
                        <div>
                            <span class="block text-xs font-bold text-gray-500 mb-1 print:text-black">ğŸ” ì¶”ì²œ íƒêµ¬ í™œë™</span>
                             <ul class="list-disc pl-4 text-gray-700 dark:text-gray-300 space-y-1 text-xs print:text-black leading-snug">
                                ${activities.map(a => `<li>${a}</li>`).join('')}
                             </ul>
                        </div>
                        
                        <div class="pt-2 border-t border-indigo-100">
                            <span class="block text-xs font-bold text-gray-500 mb-1 print:text-black">ğŸ“š ì¶”ì²œ ê³¼ëª© ë° ì´ìœ </span>
                            <ul class="list-disc pl-4 text-gray-700 dark:text-gray-300 space-y-1 text-xs print:text-black leading-snug">
                                ${subjects.map(s => `<li>${s}</li>`).join('')}
                             </ul>
                        </div>

                        <!-- Keywords -->
                        <div class="pt-2 border-t border-indigo-100">
                            <span class="block text-xs font-bold text-gray-500 mb-1 print:text-black">ğŸ”‘ ìƒê¸°ë¶€ ì¶”ì²œ í‚¤ì›Œë“œ</span>
                            <div class="flex flex-wrap gap-1">
                                ${keywords.map(k => `<span class="px-2 py-0.5 bg-white rounded border border-indigo-200 text-indigo-600 text-[10px] font-bold shadow-sm print:text-black print:border-gray-400">${k}</span>`).join('')}
                            </div>
                        </div>
                        
                        <div class="text-right pt-2">
                             <span class="text-[10px] text-gray-400">Analysis by OpenAI GPT-4o</span>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error("AI Error:", error);
                container.innerHTML = `
                    <div class="text-center py-4 text-red-500 text-sm">
                        <p class="font-bold">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-xs mt-1">${error.message}</p>
                        <button onclick="fetchAiCareerAnalysis('${(major||'').replace(/'/g,"\\'")}', '', [])" class="mt-2 text-xs bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }
    </script>

    <!-- Class Stats Dashboard Modal -->
    <div id="class-stats-dashboard-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-5xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2 theme-border">
                <h2 class="text-xl font-bold theme-text">í•™ê¸‰ í†µê³„ ëŒ€ì‹œë³´ë“œ</h2>
                <button onclick="closeClassStats()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Dashboard Filters -->
            <div id="dashboard-active-filters" class="flex gap-4 mb-4 items-center bg-gray-50 p-3 rounded">
                <span class="font-bold text-gray-700">ğŸ“Œ ì¡°íšŒ ëŒ€ìƒ:</span>
                <select id="dashboard-select-grade" class="p-2 border rounded" disabled>
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                </select>
                <select id="dashboard-select-class" class="p-2 border rounded" disabled>
                    <!-- Populated by JS -->
                </select>
                <span class="text-xs text-gray-400 ml-auto">* í•„í„°ëŠ” ë©”ì¸ í™”ë©´ì—ì„œ ì—°ë™ë©ë‹ˆë‹¤.</span>
            </div>

            <!-- Tabs -->
            <div id="dashboard-tabs" class="flex gap-2 border-b mb-4">
                <!-- Populated by JS -->
            </div>

            <!-- Content Area -->
            <div id="dashboard-content" class="flex-1 overflow-hidden flex flex-col min-h-[400px]">
                <div id="dashboard-message" class="text-center text-gray-500 py-10">
                    ì¢Œì¸¡ íƒ­ì„ ì„ íƒí•˜ì—¬ í†µê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                </div>
                <div id="dashboard-tab-content" class="flex-1 overflow-y-auto custom-scrollbar p-2">
                    <!-- Tab Content Rendered Here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Theme Selector -->
    <div class="fixed bottom-6 left-6 z-50 group">
        <div id="theme-menu"
            class="absolute bottom-full left-0 mb-2 hidden bg-white rounded-lg shadow-xl border p-2 min-w-[150px] transition-all transform origin-bottom-left">
            <div class="text-xs font-bold text-gray-400 mb-2 px-2">í…Œë§ˆ ì„ íƒ</div><button onclick="changeTheme('light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>â˜€ï¸</span>ë¼ì´íŠ¸
                ëª¨ë“œ</button><button onclick="changeTheme('dark-neon')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ™</span>ë‹¤í¬
                ë„¤ì˜¨</button><button onclick="changeTheme('tokyo-night')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒƒ</span>ë„ì¿„
                ë‚˜ì´íŠ¸</button><button onclick="changeTheme('solarized-light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ…</span>ì†”ë¼ë¼ì´ì¦ˆë“œ</button>
        </div><button onclick="toggleThemeMenu()"
            class="bg-white p-3 rounded-full shadow-lg border-2 border-purple-100 hover:border-purple-300 hover:shadow-xl transition-all flex items-center justify-center w-12 h-12"><span
                class="text-2xl">ğŸ¨</span></button>
    </div>
    <script>function changeTheme(themeName) {
            applyTheme(themeName);
            localStorage.setItem('theme', themeName);
            document.getElementById('theme-menu').classList.add('hidden');
        }

        function toggleThemeMenu() {
            document.getElementById('theme-menu').classList.toggle('hidden');
        }

        // Initialize Theme & Class Options & Config
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            populateClassOptions();
            loadConfig(); // Load API URL
        });
    </script>
</body>

</html>
