<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - êµìœ¡ê³¼ì • ì„¤ê³„</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Custom Modules -->
    <script src="js/db.js"></script>
    <script src="js/excel-handler.js"></script>
    <script src="js/qrcode-generator.js"></script>
    <script src="js/theme.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }

        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: bold;
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <a href="index.html" target="_blank" class="text-blue-600 hover:underline">í•™ìƒ í˜ì´ì§€ ë³´ê¸° &rarr;</a>
        </header>

        <!-- Tabs -->
        <div class="flex border-b mb-6">
            <button class="tab-btn px-6 py-3 text-gray-600 hover:text-blue-600 active" onclick="switchTab('system')">ì‹œìŠ¤í…œ
                ì„¤ì •</button>
            <button class="tab-btn px-6 py-3 text-gray-600 hover:text-blue-600" onclick="switchTab('courses')">ê³¼ëª© ë°ì´í„°
                ê´€ë¦¬</button>
            <button class="tab-btn px-6 py-3 text-gray-600 hover:text-blue-600" onclick="switchTab('share')">ë°°í¬ ë°
                ê³µìœ </button>
            <button class="tab-btn px-6 py-3 text-gray-600 hover:text-blue-600" onclick="switchTab('dashboard')">í•™ìƒ ì‹ ì²­
                í˜„í™©</button>
        </div>

        <!-- 1. System Config -->
        <div id="tab-system" class="tab-content">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl">
                <h2 class="text-xl font-semibold mb-4">Google Apps Script API ì„¤ì •</h2>
                <p class="text-sm text-gray-500 mb-4">
                    ë°°í¬ëœ Google Apps Script ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”.
                    ì´ URLì€ ë°ì´í„°ë² ì´ìŠ¤(Google Sheets)ì™€ì˜ í†µì‹ ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
                </p>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">API URL</label>
                    <input type="text" id="api-url" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500"
                        placeholder="https://script.google.com/macros/s/.../exec">
                </div>
                <div class="flex gap-2">
                    <button id="save-url-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        ì €ì¥
                    </button>
                    <button id="test-connection-btn"
                        class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300">
                        ì—°ê²° í…ŒìŠ¤íŠ¸
                    </button>
                </div>
                <div id="connection-status" class="mt-4 text-sm"></div>
            </div>
        </div>

        <!-- 2. Course Data Management -->
        <div id="tab-courses" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">ê³¼ëª© ì—‘ì…€ ì—…ë¡œë“œ</h2>
                    <p class="text-sm text-gray-500 mb-4">
                        'í¸ì œí‘œ' ì‹œíŠ¸ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.
                        ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.
                    </p>
                    <div class="space-y-4">
                        <button onclick="ExcelHandler.downloadTemplate()"
                            class="text-blue-600 hover:underline text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <input type="file" id="course-excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100
                        " />
                        <button id="upload-course-btn"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">
                            ë°ì´í„° ì—…ë¡œë“œ ë° ì €ì¥
                        </button>
                    </div>
                    <div id="upload-status" class="mt-4 text-sm"></div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">í˜„ì¬ ë“±ë¡ëœ ê³¼ëª©</h2>
                    <div id="current-course-count" class="text-3xl font-bold text-gray-700 mb-2">-</div>
                    <p class="text-sm text-gray-500">ê°œì˜ ê³¼ëª©ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <button id="refresh-course-btn" class="mt-4 text-sm text-blue-600 hover:underline">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>

        <!-- 3. Share & Deploy -->
        <div id="tab-share" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl">
                <h2 class="text-xl font-semibold mb-4">í•™ìƒìš© ë§í¬ ìƒì„±</h2>
                <p class="text-sm text-gray-500 mb-4">
                    ì•„ë˜ QR ì½”ë“œ ë˜ëŠ” ë§í¬ë¥¼ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”.
                    ë§í¬ì—ëŠ” API URL ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì–´ í•™ìƒë“¤ì´ ë³„ë„ì˜ ì„¤ì • ì—†ì´ ë°”ë¡œ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>

                <div id="share-container" class="hidden">
                    <div class="flex flex-col items-center p-4 bg-white rounded border mb-4">
                        <div id="qrcode" class="mb-4"></div>
                        <p class="text-sm font-mono break-all text-center text-gray-600" id="share-link-text"></p>
                    </div>
                    <button id="copy-link-btn"
                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                        ë§í¬ ë³µì‚¬í•˜ê¸°
                    </button>
                </div>

                <div id="share-error" class="hidden text-red-500">
                    ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        </div>

        <!-- 4. Student Dashboard -->
        <div id="tab-dashboard" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2">
                    <select id="filter-grade" class="p-2 border rounded">
                        <option value="">ì „ì²´ í•™ë…„</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                    </select>
                    <select id="filter-class" class="p-2 border rounded">
                        <option value="">ì „ì²´ ë°˜</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <button id="refresh-data-btn" class="bg-gray-200 px-3 py-2 rounded hover:bg-gray-300">ğŸ”„</button>
                </div>
                <button id="download-matrix-btn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (0/1 ë§¤íŠ¸ë¦­ìŠ¤)
                </button>
            </div>

            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 uppercase">
                        <tr>
                            <th class="px-4 py-3">ì‹œê°„</th>
                            <th class="px-4 py-3">í•™ë²ˆ</th>
                            <th class="px-4 py-3">ì´ë¦„</th>
                            <th class="px-4 py-3">ì§„ë¡œ</th>
                            <th class="px-4 py-3">ì´ í•™ì </th>
                            <th class="px-4 py-3">ê²€ì¦ ê²°ê³¼</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="6" class="px-4 py-4 text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'share') updateShareLink();
            if (tabName === 'dashboard') loadStudentData();
            if (tabName === 'courses') checkCourseStatus();
        }

        // 1. System Config
        const apiUrlInput = document.getElementById('api-url');
        const saveUrlBtn = document.getElementById('save-url-btn');
        const testConnBtn = document.getElementById('test-connection-btn');
        const connStatus = document.getElementById('connection-status');

        function loadConfig() {
            const savedUrl = localStorage.getItem('gas_api_url');
            if (savedUrl) {
                apiUrlInput.value = savedUrl;
                DB.init(savedUrl);
            }
        }

        saveUrlBtn.addEventListener('click', () => {
            const url = apiUrlInput.value.trim();
            if (!url) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            localStorage.setItem('gas_api_url', url);
            DB.init(url);
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            updateShareLink();
        });

        testConnBtn.addEventListener('click', async () => {
            if (!DB.isConfigured()) return alert('URLì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.');
            connStatus.textContent = 'ì—°ê²° ì‹œë„ ì¤‘...';
            connStatus.className = 'mt-4 text-sm text-gray-600';
            try {
                const data = await DB.fetchConfig();
                connStatus.textContent = 'ì—°ê²° ì„±ê³µ! (' + data.length + 'ê°œì˜ ê³¼ëª© ë°ì´í„° í™•ì¸ë¨)';
                connStatus.className = 'mt-4 text-sm text-green-600 font-bold';
            } catch (e) {
                connStatus.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + e.message;
                connStatus.className = 'mt-4 text-sm text-red-600 font-bold';
            }
        });

        // 2. Course Data
        const uploadCourseBtn = document.getElementById('upload-course-btn');
        const courseFileInput = document.getElementById('course-excel-file');
        const uploadStatus = document.getElementById('upload-status');

        uploadCourseBtn.addEventListener('click', async () => {
            if (!DB.isConfigured()) return alert('ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
            const file = courseFileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            uploadStatus.textContent = 'íŒŒì¼ ì²˜ë¦¬ ì¤‘...';
            try {
                const jsonData = await ExcelHandler.readExcel(file);
                uploadStatus.textContent = 'ì„œë²„ì— ì—…ë¡œë“œ ì¤‘...';
                await DB.saveConfig(jsonData);
                uploadStatus.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
                uploadStatus.className = 'mt-4 text-sm text-green-600 font-bold';
                checkCourseStatus();
            } catch (e) {
                console.error(e);
                uploadStatus.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + e.message;
                uploadStatus.className = 'mt-4 text-sm text-red-600 font-bold';
            }
        });

        async function checkCourseStatus() {
            if (!DB.isConfigured()) return;
            try {
                const data = await DB.fetchConfig();
                document.getElementById('current-course-count').textContent = data.length;
            } catch (e) {
                document.getElementById('current-course-count').textContent = 'Error';
            }
        }

        document.getElementById('refresh-course-btn').addEventListener('click', checkCourseStatus);

        // 3. Share
        function updateShareLink() {
            const container = document.getElementById('share-container');
            const errorMsg = document.getElementById('share-error');
            const savedUrl = localStorage.getItem('gas_api_url');

            if (!savedUrl) {
                container.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            errorMsg.classList.add('hidden');

            // Generate Link
            // Assuming index.html is in the same directory
            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const encodedKey = btoa(savedUrl); // Simple Base64 encoding
            const fullLink = `${baseUrl}?key=${encodedKey}`;

            document.getElementById('share-link-text').textContent = fullLink;
            // Increased size to 256 for better scannability
            QRCodeGenerator.generate('qrcode', fullLink, 256);

            document.getElementById('copy-link-btn').onclick = () => {
                navigator.clipboard.writeText(fullLink).then(() => alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
            };
        }

        // 4. Dashboard
        let allStudentData = [];

        async function loadStudentData() {
            if (!DB.isConfigured()) return;
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>';

            try {
                allStudentData = await DB.fetchResponses();
                renderStudentTable();
                updateClassFilter();
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center text-red-500">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            }
        }

        function renderStudentTable() {
            const tbody = document.getElementById('student-table-body');
            const gradeFilter = document.getElementById('filter-grade').value;
            const classFilter = document.getElementById('filter-class').value;

            let filtered = allStudentData;
            if (gradeFilter) filtered = filtered.filter(d => d.Grade == gradeFilter);
            if (classFilter) filtered = filtered.filter(d => d.Class == classFilter);

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(d => {
                // Parse timestamp
                const date = new Date(d.Timestamp).toLocaleString();
                // Simple validation check (mock logic for now, real logic needs course data)
                const isValid = true;
                const statusColor = isValid ? 'text-green-600' : 'text-red-600';
                const statusText = isValid ? 'ì •ìƒ' : 'ì£¼ì˜';

                return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${date}</td>
                        <td class="px-4 py-2">${d.Grade}-${d.Class}-${d.Number}</td>
                        <td class="px-4 py-2 font-medium">${d.Name}</td>
                        <td class="px-4 py-2">${d.Major}</td>
                        <td class="px-4 py-2">${d.TotalCredits}</td>
                        <td class="px-4 py-2 ${statusColor}">${statusText}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateClassFilter() {
            const classSelect = document.getElementById('filter-class');
            const classes = [...new Set(allStudentData.map(d => d.Class))].sort((a, b) => a - b);
            classSelect.innerHTML = '<option value="">ì „ì²´ ë°˜</option>' + classes.map(c => `<option value="${c}">${c}ë°˜</option>`).join('');
        }

        document.getElementById('filter-grade').addEventListener('change', renderStudentTable);
        document.getElementById('filter-class').addEventListener('change', renderStudentTable);
        document.getElementById('refresh-data-btn').addEventListener('click', loadStudentData);

        // Excel Matrix Download
        document.getElementById('download-matrix-btn').addEventListener('click', () => {
            if (allStudentData.length === 0) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

            // 1. Get all unique course names
            const allCourses = new Set();
            allStudentData.forEach(d => {
                if (d.SelectedCourses) {
                    d.SelectedCourses.split(', ').forEach(c => allCourses.add(c.trim()));
                }
            });
            const courseList = [...allCourses].sort();

            // 2. Build Matrix
            const matrix = allStudentData.map(d => {
                const row = {
                    'í•™ë…„': d.Grade,
                    'ë°˜': d.Class,
                    'ë²ˆí˜¸': d.Number,
                    'ì´ë¦„': d.Name,
                    'ì§„ë¡œ': d.Major
                };
                const selected = new Set(d.SelectedCourses ? d.SelectedCourses.split(', ').map(c => c.trim()) : []);
                courseList.forEach(c => {
                    row[c] = selected.has(c) ? 1 : 0;
                });
                return row;
            });

            ExcelHandler.downloadExcel(matrix, 'í•™ìƒì„ íƒê³¼ëª©_ë§¤íŠ¸ë¦­ìŠ¤.xlsx');
        });

        // Initialize
        loadConfig();
    </script>
    <!-- Floating Theme Selector -->
    <div
        class="fixed bottom-6 left-6 z-50 flex items-center gap-2 bg-white p-2 rounded-full shadow-lg border hover:shadow-xl transition-shadow">
        <span class="text-xl pl-2">ğŸ¨</span>
        <select id="theme-selector"
            class="bg-transparent border-none focus:ring-0 text-sm font-medium cursor-pointer pr-8 py-1">
            <option value="light">Light Mode</option>
            <option value="dark-neon">Dark Neon</option>
            <option value="tokyo-night">Tokyo Night</option>
            <option value="solarized-light">Solarized Light</option>
        </select>
    </div>
    <script>
        // Initialize theme selector for admin page
        document.addEventListener('DOMContentLoaded', () => {
            const themeSelector = document.getElementById('theme-selector');
            const savedTheme = localStorage.getItem('theme') || 'light';
            themeSelector.value = savedTheme;
            applyTheme(savedTheme);

            themeSelector.addEventListener('change', (e) => {
                const theme = e.target.value;
                applyTheme(theme);
                localStorage.setItem('theme', theme);
            });
        });
    </script>
</body>

</html>
