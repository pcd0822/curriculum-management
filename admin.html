<!DOCTYPE html>
<html lang="ko">

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Chart.js -->
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- QRCode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Custom Modules -->
<script src="js/db.js"></script>
<script src="js/excel-handler.js"></script>
<script src="js/qrcode-generator.js"></script>
<script src="js/theme.js"></script>

<style>
    body {
        font-family: 'Noto Sans KR', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }

    .tab-btn.active {
        border-bottom: 2px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: bold;
    }

    /* Custom styles for theme compatibility */
    .theme-card {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
    }

    .theme-text {
        color: var(--text-color);
    }

    .theme-text-muted {
        color: var(--text-muted);
    }

    .theme-border {
        border-color: var(--border-color);
    }

    input,
    select {
        background-color: var(--input-bg);
        border-color: var(--border-color);
        color: var(--text-color);
    }

    input:focus,
    select:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2);
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.8);
    }
</style>
</head>

<body class="min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold theme-text">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <a href="index.html" target="_blank" class="text-blue-600 hover:underline">í•™ìƒ í˜ì´ì§€ ë³´ê¸° &rarr;</a>
        </header>

        <!-- Tabs -->
        <div class="flex border-b mb-6 theme-border">
            <button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600 active"
                onclick="switchTab('system')">ì‹œìŠ¤í…œ ì„¤ì •</button>
            <button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600" onclick="switchTab('courses')">ê³¼ëª© ë°ì´í„°
                ê´€ë¦¬</button>
            <button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600" onclick="switchTab('rules')">ì„ íƒ
                ê·œì¹™</button>
            <button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600" onclick="switchTab('share')">ë°°í¬ ë°
                ê³µìœ </button>
            <button class="tab-btn px-6 py-3 theme-text-muted hover:text-blue-600" onclick="switchTab('dashboard')">í•™ìƒ
                ì‹ ì²­
                í˜„í™©</button>
        </div>

        <!-- 1. System Config -->
        <div id="tab-system" class="tab-content">
            <div class="theme-card p-6 rounded-lg shadow-md max-w-2xl">
                <h2 class="text-xl font-semibold mb-4 theme-text">Google Apps Script API ì„¤ì •</h2>
                <p class="text-sm mb-4 theme-text-muted">ë°°í¬ëœ Google Apps Script ì›¹ ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”. ì´ URLì€ ë°ì´í„°ë² ì´ìŠ¤(Google
                    Sheets)ì™€ì˜ í†µì‹ ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1 theme-text">API URL</label>
                    <input type="text" id="api-url" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500"
                        placeholder="https://script.google.com/macros/s/.../exec">
                </div>
                <div class="flex gap-2">
                    <button id="save-url-btn"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì €ì¥</button>
                    <button id="test-connection-btn"
                        class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300"
                        style="background-color: var(--hover-bg); color: var(--text-color)">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                </div>
                <div id="connection-status" class="mt-4 text-sm"></div>
            </div>
        </div>

        <!-- 2. Course Data Management -->
        <div id="tab-courses" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Course Upload -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">ê³¼ëª© ì—‘ì…€ ì—…ë¡œë“œ</h2>
                    <p class="text-sm mb-4 theme-text-muted">'í¸ì œí‘œ' ì‹œíŠ¸ê°€ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</p>
                    <div class="space-y-4">
                        <button onclick="ExcelHandler.downloadTemplate()"
                            class="text-blue-600 hover:underline text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            ê³¼ëª© í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <input type="file" id="course-excel-file" accept=".xlsx, .xls"
                            class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <button id="upload-course-btn"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">ê³¼ëª© ë°ì´í„° ì—…ë¡œë“œ ë°
                            ì €ì¥</button>
                    </div>
                    <div id="upload-status" class="mt-4 text-sm"></div>
                </div>

                <!-- Student Registry Upload -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í•™ì  ì •ë³´ ì—…ë¡œë“œ</h2>
                    <p class="text-sm mb-4 theme-text-muted">í•™ë²ˆ(5ìë¦¬)ê³¼ ì´ë¦„ì´ í¬í•¨ëœ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br>(ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€/ê°±ì‹ ë©ë‹ˆë‹¤)</p>
                    <div class="space-y-4">
                        <button onclick="ExcelHandler.downloadRegistryTemplate()"
                            class="text-blue-600 hover:underline text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            í•™ì  í…œí”Œë¦¿ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <input type="file" id="registry-excel-file" accept=".xlsx, .xls"
                            class="block w-full text-sm theme-text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <button id="upload-registry-btn"
                            class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 w-full">í•™ì  ë°ì´í„° ì—…ë¡œë“œ ë°
                            ì €ì¥</button>
                    </div>
                    <div id="registry-upload-status" class="mt-4 text-sm"></div>
                </div>

                <div class="theme-card p-6 rounded-lg shadow-md md:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í˜„ì¬ ë“±ë¡ëœ ê³¼ëª©</h2>
                    <div id="current-course-count" class="text-3xl font-bold mb-2 theme-text">-</div>
                    <p class="text-sm theme-text-muted">ê°œì˜ ê³¼ëª©ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <button id="refresh-course-btn" class="mt-4 text-sm text-blue-600 hover:underline">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>

        <!-- 2.5 Selection Rules -->
        <div id="tab-rules" class="tab-content hidden">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Limit Configuration -->
                <div class="theme-card p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4 theme-text">í•™ë…„-í•™ê¸°ë³„ ì„ íƒ ê·œì¹™ ì„¤ì •</h2>
                    <p class="text-sm mb-4 theme-text-muted">ê° í•™ê¸°ë³„ë¡œ í•™ì  ë‹¨ìœ„ ì„ íƒ ê·œì¹™ì„ ì¶”ê°€í•˜ì„¸ìš”.<br>(ì˜ˆ: 4í•™ì  ê³¼ëª© 5ê°œ ì„ íƒ)</p>

                    <div id="limit-config-container" class="space-y-6">
                        <!-- Dynamic Content -->
                    </div>

                    <button id="save-rules-btn"
                        class="mt-6 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">ê·œì¹™ ì €ì¥</button>
                </div>

                <!-- Course Classification View -->
                <div class="space-y-6">
                    <div class="theme-card p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 theme-text">ê³¼ëª© í¸ì œ í™•ì¸</h2>
                        <p class="text-sm mb-4 theme-text-muted">ë“±ë¡ëœ ê³¼ëª©ì´ í•™ë…„-í•™ê¸°ë³„ë¡œ ì˜¬ë°”ë¥´ê²Œ ë¶„ë¥˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</p>
                        <div id="course-classification-view"
                            class="space-y-4 max-h-[400px] overflow-y-auto custom-scrollbar">
                            <!-- Dynamic Content -->
                        </div>
                    </div>

                    <!-- Multi-Semester Course Config -->
                    <div class="theme-card p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4 theme-text">ë³µìˆ˜ í¸ì œ ê³¼ëª© ê´€ë¦¬</h2>
                        <p class="text-sm mb-4 theme-text-muted">ì—¬ëŸ¬ í•™ê¸°(í•™ë…„)ì— ì¤‘ë³µ ê°œì„¤ëœ ê³¼ëª© ëª©ë¡ì…ë‹ˆë‹¤. ì´ ê³¼ëª©ë“¤ì€ í•™ìƒ í˜ì´ì§€ì—ì„œ ìë™ìœ¼ë¡œ ìƒí˜¸
                            ë°°íƒ€ì ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                        <div id="multi-semester-config-container"
                            class="space-y-4 max-h-[300px] overflow-y-auto custom-scrollbar">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Share & Deploy -->
        <div id="tab-share" class="tab-content hidden">
            <div class="theme-card p-6 rounded-lg shadow-md max-w-2xl">
                <h2 class="text-xl font-semibold mb-4 theme-text">í•™ìƒìš© ë§í¬ ìƒì„±</h2>
                <p class="text-sm mb-4 theme-text-muted">ì•„ë˜ QR ì½”ë“œ ë˜ëŠ” ë§í¬ë¥¼ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”. ë§í¬ì—ëŠ” API URL ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì–´ í•™ìƒë“¤ì´ ë³„ë„ì˜
                    ì„¤ì •
                    ì—†ì´ ë°”ë¡œ
                    ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                <div id="share-container" class="hidden">
                    <div class="flex flex-col items-center p-4 rounded border mb-4 theme-border"
                        style="background-color: var(--card-bg)">
                        <div id="qrcode" class="mb-4 bg-white p-2 rounded"></div>
                        <p class="text-sm font-mono break-all text-center theme-text-muted" id="share-link-text"></p>
                    </div>
                    <button id="copy-link-btn"
                        class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ë§í¬ ë³µì‚¬í•˜ê¸°</button>
                </div>
                <div id="share-error" class="hidden text-red-500">ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ API URLì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.</div>
            </div>
        </div>

        <!-- 4. Student Dashboard -->
        <div id="tab-dashboard" class="tab-content hidden">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button onclick="openClassStats()"
                    class="p-4 rounded-lg shadow-md bg-gradient-to-br from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 transition flex items-center justify-between">
                    <div>
                        <h3 class="font-bold text-lg">í•™ê¸‰ë³„ ì‹ ì²­ í˜„í™© ì¡°íšŒ</h3>
                        <p class="text-sm opacity-90">ë°˜ë³„ ëª…ë ¬í‘œ ë° ì‹ ì²­ ìƒíƒœ í™•ì¸</p>
                    </div>
                    <span class="text-2xl">ğŸ“‹</span>
                </button>
                <div class="theme-card p-4 rounded-lg shadow-md border theme-border flex items-center justify-between">
                    <div>
                        <h3 class="font-bold theme-text">ì „ì²´ ì œì¶œ í˜„í™©</h3>
                        <p class="text-sm theme-text-muted" id="total-submissions-count">0ëª… ì œì¶œë¨</p>
                    </div>
                    <button onclick="loadStudentData()" class="text-blue-600 hover:underline text-sm">ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <!-- Visual Stats Section -->
            <div id="course-stats-container" class="mb-6 hidden">
                <div class="theme-card p-4 rounded-lg shadow-md border theme-border">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold theme-text text-lg">ê³¼ëª©ë³„ ìˆ˜ê°•ì‹ ì²­ í˜„í™©</h3>
                        <button onclick="document.getElementById('course-stats-container').classList.add('hidden')"
                            class="text-gray-500 hover:text-gray-700">ì ‘ê¸°</button>
                    </div>
                    <div id="course-stats-grid"
                        class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-[400px] overflow-y-auto custom-scrollbar">
                        <!-- Stats will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <div class="flex gap-2">
                    <select id="filter-grade" class="p-2 border rounded">
                        <option value="">ì „ì²´ í•™ë…„</option>
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                    </select>
                    <select id="filter-class" class="p-2 border rounded">
                        <option value="">ì „ì²´ ë°˜</option>
                        <!-- Options will be populated dynamically -->
                    </select>
                    <button id="refresh-data-btn" class="px-3 py-2 rounded hover:bg-gray-300"
                        style="background-color: var(--hover-bg)">ğŸ”„</button>
                </div>
                <!-- Visual Stats Buttons -->
                <div class="flex gap-2">
                    <button onclick="openIndividualStats()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">ğŸ“Š ê°œì¸ë³„ í†µê³„</button>
                    <button onclick="openClassStatsDashboard()"
                        class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">ğŸ“ˆ í•™ê¸‰ í†µê³„</button>
                    <button id="download-matrix-btn"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">ì—‘ì…€
                        ë‹¤ìš´ë¡œë“œ (í•™ìƒì„ íƒ)</button>
                </div>
            </div>
            <div class="overflow-x-auto rounded-lg shadow-md theme-card">
                <table class="w-full text-sm text-left">
                    <thead class="uppercase" style="background-color: var(--hover-bg); color: var(--text-muted)">
                        <tr>
                            <th class="px-4 py-3">ì‹œê°„</th>
                            <th class="px-4 py-3">í•™ë²ˆ</th>
                            <th class="px-4 py-3">ì´ë¦„</th>
                            <th class="px-4 py-3">ì§„ë¡œ</th>
                            <th class="px-4 py-3">ì´ í•™ì </th>
                            <th class="px-4 py-3">ê²€ì¦ ê²°ê³¼</th>
                        </tr>
                    </thead>
                    <tbody id="student-table-body">
                        <tr>
                            <td colspan="6" class="px-4 py-4 text-center theme-text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Class Lookup Modal -->
    <div id="class-lookup-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2 theme-border">
                <h2 class="text-xl font-bold theme-text">í•™ê¸‰ë³„ ì‹ ì²­ í˜„í™©</h2>
                <button onclick="closeClassStats()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="flex gap-4 mb-4">
                <select id="modal-select-grade" class="p-2 border rounded" onchange="populateStudentNumberOptions()">
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                </select>
                <select id="modal-select-class" class="p-2 border rounded" onchange="populateStudentNumberOptions()">
                    <!-- Options populated by JS -->
                </select>
                <select id="modal-select-number" class="p-2 border rounded w-24">
                    <option value="all">ì „ì²´</option>
                    <!-- Options populated by JS -->
                </select>
                <button onclick="renderIndividualStatsTable()"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì¡°íšŒ</button>
                <button onclick="downloadClassImage()"
                    class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 ml-auto">ì´ë¯¸ì§€ ì €ì¥</button>
            </div>

            <div id="class-stats-content" class="bg-white p-4 rounded border min-h-[300px] overflow-auto">
                <div class="text-center text-gray-500 py-10">í•™ë…„ê³¼ ë°˜ì„ ì„ íƒí•˜ê³  ì¡°íšŒë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            </div>
        </div>
    </div>

    <!-- Class Statistics Dashboard Modal (New) -->
    <div id="class-stats-dashboard-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-5xl w-full max-h-[90vh] overflow-y-auto custom-scrollbar shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2 theme-border">
                <h2 class="text-xl font-bold theme-text">ğŸ“ˆ í•™ê¸‰ í†µê³„ ëŒ€ì‹œë³´ë“œ</h2>
                <button onclick="document.getElementById('class-stats-dashboard-modal').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <div class="flex gap-4 mb-6">
                <select id="dashboard-select-grade" class="p-2 border rounded">
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                </select>
                <select id="dashboard-select-class" class="p-2 border rounded">
                    <!-- JS populated -->
                </select>
                <button onclick="renderClassStatsDashboard()"
                    class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">í†µê³„ ì¡°íšŒ</button>
            </div>

            <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 gap-6 p-2">
                <!-- Charts will vary based on grade -->
                <div class="theme-card p-4 rounded border shadow-sm">
                    <h3 class="font-bold mb-4 text-center">íƒêµ¬ ê³¼ëª© ì„ íƒ ë¹„ìœ¨</h3>
                    <div class="h-64 relative">
                        <canvas id="inquiryRatioChart"></canvas>
                    </div>
                </div>
                <div class="theme-card p-4 rounded border shadow-sm">
                    <h3 class="font-bold mb-4 text-center">ì œ2ì™¸êµ­ì–´ ì„ íƒ ë¹„ìœ¨</h3>
                    <div class="h-64 relative">
                        <canvas id="languageChart"></canvas>
                    </div>
                </div>
            </div>
            <div id="dashboard-message" class="text-center text-gray-500 py-10">
                í•™ë…„ê³¼ ë°˜ì„ ì„ íƒí•˜ì—¬ í†µê³„ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let allStudentData = [];
        let allCourseData = []; // Store course config globaly for Excel sorting

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'share') updateShareLink();
            if (tabName === 'dashboard') loadStudentData();
            if (tabName === 'rules') loadRulesAndClassification();
        }

        // 1. System Config
        function loadConfig() {
            const savedUrl = localStorage.getItem('gas_api_url');
            if (savedUrl) {
                document.getElementById('api-url').value = savedUrl;
                DB.init(savedUrl);
                loadCourseCount();
            }
        }

        document.getElementById('save-url-btn').addEventListener('click', () => {
            const url = document.getElementById('api-url').value.trim();
            if (!url) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            localStorage.setItem('gas_api_url', url);
            DB.init(url);
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadCourseCount();
        });

        document.getElementById('test-connection-btn').addEventListener('click', async () => {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const result = await DB.fetchConfig();
                if (Array.isArray(result)) {
                    statusEl.textContent = `ì—°ê²° ì„±ê³µ! (ê³¼ëª© ìˆ˜: ${result.length})`;
                    statusEl.className = 'mt-4 text-sm text-green-600';
                } else {
                    throw new Error('Invalid response');
                }
            } catch (e) {
                statusEl.textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // 2. Course Data & Registry
        async function loadCourseCount() {
            if (!DB.isConfigured()) return;
            try {
                const courses = await DB.fetchConfig();
                allCourseData = courses || []; // Save globally
                document.getElementById('current-course-count').textContent = courses ? courses.length : 0;
            } catch (e) {
                console.error('Failed to load course count', e);
            }
        }

        document.getElementById('refresh-course-btn').addEventListener('click', loadCourseCount);

        document.getElementById('upload-course-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('course-excel-file');
            const file = fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const jsonData = await ExcelHandler.readExcel(file);
                // Standardize keys (required field mostly)
                // Map Korean headers to English keys
                const headerMap = {
                    'ê³¼ëª©ëª…': 'subjectName',
                    'ì˜ë¬¸ID': 'slug',
                    'slug': 'slug', // Support both
                    'ì˜ë¬¸id': 'slug',
                    'í•™ë…„': 'grade',
                    'í•™ê¸°': 'semester',
                    'í•™ì ': 'credits',
                    'êµê³¼êµ°': 'category',
                    'ì„¸ë¶€êµê³¼': 'subCategory',
                    'í•„ìˆ˜ì—¬ë¶€': 'required',
                    'ê°œì„¤ì—¬ë¶€': 'offered',
                    'ì„ ìˆ˜ê³¼ëª©': 'prerequisites'
                };

                const processed = jsonData.map(row => {
                    const newRow = {};
                    Object.keys(row).forEach(key => {
                        const cleanKey = key.trim();
                        const mappedKey = headerMap[cleanKey] || headerMap[cleanKey.toLowerCase()] || cleanKey;
                        newRow[mappedKey] = row[key];
                    });

                    // Standard Schema Keys
                    const standardKeys = [
                        'subjectName', 'slug', 'grade', 'semester', 'credits',
                        'category', 'subCategory', 'required', 'offered', 'prerequisites'
                    ];

                    // Ensure all standard keys exist
                    standardKeys.forEach(k => {
                        if (newRow[k] === undefined) newRow[k] = '';
                    });

                    // Normalize required field
                    if (newRow.required !== undefined && newRow.required !== '') {
                        const v = String(newRow.required).toUpperCase();
                        newRow.required = (v === 'TRUE' || v === 'YES' || v === '1' || newRow.required === true);
                    } else {
                        newRow.required = false;
                    }

                    if (newRow.offered !== undefined && newRow.offered !== '') {
                        const v = String(newRow.offered).toUpperCase();
                        newRow.offered = (v === 'TRUE' || v === 'YES' || v === '1' || newRow.offered === true);
                    } else {
                        newRow.offered = true;
                    }

                    // Generate Slug if missing
                    if (!newRow.slug && newRow.subjectName) {
                        // Simple fallback slug generation (not perfect but better than nothing)
                        // Ideally user provides slug.
                    }

                    return newRow;
                });

                const result = await DB.saveConfig(processed);
                if (result.status === 'success') {
                    statusEl.textContent = 'ì—…ë¡œë“œ ì„±ê³µ!';
                    statusEl.className = 'mt-4 text-sm text-green-600';
                    loadCourseCount();
                } else {
                    throw new Error('Upload failed');
                }
            } catch (e) {
                statusEl.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });

        // Registry Upload
        document.getElementById('upload-registry-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('registry-excel-file');
            const file = fileInput.files[0];
            if (!file) return alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            const statusEl = document.getElementById('registry-upload-status');
            statusEl.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            statusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const jsonData = await ExcelHandler.readExcel(file);
                // Check if data has ID and Name
                if (jsonData.length === 0 || !jsonData[0].hasOwnProperty('í•™ë²ˆ') || !jsonData[0].hasOwnProperty('ì´ë¦„')) {
                    throw new Error('ì˜¬ë°”ë¥¸ ì—‘ì…€ ì„œì‹ì´ ì•„ë‹™ë‹ˆë‹¤. "í•™ë²ˆ"ê³¼ "ì´ë¦„" ì—´ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                }

                // Send to server
                if (DB.saveRegistry) {
                    const result = await DB.saveRegistry(jsonData);
                    if (result.status === 'success') {
                        statusEl.textContent = 'í•™ì  ì •ë³´ ì—…ë¡œë“œ ì„±ê³µ!';
                        statusEl.className = 'mt-4 text-sm text-green-600';
                    } else {
                        throw new Error(result.message || 'Upload failed');
                    }
                } else {
                    throw new Error('DB.saveRegistry ê¸°ëŠ¥ì´ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. server.gsë¥¼ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.');
                }

            } catch (e) {
                statusEl.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
                statusEl.className = 'mt-4 text-sm text-red-600';
            }
        });


        // 2.5 Selection Rules (Advanced)
        let currentRules = {
            '2-1': [], '2-2': [], '3-1': [], '3-2': []
        };
        let currentMultiRules = {};

        async function loadRulesAndClassification() {
            if (!DB.isConfigured()) return;

            // Show Loading
            const container = document.getElementById('course-classification-view');
            const limitContainer = document.getElementById('limit-config-container');
            if (container) container.innerHTML = '<div class="text-center py-4 text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            if (limitContainer) limitContainer.innerHTML = '<div class="text-center py-4 text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            // 1. Fetch Data First (Parallel)
            let courses = [];
            let settings = {};

            try {
                [courses, settings] = await Promise.all([
                    DB.fetchConfig(),
                    DB.fetchSettings().catch(() => ({}))
                ]);
                allCourseData = courses || []; // Update global cache
            } catch (e) {
                console.error('Data load failed', e);
                return;
            }

            if (!courses) return;

            // 2. Update State
            if (settings && settings.selectionRules) {
                currentRules = settings.selectionRules;
            }
            if (settings && settings.multiSemesterRules) {
                currentMultiRules = settings.multiSemesterRules;
            }

            // 3. Render Classification
            container.innerHTML = '';

            const grouped = {};
            courses.forEach(c => {
                const key = `${c.grade}-${c.semester}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(c);
            });

            Object.keys(grouped).sort().forEach(key => {
                const [g, s] = key.split('-');
                const groupCourses = grouped[key];

                const section = document.createElement('div');
                section.className = 'border p-4 rounded bg-opacity-50';
                section.style.borderColor = 'var(--border-color)';
                section.style.backgroundColor = 'var(--hover-bg)';

                section.innerHTML = `
                    <h3 class="font-bold mb-2 theme-text">${g}í•™ë…„ ${s}í•™ê¸° (${groupCourses.length}ê³¼ëª©)</h3>
                    <div class="flex flex-wrap gap-2">
                        ${groupCourses.map(c => `
                            <span class="text-xs px-2 py-1 rounded border ${c.required ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-gray-700 border-gray-200'}" title="${c.subjectName}">
                                ${c.id || c.subjectName} (${c.credits})
                            </span>
                        `).join('')}
                    </div>
                `;
                container.appendChild(section);
            });

            // 4. Render Limit Config (Advanced)
            limitContainer.innerHTML = ''; // Clear immediately before appending

            ['2-1', '2-2', '3-1', '3-2'].forEach(key => {
                const [g, s] = key.split('-');

                const wrapper = document.createElement('div');
                wrapper.className = 'border p-4 rounded';
                wrapper.style.borderColor = 'var(--border-color)';

                wrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold theme-text">${g}í•™ë…„ ${s}í•™ê¸°</h4>
                        <button onclick="addRule('${key}')" class="text-xs bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-gray-700">+ ê·œì¹™ ì¶”ê°€</button>
                    </div>
                    <div id="rules-list-${key}" class="space-y-2">
                        <!-- Rules will be added here -->
                    </div>
                `;
                limitContainer.appendChild(wrapper);
                renderRulesList(key);
            });

            // 5. Render Multi-Semester Course Config
            renderMultiSemesterConfig(courses, settings);
        }

        function renderMultiSemesterConfig(courses, settings) {
            const container = document.getElementById('multi-semester-config-container');
            if (!container) return;

            container.innerHTML = `
                <div class="mb-4 p-3 bg-gray-50 rounded border">
                    <h4 class="font-bold text-sm mb-2 theme-text">ìƒˆë¡œìš´ ë³µìˆ˜ í¸ì œ ê·¸ë£¹ ì¶”ê°€</h4>
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2">
                            <select id="multi-course-select" class="flex-1 p-2 border rounded text-sm">
                                <option value="">ê³¼ëª© ì„ íƒ...</option>
                                ${[...new Set(courses.map(c => c.subjectName))].sort().map(name => `<option value="${name}">${name}</option>`).join('')}
                            </select>
                            <button onclick="addMultiSemesterGroup()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">ì¶”ê°€</button>
                        </div>
                        <div class="text-xs text-gray-500">
                            * ë™ì¼í•œ ê³¼ëª©ëª…ì´ ì—¬ëŸ¬ í•™ê¸°ì— ê°œì„¤ëœ ê²½ìš°, ì•„ë˜ ëª©ë¡ì— ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
                            * ìˆ˜ë™ìœ¼ë¡œ ê·¸ë£¹ì„ ì¶”ê°€í•˜ë ¤ë©´ ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>
                <div id="multi-semester-list" class="space-y-2"></div>
            `;

            const listEl = document.getElementById('multi-semester-list');

            // 1. Automatic Detection (Name-based) & ID Mapping
            const nameMap = {};
            const nameToIds = {};

            courses.forEach(c => {
                if (!nameMap[c.subjectName]) {
                    nameMap[c.subjectName] = new Set();
                    nameToIds[c.subjectName] = new Set();
                }
                nameMap[c.subjectName].add(`${c.grade}-${c.semester}`);
                nameToIds[c.subjectName].add(c.id || c.subjectName);
            });

            // 2. Merge with Manual Settings
            let multiRules = settings.multiSemesterRules || {};

            // Combine automatic and manual
            const allSubjects = new Set([...Object.keys(nameMap), ...Object.keys(multiRules)]);
            const sortedSubjects = [...allSubjects].sort();

            // Populate Dropdown with IDs
            const selectEl = document.getElementById('multi-course-select');
            selectEl.innerHTML = '<option value="">ê³¼ëª© ì„ íƒ...</option>' +
                sortedSubjects.map(name => {
                    const ids = nameToIds[name] ? [...nameToIds[name]].join(', ') : name;
                    return `<option value="${name}">${ids}</option>`;
                }).join('');

            sortedSubjects.forEach(name => {
                const autoSemesters = nameMap[name] ? [...nameMap[name]] : [];
                const manualSemesters = multiRules[name] || [];
                const ids = nameToIds[name] ? [...nameToIds[name]].join(', ') : name;

                // If no duplicates and no manual rule, skip
                if (autoSemesters.length < 2 && manualSemesters.length === 0) return;

                const allSemesters = [...new Set([...autoSemesters, ...manualSemesters])].sort();

                const div = document.createElement('div');
                div.className = 'p-3 border rounded bg-white hover:bg-gray-50 transition-colors';
                div.style.borderColor = 'var(--border-color)';
                div.style.backgroundColor = 'var(--card-bg)';

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="font-bold theme-text">${ids}</span>
                        </div>
                        <button onclick="deleteMultiRule('${name}')" class="text-xs text-red-500 hover:text-red-700">ì´ˆê¸°í™”</button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${['1-1', '1-2', '2-1', '2-2', '3-1', '3-2'].map(sem => {
                    const isAuto = autoSemesters.includes(sem);
                    const isChecked = allSemesters.includes(sem);
                    return `
                                <label class="flex items-center space-x-1 text-xs cursor-pointer">
                                    <input type="checkbox" 
                                        value="${sem}" 
                                        ${isChecked ? 'checked' : ''} 
                                        ${isAuto ? 'disabled' : ''}
                                        onchange="updateMultiRule('${name}', '${sem}', this.checked)"
                                        class="form-checkbox h-3 w-3 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                                    <span class="${isChecked ? 'text-blue-600 font-medium' : 'text-gray-500'}">${sem}</span>
                                </label>
                            `;
                }).join('')}
                    </div>
                `;
                listEl.appendChild(div);
            });
        }

        window.addMultiSemesterGroup = () => {
            const select = document.getElementById('multi-course-select');
            const name = select.value;
            if (!name) return alert('ê³¼ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

            if (!currentMultiRules[name]) currentMultiRules[name] = [];
            saveMultiRules();
        };

        window.updateMultiRule = (name, semester, isChecked) => {
            if (!currentMultiRules[name]) currentMultiRules[name] = [];

            if (isChecked) {
                if (!currentMultiRules[name].includes(semester)) {
                    currentMultiRules[name].push(semester);
                }
            } else {
                currentMultiRules[name] = currentMultiRules[name].filter(s => s !== semester);
            }
            saveMultiRules();
        };

        window.deleteMultiRule = (name) => {
            if (confirm(`'${name}'ì˜ ìˆ˜ë™ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìë™ ê°ì§€ëœ í¸ì œëŠ” ìœ ì§€ë©ë‹ˆë‹¤)`)) {
                delete currentMultiRules[name];
                saveMultiRules();
            }
        };

        async function saveMultiRules() {
            try {
                await DB.saveSettings({ multiSemesterRules: currentMultiRules });
                loadRulesAndClassification();
            } catch (e) {
                console.error('Failed to save multi rules', e);
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        }

        function renderRulesList(key) {
            const listEl = document.getElementById(`rules-list-${key}`);
            listEl.innerHTML = '';

            if (!currentRules[key] || currentRules[key].length === 0) {
                listEl.innerHTML = '<div class="text-xs text-gray-400 italic">ì„¤ì •ëœ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            currentRules[key].forEach((rule, idx) => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-2 text-sm';

                row.innerHTML = `
                    <select onchange="updateRule('${key}', ${idx}, 'credits', this.value)" class="p-1 border rounded w-24">
                        <option value="all" ${rule.credits === 'all' ? 'selected' : ''}>ëª¨ë“  í•™ì </option>
                        <option value="4" ${rule.credits == 4 ? 'selected' : ''}>4í•™ì </option>
                        <option value="3" ${rule.credits == 3 ? 'selected' : ''}>3í•™ì </option>
                        <option value="2" ${rule.credits == 2 ? 'selected' : ''}>2í•™ì </option>
                        <option value="1" ${rule.credits == 1 ? 'selected' : ''}>1í•™ì </option>
                    </select>
                    <span class="theme-text">ê³¼ëª©ì„</span>
                    <select onchange="updateRule('${key}', ${idx}, 'count', this.value)" class="p-1 border rounded w-16">
                        ${[...Array(10).keys()].map(i => `<option value="${i + 1}" ${rule.count == i + 1 ? 'selected' : ''}>${i + 1}</option>`).join('')}
                    </select>
                    <span class="theme-text">ê°œ ì„ íƒ</span>
                    <button onclick="removeRule('${key}', ${idx})" class="text-red-500 hover:text-red-700 ml-auto">Ã—</button>
                `;
                listEl.appendChild(row);
            });
        }

        window.addRule = (key) => {
            if (!currentRules[key]) currentRules[key] = [];
            currentRules[key].push({ credits: 'all', count: 1 });
            renderRulesList(key);
        };

        window.removeRule = (key, idx) => {
            currentRules[key].splice(idx, 1);
            renderRulesList(key);
        };

        window.updateRule = (key, idx, field, value) => {
            currentRules[key][idx][field] = value;
        };

        document.getElementById('save-rules-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-rules-btn');
            btn.disabled = true;
            btn.textContent = 'ì €ì¥ ì¤‘...';

            try {
                await DB.saveSettings({ selectionRules: currentRules });
                alert('ê·œì¹™ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ê·œì¹™ ì €ì¥';
            }
        });


        // 3. Share
        function updateShareLink() {
            const container = document.getElementById('share-container');
            const errorMsg = document.getElementById('share-error');
            const savedUrl = localStorage.getItem('gas_api_url');

            if (!savedUrl) {
                container.classList.add('hidden');
                errorMsg.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            errorMsg.classList.add('hidden');

            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const encodedKey = btoa(savedUrl);
            const fullLink = `${baseUrl}?key=${encodedKey}`;

            document.getElementById('share-link-text').textContent = fullLink;
            QRCodeGenerator.generate('qrcode', fullLink, 256);

            document.getElementById('copy-link-btn').onclick = () => {
                navigator.clipboard.writeText(fullLink).then(() => alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
            };
        }

        // 4. Dashboard
        function updateDashboardCounts() {
            // Count total submissions
            const count = allStudentData ? allStudentData.length : 0;
            const countEl = document.getElementById('total-submissions-count');
            if (countEl) countEl.textContent = `${count}ëª… ì œì¶œë¨`;
        }

        // Global Data
        // Global Data - Ensure these are initialized only once if they exist globally, but if 416 has it, we just use it.
        // If allStudentData is declared at 416, we don't redeclare here.
        // let allStudentData = []; // Removed to avoid conflict
        let registryData = [];

        async function loadStudentData() {
            if (!DB.isConfigured()) return;
            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center theme-text-muted">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>';

            // Also ensure course data is loaded for headers
            if (allCourseData.length === 0) {
                try { allCourseData = await DB.fetchConfig() || []; } catch (e) { }
            }

            // Parallel Fetch
            try {
                const [response, registry] = await Promise.all([
                    DB.fetchResponses(),
                    DB.fetchRegistry()
                ]);

                // Handle Responses
                if (Array.isArray(response)) {
                    allStudentData = response;
                } else if (response && response.data) {
                    allStudentData = response.data;
                } else {
                    allStudentData = [];
                }

                // Handle Registry
                if (Array.isArray(registry)) {
                    registryData = registry;
                } else {
                    registryData = [];
                }

                updateDashboardCounts();
                document.getElementById('total-submissions-count').textContent = `${allStudentData.length}ëª… ì œì¶œë¨`;
                renderStudentTable();
                updateClassFilter();
            } catch (e) {
                console.error("Failed to load data:", e);
                tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-4 text-center text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${e.message}</td></tr>`;
            }
        }

        function renderStudentTable() {
            const tbody = document.getElementById('student-table-body');
            const gradeFilter = document.getElementById('filter-grade').value;
            const classFilter = document.getElementById('filter-class').value;

            if (!Array.isArray(allStudentData)) allStudentData = [];

            let filtered = allStudentData;
            if (gradeFilter) filtered = filtered.filter(d => String(d.Grade) === String(gradeFilter));
            if (classFilter) filtered = filtered.filter(d => String(d.Class) === String(classFilter));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center theme-text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // Sort: Grade -> Class -> Number
            filtered.sort((a, b) => {
                if (a.Grade !== b.Grade) return a.Grade - b.Grade;
                if (a.Class !== b.Class) return a.Class - b.Class;
                return a.Number - b.Number;
            });

            tbody.innerHTML = filtered.map(d => {
                const date = new Date(d.Timestamp).toLocaleString();
                const isValid = true;
                // We could calculate validation status here if needed, but for now assuming valid

                return `
                    <tr class="border-b hover:bg-opacity-50" style="background-color: var(--card-bg); border-color: var(--border-color)">
                        <td class="px-4 py-2 theme-text">${date}</td>
                        <td class="px-4 py-2 theme-text">${d.Grade}${String(d.Class).padStart(2, '0')}${String(d.Number).padStart(2, '0')}</td>
                        <td class="px-4 py-2 font-medium theme-text">${d.Name}</td>
                        <td class="px-4 py-2 theme-text">${d.Major}</td>
                        <td class="px-4 py-2 theme-text">${d.TotalCredits}</td>
                        <td class="px-4 py-2 text-green-600">ì œì¶œì™„ë£Œ</td>
                    </tr>
                `;
            }).join('');
        }

        function updateClassFilter() {
            const classSelect = document.getElementById('filter-class');
            const classes = [...new Set(allStudentData.map(d => d.Class))].sort((a, b) => a - b);
            classSelect.innerHTML = '<option value="">ì „ì²´ ë°˜</option>' + classes.map(c => `<option value="${c}">${c}ë°˜</option>`).join('');
        }

        document.getElementById('filter-grade').addEventListener('change', renderStudentTable);
        document.getElementById('filter-class').addEventListener('change', renderStudentTable);
        document.getElementById('refresh-data-btn').addEventListener('click', loadStudentData);

        // Excel Matrix Download (Enhanced)
        document.getElementById('download-matrix-btn').addEventListener('click', () => {
            if (allStudentData.length === 0) return alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

            // 1. Get all subject names and their semester info from allCourseData
            // If allCourseData is empty (rare), we might miss filtering
            const courseMeta = {}; // { "Slug/ID" : { grade: 1, semester: 1, required: false } }

            allCourseData.forEach(c => {
                const id = c.id || c.subjectName; // Use ID if available
                // Normalize required
                const req = (c.required === true || String(c.required).toUpperCase() === 'TRUE');
                courseMeta[id] = {
                    grade: c.grade,
                    semester: c.semester,
                    required: req
                };
                // Also map subjectName just in case selectedCourses uses name
                courseMeta[c.subjectName] = courseMeta[id];
            });

            // 2. Collect all courses actually selected by students
            const allSelectedCourses = new Set();
            allStudentData.forEach(d => {
                if (d.SelectedCourses) {
                    d.SelectedCourses.split(', ').forEach(c => {
                        allSelectedCourses.add(c.trim());
                    });
                }
            });

            // 3. Filter and Sort Columns
            // Filter out School Designated (Required) courses
            const courseColumns = [...allSelectedCourses].filter(c => {
                const meta = courseMeta[c];
                return meta ? !meta.required : true; // Keep if unknown or not required
            });

            // Sort by Grade-Semester-Name
            courseColumns.sort((a, b) => {
                const metaA = courseMeta[a] || { grade: 9, semester: 9 };
                const metaB = courseMeta[b] || { grade: 9, semester: 9 };

                if (metaA.grade !== metaB.grade) return metaA.grade - metaB.grade;
                if (metaA.semester !== metaB.semester) return metaA.semester - metaB.semester;
                return a.localeCompare(b);
            });

            // 4. Build Matrix
            const matrix = allStudentData.map(d => {
                const row = {
                    'í•™ë…„': d.Grade,
                    'ë°˜': d.Class,
                    'ë²ˆí˜¸': d.Number,
                    'í•™ë²ˆ': `${d.Grade}${String(d.Class).padStart(2, '0')}${String(d.Number).padStart(2, '0')}`,
                    'ì´ë¦„': d.Name,
                    'ì§„ë¡œ': d.Major,
                    'ì´í•™ì ': d.TotalCredits
                };
                const selected = new Set(d.SelectedCourses ? d.SelectedCourses.split(', ').map(c => c.trim()) : []);

                courseColumns.forEach(c => {
                    row[c] = selected.has(c) ? 1 : 0;
                });
                return row;
            });

            ExcelHandler.downloadExcel(matrix, 'í•™ìƒì„ íƒê³¼ëª©_ë§¤íŠ¸ë¦­ìŠ¤(ë¹„í•„ìˆ˜).xlsx');
        });

        // --- Class Stats & Modal Functions ---
        const modal = document.getElementById('class-lookup-modal');
        const modalContent = document.getElementById('class-stats-content');

        window.openClassStats = () => {
            modal.classList.remove('hidden');
        };

        window.closeClassStats = () => {
            modal.classList.add('hidden');
        };

        // Close on click outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeClassStats();
        });

        // Populate Student Number Options
        function populateStudentNumberOptions() {
            const grade = document.getElementById('modal-select-grade').value;
            const cls = document.getElementById('modal-select-class').value;
            const numSelect = document.getElementById('modal-select-number');

            // Clear existing
            numSelect.innerHTML = '<option value="all">ì „ì²´</option>';

            // Use Registry data if available, or fall back to responses
            let studentsInClass = [];
            if (registryData && registryData.length > 0) {
                studentsInClass = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '');
                    return sNum.startsWith(grade) && parseInt(sNum.substring(1, 3)) == cls;
                }).map(r => ({
                    number: parseInt(String(r['í•™ë²ˆ']).substring(3, 5)),
                    name: r['ì´ë¦„'] || r.name
                }));
            } else {
                studentsInClass = allStudentData.filter(s => s.Grade == grade && s.Class == cls).map(s => ({
                    number: parseInt(s.Number),
                    name: s.Name
                }));
            }

            // Remove duplicates and sort
            const unique = [];
            const seen = new Set();
            studentsInClass.forEach(s => {
                if (!seen.has(s.number)) {
                    seen.add(s.number);
                    unique.push(s);
                }
            });
            unique.sort((a, b) => a.number - b.number);

            unique.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.number;
                opt.textContent = `${s.number}ë²ˆ ${s.name}`;
                numSelect.appendChild(opt);
            });
        }

        // Updated Render Function (was queryClassStats)
        window.renderIndividualStatsTable = () => {
            const grade = document.getElementById('modal-select-grade').value;
            const cls = document.getElementById('modal-select-class').value;
            const targetNum = document.getElementById('modal-select-number').value;

            let filtered = allStudentData.filter(s => s.Grade == grade && s.Class == cls);

            if (targetNum !== 'all') {
                filtered = filtered.filter(s => parseInt(s.Number) == targetNum);
            }

            // Sort by number
            filtered.sort((a, b) => parseInt(a.Number) - parseInt(b.Number));

            const html = `
                <div class="mb-2 text-center font-bold text-lg border-b pb-2">
                    ${grade}í•™ë…„ ${cls}ë°˜ ${targetNum !== 'all' ? targetNum + 'ë²ˆ' : ''} ê³¼ëª© ì„ íƒ í˜„í™© (${filtered.length}ëª…)
                </div>
                <table class="w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700">
                            <th class="border p-1">ë²ˆí˜¸</th>
                            <th class="border p-1">ì´ë¦„</th>
                            <th class="border p-1">ì§„ë¡œ</th>
                            <th class="border p-1">ì‹ ì²­ê³¼ëª©ìˆ˜</th>
                            <th class="border p-1">ì´í•™ì </th>
                            <th class="border p-1">ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.length > 0 ? filtered.map(s => {
                const courseCount = s.SelectedCourses ? s.SelectedCourses.split(',').length : 0;
                return `
                                <tr>
                                    <td class="border p-1 text-center font-bold">${s.Number}</td>
                                    <td class="border p-1 text-center">${s.Name}</td>
                                    <td class="border p-1 text-center text-gray-600 truncate max-w-[100px]">${s.Major}</td>
                                    <td class="border p-1 text-center">${courseCount}</td>
                                    <td class="border p-1 text-center">${s.TotalCredits}</td>
                                    <td class="border p-1 text-center text-green-600">ì™„ë£Œ</td>
                                </tr>
                             `;
            }).join('') : '<tr><td colspan="6" class="p-4 text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                    </tbody>
                </table>
             `;
            modalContent.innerHTML = html;
        };

        window.downloadClassImage = () => {
            if (!modalContent.querySelector('table')) return alert('ë¨¼ì € ì¡°íšŒë¥¼ í•´ì£¼ì„¸ìš”.');

            html2canvas(modalContent).then(canvas => {
                const link = document.createElement('a');
                link.download = `í•™ê¸‰í†µê³„_${document.getElementById('modal-select-grade').value}í•™ë…„${document.getElementById('modal-select-class').value}ë°˜.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        // --- New Statistics & Bug Fixes ---

        // Fix for Class Dropdown Bug and options population
        function populateClassOptions() {
            // Find existing max class or default to 15
            const maxClass = 15;
            const optionsHtml = [...Array(maxClass).keys()].map(i => `<option value="${i + 1}">${i + 1}ë°˜</option>`).join('');

            const filterEl = document.getElementById('filter-class');
            const modalEl = document.getElementById('modal-select-class');
            const dashboardEl = document.getElementById('dashboard-select-class');

            if (filterEl) {
                const existing = filterEl.innerHTML;
                // Keep "All Classes" option if present
                if (!existing.includes('1ë°˜')) filterEl.innerHTML += optionsHtml;
                // Actually filter-class is handled by updateClassFilter usually, but initial population is good
            }
            if (modalEl) modalEl.innerHTML = optionsHtml;
            if (dashboardEl) dashboardEl.innerHTML = optionsHtml;
        }

        // Call on load
        document.addEventListener('DOMContentLoaded', () => {
            populateClassOptions();
        });

        // 1. Individual Stats (Renaming queryClassStats logic)
        window.openIndividualStats = () => {
            document.getElementById('class-lookup-modal').classList.remove('hidden');
            populateStudentNumberOptions(); // Initialize
        };

        window.closeClassStats = () => { // Renamed or kept for compatibility
            document.getElementById('class-lookup-modal').classList.add('hidden');
        }

        // Reuse existing queryClassStats but renamed internally or alias it? 
        // The user wants "Individual Stats" button to trigger the view.
        // I already mapped the button to openIndividualStats() which opens the modal.
        // The 'Look up' button inside calls openIndividualStats() (modified from queryClassStats).


        let dashboardCharts = {};

        // Helper: Calculate Rank Counts
        function calculateRankCounts(total) {
            return {
                grade1: Math.round(total * 0.10),
                grade2: Math.round(total * 0.34) - Math.round(total * 0.10),
                grade3: Math.round(total * 0.66) - Math.round(total * 0.34),
                grade4: Math.round(total * 0.90) - Math.round(total * 0.66),
                grade5: total - Math.round(total * 0.90)
            };
        }

        // --- Class Stats Dashboard Logic ---
        window.currentDashboardTab = 'charts'; // charts, class-subjects, validation, grade-subjects

        window.openClassStatsDashboard = () => {
            document.getElementById('class-stats-dashboard-modal').classList.remove('hidden');
        };

        window.renderClassStatsDashboard = () => {
            const grade = document.getElementById('dashboard-select-grade').value;
            const cls = document.getElementById('dashboard-select-class').value;
            const container = document.getElementById('dashboard-content');
            const msgEl = document.getElementById('dashboard-message');

            // Data Preparation
            const classStudents = allStudentData.filter(s => s.Grade == grade && s.Class == cls);
            const gradeStudents = allStudentData.filter(s => s.Grade == grade);

            if (classStudents.length === 0 && window.currentDashboardTab !== 'grade-subjects') {
                container.classList.add('hidden');
                msgEl.textContent = `${grade}í•™ë…„ ${cls}ë°˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                msgEl.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            msgEl.classList.add('hidden');

            // Render Tab Buttons
            renderDashboardTabs();

            // Render Content based on Tab
            const contentArea = document.getElementById('dashboard-tab-content');
            contentArea.innerHTML = ''; // Clear

            if (window.currentDashboardTab === 'charts') {
                contentArea.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="h-64 relative border rounded p-4 theme-border bg-white dark:bg-gray-800">
                            <h4 class="text-center font-bold mb-4 theme-text">íƒêµ¬ ê³¼ëª© ì„ íƒ ë¹„ìœ¨ (ì‚¬íšŒ vs ê³¼í•™)</h4>
                            <canvas id="inquiryRatioChart"></canvas>
                        </div>
                        <div class="h-64 relative border rounded p-4 theme-border bg-white dark:bg-gray-800">
                            <h4 class="text-center font-bold mb-4 theme-text">ì œ2ì™¸êµ­ì–´ ë° êµì–‘ ì„ íƒ í˜„í™©</h4>
                            <canvas id="languageChart"></canvas>
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    renderInquiryChart(classStudents);
                    renderLanguageChart(classStudents);
                }, 100);

            } else if (window.currentDashboardTab === 'class-subjects') {
                renderClassSubjectStats(contentArea, classStudents, grade);

            } else if (window.currentDashboardTab === 'validation') {
                renderValidationStats(contentArea, classStudents, grade, cls);

            } else if (window.currentDashboardTab === 'grade-subjects') {
                renderGradeSubjectStats(contentArea, gradeStudents, grade);
            }
        };

        function renderDashboardTabs() {
            const tabsContainer = document.getElementById('dashboard-tabs');
            const tabs = [
                { id: 'charts', label: 'ğŸ“Š ì°¨íŠ¸' },
                { id: 'class-subjects', label: 'ğŸ« í•™ê¸‰ ê³¼ëª©ë³„ í†µê³„' },
                { id: 'validation', label: 'âœ… ê²€ì¦ í˜„í™©' },
                { id: 'grade-subjects', label: 'ğŸ“ í•™ë…„ ì „ì²´ í†µê³„' }
            ];

            tabsContainer.innerHTML = tabs.map(t => `
                <button onclick="switchDashboardTab('${t.id}')" 
                    class="px-4 py-2 text-sm font-bold border-b-2 transition-colors ${window.currentDashboardTab === t.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}">
                    ${t.label}
                </button>
            `).join('');
        }

        window.switchDashboardTab = (tabId) => {
            window.currentDashboardTab = tabId;
            renderClassStatsDashboard();
        };

        // Tab 2: Class Subject Stats
        function renderClassSubjectStats(container, students, currentGrade) {
            container.innerHTML = `
                <div class="mb-4 flex gap-2 items-center">
                    <span class="font-bold theme-text">í•„í„°:</span>
                    <select id="stats-filter-semester" onchange="renderClassStatsDashboard()" class="border p-1 rounded text-sm">
                        <option value="all">ì „ì²´ í•™ê¸°</option>
                        <option value="1">1í•™ê¸°</option>
                        <option value="2">2í•™ê¸°</option>
                    </select>
                     <span class="text-xs text-gray-400 ml-2">* í•´ë‹¹ í•™ê¸‰ í•™ìƒë“¤ì˜ ì„ íƒ ê³¼ëª© ì¸ì›ì…ë‹ˆë‹¤.</span>
                </div>
                <div id="class-subject-table-container" class="overflow-x-auto"></div>
            `;

            const semesterFilter = document.getElementById('stats-filter-semester').value;
            const counts = {};

            students.forEach(s => {
                if (s.SelectedCourses) {
                    s.SelectedCourses.split(', ').map(x => x.trim()).forEach(cName => {
                        // Filter by Semester Logic (Requires Course Metadata)
                        const meta = allCourseData.find(c => c.subjectName === cName);
                        if (semesterFilter !== 'all') {
                            if (!meta || String(meta.semester) !== semesterFilter) return;
                        }
                        // Also could filter by Grade if course has specific grade, but usually we just show all selected.
                        // But request says "Grade-Semester". Let's assume user wants courses for THIS grade? 
                        // Or courses OPEN to this grade? Usually simpler to just count what they picked.

                        counts[cName] = (counts[cName] || 0) + 1;
                    });
                }
            });

            // Sort by count desc
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            let html = `
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="bg-gray-100 dark:bg-gray-700 theme-text">
                            <th class="border p-2 theme-border text-left">ê³¼ëª©ëª…</th>
                            <th class="border p-2 theme-border text-center w-24">ì„ íƒ ì¸ì›</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (sorted.length === 0) {
                html += `<tr><td colspan="2" class="p-4 text-center text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                sorted.forEach(([name, count]) => {
                    html += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600 theme-text">
                            <td class="border p-2 theme-border font-medium">${name}</td>
                            <td class="border p-2 theme-border text-center font-bold text-blue-600">${count}ëª…</td>
                        </tr>
                    `;
                });
            }
            html += `</tbody></table>`;
            document.getElementById('class-subject-table-container').innerHTML = html;

            // Restore filter selection
            document.getElementById('stats-filter-semester').value = semesterFilter;
            // Re-attach event listener since innerHTML wiped it (actually onclick in HTML handles it, but verify scope)
        }

        // Tab 3: Validation Stats
        function renderValidationStats(container, students, grade, cls) {
            // Merge Registry
            let baseList = [];
            const hasRegistry = registryData && registryData.length > 0;

            if (hasRegistry) {
                baseList = registryData.filter(r => {
                    const sNum = String(r['í•™ë²ˆ'] || r.studentId || '');
                    if (sNum.length === 5) {
                        return sNum.startsWith(grade) && parseInt(sNum.substring(1, 3)) == cls;
                    }
                    return false;
                }).map(r => ({
                    number: parseInt(String(r['í•™ë²ˆ']).substring(3, 5)),
                    name: r['ì´ë¦„'] || r.name,
                    studentId: r['í•™ë²ˆ'],
                    fromRegistry: true
                }));
            }

            if (baseList.length === 0 && students.length > 0) {
                baseList = students.map(s => ({
                    number: parseInt(s.Number),
                    name: s.Name,
                    studentId: `${s.Grade}${String(s.Class).padStart(2, '0')}${String(s.Number).padStart(2, '0')}`,
                    fromRegistry: false
                }));
            }
            baseList.sort((a, b) => a.number - b.number);

            const merged = baseList.map(item => {
                const res = students.find(s => parseInt(s.Number) == item.number);
                return { ...item, response: res };
            });

            let html = `
                <div class="mb-2 text-sm text-gray-500 text-right">ì´ ${merged.length}ëª… (ì œì¶œ: ${merged.filter(m => m.response).length}ëª…)</div>
                <div class="overflow-y-auto max-h-[400px]">
                <table class="w-full text-sm border-collapse">
                    <thead class="sticky top-0 bg-gray-100 dark:bg-gray-700 z-10 shadow-sm">
                        <tr class="theme-text">
                            <th class="border p-2 theme-border w-16 text-center">ë²ˆí˜¸</th>
                            <th class="border p-2 theme-border w-24 text-center">ì´ë¦„</th>
                            <th class="border p-2 theme-border text-center">ê²€ì¦ í˜„í™©</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            merged.forEach(m => {
                let statusHtml = '<span class="text-gray-400">-</span>';
                if (!m.response) {
                    statusHtml = '<span class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">ë¯¸ì œì¶œ</span>';
                } else {
                    const vRes = m.response.ValidationResult || '';
                    if (!vRes) {
                        statusHtml = '<span class="text-gray-500">íŠ¹ì´ì‚¬í•­ ì—†ìŒ</span>';
                    } else if (vRes.includes('ë¶€ì¡±') || vRes.includes('ì´ˆê³¼') || vRes.includes('í•„ìš”') || vRes.includes('í™•ì¸')) {
                        statusHtml = `<span class="text-red-600 font-bold whitespace-pre-wrap text-xs">${vRes}</span>`;
                    } else {
                        statusHtml = `<span class="text-blue-600 font-bold">PASS (í†µê³¼)</span>`;
                    }
                }

                html += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-600 theme-text">
                        <td class="border p-2 theme-border text-center">${m.number}</td>
                        <td class="border p-2 theme-border text-center font-medium">${m.name}</td>
                        <td class="border p-2 theme-border">${statusHtml}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Tab 4: Grade Subject Stats (Rank Estimation)
        function renderGradeSubjectStats(container, students, currentGrade) {
            container.innerHTML = `
                <div class="mb-4 flex gap-2 items-center flex-wrap">
                    <span class="font-bold theme-text">í•„í„°:</span>
                    <select id="grade-stats-semester" onchange="renderClassStatsDashboard()" class="border p-1 rounded text-sm">
                        <option value="all">ì „ì²´ í•™ê¸°</option>
                        <option value="1">1í•™ê¸°</option>
                        <option value="2">2í•™ê¸°</option>
                    </select>
                    <div class="ml-auto text-xs text-red-500 font-bold bg-red-50 px-2 py-1 rounded">
                        âš ï¸ [ì£¼ì˜] ì„ì°¨ë“±ê¸‰ ì¸ì›ì€ í•™ë…„ ì „ì²´ ì¸ì›ì´ ì•„ë‹Œ, 'í•´ë‹¹ ê³¼ëª© ì„ íƒ ì¸ì›' ê¸°ì¤€ ë‹¨ìˆœ ë¹„ìœ¨ ê³„ì‚°ì…ë‹ˆë‹¤.<br>
                        ì‹¤ì œ ì„±ì  ì‚°ì¶œ ì‹œ ë™ì ì ì²˜ë¦¬ ë“±ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (1ë“±ê¸‰:4%ê°€ ì•„ë‹Œ 10% ë“± ì‚¬ìš©ìê°€ ìš”ì²­í•œ ì»¤ìŠ¤í…€ ë¹„ìœ¨ ì ìš©ë¨)
                    </div>
                </div>
                <div id="grade-subject-table-container" class="overflow-x-auto"></div>
            `;
            const semesterFilter = document.getElementById('grade-stats-semester').value; // Potentially null if re-render? No, element exists now.

            // Count
            const counts = {};
            students.forEach(s => {
                if (s.SelectedCourses) {
                    s.SelectedCourses.split(', ').map(x => x.trim()).forEach(cName => {
                        const meta = allCourseData.find(c => c.subjectName === cName);
                        if (semesterFilter !== 'all') {
                            if (!meta || String(meta.semester) !== semesterFilter) return;
                        }
                        counts[cName] = (counts[cName] || 0) + 1;
                    });
                }
            });

            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            let html = `
                <table class="w-full text-xs border-collapse">
                    <thead class="sticky top-0 bg-gray-100 dark:bg-gray-700 z-10">
                        <tr class="theme-text">
                            <th class="border p-2 theme-border text-left min-w-[150px]">ê³¼ëª©ëª…</th>
                            <th class="border p-2 theme-border text-center w-16 bg-blue-50 text-blue-900 font-bold">ì´ì›</th>
                            <th class="border p-2 theme-border text-center w-16" title="ìƒìœ„ 10%">1ë“±ê¸‰<br><span class="text-[10px] text-gray-500">~10%</span></th>
                            <th class="border p-2 theme-border text-center w-16" title="ìƒìœ„ 34%">2ë“±ê¸‰<br><span class="text-[10px] text-gray-500">~34%</span></th>
                            <th class="border p-2 theme-border text-center w-16" title="ìƒìœ„ 66%">3ë“±ê¸‰<br><span class="text-[10px] text-gray-500">~66%</span></th>
                            <th class="border p-2 theme-border text-center w-16" title="ìƒìœ„ 90%">4ë“±ê¸‰<br><span class="text-[10px] text-gray-500">~90%</span></th>
                            <th class="border p-2 theme-border text-center w-16">5ë“±ê¸‰<br><span class="text-[10px] text-gray-500">ë‚˜ë¨¸ì§€</span></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            if (sorted.length === 0) {
                html += `<tr><td colspan="7" class="p-8 text-center text-gray-500">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            } else {
                sorted.forEach(([name, count]) => {
                    const ranks = calculateRankCounts(count);
                    html += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600 theme-text text-center">
                            <td class="border p-2 theme-border text-left font-medium truncate">${name}</td>
                            <td class="border p-2 theme-border font-bold text-blue-600 bg-blue-50 dark:bg-blue-900/20">${count}</td>
                            <td class="border p-2 theme-border">${ranks.grade1}</td>
                            <td class="border p-2 theme-border">${ranks.grade2}</td>
                            <td class="border p-2 theme-border">${ranks.grade3}</td>
                            <td class="border p-2 theme-border">${ranks.grade4}</td>
                            <td class="border p-2 theme-border text-gray-400">${ranks.grade5}</td>
                        </tr>
                    `;
                });
            }
            html += '</tbody></table>';

            document.getElementById('grade-subject-table-container').innerHTML = html;
            // Restore value
            if (document.getElementById('grade-stats-semester'))
                document.getElementById('grade-stats-semester').value = semesterFilter;
        }


        function renderInquiryChart(students) {
            const ctx = document.getElementById('inquiryRatioChart');
            if (!ctx) return;

            // Count Social vs Science
            let social = 0;
            let science = 0;

            // Need to match course names to categories. 
            // Using allCourseData global to lookup category by subjectName
            const courseMap = {};
            allCourseData.forEach(c => {
                courseMap[c.subjectName] = c.subCategory || c.category;
            });

            students.forEach(s => {
                if (s.SelectedCourses) {
                    const courses = s.SelectedCourses.split(', ').map(x => x.trim());
                    courses.forEach(cName => {
                        const cat = courseMap[cName];
                        if (cat && cat.includes('ì‚¬íšŒ')) social++;
                        if (cat && cat.includes('ê³¼í•™')) science++;
                    });
                }
            });

            if (dashboardCharts.inquiry) dashboardCharts.inquiry.destroy();

            dashboardCharts.inquiry = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ì‚¬íšŒíƒêµ¬', 'ê³¼í•™íƒêµ¬'],
                    datasets: [{
                        data: [social, science],
                        backgroundColor: ['rgba(251, 146, 60, 0.6)', 'rgba(59, 130, 246, 0.6)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderLanguageChart(students) {
            const ctx = document.getElementById('languageChart');
            if (!ctx) return;

            const counts = {};
            const targetLangs = ['ì¼ë³¸ì–´', 'ì¤‘êµ­ì–´', 'í•œë¬¸', 'ìŠ¤í˜ì¸ì–´', 'í”„ë‘ìŠ¤ì–´', 'ë…ì¼ì–´'];
            // Dynamic detection?

            students.forEach(s => {
                if (s.SelectedCourses) {
                    s.SelectedCourses.split(', ').map(x => x.trim()).forEach(cName => {
                        // Simple check if course name contains language
                        if (targetLangs.some(l => cName.includes(l)) || cName.endsWith('ì–´') || cName === 'í•œë¬¸') {
                            counts[cName] = (counts[cName] || 0) + 1;
                        }
                    });
                }
            });

            const labels = Object.keys(counts);
            const data = Object.values(counts);

            if (dashboardCharts.language) dashboardCharts.language.destroy();

            dashboardCharts.language = new Chart(ctx, {
                type: 'bar', // or doughnut
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì„ íƒ ì¸ì›',
                        data: data,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>

    <!-- Modal: Class Stats Dashboard (New) -->
    <div id="class-stats-dashboard-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div
            class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-5xl h-[90vh] flex flex-col shadow-2xl relative">
            <button onclick="document.getElementById('class-stats-dashboard-modal').classList.add('hidden')"
                class="absolute top-4 right-4 text-gray-500 text-2xl hover:text-gray-700">&times;</button>

            <h2 class="text-2xl font-bold mb-4 theme-text">ğŸ“Š í•™ê¸‰/í•™ë…„ í†µê³„ ëŒ€ì‹œë³´ë“œ</h2>

            <!-- Scope Selection -->
            <div class="flex gap-4 mb-4 items-center bg-gray-50 dark:bg-gray-700 p-3 rounded">
                <select id="dashboard-select-grade" class="border p-2 rounded w-24">
                    <option value="1">1í•™ë…„</option>
                    <option value="2">2í•™ë…„</option>
                    <option value="3">3í•™ë…„</option>
                </select>
                <select id="dashboard-select-class" class="border p-2 rounded w-24">
                    <!-- Dynamic -->
                </select>
                <button onclick="renderClassStatsDashboard()"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">ì¡°íšŒ</button>
            </div>

            <div id="dashboard-message" class="text-center text-gray-500 py-10 hidden"></div>

            <div id="dashboard-content" class="flex-1 flex flex-col overflow-hidden hidden">
                <!-- Tabs -->
                <div id="dashboard-tabs" class="flex gap-2 border-b theme-border mb-4 overflow-x-auto">
                    <!-- Injected via JS -->
                </div>

                <!-- Content Area -->
                <div id="dashboard-tab-content" class="flex-1 overflow-y-auto custom-scrollbar p-1">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Theme Selector -->
    <div class="fixed bottom-6 left-6 z-50 group">
        <div id="theme-menu"
            class="absolute bottom-full left-0 mb-2 hidden bg-white rounded-lg shadow-xl border p-2 min-w-[150px] transition-all transform origin-bottom-left">
            <div class="text-xs font-bold text-gray-400 mb-2 px-2">í…Œë§ˆ ì„ íƒ</div>
            <button onclick="changeTheme('light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>â˜€ï¸</span>ë¼ì´íŠ¸
                ëª¨ë“œ</button>
            <button onclick="changeTheme('dark-neon')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ™</span>ë‹¤í¬
                ë„¤ì˜¨</button>
            <button onclick="changeTheme('tokyo-night')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒƒ</span>ë„ì¿„
                ë‚˜ì´íŠ¸</button>
            <button onclick="changeTheme('solarized-light')"
                class="w-full text-left px-2 py-1.5 hover:bg-purple-50 rounded text-sm flex items-center gap-2 text-gray-800"><span>ğŸŒ…</span>ì†”ë¼ë¼ì´ì¦ˆë“œ</button>
        </div>
        <button onclick="toggleThemeMenu()"
            class="bg-white p-3 rounded-full shadow-lg border-2 border-purple-100 hover:border-purple-300 hover:shadow-xl transition-all flex items-center justify-center w-12 h-12">
            <span class="text-2xl">ğŸ¨</span>
        </button>
    </div>
    <script>
        function changeTheme(themeName) {
            applyTheme(themeName);
            localStorage.setItem('theme', themeName);
            document.getElementById('theme-menu').classList.add('hidden');
        }

        function toggleThemeMenu() {
            document.getElementById('theme-menu').classList.toggle('hidden');
        }

        // Initialize Theme & Class Options & Config
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            populateClassOptions();
            loadConfig(); // Load API URL
        });
    </script>
</body>

</html>
